<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Správca turnaja</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">

    <style>
        /* --- General Styles --- */
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-top: 20px;
            margin-bottom: 20px; /* Added margin-bottom for separation */
        }

        h2 {
            margin-top: 0; /* Reset margin-top, controlled by section padding */
            margin-bottom: 10px;
            color: #555;
        }

         h3 { /* Style for category headings in Manage Teams modal */
            margin-top: 15px;
            margin-bottom: 8px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
         }


        .add-button {
            display: block;
            margin: 20px auto;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #28a745;
            color: white;
            font-size: 2em;
            border: none;
            cursor: pointer;
            text-align: center;
            line-height: 50px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
            position: sticky;
            top: 20px;
            z-index: 10;
        }

        .add-button:hover {
            background-color: #218838;
        }

        .content-wrapper {
            display: flex;
            margin-top: 20px;
            padding: 0 20px;
        }

        .left-menu {
            width: 200px;
            margin-right: 20px;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 90px;
            align-self: flex-start;
            max-height: calc(100vh - 110px);
            overflow-y: auto;
        }

        .left-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .left-menu li {
            margin-bottom: 10px;
        }

        .left-menu a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
            display: block;
            padding: 5px 0;
            transition: color 0.3s ease;
        }

        .left-menu a:hover {
            color: #0056b3;
        }

        main {
            flex-grow: 1;
            padding: 0;
            box-shadow: none;
            background-color: transparent;
        }

        /* --- Section Block Style --- */
        .section-block {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px; /* Space below each block */
        }


        /* --- Table Styles --- */
        /* Styles for the table element itself, regardless of the wrapper */
        #categoryTable, .category-group-table, .group-clubs-table, #clubsTable, #createdTeamsTable {
            border-collapse: collapse;
            width: 100%;
            border: none;
            overflow: hidden;
        }


        /* Style for the section wrapping category heading and group table */
        .category-group-section {
            /* Inherits background, padding, radius, shadow from .section-block */
            /* Flex properties only for group sections when inside #groupsContent */
            min-width: 300px;
            flex-grow: 1;
            flex-basis: 0;
        }

        /* Style for the main container of group sections (the flex container) */
        #groupsContent {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
            padding: 0;
            margin-bottom: 20px;
        }
         #groupsContent .section-block {
             margin-bottom: 0; /* Override margin for flex items */
         }


        /* Remove margin-top from the first element inside a section block */
        .section-block h2:first-child,
        .section-block table:first-child {
            margin-top: 0;
        }

         /* Style for tables within the manage teams modal */
         #manageTeamsModal .group-clubs-table {
             margin-bottom: 15px; /* Space below each category table in the modal */
         }


        /* Table Header and Cell Styles - apply to all tables */
        #categoryTable th, #clubsTable th, .category-group-table th, .group-clubs-table th, #createdTeamsTable th {
            background-color: #f2f2f2;
            color: #333;
            font-weight: bold;
            text-align: left;
            padding: 12px 15px;
            border-bottom: 2px solid #ddd;
        }

        #categoryTable td, #clubsTable td, .category-group-table td, .group-clubs-table td, #createdTeamsTable td {
            text-align: left;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }

        /* Center align quantity cells in Created Teams table */
         #createdTeamsTable tbody td:not(:first-child):not(:last-child) {
              text-align: center;
         }


        /* Remove bottom border from last row in tbody for all tables */
        #categoryTable tbody tr:last-child td,
        #clubsTable tbody tr:last-child td,
        .category-group-table tbody tr:last-child td,
        .group-clubs-table tbody tr:last-child td,
        #createdTeamsTable tbody tr:last-child td {
             border-bottom: none;
        }

        /* Hover effect for all table rows */
        #categoryTable tbody tr:hover,
        #clubsTable tbody tr:hover,
        .category-group-table tbody tr:hover,
        .group-clubs-table tbody tr:hover,
        #createdTeamsTable tbody tr:hover {
            background-color: #f9f9f9;
            cursor: pointer;
        }

        /* Ensure last cell in row doesn't wrap buttons */
        #categoryTable td:last-child,
        #clubsTable td:last-child,
        .category-group-table td:last-child,
        .group-clubs-table td:last-child,
        #createdTeamsTable td:last-child,
         #manageTeamsModal .group-clubs-table td:last-child /* Also for tables in modal */
         {
             white-space: nowrap;
        }

        #clubsContent {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
            padding: 0;
            margin-bottom: 20px;
        }

        /* Style for container divs that wrap club sections when inside #clubsContent */
        #clubsContent .section-block {
            /* Inherits background, padding, radius, shadow from .section-block */
            min-width: 300px;
            flex-grow: 1;
            flex-basis: calc(33.33% - 20px);
            margin-bottom: 0; /* Override the default .section-block margin when inside flex */
        }

        #teamCreationContentSection table {
            /* Ensure table within section block takes full width */
             width: 100%;
        }


        /* --- Action Button Styles --- */
        .action-button {
            padding: 5px 10px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .action-button:not(.delete-button) {
            background-color: #007bff;
            color: white;
        }

        .action-button.delete-button {
            background-color: #dc3545;
            color: white;
        }

        .action-button:not(.delete-button):hover { background-color: #0056b3; }
        .action-button.delete-button:hover { background-color: #c82333; }


        /* --- Modal Styles --- */
         .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
         }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }

        .close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover, .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content form label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

         .modal-content form input[type="text"],
         .modal-content form input[type="number"],
         .modal-content form select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
         }
         /* Adjust select height for multiple */
         .modal-content form select[multiple] {
              min-height: 100px; /* Or adjust as needed */
         }


        .modal-content form button[type="submit"] { /* Target the submit button */
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

         .modal-content form button[type="submit"]:hover { /* Target the submit button */
            background-color: #218838;
         }

         /* Style for the container divs around specific form elements */
         .modal-content form div {
             margin-bottom: 20px; /* Add spacing below input groups */
         }
         .modal-content form div:last-of-type {
              margin-bottom: 0; /* Remove bottom margin for the last one before the button */
         }
          .modal-content form label,
          .modal-content form input[type="text"],
          .modal-content form input[type="number"],
          .modal-content form select {
              margin-bottom: 0; /* Remove margin from elements inside the div */
          }

          /* Optional CSS for dynamically added category/count pairs */
            .category-count-pair {
                border: 1px solid #eee;
                padding: 10px;
                margin-bottom: 15px; /* Space below each pair */
                border-radius: 5px;
                background-color: #f9f9f9;
            }

            .category-count-pair label {
                display: inline-block; /* Make labels inline */
                margin-bottom: 5px;
                margin-right: 10px; /* Space between label and input/select */
                font-weight: normal; /* Less bold than section titles */
                min-width: 80px; /* Align labels (adjust as needed) */
            }

            .category-count-pair select,
            .category-count-pair input[type="number"] {
                 display: inline-block; /* Make inputs/selects inline */
                 width: auto; /* Allow size based on content/min-width */
                 margin-bottom: 0; /* Remove bottom margin */
                 margin-right: 10px; /* Space between elements */
                 padding: 5px; /* Smaller padding */
            }

            /* Style for the remove button within the pair */
            .category-count-pair .action-button.delete-button {
                padding: 3px 8px; /* Smaller padding */
                font-size: 0.8em; /* Smaller font */
            }

            /* Adjust spacing within the container div */
            #teamCategoryCountContainer div {
                margin-bottom: 10px; /* Space between inner divs (label+element) */
            }

            /* Ensure remove button is not on a new line if space allows */
            .category-count-pair div:last-of-type { /* This targets the last div within a pairDiv */
                 margin-bottom: 0;
            }


    </style>
</head>
<body>
    <script>
        // Basic check for admin, redirect if not
        const userName = localStorage.getItem('username');
        if (userName !== 'admin') {
             window.location.href = 'login.html';
        }
    </script>

    <h1>Správca turnaja</h1>

    <button class="add-button" id="addButton" title="Pridať položku">+</button>

    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <span class="close category-modal-close">&times;</span>
            <h2 id="categoryModalTitle">Pridať kategóriu</h2>
            <form id="categoryForm">
                <div>
                    <label for="categoryName">Názov kategórie:</label>
                    <input type="text" id="categoryName" name="categoryName" required>
                </div>
                <button type="submit">Uložiť</button>
            </form>
        </div>
    </div>

     <div class="modal" id="groupModal">
         <div class="modal-content">
                 <span class="close group-modal-close">&times;</span>
                 <h2 id="groupModalTitle">Pridať skupinu</h2>
                 <form id="groupForm">
                     <div>
                          <label for="groupCategory">Kategória:</label>
                          <select id="groupCategory" name="groupCategory" required>
                               <option value="">-- Vyberte kategóriu --</option>
                               </select>
                     </div>

                     <div>
                          <label for="groupName">Názov skupiny:</label>
                          <input type="text" id="groupName" name="groupName" required>
                     </div>

                     <button type="submit">Uložiť</button>
                 </form>
         </div>
     </div>

    <div class="modal" id="clubModal">
         <div class="modal-content">
                 <span class="close club-modal-close">&times;</span>
                 <h2 id="clubModalTitle">Priradiť tím do skupiny</h2> <form id="clubForm">
                       <div id="unassignedClubSelectContainer">
                          <label for="unassignedClubSelect">Vyberte existujúci tím:</label>
                          <select id="unassignedClubSelect"> <option value="">-- Vyberte tím na priradenie --</option>
                               </select>
                      </div>

                      <div id="clubNameInputContainer">
                          <label for="clubName">Názov klubu:</label>
                          <input type="text" id="clubName" name="clubName" required>
                       </div>

                      <div>
                          <label for="clubCategory">Kategória:</label>
                          <select id="clubCategory" name="clubCategory" required>
                               <option value="">-- Vyberte kategóriu --</option>
                               </select>
                      </div>

                      <div> <label for="clubGroup">Skupina:</label>
                           <select id="clubGroup" name="clubGroup" required disabled> <option value="">-- Najprv vyberte kategóriu --</option>
                                </select>
                      </div>

                       <button type="submit">Uložiť</button>
                  </form>
         </div>
     </div>

    <div class="modal" id="teamCreationModal">
        <div class="modal-content">
            <span class="close team-creation-modal-close">&times;</span>
            <h2 id="teamCreationModalTitle">Vytvoriť tímy</h2>
            <form id="teamCreationForm">
                <div>
                    <label for="teamNameInput">Základný názov tímu:</label>
                    <input type="text" id="teamNameInput" name="teamName" required>
                </div>

                <div id="teamCategoryCountContainer">
                     </div>

                 <button type="button" id="addCategoryCountPairButton" class="action-button" style="margin-bottom: 15px;">Pridať ďalšiu kategóriu</button> <button type="submit">Vytvoriť tímy</button> </form>
        </div>
    </div>

    <div class="modal" id="manageTeamsModal">
        <div class="modal-content" style="max-width: 700px;"> <span class="close manage-teams-modal-close">&times;</span>
            <h2 id="manageTeamsModalTitle"><span id="baseTeamNameInModal"></span></h2>

            <div id="teamsListInModal">
                <p>Načítavam tímy...</p> </div>

            <div style="text-align: right; margin-top: 20px;">
                 <button class="action-button" onclick="closeManageTeamsModal()">Zatvoriť</button>
            </div>
        </div>
    </div>


    <div class="content-wrapper">
        <nav class="left-menu">
            <ul>
                <li><a href="#kategorie">Vytvorenie kategórií</a></li>
                <li><a href="#skupiny">Vytvorenie skupín</a></li>
                <li><a href="#vytvorenie-timov">Vytvorenie tímov</a></li>
                <li><a href="#timy-do-skupin">Tímy do skupín</a></li>
                <li><a href="#sportove-haly">Športové haly</a></li>
                <li><a href="#sprava-turnaja">Správa turnaja</a></li>
                <li><a href="#nastavenia">Nastavenia</a></li>
            </ul>
        </nav>

        <main>
            <div id="categoriesContentSection" class="section-block" style="display: none;">
                 <h2>Vytvorenie kategórií</h2>
                <table id="categoryTable">
                    <thead>
                        <tr>
                            <th>Názov</th>
                            <th style="width: 150px;">Upraviť</th>
                        </tr>
                    </thead>
                    <tbody id="categoryTableBody">
                        </tbody>
                </table>
            </div>

            <div id="groupsContent" style="display: none;">
                </div>

            <div id="clubsContent" style="display: none;">
                 </div>

             <div id="teamCreationContentSection" class="section-block" style="display: none;">
                 <h2>Vytvorenie tímov</h2>
                 <table id="createdTeamsTable">
                     <thead>
                         <tr id="createdTeamsTableHeader"> <th>Názov tímu</th>
                             <th style="width: 150px;">Upraviť</th>
                         </tr>
                     </thead>
                     <tbody id="createdTeamsTableBody">
                         </tbody>
                 </table>
            </div>

            </main>
    </div>


    <script type="module">
        // Import potrebných Firebase Firestore funkcií priamo z CDN
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, where, addDoc, updateDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';
        // Import FieldPath pre query podľa ID dokumentu v clubForm submit handleri
        import { FieldPath } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';


        // Tvoja Firebase konfigurácia
        const firebaseConfig = {
            apiKey: "AIzaSyD0h0rQZiIGi0-UDb4-YU_JihRGpIlfz40", // ZMEŇ ZA SVOJ SKUTOČNÝ API KĽÚČ
            authDomain: "turnaj-a28c5.firebaseapp.com", // ZMEŇ ZA SVOJ SKUTOČNÝ authDomain
            projectId: "turnaj-a28c5", // ZMEŇ ZA SVOJ SKUTOČNÝ projectId
            storageBucket: "turnaj-a28c5.firebasestorage.app", // ZMEŇ ZA SVOJ SKUTOČNÝ storageBucket
            messagingSenderId: "13732191148", // ZMEŇ ZA SVOJ SKUTOČNÝ messagingSenderId
            appId: "1:13732191148:web:5ad78eaef2ad452a10f809" // ZMEŇ ZA SVOJ SKUTOČNÝ appId
        };

        // Inicializácia Firebase aplikácie
        const app = initializeApp(firebaseConfig);
        // Získanie inštancie Firestore databázy
        const db = getFirestore(app);

        // Referencia na kolekcie
        const categoriesCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'categories');
        const groupsCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'groups'); // Groups use composite IDs
        const clubsCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'clubs'); // Clubs now use auto-generated IDs


        // Získame referencie na DOM elementy
        const addButton = document.getElementById('addButton');

        // Modál Kategórie
        const categoryModal = document.getElementById('categoryModal');
        const categoryModalCloseBtn = categoryModal.querySelector('.category-modal-close');
        const categoryForm = document.getElementById('categoryForm');
        const categoryNameInput = document.getElementById('categoryName');
        const categoryModalTitle = document.getElementById('categoryModalTitle');

        // Modál Skupiny
        const groupModal = document.getElementById('groupModal');
        const groupModalCloseBtn = groupModal.querySelector('.group-modal-close');
        const groupForm = document.getElementById('groupForm');
        const groupCategorySelect = document.getElementById('groupCategory');
        const groupNameInput = document.getElementById('groupName');
        const groupModalTitle = document.getElementById('groupModalTitle');
        const groupFormSubmitButton = groupForm.querySelector('button[type="submit"]');

        // Modál Kluby (pre priradenie do skupín / úpravu priradených)
        const clubModal = document.getElementById('clubModal');
        const clubModalCloseBtn = clubModal.querySelector('.club-modal-close');
        const clubForm = document.getElementById('clubForm');
        const clubNameInput = document.getElementById('clubName'); // Existing name input (used when editing assigned)
        const clubCategorySelect = document.getElementById('clubCategory');
        const clubGroupSelect = document.getElementById('clubGroup');
        const clubModalTitle = document.getElementById('clubModalTitle');
        const clubFormSubmitButton = clubForm.querySelector('button[type="submit"]');

        // REFERENCES FOR CLUB MODAL CHANGES (add/edit assigned)
        const unassignedClubSelectContainer = document.getElementById('unassignedClubSelectContainer');
        const unassignedClubSelect = document.getElementById('unassignedClubSelect');
        const clubNameInputContainer = document.getElementById('clubNameInputContainer');


        // Modál Vytvorenie Tímov
        const teamCreationModal = document.getElementById('teamCreationModal');
        const teamCreationModalCloseBtn = teamCreationModal.querySelector('.team-creation-modal-close');
        const teamCreationForm = document.getElementById('teamCreationForm');
        // Removed teamCategorySelect and teamCountInput as they are now dynamic
        const teamNameInput = document.getElementById('teamNameInput'); // Input for base team name
        // New references for dynamic elements container and add button
        const teamCategoryCountContainer = document.getElementById('teamCategoryCountContainer');
        const addCategoryCountPairButton = document.getElementById('addCategoryCountPairButton');


        // Nový Modal pre správu individuálnych tímov
        const manageTeamsModal = document.getElementById('manageTeamsModal');
        const manageTeamsModalCloseBtn = manageTeamsModal.querySelector('.manage-teams-modal-close');
        const baseTeamNameInModalSpan = document.getElementById('baseTeamNameInModal');
        const teamsListInModalDiv = document.getElementById('teamsListInModal');


        // Zobrazované sekcie (obalové divy)
        const categoriesContentSection = document.getElementById('categoriesContentSection'); // Obalový div pre kategórie
        const groupsContentDiv = document.getElementById('groupsContent'); // Flex kontajner pre skupiny
        const clubsContentDiv = document.getElementById('clubsContent'); // Flex kontajner pre kluby v skupinách (priradené)
        // Obalový div pre sekciu Vytvorenie Tímov (nepriradené)
        const teamCreationContentSection = document.getElementById('teamCreationContentSection');


        // Referencie na samotné tabuľky (pre manipuláciu s tbody)
        const categoryTable = document.getElementById('categoryTable');
        const categoryTableBody = document.getElementById('categoryTableBody');

        // Referencia na tbody tabuľky Vytvorenie Tímov
        const createdTeamsTableBody = document.getElementById('createdTeamsTableBody');
        // Referencia na hlavičku tabuľky Vytvorenie Tímov (pre dynamické stĺpce)
        const createdTeamsTableHeader = document.getElementById('createdTeamsTableHeader');


        // Premenné stavu modálov
        let currentCategoryModalMode = 'add';
        let editingCategoryName = null;

        let currentGroupModalMode = 'add';
        let editingGroupId = null; // Kompozitné ID upravovanej skupiny

        // Premenné stavu pre modál Kluby (Priradenie/Úprava)
        let currentClubModalMode = 'add-assign'; // Default mode: 'add-assign' or 'edit-assigned'
        let editingClubId = null; // Auto-generated ID of the club document being edited


        // Premenné stavu pre modál Vytvorenie Tímov (zatiaľ len 'add')
        let currentTeamCreationModalMode = 'add';


        // --- Funkcie pre Kategórie ---
        function addCategoryRowToTable(categoryName) {
             const tr = document.createElement('tr');
             const nameTd = document.createElement('td');
             nameTd.textContent = categoryName;
             const actionsTd = document.createElement('td');
             actionsTd.style.whiteSpace = 'nowrap';

             const renameButton = document.createElement('button');
             renameButton.textContent = 'Premenovať';
             renameButton.classList.add('action-button');
             renameButton.onclick = function() {
                 currentCategoryModalMode = 'edit';
                 editingCategoryName = categoryName;
                 categoryModalTitle.textContent = 'Premenovať kategóriu';
                 categoryNameInput.value = categoryName;
                 categoryModal.style.display = 'block';
                 categoryNameInput.focus();
             };


             const deleteButton = document.createElement('button');
             deleteButton.textContent = 'Vymazať';
             deleteButton.classList.add('action-button', 'delete-button');
             deleteButton.onclick = async function() {
                  const categoryToDelete = this.closest('tr').querySelector('td:first-child').textContent;

                  if (!confirm(`Naozaj chcete vymazať kategóriu "${categoryToDelete}"? Akékoľvek priradené skupiny a kluby prídu o svoju kategóriu (categoryId a groupId sa nastavia na null)!`)) {
                      return;
                  }

                  try {
                      // Pred zmazaním kategórie, nájdi a aktualizuj všetky kluby a skupiny, ktoré na ňu odkazujú
                      const batch = writeBatch(db);

                      // Nájdi a aktualizuj skupiny s touto kategóriou
                      const groupsQuery = query(groupsCollectionRef, where('categoryId', '==', categoryToDelete));
                      const groupsSnapshot = await getDocs(groupsQuery);

                       // Fetch clubs related to groups being deleted *before* starting the batch queries within the loop
                       const clubUpdates = [];
                       for (const groupDoc of groupsSnapshot.docs) {
                           const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', groupDoc.id));
                           const clubsSnapshot = await getDocs(clubsInGroupQuery);
                           clubsSnapshot.forEach(clubDoc => {
                                // Let's simplify: if category deleted, clubs lose both references.
                               clubUpdates.push({ ref: clubDoc.ref, updates: { categoryId: null, groupId: null } }); // Update club with null categoryId and null groupId
                                console.log(`Klub "${clubDoc.id}" odpriradený kvôli zmazaniu skupiny "${groupDoc.id}".`); // Clarified log
                           });
                            // Add group deletion to batch
                           batch.delete(groupDoc.ref); // Delete old group doc
                           console.log(`Stará skupina "${groupDoc.id}" zmazaná pri mazaní kategórie.`); // Clarified log
                       }

                       // Add club updates to batch
                       clubUpdates.forEach(item => {
                           batch.update(item.ref, item.updates);
                       });


                      // Nájdi a aktualizuj kluby s touto kategóriou, ktoré už nemusia byť priradené k skupine (groupId == null)
                      const unassignedClubsQuery = query(clubsCollectionRef, where('categoryId', '==', categoryToDelete), where('groupId', '==', null));
                       const unassignedClubsSnapshot = await getDocs(unassignedClubsQuery);
                       unassignedClubsSnapshot.forEach(doc => {
                           batch.update(doc.ref, { categoryId: null }); // Just update categoryId to null
                           console.log(`Nepriradený klub "${doc.id}" aktualizovaný (categoryId = null).`);
                       });


                      // Nakoniec zmaž samotnú kategóriu
                      batch.delete(doc(categoriesCollectionRef, categoryToDelete)); // Delete old category doc using old name

                      await batch.commit();

                      console.log(`Kategória "${categoryToDelete}" a súvisiace referencie boli úspešne zmazané/aktualizované.`);

                      // Refresh displays that might be affected
                       loadCategoriesTable(); // Always refresh category table
                       if (window.location.hash === '#skupiny') displayGroupsByCategory();
                       if (window.location.hash === '#timy-do-skupin') displayClubs();
                       if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();


                  } catch (error) {
                      console.error('Chyba pri mazaní kategórie a súvisiacich dát: ', error);
                      alert('Chyba pri mazaní kategórie! Prosím, skúste znova.');
                      // Close modal and reset state on error
                      categoryModal.style.display = 'none'; categoryForm.reset();
                      currentCategoryModalMode = 'add'; editingCategoryName = null;
                  }
             };

             actionsTd.appendChild(renameButton);
             actionsTd.appendChild(deleteButton);
             tr.appendChild(nameTd);
             tr.appendChild(actionsTd);
             categoryTableBody.appendChild(tr); // Append directly to tbody
         }

         async function loadCategoriesTable() {
             try {
                 categoryTableBody.innerHTML = ''; // Clear existing rows
                 const querySnapshot = await getDocs(categoriesCollectionRef);
                 if (querySnapshot.empty) {
                     console.log("Žiadne kategórie nenájdené.");
                     const noDataRow = document.createElement('tr');
                     const td = document.createElement('td');
                     td.colSpan = 2;
                     td.textContent = "Žiadne kategórie zatiaľ pridané.";
                     td.style.textAlign = 'center';
                     noDataRow.appendChild(td);
                     categoryTableBody.appendChild(noDataRow);
                 } else {
                     // Sort categories alphabetically by name (doc.id)
                     const sortedDocs = querySnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                     sortedDocs.forEach((doc) => {
                         const categoryName = doc.id;
                         addCategoryRowToTable(categoryName);
                     });
                     console.log(`Načítaných kategórií: ${sortedDocs.length}`);
                 }
             } catch (error) {
                 console.error('Chyba pri načítaní kategórií: ', error);
                 alert('Chyba pri načítaní kategórií!');
                  const errorRow = document.createElement('tr');
                  const td = document.createElement('td');
                  td.colSpan = 2;
                  td.textContent = "Chyba pri načítaní kategórií.";
                  td.style.textAlign = 'center';
                  errorRow.appendChild(td);
                  categoryTableBody.appendChild(errorRow);
             }
         }


         // --- Funkcie pre Skupiny (logika zápisu používa kompozitné ID) ---

         // Funkcia na načítanie kategórií a naplnenie <select>
         // Použiteľná pre groupModal, clubModal a teamCreationModal
         async function populateCategorySelect(selectElement, selectedCategoryId = null) {
              // Handle multiple select placeholder differently (Removed multiple select logic from here)
              selectElement.innerHTML = '<option value="">-- Vyberte kategóriu --</option>';


               selectElement.disabled = true; // Disable while loading


              try {
                  const querySnapshot = await getDocs(categoriesCollectionRef);
                  if (querySnapshot.empty) {
                      console.log("Žiadne kategórie pre naplnenie selectu.");
                      const option = document.createElement('option');
                      option.value = "";
                      option.textContent = "-- Žiadne kategórie --";
                      option.disabled = true;
                      selectElement.appendChild(option);
                       selectElement.disabled = false; // Re-enable even if empty, unless truly errored
                  } else {
                       selectElement.disabled = false; // Enable the select
                       // Sort categories alphabetically by name (doc.id)
                       const sortedDocs = querySnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                       sortedDocs.forEach((doc) => {
                            const categoryName = doc.id;
                            const option = document.createElement('option');
                            option.value = categoryName;
                            option.textContent = categoryName;
                            selectElement.appendChild(option);
                       });

                       // Select the provided category ID(s) (Simplified for single select)
                       if (selectedCategoryId) {
                            if (selectElement.querySelector(`option[value="${selectedCategoryId}"]`)) {
                                 selectElement.value = selectedCategoryId;
                            } else {
                                 console.warn(`Kategória "${selectedCategoryId}" pre zvolenú položku nenájdená v zozname kategórií.`);
                                 selectElement.value = ""; // Reset to default if selected category not found
                            }
                       }
                   }
               } catch (error) {
                   console.error('Chyba pri načítaní kategórií pre select: ', error);
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "Chyba pri načítaní kategórií";
                    option.disabled = true;
                    selectElement.appendChild(option);
                    selectElement.disabled = true; // Keep disabled on error
               }
            }

            // Funkcia na načítanie skupín pre danú kategóriu a naplnenie <select> (používa kompozitné ID)
            // Použiteľná pre clubModal
            async function populateGroupSelect(categoryId, selectElement, selectedGroupId = null) { // selectElement, selectedGroupId
                selectElement.innerHTML = '<option value="">-- Vyberte skupinu --</option>';
                selectElement.disabled = true; // Disable until category is selected or loading is complete


                if (!categoryId || categoryId === '-- Vyberte kategóriu --') { // Also check placeholder value
                    selectElement.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
                    selectElement.disabled = true;
                    return; // No category selected, cannot load groups
                }

                 selectElement.disabled = true; // Re-disable during loading

                try {
                    // Query groups that belong to the selected category
                    const q = query(groupsCollectionRef, where('categoryId', '==', categoryId));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        console.log(`Žiadne skupiny nájdené pre kategóriu "${categoryId}".`);
                        const option = document.createElement('option');
                        option.value = "";
                        option.textContent = "-- Žiadne skupiny v kategórii --";
                        option.disabled = true;
                        selectElement.appendChild(option);

                    } else {
                        console.log(`Načítané skupín pre kategóriu "${categoryId}".`);
                        // Sort groups alphabetically by name
                        const sortedDocs = querySnapshot.docs.sort((a, b) => (a.data().name || '').localeCompare(b.data().name || ''));

                        sortedDocs.forEach((doc) => {
                             const groupData = doc.data();
                             // The group ID is the composite ID "Category - Group Name"
                             const groupId = doc.id; // This is the composite ID
                             const groupName = groupData.name; // Get the actual group name field

                             const option = document.createElement('option');
                              // Use the composite ID as the option value
                             option.value = groupId;
                              // Display the group name
                             option.textContent = groupName;
                             selectElement.appendChild(option);
                          });

                           // Select the provided group ID if in edit mode and it exists
                           if (selectedGroupId) {
                                 if (selectElement.querySelector(`option[value="${selectedGroupId}"]`)) {
                                      selectElement.value = selectedGroupId;
                                 } else {
                                      console.warn(`Skupina "${selectedGroupId}" pre zvolenú položku nenájdená v zozname skupín pre túto kategóriu.`);
                                      selectElement.value = ""; // Reset to default if selected group not found
                                 }
                           }
                    }
                    selectElement.disabled = false; // Enable after loading (even if empty)

                } catch (error) {
                    console.error('Chyba pri načítaní skupín pre select: ', error);
                     selectElement.innerHTML = '<option value="">Chyba pri načítaní skupín</option>'; // Indicate error
                     selectElement.disabled = true; // Keep disabled on error
               }
            }


// Funkcia na otvorenie modálu skupiny (pre pridanie alebo úpravu)
 //groupId je kompozitné ID, groupData má name, categoryId
async function openGroupModal(groupId = null, groupData = null) {
     groupModal.style.display = 'block';

     // Resetuj stav modálu a formulár
     currentGroupModalMode = 'add';
     editingGroupId = null; // Vymaž ID upravovanej skupiny
     groupForm.reset(); // Vyčisti polia formulára
     groupNameInput.disabled = false; // Uisti sa, že vstup pre názov je povolený
     groupFormSubmitButton.textContent = 'Uložiť'; // Default button text


     // Naplň select kategórií pre modál skupiny
     groupCategorySelect.value = ""; // Resetuj výber kategórie


     if (groupId && groupData) {
         // Režim úpravy
         currentGroupModalMode = 'edit';
         editingGroupId = groupId; // Ulož kompozitné ID skupiny, ktorá sa upravuje
         groupModalTitle.textContent = 'Premenovať skupinu';
         groupFormSubmitButton.textContent = 'Uložiť zmeny';

         // Naplň select kategórií a potom nastav zvolenú hodnotu
         await populateCategorySelect(groupCategorySelect, groupData.categoryId); // Pass select element first

         // Vyplň polia formulára
         groupNameInput.value = groupData.name; // Použi pole 'name' z dát
         // Hodnota groupCategorySelect sa nastaví funkciou populateCategorySelect

     } else {
         // Režim pridania (počiatočný stav už nastavený vyššie)
         groupModalTitle.textContent = 'Pridať skupinu';

         await populateCategorySelect(groupCategorySelect, null); // Naplň select kategórií
     }

     groupNameInput.focus(); // Nastav focus na pole pre názov
    }


            // Funkcia na zobrazenie skupín usporiadaných podľa kategórií
            async function displayGroupsByCategory() {
                 groupsContentDiv.innerHTML = ''; // Clear container

                 try {
                    // 1. Načítať všetky kategórie
                    const categoriesSnapshot = await getDocs(categoriesCollectionRef);
                    // Sort categories by name (doc.id)
                    const sortedCategoriesDocs = categoriesSnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                    const categories = sortedCategoriesDocs.map(doc => doc.id);


                    if (categories.length === 0) {
                         const message = document.createElement('p');
                         message.textContent = "Pridajte kategórie v sekcii 'Kategórie' pre zobrazenie skupín.";
                         groupsContentDiv.appendChild(message);
                         return;
                    }

                    // 2. Načítať všetky skupiny
                    const groupsSnapshot = await getDocs(groupsCollectionRef);

                    // 3. Zoskupiť skupiny podľa categoryId
                    const groupsByCategory = {};
                    groupsSnapshot.forEach(doc => {
                         const groupData = doc.data();
                         const groupId = doc.id; // This je kompozitné ID
                         const categoryId = groupData.categoryId;

                         if (categoryId) {
                             if (!groupsByCategory[categoryId]) {
                                 // OPRAVENÉ: Inicializuj ako prázdne POLE
                                 groupsByCategory[categoryId] = [];
                             }
                             // Uložíme ID a dáta do poľa
                             groupsByCategory[categoryId].push({ id: groupId, data: groupData });
                         } else {
                             console.warn(`Skupina ${groupId} nemá priradenú categoryId.`);
                             // Optional: Handle groups without a category
                         }
                    });

                    // 4. Pre každú kategóriu vytvoriť sekciu (div) s nadpisom a tabuľkou so skupinami
                    categories.forEach(categoryName => {
                         const groupsForThisCategory = groupsByCategory[categoryName] || [];

                         // Použijeme triedu section-block pre konzistentný vzhľad
                         const categorySectionDiv = document.createElement('div');
                         categorySectionDiv.classList.add('category-group-section', 'section-block');

                         const categoryHeading = document.createElement('h2');
                         categoryHeading.textContent = `${categoryName}`;
                         categorySectionDiv.appendChild(categoryHeading);

                         const categoryGroupsTable = document.createElement('table');
                         categoryGroupsTable.classList.add('category-group-table');

                         const thead = document.createElement('thead');
                         const headerRow = document.createElement('tr');
                         const groupNameTh = document.createElement('th');
                         groupNameTh.textContent = 'Názov';
                         const actionsTh = document.createElement('th');
                         actionsTh.textContent = 'Upraviť'; // Changed to Akcie
                         actionsTh.style.width = '150px';

                         headerRow.appendChild(groupNameTh);
                         headerRow.appendChild(actionsTh);
                         thead.appendChild(headerRow);
                         categoryGroupsTable.appendChild(thead);

                         const tbody = document.createElement('tbody');

                         if (groupsForThisCategory.length === 0) {
                             const noGroupsRow = document.createElement('tr');
                             const td = document.createElement('td');
                             td.colSpan = 2;
                             td.textContent = `V kategórii "${categoryName}" zatiaľ nie sú žiadne skupiny.`;
                             td.style.textAlign = 'center';
                             noGroupsRow.appendChild(td);
                             tbody.appendChild(noGroupsRow);
                         } else {
                             // Sort groups by name before displaying
                             groupsForThisCategory.sort((a, b) => (a.data.name || '').localeCompare(b.data.name || ''));

                             groupsForThisCategory.forEach(group => {
                                  const groupRow = document.createElement('tr');
                                  const groupNameTd = document.createElement('td');
                                  groupNameTd.textContent = group.data.name; // Use the 'name' field for display


                                  const groupActionsTd = document.createElement('td');
                                  groupActionsTd.style.whiteSpace = 'nowrap';

                                  // TLAČIDLO ÚPRAVA SKUPINY - VOLÁ openGroupModal
                                   const editGroupButton = document.createElement('button');
                                   editGroupButton.textContent = 'Premenovať';
                                   editGroupButton.classList.add('action-button');
                                   editGroupButton.onclick = () => {
                                        openGroupModal(group.id, group.data); // Pass the composite group ID and its data
                                   };


                                  // TLAČIDLO VYMAZAŤ SKUPINU
                                   const deleteGroupButton = document.createElement('button'); // Corrected variable name
                                   deleteGroupButton.textContent = 'Vymazať';
                                   deleteGroupButton.classList.add('action-button', 'delete-button');
                                   deleteGroupButton.onclick = async () => {
                                        if (!confirm(`Naozaj chcete vymazať skupinu "${group.data.name}" z kategórie "${group.data.categoryId}"? Tímy priradené k tejto skupine prídu o priradenie (groupId sa nastaví na null)!`)) { // Updated warning
                                             return;
                                        }
                                        try {
                                             // Pred zmazaním skupiny nájdi všetky kluby, ktoré na ňu odkazujú a aktualizuj ich
                                             const batch = writeBatch(db);

                                             const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', group.id));
                                             const clubsSnapshot = await getDocs(clubsInGroupQuery); // Use await here
                                             clubsSnapshot.forEach(doc => {
                                                  batch.update(doc.ref, { groupId: null }); // Nastav groupId na null
                                                  console.log(`Klub "${doc.id}" odpriradený zo skupiny "${group.id}".`);
                                             });

                                             // Nakoniec zmaž samotnú skupinu
                                             batch.delete(doc(groupsCollectionRef, group.id));

                                             await batch.commit();

                                             console.log(`Skupina "${group.data.name}" (ID: ${group.id}) a súvisiace kluby boli úspešne zmazané/aktualizované.`);

                                             // Refresh displays that might be affected
                                             displayGroupsByCategory(); // Reload display
                                             if (window.location.hash === '#timy-do-skupin') displayClubs();
                                             if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();


                                         } catch (error) {
                                             console.error('Chyba pri mazaní skupiny a súvisiacich dát: ', error);
                                             alert('Chyba pri mazaní skupiny! Prosím, skúste znova.');
                                         }
                                    };

                                    groupActionsTd.appendChild(editGroupButton);
                                    groupActionsTd.appendChild(deleteGroupButton); // Corrected variable name

                                    groupRow.appendChild(groupNameTd);
                                    groupRow.appendChild(groupActionsTd);
                                    tbody.appendChild(groupRow);
                               });
                            }

                            categoryGroupsTable.appendChild(tbody);
                            categorySectionDiv.appendChild(categoryGroupsTable);
                            groupsContentDiv.appendChild(categorySectionDiv); // Append the section div to the main container
                        });


                     } catch (error) {
                         console.error('Chyba pri načítaní alebo zobrazovaní skupín: ', error);
                         const errorMessage = document.createElement('p');
                         errorMessage.textContent = 'Chyba pri načítaní dát skupín.';
                         groupsContentDiv.appendChild(errorMessage);
                     }
            }


            // --- Funkcie pre Kluby (Priradenie do skupín & Správa priradených) ---

            // Funkcia na načítanie nepriradených tímov a naplnenie selectu v modáli klubu
            async function populateUnassignedClubsSelect(selectElement, selectedClubId = null) {
                 selectElement.innerHTML = '<option value="">-- Vyberte tím na priradenie --</option>';
                 selectElement.disabled = true; // Disable until clubs are loaded


                 try {
                     // Query clubs where groupId is null (unassigned teams)
                     const q = query(clubsCollectionRef, where('groupId', '==', null));
                     const querySnapshot = await getDocs(q);

                     if (querySnapshot.empty) {
                         console.log("Žiadne nepriradené tímy na priradenie.");
                         const option = document.createElement('option');
                         option.value = "";
                         option.textContent = "-- Žiadne tímy na priradenie --";
                         option.disabled = true;
                         selectElement.appendChild(option);
                         selectElement.disabled = false; // Re-enable even if empty
                     } else {
                          selectElement.disabled = false; // Enable the select
                          // Sort unassigned teams alphabetically by name
                           const sortedDocs = querySnapshot.docs.sort((a, b) => (a.data().name || '').localeCompare(b.data().name || ''));

                           sortedDocs.forEach((doc) => {
                                const clubData = doc.data();
                                const clubId = doc.id; // Auto-generated ID

                                const option = document.createElement('option');
                                option.value = clubId; // Use the auto-generated ID as value
                                option.textContent = clubData.name; // Display the club name
                                selectElement.appendChild(option);
                           });

                           // Select the provided club ID if needed (e.g., if modal is reused for something like re-assigning)
                           if (selectedClubId) {
                                if (selectElement.querySelector(`option[value="${selectedClubId}"]`)) {
                                     selectElement.value = selectedClubId;
                                } else {
                                     console.warn(`Nepriradený tím s ID "${selectedClubId}" nenájdený.`);
                                     selectElement.value = ""; // Reset to default
                                }
                           }
                        }
                    } catch (error) {
                        console.error('Chyba pri načítaní nepriradených tímov pre select: ', error);
                        selectElement.innerHTML = '<option value="">Chyba pri načítaní tímov</option>'; // Indicate error
                        selectElement.disabled = true; // Keep disabled on error
                   }
                }


            // Funkcia na otvorenie modálu klubu (pre priradenie do skupiny ALEBO úpravu priradeného/nepriradeného)
            // clubId je auto-generované ID dokumentu
            async function openClubModal(clubId = null, clubData = null) { // clubId is auto-generated ID
                 clubModal.style.display = 'block';

                 // Reset form fields including the new select
                 clubForm.reset();
                 clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>'; // Clear groups
                 clubGroupSelect.disabled = true;
                 clubCategorySelect.value = ""; // Reset category select

                 // Reset visibility of name input vs select
                 unassignedClubSelectContainer.style.display = 'block'; // Default to showing select for add-assign
                 clubNameInputContainer.style.display = 'none';

                 // Reset group select visibility and disabled state
                 clubGroupSelect.parentElement.style.display = 'block'; // Default to showing group select
                 clubGroupSelect.disabled = true;


                 if (clubId && clubData) {
                    // Edit mode (Editing an ALREADY ASSIGNED club OR an UNASSIGNED club from Manage Modal)
                    currentClubModalMode = 'edit-assigned'; // Stále použijeme 'edit-assigned' režim
                    editingClubId = clubId; // Store the auto-generated ID of the club being edited
                     clubModalTitle.textContent = 'Upraviť tím'; // Zmeníme nadpis, je to všeobecnejšie pre editáciu
                    clubFormSubmitButton.textContent = 'Uložiť zmeny';

                    // Hide the unassigned clubs select, show the name input
                    unassignedClubSelectContainer.style.display = 'none';
                    clubNameInputContainer.style.display = 'block';
                    clubNameInput.readOnly = false; // Allow editing name

                    // Populate the category select and then set the value
                    await populateCategorySelect(clubCategorySelect, clubData.categoryId); // Pass select element first

                    // Check if the club is assigned or unassigned
                    if(clubData.groupId) { // If club has a groupId, it's assigned
                         // Show and populate the group select
                         clubGroupSelect.parentElement.style.display = 'block';
                         clubGroupSelect.disabled = false; // Enable group select for assigned teams
                         // Populate the group select based on the selected category and then set the group value
                         await populateGroupSelect(clubData.categoryId, clubGroupSelect, clubData.groupId);
                    } else { // If groupId is null, it's unassigned
                         // Hide and disable the group select
                         clubGroupSelect.parentElement.style.display = 'none';
                         clubGroupSelect.disabled = true;
                         clubGroupSelect.value = ''; // Clear any previous selection
                    }


                    // Fill the form fields
                    clubNameInput.value = clubData.name; // Use the 'name' field from data
                    // Category and Group selects are set by populate functions

                } else {
                    // Add mode (Assigning an UNASSIGNED club to a group)
                    currentClubModalMode = 'add-assign';
                    editingClubId = null; // No specific club ID selected yet via edit button
                    clubModalTitle.textContent = 'Priradiť tím do skupiny'; // Specific title
                    clubFormSubmitButton.textContent = 'Priradiť'; // Specific button text

                    // Show the unassigned clubs select, hide the name input
                    unassignedClubSelectContainer.style.display = 'block';
                    clubNameInputContainer.style.display = 'none';
                    clubNameInput.value = ''; // Clear the name input just in case

                     // Show and disable the group select initially
                     clubGroupSelect.parentElement.style.display = 'block';
                     clubGroupSelect.disabled = true; // Disable until category is chosen
                     clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>'; // Reset group options


                    // Populate the unassigned clubs select
                    await populateUnassignedClubsSelect(unassignedClubSelect, null); // Pass select element

                    // Populate the category select (no category pre-selected initially for assignment)
                    await populateCategorySelect(clubCategorySelect, null);
                }

                // Set focus based on mode
            // Použijeme setTimeout na malé oneskorenie A skontrolujeme viditeľnosť pred nastavením focusu
            if (currentClubModalMode === 'add-assign') {
                 setTimeout(() => {
                      // Skontrolujeme, či je kontajner výberového poľa viditeľný
                      if (unassignedClubSelectContainer.offsetParent !== null) {
                           unassignedClubSelect.focus();
                      } else {
                           console.warn("openClubModal: Nemôžem nastaviť focus na unassignedClubSelect, jeho kontajner nie je viditeľný.");
                           // Núdzové riešenie: nastavíme focus na tlačidlo zatvorenia modálu
                           clubModalCloseBtn.focus();
                      }
                 }, 50); // Oneskoríme focus o 50 milisekúnd
            } else { // edit-assigned
                 setTimeout(() => {
                      // Skontrolujeme, či je kontajner textového poľa viditeľný
                      if (clubNameInputContainer.offsetParent !== null) {
                           clubNameInput.focus();
                       } else {
                           console.warn("openClubModal: Nemôžem nastaviť focus na clubNameInput, jeho kontajner nie je viditeľný.");
                            // Núdzové riešenie: nastavíme focus na tlačidlo zatvorenia modálu
                           clubModalCloseBtn.focus();
                       }
                 }, 50); // Oneskoríme focus o 50 milisekúnd
            }
        }

            // Funkcia na zobrazenie klubov usporiadaných podľa kategórií a skupín (PRIRADENÉ tímy)
            // fetchuje kluby s groupId != null
            async function displayClubs() {
                clubsContentDiv.innerHTML = ''; // Vyčistiť kontajner

                try {
                    // Načítať všetky kluby, ktoré SÚ priradené do skupín (groupId != null)
                     const q = query(clubsCollectionRef, where('groupId', '!=', null));
                    const clubsSnapshot = await getDocs(q);

                    const clubs = clubsSnapshot.docs.map(clubDoc => ({ id: clubDoc.id, data: clubDoc.data() })); // Get club data with auto-generated ID

                    if (clubs.length === 0) {
                        console.log("Žiadne kluby priradené do skupín nenájdené.");
                        const message = document.createElement('p');
                        message.textContent = "Žiadne kluby zatiaľ neboli priradené do skupín.";
                        clubsContentDiv.appendChild(message); // Správu pridáme do kontajnera div
                        return;
                    }

                    // Zoskupenie klubov najprv podľa categoryId a potom podľa groupId
                    const clubsByCategoryAndGroup = {};
                    clubs.forEach(club => {
                        const categoryId = club.data.categoryId;
                        const groupId = club.data.groupId; // Toto je kompozitné ID skupiny (NázovKategórie - NázovSkupiny)

                        // Ensure categoryId and groupId exist for grouping
                         if (categoryId && groupId && categoryId !== 'null' && groupId !== 'null') { // Added check against 'null' strings
                             if (!clubsByCategoryAndGroup[categoryId]) {
                                 clubsByCategoryAndGroup[categoryId] = {};
                             }
                             if (!clubsByCategoryAndGroup[categoryId][groupId]) {
                                 clubsByCategoryAndGroup[categoryId][groupId] = [];
                             }
                              clubsByCategoryAndGroup[categoryId][groupId].push(club); // Uložíme celý objekt { id: auto-generated, data }
                         } else {
                             console.warn(`Klub ${club.id} priradený do skupiny (groupId != null) nemá platnú categoryId (${categoryId}) alebo groupId (${groupId}).`);
                         }
                    });

                    // Získaj zotriedené názvy kategórií
                    const sortedCategories = Object.keys(clubsByCategoryAndGroup).sort();

                     if (sortedCategories.length === 0 && clubs.length > 0) {
                         // This case happens if clubs exist but none have valid categoryId/groupId for grouping
                          console.warn("Kluby boli nájdené, ale žiadne nemajú platné categoryId/groupId na zobrazenie v skupinách.");
                          const message = document.createElement('p');
                          message.textContent = "Existujú kluby, ale žiadne nemajú priradenú kategóriu a skupinu pre zobrazenie tu.";
                          clubsContentDiv.appendChild(message);
                          return;
                     }


                    // Iteruj cez kategórie a skupiny, aby si vytvoril/a sekcie a tabuľky
                    sortedCategories.forEach(categoryId => {
                        // Získaj zotriedené kompozitné ID skupín v danej kategórii
                        const sortedGroups = Object.keys(clubsByCategoryAndGroup[categoryId]).sort();

                        sortedGroups.forEach(groupId => {
                            const clubsInThisGroup = clubsByCategoryAndGroup[categoryId][groupId];

                            // Vytvor section block pre túto kombináciu kategória-skupina
                            const groupClubSectionDiv = document.createElement('div');
                            groupClubSectionDiv.classList.add('section-block');

                            // Vytvor nadpis pre túto sekciu
                            const groupNameParts = groupId.split(' - ');
                            const groupName = groupNameParts.length > 1 ? groupNameParts.slice(1).join(' - ') : groupId;

                            const sectionHeading = document.createElement('h2');
                            sectionHeading.textContent = `${categoryId} - ${groupName}`;
                            groupClubSectionDiv.appendChild(sectionHeading);

                            // Vytvor tabuľku pre kluby v tejto skupine
                            const clubTable = document.createElement('table');
                            clubTable.classList.add('group-clubs-table');

                            // Vytvor hlavičku tabuľky
                            const thead = document.createElement('thead');
                            const headerRow = document.createElement('tr');
                            const clubNameTh = document.createElement('th');
                            clubNameTh.textContent = 'Názov klubu';
                             const actionsTh = document.createElement('th');
                             actionsTh.textContent = 'Upraviť';
                             actionsTh.style.width = '150px';

                             headerRow.appendChild(clubNameTh);
                             headerRow.appendChild(actionsTh);
                             thead.appendChild(headerRow);
                             clubTable.appendChild(thead);


                            // Vytvor telo tabuľky
                            const tbody = document.createElement('tbody');

                            if (clubsInThisGroup.length === 0) {
                                 const noClubsRow = document.createElement('tr');
                                 const td = document.createElement('td');
                                 td.colSpan = 2;
                                 td.textContent = `Žiadne kluby v tejto skupine.`;
                                 td.style.textAlign = 'center';
                                 tbody.appendChild(noClubsRow); // Corrected this line
                            } else {
                                 // Sort clubs by name before displaying
                                 clubsInThisGroup.sort((a, b) => (a.data.name || '').localeCompare(b.data.name || ''));

                                 // Pridaj riadky pre každý klub v tejto skupine
                                 clubsInThisGroup.forEach(club => {
                                     const tr = document.createElement('tr');

                                     const nameTd = document.createElement('td');
                                     nameTd.textContent = club.data.name; // Zobraz názov klubu z dát

                                     const actionsTd = document.createElement('td');
                                     actionsTd.style.whiteSpace = 'nowrap';

                                     // === TLAČIDLO ÚPRAVA KLUBU (ZMENIŤ SKUPINU/KATEGÓRIU/NÁZOV) ===
                                     // Otvorí clubModal v režime úpravy priradeného
                                      const editClubButton = document.createElement('button');
                                      editClubButton.textContent = 'Upraviť';
                                      editClubButton.classList.add('action-button');
                                      editClubButton.onclick = () => {
                                           // Open the club modal with the current club data for editing
                                          // Pass the auto-generated ID and data
                                           openClubModal(club.id, club.data);
                                       };


                                     // === TLAČIDLO VYMAZAŤ KLUBU (ZMAZAŤ ÚPLNE) ===
                                     // Mazanie klubu z tejto sekcie by malo asi znamenať úplné zmazanie dokumentu z Firestore.
                                      const deleteClubButton = document.createElement('button');
                                      deleteClubButton.textContent = 'Vymazať';
                                      deleteClubButton.classList.add('action-button', 'delete-button');
                                      deleteClubButton.onclick = async () => {
                                          if (!confirm(`Naozaj chcete vymazať klub "${club.data.name}" zo skupiny "${groupName}" v kategórii "${categoryId}"?`)) {
                                              return;
                                          }
                                          // Na zmazanie použi auto-generované ID klubu
                                          try {
                                               await deleteDoc(doc(clubsCollectionRef, club.id)); // Delete using the club's auto-generated ID
                                               console.log(`Klub "${club.data.name}" (ID: ${club.id}) bol úspešne zmazaný.`);
                                               displayClubs(); // Obnov zobrazenie klubov po zmazaní
                                                // Refresh created teams display if visible, as deleting an assigned team makes it disappear from both lists
                                                if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();

                                          } catch (error) {
                                               console.error('Chyba pri mazaní klubu: ', error);
                                               alert('Chyba pri mazaní klubu!');
                                          }
                                      };

                                       actionsTd.appendChild(editClubButton);
                                       actionsTd.appendChild(deleteClubButton); // Corrected variable name

                                      tr.appendChild(nameTd);
                                      tr.appendChild(actionsTd);

                                      tbody.appendChild(tr);
                                   });
                                }

                                clubTable.appendChild(tbody);
                                groupClubSectionDiv.appendChild(clubTable);
                                clubsContentDiv.appendChild(groupClubSectionDiv); // Pridaj sekciu do hlavného kontajnera klubov
                             });
                        });

                        console.log("Kluby priradené do skupín boli načítané a zobrazené.");

                   } catch (error) {
                       console.error('Chyba pri načítaní alebo zobrazovaní klubov: ', error);
                       const errorMessage = document.createElement('p');
                       errorMessage.textContent = 'Chyba pri načítaní dát klubov priradených do skupín.';
                       clubsContentDiv.appendChild(errorMessage);
                   }
            }

            // Funkcia na zobrazenie vytvorených tímov (klubov, ktoré ešte nie sú priradené do skupiny)
            async function displayCreatedTeams() {
                 createdTeamsTableBody.innerHTML = ''; // Clear existing rows
                 createdTeamsTableHeader.innerHTML = ''; // Clear existing header (except first and last columns)


                 try {
                     // 1. Načítať všetky kategórie pre dynamickú hlavičku
                     const categoriesSnapshot = await getDocs(categoriesCollectionRef);
                     const categories = categoriesSnapshot.docs.map(doc => doc.id).sort(); // Získaj a zotried názvy kategórií

                     // Vytvoriť prvý stĺpec hlavičky
                     const teamNameTh = document.createElement('th');
                     teamNameTh.textContent = 'Názov tímu';
                     createdTeamsTableHeader.appendChild(teamNameTh);

                     // Vytvoriť stĺpce hlavičky pre každú kategóriu
                     categories.forEach(categoryName => {
                         const categoryTh = document.createElement('th');
                         categoryTh.textContent = categoryName;
                         categoryTh.style.textAlign = 'center'; // Zarovnanie pre počty
                         createdTeamsTableHeader.appendChild(categoryTh);
                     });

                     // Vytvoriť posledný stĺpec hlavičky
                     const actionsTh = document.createElement('th');
                     actionsTh.textContent = 'Upraviť';
                     actionsTh.style.width = '150px';
                     createdTeamsTableHeader.appendChild(actionsTh);


                     // 2. Načítať všetky nepriradené tímy (groupId == null)
                     const q = query(clubsCollectionRef, where('groupId', '==', null));
                     const querySnapshot = await getDocs(q);

                     // 3. Zoskupiť tímy podľa základného názvu a spočítať pre kategórie
                     const teamsByBaseName = {};
                     querySnapshot.docs.forEach(doc => {
                         const clubData = doc.data();
                         const teamName = clubData.name || 'Neznámy názov';
                         const categoryId = clubData.categoryId || 'Nepriradená'; // Ak tím nemá kategóriu

                         // Zjednodušený základný názov tímu (napr. odstránenie písmen A, B, C...)
                         // Toto je kľúčový krok, ktorý závisí od konvencie pomenovania vašich tímov
                         // Príklad: Ak názov je "MŠK IUVENTA Michalovce A", základný názov by bol "MŠK IUVENTA Michalovce"
                         // Bude potrebné implementovať logiku na extrakciu základného názvu
                         // Tu je PREDPOKLAD, že tímy vytvorené funkciou teamCreationForm majú tvar "Zakladny Nazov X" kde X je písmeno.
                         // Ak máte inú konvenciu, túto logiku musíte prispôsobiť.
                         const baseNameMatch = teamName.match(/^(.*)\s[A-Z]$/);
                         const baseTeamName = baseNameMatch ? baseNameMatch[1] : teamName;


                         if (!teamsByBaseName[baseTeamName]) {
                             teamsByBaseName[baseTeamName] = {
                                 categories: {},
                                 originalTeams: [] // Uložíme originálne dokumenty pre akcie
                             };
                         }

                         if (!teamsByBaseName[baseTeamName].categories[categoryId]) {
                              teamsByBaseName[baseTeamName].categories[categoryId] = 0;
                         }
                         teamsByBaseName[baseTeamName].categories[categoryId]++;
                         teamsByBaseName[baseTeamName].originalTeams.push({ id: doc.id, data: clubData }); // Uložíme info o pôvodnom tíme
                     });

                      console.log("Zoskupené tímy:", teamsByBaseName);


                     // 4. Vygenerovať riadky tabuľky na základe zoskupených dát
                     const sortedBaseNames = Object.keys(teamsByBaseName).sort();

                     if (sortedBaseNames.length === 0) {
                         const noDataRow = document.createElement('tr');
                         const td = document.createElement('td');
                         td.colSpan = 2 + categories.length; // Názov + Počet kategórií + Akcie
                         td.textContent = "Žiadne tímy na priradenie zatiaľ pridané.";
                         td.style.textAlign = 'center';
                         noDataRow.appendChild(td);
                         createdTeamsTableBody.appendChild(noDataRow);
                     } else {
                         sortedBaseNames.forEach(baseTeamName => {
                             const teamSummary = teamsByBaseName[baseTeamName];
                             const tr = document.createElement('tr');

                             // Bunka pre názov tímu
                             const nameTd = document.createElement('td');
                             nameTd.textContent = baseTeamName; // Zobraz základný názov
                             tr.appendChild(nameTd);

                             // Bunky pre počty tímov v kategóriách
                             categories.forEach(categoryName => {
                                 const countTd = document.createElement('td');
                                 // Zobraz počet tímov pre túto kategóriu a tento základný názov
                                 const count = teamSummary.categories[categoryName] || 0;
                                 countTd.textContent = count > 0 ? count : '-'; // Zobraz '-' ak je počet 0
                                 countTd.style.textAlign = 'center'; // Zarovnanie pre počty
                                 tr.appendChild(countTd);
                             });

                             // Bunka pre akcie
                             const actionsTd = document.createElement('td');
                             actionsTd.style.whiteSpace = 'nowrap';

                             // === Akcie (Spravovať tímy / Vymazať VŠETKY) ===
                              const manageTeamsButton = document.createElement('button');
                              manageTeamsButton.textContent = 'Spravovať tímy';
                              manageTeamsButton.classList.add('action-button');
                              manageTeamsButton.onclick = () => {
                                  // Otvoriť nový modál a zobraziť v ňom individuálne tímy
                                  openManageTeamsModal(baseTeamName, teamSummary.originalTeams);
                              };
                              actionsTd.appendChild(manageTeamsButton);


                              // Tlačidlo na hromadné vymazanie všetkých tímov s týmto základným názvom
                              const deleteAllButton = document.createElement('button');
                              deleteAllButton.textContent = 'Vymazať';
                              deleteAllButton.classList.add('action-button', 'delete-button');
                              deleteAllButton.onclick = async () => {
                                  if (!confirm(`Naozaj chcete vymazať VŠETKY tímy s názvom "${baseTeamName}" (${teamSummary.originalTeams.length} ks)?`)) {
                                      return;
                                  }
                                  try {
                                       const batch = writeBatch(db);
                                       // Pre každý originálny tím dokument pod týmto základným názvom, pridaj operáciu mazania do batchu
                                       teamSummary.originalTeams.forEach(team => {
                                           batch.delete(doc(clubsCollectionRef, team.id)); // Použi auto-generované ID
                                       });

                                      await batch.commit();
                                      console.log(`Všetky tímy s názvom "${baseTeamName}" (${teamSummary.originalTeams.length} ks) boli úspešne zmazané.`);
                                      displayCreatedTeams(); // Refresh the list
                                       // Refresh clubs-in-groups display if visible (shouldn't affect it directly as these are unassigned)
                                      // if (window.location.hash === '#timy-do-skupin') { displayClubs(); }


                                  } catch (error) {
                                      console.error(`Chyba pri mazaní tímov s názvom "${baseTeamName}": `, error);
                                      alert('Chyba pri mazaní tímov!');
                                  }
                               };
                               actionsTd.appendChild(deleteAllButton);


                             tr.appendChild(actionsTd);
                             createdTeamsTableBody.appendChild(tr);
                         });
                     }

                     console.log(`Načítaných základných názvov tímov (na priradenie do skupín): ${sortedBaseNames.length}`);

                 } catch (error) {
                     console.error('Chyba pri načítaní alebo zobrazovaní vytvorených tímov: ', error);
                     const errorMessage = document.createElement('tr'); // Use tr to fit in table body
                     const td = document.createElement('td');
                     // Výpočet colspan: 1 (Názov tímu) + počet kategórií + 1 (Akcie)
                     td.colSpan = 2 + categories.length;
                     td.textContent = 'Chyba pri načítaní dát tímov.';
                     td.style.textAlign = 'center';
                     errorMessage.appendChild(td);
                     createdTeamsTableBody.appendChild(errorMessage);
                 }
            }

            // Funkcia na zatvorenie modálu pre správu individuálnych tímov
             function closeManageTeamsModal() {
                 manageTeamsModal.style.display = 'none';
                 teamsListInModalDiv.innerHTML = ''; // Vyčistiť obsah pri zatvorení
             }

            // Funkcia na otvorenie modálu a zobrazenie individuálnych tímov
            // baseTeamName: základný názov tímu (string)
            // individualTeams: pole objektov { id: teamId, data: teamData } pre tímy s týmto názvom
            async function openManageTeamsModal(baseTeamName, individualTeams) {
                 manageTeamsModal.style.display = 'block';
                 baseTeamNameInModalSpan.textContent = baseTeamName; // Nastav základný názov v nadpise modálu
                 teamsListInModalDiv.innerHTML = ''; // Vyčistiť pred naplnením

                 if (!individualTeams || individualTeams.length === 0) {
                     teamsListInModalDiv.innerHTML = '<p>Žiadne individuálne tímy nájdené pre tento názov.</p>';
                     return;
                 }

                 // Zoskupiť individuálne tímy podľa kategórie pre zobrazenie
                 const teamsByCategory = {};
                 individualTeams.forEach(team => {
                     const category = team.data.categoryId || 'Nepriradená';
                     if (!teamsByCategory[category]) {
                         teamsByCategory[category] = [];
                     }
                     teamsByCategory[category].push(team);
                 });

                 // Získaj zotriedené názvy kategórií
                 const sortedCategories = Object.keys(teamsByCategory).sort();

                 // Pre každú kategóriu vytvoriť menšiu tabuľku alebo zoznam v modáli
                 sortedCategories.forEach(categoryName => {
                     const teamsInThisCategory = teamsByCategory[categoryName];

                     const categoryHeading = document.createElement('h3');
                     categoryHeading.textContent = `${categoryName}`;
                     teamsListInModalDiv.appendChild(categoryHeading);

                     // Vytvoriť menšiu tabuľku pre tímy v tejto kategórii
                     const categoryTeamsTable = document.createElement('table');
                      // Môžete použiť existujúce štýly tabuliek alebo pridať nové
                     categoryTeamsTable.classList.add('group-clubs-table'); // Re-use class for basic styling


                     const thead = document.createElement('thead');
                     const headerRow = document.createElement('tr');
                     const teamNameTh = document.createElement('th');
                     teamNameTh.textContent = 'Názov tímu (celý)'; // Indicate it's the full name
                      const actionsTh = document.createElement('th');
                      actionsTh.textContent = 'Upraviť';
                      actionsTh.style.width = '150px';

                      headerRow.appendChild(teamNameTh);
                      headerRow.appendChild(actionsTh);
                      thead.appendChild(headerRow);
                      categoryTeamsTable.appendChild(thead);


                     const tbody = document.createElement('tbody');

                     // Zotriediť tímy v kategórii podľa názvu
                     teamsInThisCategory.sort((a, b) => (a.data.name || '').localeCompare(b.data.name || ''));


                     teamsInThisCategory.forEach(team => {
                         const tr = document.createElement('tr');

                         const nameTd = document.createElement('td');
                         nameTd.textContent = team.data.name || 'Neznámy názov';
                         tr.appendChild(nameTd);

                         const actionsTd = document.createElement('td');
                         actionsTd.style.whiteSpace = 'nowrap';


                         // === TLAČIDLO ÚPRAVA INDIVIDUÁLNEHO TÍMU ===
                          // Toto by malo otvoriť existujúci clubModal, ale v špecifickom režime
                          // pre úpravu NEPRIRADENÉHO tímu (zmeniť názov, prípadne kategóriu)
                         const editIndividualTeamButton = document.createElement('button');
                         editIndividualTeamButton.textContent = 'Upraviť';
                         editIndividualTeamButton.classList.add('action-button');
                         editIndividualTeamButton.onclick = () => {
                             // Pred otvorením clubModal musíme nastaviť jeho stav a dáta
                             // clubModal je primárne na priradzovanie do skupín/úpravu priradených.
                             // Potrebujeme režim úpravy nepriradeného tímu.
                             // Musíme si byť istí, že clubModal formulár a logika to zvládne.
                             console.log("Pokus o úpravu individuálneho tímu:", team);

                             // Zatvoriť manageTeamsModal pred otvorením clubModal
                             closeManageTeamsModal();

                             // Otvoríme existujúci clubModal s dátami tohto tímu
                             // Potrebujeme ho otvoriť v režime, kde sa nedá vybrať skupina, len zmeniť názov/kategória.
                             // Použijeme režim 'edit-assigned', ale prispôsobíme ho v openClubModal
                             openClubModal(team.id, team.data); // Zavoláme openClubModal s ID a dátami

                         };
                         actionsTd.appendChild(editIndividualTeamButton);


                         // === TLAČIDLO VYMAZAŤ INDIVIDUÁLNY TÍM ===
                         const deleteIndividualTeamButton = document.createElement('button');
                         deleteIndividualTeamButton.textContent = 'Vymazať';
                         deleteIndividualTeamButton.classList.add('action-button', 'delete-button');
                         deleteIndividualTeamButton.onclick = async () => {
                             if (!confirm(`Naozaj chcete vymazať tím "${team.data.name}" z kategórie "${categoryName}"?`)) {
                                 return;
                             }
                             try {
                                 // Na zmazanie použi auto-generované ID tohto konkrétneho tímu
                                 await deleteDoc(doc(clubsCollectionRef, team.id));
                                 console.log(`Individuálny tím "${team.data.name}" (ID: ${team.id}) úspešne zmazaný.`);

                                 // Po zmazaní refreshnúť ZOBRAZENIE v manageTeamsModal
                                 // a tiež zobrazenie v hlavnej sekcii #vytvorenie-timov
                                  // A simpler approach: close the modal and force refresh of the main #vytvorenie-timov list
                                  closeManageTeamsModal(); // Zatvor modál

                                 // Refresh the main 'Created Teams' section display
                                  if (window.location.hash === '#vytvorenie-timov') {
                                       displayCreatedTeams();
                                  }
                                   // Refresh clubs-in-groups display if visible (shouldn't affect it directly as these are unassigned)
                                  // if (window.location.hash === '#timy-do-skupin') { displayClubs(); }


                             } catch (error) {
                                 console.error(`Chyba pri mazaní individuálneho tímu "${team.data.name}" (ID: ${team.id}): `, error);
                                 alert('Chyba pri mazaní tímu!');
                             }
                         };
                         actionsTd.appendChild(deleteIndividualTeamButton);

                         tr.appendChild(actionsTd); // Add actions cell

                         tbody.appendChild(tr);
                     });

                     categoryTeamsTable.appendChild(tbody);
                     teamsListInModalDiv.appendChild(categoryTeamsTable);
                 });

                 // Môžete nastaviť focus na prvé tlačidlo alebo prvý input v modáli, ak je to potrebné
                 // manageTeamsModalCloseBtn.focus();
             }

             // --- Funkcia na dynamické pridanie dvojice select kategória + input počet tímov ---
             async function addCategoryCountPair(initialCategory = null) { // Optional: pre-select category if provided
                 const container = document.getElementById('teamCategoryCountContainer');

                 const pairDiv = document.createElement('div');
                 pairDiv.classList.add('category-count-pair'); // Optional class for styling


                 // Vytvorenie selectboxu pre kategóriu
                 const categorySelectLabel = document.createElement('label');
                 // Nemá for atribút, lebo sa dynamicky generuje pre každý select
                 categorySelectLabel.textContent = 'Kategória:'; // Zmenený text labelu
                 const categorySelect = document.createElement('select');
                 // Nemá ID, ale môžeme mu dať triedu na jednoduchšie nájdenie
                 categorySelect.classList.add('team-category-select-dynamic');
                 categorySelect.name = 'category'; // Použijeme generické meno pre zber dát

                 // Vytvorenie inputu pre počet tímov
                 const teamCountLabel = document.createElement('label');
                 // Nemá for atribút
                 teamCountLabel.textContent = 'Počet tímov:'; // Zmenený text labelu
                 const teamCountInput = document.createElement('input');
                 // Nemá ID, triedu pre jednoduchšie nájdenie
                 teamCountInput.classList.add('team-count-input-dynamic');
                 teamCountInput.type = 'number';
                 teamCountInput.name = 'count'; // Použijeme generické meno pre zber dát
                 teamCountInput.min = '1';
                 teamCountInput.value = '1'; // Default value


                 // Tlačidlo na odstránenie tejto dvojice
                 const removeButton = document.createElement('button');
                 removeButton.textContent = 'Odstrániť';
                 removeButton.classList.add('action-button', 'delete-button');
                 removeButton.type = 'button'; // Dôležité: aby sa nespustil submit formulára
                 removeButton.style.marginLeft = '10px'; // Add some spacing
                  removeButton.onclick = () => {
                      // Zmazať nadradený div obsahujúci select a input
                      pairDiv.remove();
                       // Voliteľne: skontrolovať, či zostala aspoň jedna dvojica
                       const remainingPairs = container.querySelectorAll('.category-count-pair');
                       if (remainingPairs.length === 0) {
                            // Ak nezostala žiadna, možno pridať prázdnu alebo zablokovať submit
                            // Pre tento príklad necháme prázdne, submit handler to ošetrí
                       }
                  };


                 // Poskladať elementy do divu
                 const selectContainer = document.createElement('div');
                 selectContainer.style.marginBottom = '10px'; // Spacing between select/input pairs
                 selectContainer.appendChild(categorySelectLabel);
                 selectContainer.appendChild(categorySelect);

                  const inputContainer = document.createElement('div');
                  inputContainer.style.marginBottom = '10px'; // Spacing below input
                 inputContainer.appendChild(teamCountLabel);
                 inputContainer.appendChild(teamCountInput);


                  pairDiv.appendChild(selectContainer);
                  pairDiv.appendChild(inputContainer);
                  pairDiv.appendChild(removeButton); // Pridaj tlačidlo na odstránenie

                 container.appendChild(pairDiv);

                 // Asynchrónne naplniť select kategórií
                 await populateCategorySelect(categorySelect, initialCategory); // Reuse populateCategorySelect
            }


            // Funkcia na otvorenie modálu Vytvorenie Tímov - PRESUNUTÁ PRED LISTENERY
            async function openTeamCreationModal() {
                 teamCreationModal.style.display = 'block';

                 // Resetuj stav modálu a formulár
                 currentTeamCreationModalMode = 'add'; // Zatiaľ len 'add'
                 teamCreationModalTitle.textContent = 'Vytvoriť tímy';
                 teamCreationForm.reset();

                 // Vyčisti kontajner dynamických polí a pridaj prvú dvojicu
                 teamCategoryCountContainer.innerHTML = '';
                 await addCategoryCountPair(); // Pridaj prvú dvojicu select + input


                 teamNameInput.focus(); // Nastav focus na názov tímu
            }


            // --- Funkcia na prepínanie zobrazenia obsahu ---

            function toggleContentDisplay() {
                 const hash = window.location.hash;
                 console.log("Navigating to hash:", hash);

                 // Skryť všetky dynamické oblasti a modály
                 addButton.style.display = 'none';
                 categoriesContentSection.style.display = 'none';
                 groupsContentDiv.style.display = 'none';
                 clubsContentDiv.style.display = 'none';
                 teamCreationContentSection.style.display = 'none';

                 categoryModal.style.display = 'none';
                 groupModal.style.display = 'none';
                 clubModal.style.display = 'none';
                 teamCreationModal.style.display = 'none';
                 manageTeamsModal.style.display = 'none'; // Skryť aj nový modál


                 // Vyčistiť obsah dynamických oblastí
                 categoryTableBody.innerHTML = '';
                 groupsContentDiv.innerHTML = '';
                 clubsContentDiv.innerHTML = '';
                 createdTeamsTableBody.innerHTML = '';
                 createdTeamsTableHeader.innerHTML = ''; // Clear header for dynamic generation
                 teamsListInModalDiv.innerHTML = ''; // Clear manage teams modal content
                 teamCategoryCountContainer.innerHTML = ''; // Clear dynamic team creation fields


                 // Reset modal states and forms when navigating away
                  currentCategoryModalMode = 'add'; editingCategoryName = null;
                  categoryForm.reset();

                  currentGroupModalMode = 'add'; editingGroupId = null;
                  groupForm.reset();

                  // Reset club modal state (add/edit assigned)
                  currentClubModalMode = 'add-assign'; editingClubId = null; // Reset to add-assign mode
                  clubForm.reset();
                  // Ensure the correct input/select is shown/hidden when modal opens next time
                  unassignedClubSelectContainer.style.display = 'block';
                  clubNameInputContainer.style.display = 'none';
                  // Reset group select visibility for club modal
                  clubGroupSelect.parentElement.style.display = 'block';


                  // Reset team creation modal state
                  currentTeamCreationModalMode = 'add';
                  teamCreationForm.reset();


                 if (hash === '#kategorie') {
                     addButton.style.display = 'block';
                     categoriesContentSection.style.display = 'block';
                     loadCategoriesTable();
                     addButton.title = "Pridať kategóriu";
                 } else if (hash === '#skupiny') {
                     addButton.style.display = 'block';
                     groupsContentDiv.style.display = 'flex';
                     displayGroupsByCategory();
                     addButton.title = "Pridať skupinu";
                 } else if (hash === '#vytvorenie-timov') {
                     addButton.style.display = 'block';
                     teamCreationContentSection.style.display = 'block';
                     displayCreatedTeams();
                     addButton.title = "Vytvoriť tímy";
                 }
                 else if (hash === '#timy-do-skupin') {
                     addButton.style.display = 'block';
                     clubsContentDiv.style.display = 'flex';
                     displayClubs(); // Load and display assigned clubs
                     // The '+' button in this section is for assigning an UNASSIGNED team
                     addButton.title = "Priradiť tím do skupiny";
                 }
                 // Add cases for other sections if needed (#sportove-haly, #sprava-turnaja, #nastavenia)
                 // else if (hash === '#sportove-haly') { ... }
                 // else if (hash === '#sprava-turnaja') { ... }
                 // else if (hash === '#nastavenia') { ... }
                 else {
                     // Default or unimplemented sections
                     addButton.style.display = 'none';
                     addButton.title = "Pridať položku"; // Default title
                     console.log("Neznáma alebo neimplementovaná sekcia, zobrazujem prázdny obsah.");
                 }
            }


            // --- Event Listeners ---

            // Spoločná obsluha kliknutia na tlačidlo Pridať (+)
            addButton.addEventListener('click', () => {
                const hash = window.location.hash;
                if (hash === '#kategorie') {
                     // Open category modal in add mode
                     currentCategoryModalMode = 'add';
                     editingCategoryName = null;
                     categoryModalTitle.textContent = 'Pridať kategóriu';
                     categoryForm.reset();
                     categoryModal.style.display = 'block';
                     categoryNameInput.focus();
                } else if (hash === '#skupiny') {
                     // Open group modal in add mode
                     openGroupModal(); // Call openGroupModal without arguments for add mode
                } else if (hash === '#vytvorenie-timov') {
                     // Open team creation modal
                     openTeamCreationModal(); // Call the updated function
                }
                else if (hash === '#timy-do-skupin') {
                     // Open club modal in add-assign mode (to assign an unassigned team)
                     openClubModal(); // Call openClubModal without arguments for add-assign mode
                }
            });


            // Obsluha zatvorenia modálov (kliknutie na X)
            categoryModalCloseBtn.addEventListener('click', () => {
                 categoryModal.style.display = 'none';
                 currentCategoryModalMode = 'add'; editingCategoryName = null;
                 categoryForm.reset();
            });

            groupModalCloseBtn.addEventListener('click', () => {
                 groupModal.style.display = 'none';
                 currentGroupModalMode = 'add'; editingGroupId = null;
                 groupForm.reset();
            });

             clubModalCloseBtn.addEventListener('click', () => { // Club Modal Close
                 clubModal.style.display = 'none';
                 currentClubModalMode = 'add-assign'; editingClubId = null; // Reset club modal state
                 clubForm.reset();
                  // Reset visibility of name input vs select
                  unassignedClubSelectContainer.style.display = 'block';
                  clubNameInputContainer.style.display = 'none';
                   // Reset group select visibility for club modal
                  clubGroupSelect.parentElement.style.display = 'block';
             });

             // Team Creation Modal Close
             teamCreationModalCloseBtn.addEventListener('click', () => {
                 teamCreationModal.style.display = 'none';
                 currentTeamCreationModalMode = 'add';
                 teamCreationForm.reset();
                 teamCategoryCountContainer.innerHTML = ''; // Clear dynamic fields on close
                  // Optional: add back an initial empty pair for next open
                  // addCategoryCountPair(); // If you want one pair ready on open
             });

            // Nový Modal pre správu individuálnych tímov - Zatvorenie na X
            manageTeamsModalCloseBtn.addEventListener('click', closeManageTeamsModal);


            // Obsluha zatvorenia modálov (kliknutie mimo modal)
            window.addEventListener('click', (e) => {
                if (e.target === categoryModal) {
                     categoryModal.style.display = 'none';
                     currentCategoryModalMode = 'add'; editingCategoryName = null;
                     categoryForm.reset();
                }
                if (e.target === groupModal) {
                     groupModal.style.display = 'none';
                     currentGroupModalMode = 'add'; editingGroupId = null;
                     groupForm.reset();
                }
                 if (e.target === clubModal) { // Club Modal Close
                     clubModal.style.display = 'none';
                     currentClubModalMode = 'add-assign'; editingClubId = null; // Reset club modal state
                     clubForm.reset();
                      // Reset visibility of name input vs select
                     unassignedClubSelectContainer.style.display = 'block';
                     clubNameInputContainer.style.display = 'none';
                      // Reset group select visibility for club modal
                     clubGroupSelect.parentElement.style.display = 'block';
                 }
                 // Team Creation Modal Close
                 if (e.target === teamCreationModal) {
                     teamCreationModal.style.display = 'none';
                     currentTeamCreationModalMode = 'add';
                     teamCreationForm.reset();
                      teamCategoryCountContainer.innerHTML = ''; // Clear dynamic fields on close
                      // Optional: add back an initial empty pair for next open
                      // addCategoryCountPair(); // If you want one pair ready on open
                 }
                 // Nový Modal pre správu individuálnych tímov - Zatvorenie kliknutím mimo
                 if (e.target === manageTeamsModal) {
                      closeManageTeamsModal();
                 }
            });


            // Spustíme toggleContentDisplay pri načítaní stránky a zmene hašu
            window.addEventListener('hashchange', toggleContentDisplay);
            window.addEventListener('load', () => {
                 // Set initial hash if none is present, e.g., to #kategorie
                 if (!window.location.hash || window.location.hash === '#') { // Also handle empty hash
                      window.location.hash = '#kategorie';
                 } else {
                     // If hash is present, call toggleContentDisplay
                     toggleContentDisplay();
                 }
            });


            // Obsluha formulára na pridanie/úpravu kategórie
            categoryForm.addEventListener('submit', async (e) => {
                 e.preventDefault();
                 const categoryName = categoryNameInput.value.trim();
                 if (categoryName === '') { alert('Názov kategórie nemôže byť prázdny.'); return; }

                 if (currentCategoryModalMode === 'add') {
                      const categoryDocRef = doc(categoriesCollectionRef, categoryName);
                      try {
                           const existingDoc = await getDoc(categoryDocRef);
                           if (existingDoc.exists()) { alert(`Kategória "${categoryName}" už existuje!`); return; }
                           await setDoc(categoryDocRef, { /* optional data like createdAt: new Date() */ });
                           console.log(`Kategória "${categoryName}" bola úspešne pridaná.`);
                           categoryModal.style.display = 'none'; categoryForm.reset();
                           currentCategoryModalMode = 'add'; editingCategoryName = null;
                           // Refresh displays that might be affected
                           loadCategoriesTable(); // Always refresh category table
                           if (window.location.hash === '#skupiny') displayGroupsByCategory();
                           if (window.location.hash === '#timy-do-skupin') displayClubs();
                           if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();

                      } catch (error) {
                           console.error('Chyba pri pridávaní kategórie: ', error);
                           alert('Chyba pri pridávaní kategórie!');
                           // Close modal and reset state on error
                           categoryModal.style.display = 'none'; categoryForm.reset();
                           currentCategoryModalMode = 'add'; editingCategoryName = null;
                      }
                 } else if (currentCategoryModalMode === 'edit') {
                      const oldCategoryName = editingCategoryName;
                      const newCategoryName = categoryName;
                      if (!oldCategoryName) { console.error("Chyba: Chýba pôvodný názov kategórie."); alert("Chyba pri úprave kategórie."); categoryModal.style.display = 'none'; categoryForm.reset(); currentCategoryModalMode = 'add'; editingCategoryName = null; return; }
                      if (newCategoryName === oldCategoryName) { console.log("Názov kategórie sa nezmenil."); categoryModal.style.display = 'none'; categoryForm.reset(); return; }

                      const newCategoryDocRef = doc(categoriesCollectionRef, newCategoryName);
                      try {
                           const existingDoc = await getDoc(newCategoryDocRef);
                           if (existingDoc.exists()) { alert(`Kategória s názvom "${newCategoryName}" už existuje!`); return; }

                           const oldCategoryDocRef = doc(categoriesCollectionRef, oldCategoryName);
                           const oldDocSnapshot = await getDoc(oldCategoryDocRef);
                           if (!oldDocSnapshot.exists()) { console.error(`Chyba: Pôvodný dokument kategórie ${oldCategoryName} nenájdený.`); alert("Pôvodná kategória na úpravu nebola nájdená."); categoryModal.style.display = 'none'; categoryForm.reset(); currentCategoryModalMode = 'add'; editingCategoryName = null; loadCategoriesTable(); return; }
                           const oldDocData = oldDocSnapshot.data();

                           const batch = writeBatch(db);
                           batch.set(newCategoryDocRef, oldDocData); // Create new doc with new ID
                           // Note: We delete the old doc after processing references to ensure it exists during lookups

                           // UPDATE REFERENCES IN GROUPS AND CLUBS
                           // Groups first
                           const groupsQuery = query(groupsCollectionRef, where('categoryId', '==', oldCategoryName));
                           const groupsSnapshot = await getDocs(groupsQuery);

                       // Fetch clubs related to groups being deleted *before* starting the batch queries within the loop
                       const clubUpdates = [];
                       for (const groupDoc of groupsSnapshot.docs) {
                           const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', groupDoc.id));
                           const clubsSnapshot = await getDocs(clubsInGroupQuery);
                           clubsSnapshot.forEach(clubDoc => {
                                // Use the new composite group ID for the update
                               const oldGroupId = groupDoc.id; // e.g., "OldCategory - GroupA"
                               const groupData = groupDoc.data(); // Get group data to reconstruct the name part
                               const newGroupId = `${newCategoryName} - ${groupData.name}`; // Construct new group ID using new category name and old group name

                               clubUpdates.push({ ref: clubDoc.ref, updates: { categoryId: newCategoryName, groupId: newGroupId } }); // Update club with new categoryId and new groupId
                                console.log(`Klub "${clubDoc.id}" aktualizovaný (categoryId, groupId) kvôli zmene kategórie skupiny.`);
                           });
                            // Add group deletion to batch
                           batch.delete(groupDoc.ref); // Delete old group doc
                           console.log(`Stará skupina "${groupDoc.id}" zmazaná po premenovaní kategórie.`); // Clarified log
                       }

                       // Add club updates to batch
                       clubUpdates.forEach(item => {
                           batch.update(item.ref, item.updates);
                       });


                      // Nájdi a aktualizuj kluby s touto kategóriou, ktoré už nemusia byť priradené k skupine (groupId == null)
                      const unassignedClubsQuery = query(clubsCollectionRef, where('categoryId', '==', oldCategoryName), where('groupId', '==', null));
                       const unassignedClubsSnapshot = await getDocs(unassignedClubsQuery);
                       unassignedClubsSnapshot.forEach(doc => {
                           batch.update(doc.ref, { categoryId: newCategoryName }); // Just update categoryId to new name
                           console.log(`Nepriradený klub "${doc.id}" aktualizovaný (categoryId).`);
                       });


                      // Nakoniec zmaž samotnú pôvodnú kategóriu
                      batch.delete(oldCategoryDocRef); // Delete old category doc using old name


                      await batch.commit();

                      console.log(`Premenovanie kategórie "${oldCategoryName}" na "${newCategoryName}" a aktualizácia referencií bolo úspešné.`);

                      currentCategoryModalMode = 'add'; editingCategoryName = null;
                      categoryModal.style.display = 'none'; categoryForm.reset();

                      // Refresh displays that might be affected
                      loadCategoriesTable();
                      if (window.location.hash === '#skupiny') displayGroupsByCategory();
                      if (window.location.hash === '#timy-do-skupin') displayClubs();
                      if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();


                      } catch (error) {
                           console.error('Chyba pri premenovaní kategórie a aktualizácii referencií: ', error);
                           alert('Chyba pri premenovaní kategórie! Prosím, skúste znova.');
                           // Reset state and close modal on error
                           currentCategoryModalMode = 'add'; editingCategoryName = null;
                           categoryModal.style.display = 'none'; categoryForm.reset();
                      }
                 }
            });


             // --- Obsluha formulára Skupiny (používa kompozitné ID) ---
              groupForm.addEventListener('submit', async (e) => {
                  e.preventDefault();
                  const selectedCategoryId = groupCategorySelect.value;
                  const groupName = groupNameInput.value.trim();

                  if (selectedCategoryId === '' || selectedCategoryId === '-- Vyberte kategóriu --' || groupCategorySelect.disabled) { alert('Prosím, vyberte platnú kategóriu pre skupinu.'); return; }
                  if (groupName === '') { alert('Názov skupiny nemôže byť prázdny.'); return; }

                  const compositeGroupId = `${selectedCategoryId} - ${groupName}`;
                  const groupDocRef = doc(groupsCollectionRef, compositeGroupId);

                  try {
                      const existingDoc = await getDoc(groupDocRef);

                      if (currentGroupModalMode === 'add') {
                          // === LOGIKA PRIDÁVANIA SKUPINY ===
                          if (existingDoc.exists()) {
                               alert(`Skupina s názvom "${groupName}" už v kategórii "${selectedCategoryId}" existuje! Názvy skupín musia byť unikátne v rámci kategórie.`);
                               return;
                          }
                          await setDoc(groupDocRef, { name: groupName, categoryId: selectedCategoryId });
                          console.log(`Skupina "${groupName}" (ID: ${compositeGroupId}) bola úspešne pridaná do kategórie "${selectedCategoryId}".`);

                      } else if (currentGroupModalMode === 'edit') {
                          // === LOGIKA ÚPRAVY SKUPINY (PREMENOVANIE / ZMENA KATEGÓRIE) ===
                          const oldGroupId = editingGroupId;
                          if (!oldGroupId) { console.error("Chyba: Režim úpravy skupiny bez platného editingGroupId."); alert("Chyba pri úprave skupiny. Prosím, obnovte stránku."); groupModal.style.display = 'none'; groupForm.reset(); currentGroupModalMode = 'add'; editingGroupId = null; return; }

                          const oldGroupDocRef = doc(groupsCollectionRef, oldGroupId);
                          const oldDocSnapshot = await getDoc(oldGroupDocRef);
                          if (!oldDocSnapshot.exists()) { console.error(`Chyba: Pôvodný dokument skupiny ${oldGroupId} nenájdený.`); alert("Pôvodná skupina na úpravu nebola nájdená."); groupModal.style.display = 'none'; groupForm.reset(); currentGroupModalMode = 'add'; editingGroupId = null; displayGroupsByCategory(); return; }
                          const oldGroupData = oldDocSnapshot.data();


                          // Check if the composite ID has changed (name or category)
                          if (oldGroupId !== compositeGroupId) {
                               console.log(`Premenovanie/presun skupiny z "${oldGroupId}" na "${compositeGroupId}".`);
                               // Check if the NEW composite ID already exists (another group with this name/category)
                               if (existingDoc.exists()) {
                                  alert(`Skupina s názvom "${groupName}" už v kategórii "${selectedCategoryId}" existuje (iná skupina)! Názvy skupín musia byť unikátne v rámci kategórie.`);
                                  return;
                               }
                               // If ID changes, we need to delete the old document and create a new one
                               const batch = writeBatch(db);
                               // Use the current data from the form for the new document
                               batch.set(groupDocRef, { name: groupName, categoryId: selectedCategoryId }); // Create new group doc with new ID
                               // Note: Delete the old doc after processing references
                               // batch.delete(oldGroupDocRef); // This will be done after club updates below

                               // Update clubs that referenced the OLD group ID
                               const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', oldGroupId));
                               const clubsSnapshot = await getDocs(clubsInGroupQuery); // Use await here
                               clubsSnapshot.forEach(clubDoc => {
                                    // Update the club's groupId to the new composite ID
                                    batch.update(clubDoc.ref, { groupId: compositeGroupId, categoryId: selectedCategoryId }); // Ensure categoryId is also updated on club
                                    console.log(`Klub "${clubDoc.id}" aktualizovaný (groupId, categoryId) kvôli zmene skupiny.`);
                               });

                                // Now delete the old group document
                                batch.delete(oldGroupDocRef);


                               await batch.commit();

                               console.log(`Skupina úspešne premenovaná/presunutá z ID "${oldGroupId}" na "${compositeGroupId}" a súvisiace kluby aktualizované.`);

                           } else {
                               // If the composite ID hasn't changed, just update the existing document
                               console.log(`Úprava údajov pre skupinu s ID "${oldGroupId}". Kompozitné ID sa nemení.`);
                               // Use updateDoc on the document with the current ID
                               await updateDoc(groupDocRef, {
                                   name: groupName,
                                   categoryId: selectedCategoryId
                               });
                               console.log(`Skupina s ID "${oldGroupId}" úspešne upravená.`);
                           }
                      }

                      // --- Common logic after successful add or edit ---
                      groupModal.style.display = 'none'; groupForm.reset();
                      currentGroupModalMode = 'add'; editingGroupId = null;

                      // Refresh displays that might be affected
                      if (window.location.hash === '#skupiny') displayGroupsByCategory();
                      if (window.location.hash === '#timy-do-skupin') displayClubs();
                      if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();


                   } catch (error) {
                       console.error('Chyba pri ukladaní skupiny: ', error);
                       alert(`Chyba pri ukladaní skupiny! Detail: ${error.message}`);
                        // Reset state and close modal on error
                       groupModal.style.display = 'none';
                       groupForm.reset();
                       currentGroupModalMode = 'add'; editingGroupId = null;
                    }
               });

            // --- Obsluha formulára Kluby (Priradenie do skupín & Úprava priradených/nepriradených) ---
             clubForm.addEventListener('submit', async (e) => {
                 e.preventDefault();

                 const selectedCategoryId = clubCategorySelect.value;
                 // Get the selected group ID only if the group select is NOT disabled
                 const selectedGroupId = !clubGroupSelect.disabled ? clubGroupSelect.value : null;


                 // Validate selects based on mode and visibility
                 if (clubCategorySelect.disabled === false && (selectedCategoryId === '' || selectedCategoryId === '-- Vyberte kategóriu --')) {
                     alert('Prosím, vyberte platnú kategóriu.');
                     return;
                 }
                  // Validate group selection only if the group select is visible and enabled
                 if (clubGroupSelect.parentElement.style.display !== 'none' && clubGroupSelect.disabled === false && (selectedGroupId === '' || selectedGroupId === '-- Vyberte skupinu --' || selectedGroupId === '-- Žiadne skupiny v kategórii --')) {
                      alert('Prosím, vyberte platnú skupinu.');
                      return;
                  }


                 try {
                     if (currentClubModalMode === 'add-assign') {
                         // === LOGIKA PRIRADENIA TÍMU DO SKUPINY ===
                         const selectedUnassignedClubId = unassignedClubSelect.value;

                         // Validate the selected unassigned club
                         if (unassignedClubSelectContainer.style.display !== 'none' && selectedUnassignedClubId === '') { // Only validate if the select je viditeľný
                             alert('Prosím, vyberte tím na priradenie.');
                             return;
                         }
                          // We also need a valid group selected for assignment
                          if (!selectedGroupId) {
                               alert('Pre priradenie tímu je potrebné vybrať kategóriu aj skupinu.');
                               return; // Should not happen if previous group select validation works, but double-check
                          }


                         // Fetch the selected unassigned club document to confirm it exists and is unassigned
                         const clubRefToAssign = doc(clubsCollectionRef, selectedUnassignedClubId);
                         const clubDocToAssign = await getDoc(clubRefToAssign);

                         if (!clubDocToAssign.exists()) {
                             alert('Vybraný tím nebol nájdený alebo už bol priradený/zmazaný.');
                             // Refresh the unassigned list and close modal
                             populateUnassignedClubsSelect(unassignedClubSelect, null);
                             clubModal.style.display = 'none';
                             clubForm.reset();
                              // Reset visibility
                             unassignedClubSelectContainer.style.display = 'block';
                             clubNameInputContainer.style.display = 'none';
                             clubGroupSelect.parentElement.style.display = 'block'; // Reset group visibility
                             return;
                         }

                         const clubDataToAssign = clubDocToAssign.data();
                         if (clubDataToAssign.groupId !== null) {
                             alert(`Tím "${clubDataToAssign.name}" je už priradený do skupiny "${clubDataToAssign.groupId}".`);
                             // Refresh the unassigned list and close modal
                             populateUnassignedClubsSelect(unassignedClubSelect, null);
                             clubModal.style.display = 'none';
                             clubForm.reset();
                              // Reset visibility
                             unassignedClubSelectContainer.style.display = 'block';
                             clubNameInputContainer.style.display = 'none';
                             clubGroupSelect.parentElement.style.display = 'block'; // Reset group visibility
                             return;
                         }

                         // Check if a club with the exact same name already exists IN THIS TARGET GROUP
                         const existingClubInGroupQuery = query(clubsCollectionRef,
                              where('groupId', '==', selectedGroupId),
                              where('name', '==', clubDataToAssign.name)
                         );
                         const existingClubInGroupSnapshot = await getDocs(existingClubInGroupQuery);
                         if (!existingClubInGroupSnapshot.empty) {
                             alert(`Tím s názvom "${clubDataToAssign.name}" už v skupine "${selectedGroupId}" existuje!`);
                             return;
                         }


                         // Update the existing unassigned club document to assign it to the group
                         await updateDoc(clubRefToAssign, {
                             categoryId: selectedCategoryId, // Update categoryId based on selected group's category
                             groupId: selectedGroupId, // Store the composite group ID
                             // Keep the original name
                         });

                         console.log(`Tím "${clubDataToAssign.name}" (ID: ${selectedUnassignedClubId}) úspešne priradený do skupiny "${selectedGroupId}".`);
                         alert(`Tím "${clubDataToAssign.name}" úspešne priradený.`);

                         // --- Common logic after successful add/assign ---
                         clubModal.style.display = 'none';
                         clubForm.reset();
                         currentClubModalMode = 'add-assign'; // Reset state to add-assign
                         editingClubId = null; // Clear editing ID

                         // Reset visibility of name input vs select for next time
                          unassignedClubSelectContainer.style.display = 'block';
                          clubNameInputContainer.style.display = 'none';
                          // Reset group select visibility for club modal
                          clubGroupSelect.parentElement.style.display = 'block';

    
                         // Refresh displays that might be affected
                         // Refresh main 'Created Teams' display because an unassigned team was edited (name/category)
                          if (window.location.hash === '#vytvorenie-timov') {
                               displayCreatedTeams(); // Obnoviť zoznam vytvorených tímov
                          }
                         // Refresh clubs-in-groups display if visible, as an assigned team was edited/assigned
                          if (window.location.hash === '#timy-do-skupin') {
                               displayClubs(); // Refresh assigned clubs display
                          }

                     } else if (currentClubModalMode === 'edit-assigned') {
                         // === LOGIKA ÚPRAVY PRIRADENÉHO ALEBO NEPRIRADENÉHO KLUBU ===
                         // editingClubId holds the auto-generated ID of the club being edited
                         const clubIdToEdit = editingClubId;
                         const updatedClubName = clubNameInput.value.trim(); // Get the potentially updated name

                         if (!clubIdToEdit) {
                              console.error("Chyba: Režim úpravy priradeného klubu bez platného editingClubId.");
                              alert("Chyba pri úprave klubu. Prosím, obnovte stránku.");
                              clubModal.style.display = 'none'; clubForm.reset(); currentClubModalMode = 'add-assign'; editingClubId = null;
                               // Reset visibility
                              unassignedClubSelectContainer.style.display = 'block';
                              clubNameInputContainer.style.display = 'none';
                              clubGroupSelect.parentElement.style.display = 'block'; // Reset group visibility
                              return;
                         }
                         if (updatedClubName === '') {
                              alert('Názov klubu nemôže byť prázdny.');
                              return;
                         }

                         const clubRefToEdit = doc(clubsCollectionRef, clubIdToEdit);
                         const clubDocToEdit = await getDoc(clubRefToEdit);
                         if (!clubDocToEdit.exists()) {
                             console.error(`Chyba: Dokument klubu ${clubIdToEdit} nenájdený na úpravu.`);
                             alert("Klub na úpravu nebol nájdený.");
                             clubModal.style.display = 'none'; clubForm.reset(); currentClubModalMode = 'add-assign'; editingClubId = null;
                             displayClubs(); // Refresh display as the club je preč
                             return;
                         }
                         const originalClubData = clubDocToEdit.data(); // Get original data


                         // === Podmienená kontrola duplicitného názvu ===
                          // Kontrolujeme, ak sa klub priradzuje do skupiny (mal null groupId, teraz má value)
                          // ALEBO ak mení skupinu (mal groupId, mení sa na iné groupId)
                          // ALEBO ak zostáva v tej istej skupine A mení sa jeho názov
                          // ALEBO ak zostáva nepriradený (groupId je a zostáva null) A mení sa jeho názov
                          const targetGroupIdForCheck = selectedGroupId; // This is the new groupId (could be null)
                          const originalGroupId = originalClubData.groupId;

                          // Only perform duplication check if:
                          // 1. The targetGroupId is NOT null (it's being assigned or moved to a group)
                          // 2. OR the targetGroupId IS null (remains unassigned) but the name has changed.

                           if (targetGroupIdForCheck !== null) { // Checking against a specific group
                               // Check if a different club with the same updated name already exists IN THE TARGET GROUP
                               const existingClubInTargetGroupQuery = query(clubsCollectionRef,
                                    where('groupId', '==', targetGroupIdForCheck), // Cieľová skupina
                                    where('name', '==', updatedClubName),     // Nový názov
                                    where(FieldPath.documentId(), '!=', clubIdToEdit) // Vylúčime aktuálny dokument
                               );
                               const existingClubInTargetGroupSnapshot = await getDocs(existingClubInTargetGroupQuery);
                               if (!existingClubInTargetGroupSnapshot.empty) {
                                    alert(`Klub s názvom "${updatedClubName}" už v cieľovej skupine "${targetGroupIdForCheck}" existuje! Prosím, zvoľte iný názov alebo skupinu.`);
                                    return;
                               }
                           } else if (updatedClubName !== originalClubData.name) { // Remains unassigned, only name changed
                                // Optional: Check if another UNASSIGNED club with the same new name exists
                                // This might not be strictly necessary depending on desired uniqueness constraints.
                                // If needed, uncomment and adjust the query:
                                /*
                                const existingUnassignedClubQuery = query(clubsCollectionRef,
                                     where('groupId', '==', null),
                                     where('name', '==', updatedClubName),
                                     where(FieldPath.documentId(), '!=', clubIdToEdit)
                                );
                                const existingUnassignedClubSnapshot = await getDocs(existingUnassignedClubQuery);
                                if (!existingUnassignedClubSnapshot.empty) {
                                    alert(`Iný nepriradený klub s názvom "${updatedClubName}" už existuje!`);
                                    return;
                                }
                                */
                           }


                         // Update the assigned/unassigned club document
                         await updateDoc(clubRefToEdit, {
                              name: updatedClubName, // Update name
                             categoryId: selectedCategoryId, // Allow changing category even for unassigned
                             groupId: selectedGroupId, // This will be null if the group select was hidden/disabled
                             // Update other fields if they were in the form
                         });

                         console.log(`Klub "${updatedClubName}" (ID: ${clubIdToEdit}) úspešne upravený.`);
                         alert(`Klub úspešne upravený.`);

                     }

                     // --- Common logic after successful add/assign or edit ---
                     clubModal.style.display = 'none';
                     clubForm.reset();
                     currentClubModalMode = 'add-assign'; // Reset state to add-assign
                     editingClubId = null; // Clear editing ID

                     // Reset visibility of name input vs select for next time
                      unassignedClubSelectContainer.style.display = 'block';
                      clubNameInputContainer.style.display = 'none';
                      // Reset group select visibility for club modal
                      clubGroupSelect.parentElement.style.display = 'block';


                     // Refresh displays that might be affected
                     // Refresh main 'Created Teams' display because an unassigned team was edited (name/category)
                      if (window.location.hash === '#vytvorenie-timov') {
                           displayCreatedTeams(); // Refresh main list
                      }
                     // Refresh clubs-in-groups display if visible, as an assigned team was edited/assigned
                      if (window.location.hash === '#timy-do-skupin') {
                           displayClubs(); // Refresh assigned clubs display
                      }


                 } catch (error) {
                     console.error('Chyba pri ukladaní alebo priradzovaní klubu: ', error);
                     alert(`Chyba pri ukladaní alebo priradzovaní klubu! Detail: ${error.message}`);
                      // Zatvor modál a resetuj stav pri chybe
                      clubModal.style.display = 'none';
                      clubForm.reset();
                      currentClubModalMode = 'add-assign'; editingClubId = null;
                       // Reset visibility of name input vs select on error
                      unassignedClubSelectContainer.style.display = 'block';
                      clubNameInputContainer.style.display = 'none';
                       // Reset group select visibility for club modal on error
                      clubGroupSelect.parentElement.style.display = 'block';
                 }
             });


            // --- Event Listener pre zmenu kategórie v modáli klubu (pre priradenie do skupiny) ---
             clubCategorySelect.addEventListener('change', async () => { // Made async to use await for populateGroupSelect
                 const selectedCategoryId = clubCategorySelect.value;
                 // Populate the group select based on the newly selected category
                  // Only populate if in add-assign mode or if group select is currently visible (editing an assigned club)
                  if (currentClubModalMode === 'add-assign' || clubGroupSelect.parentElement.style.display !== 'none') {
                       await populateGroupSelect(selectedCategoryId, clubGroupSelect); // Pass category ID and select element
                  } else {
                       // If in edit-assigned mode and group select is hidden (editing unassigned)
                       // Changing category doesn't affect group select visibility/options
                  }
             });

             // Event listener for change in the unassigned club select (in clubModal) - handles category/group selects update
             unassignedClubSelect.addEventListener('change', async () => {
                  const selectedClubId = unassignedClubSelect.value;
                  // When an unassigned club is selected in add-assign mode, populate the category select with its category
                  // and then populate the group select.
                  if (currentClubModalMode === 'add-assign' && selectedClubId) {
                       try {
                           const clubDoc = await getDoc(doc(clubsCollectionRef, selectedClubId));
                           if (clubDoc.exists()) {
                               const clubData = clubDoc.data();
                               await populateCategorySelect(clubCategorySelect, clubData.categoryId); // Populate and select category
                               // Populate group select based on the selected category
                               // No selected group initially for assignment, so selectedGroupId is null
                               await populateGroupSelect(clubData.categoryId, clubGroupSelect, null); // Pass category ID and select element
                           } else {
                               console.warn(`Vybraný nepriradený tím ${selectedClubId} už neexistuje.`);
                               // Reset selects if the selected team is no longer found
                               unassignedClubSelect.value = "";
                               clubCategorySelect.value = "";
                               clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
                               clubGroupSelect.disabled = true;
                           }
                       } catch (error) {
                           console.error('Chyba pri načítaní detailov vybraného nepriradeného tímu:', error);
                           alert('Chyba pri načítaní detailov tímu.');
                           unassignedClubSelect.value = "";
                           clubCategorySelect.value = "";
                           clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
                           clubGroupSelect.disabled = true;
                       }
                  } else if (currentClubModalMode === 'add-assign' && !selectedClubId) {
                       // No team selected in unassigned select (back to placeholder), reset category and group selects
                       clubCategorySelect.value = "";
                       clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
                       clubGroupSelect.disabled = true;
                  }
                   // If not in add-assign mode, this listener should not trigger changes
             });


            // --- Obsluha formulára Vytvorenie Tímov - UPRAVENÉ PRE VIAC KATEGÓRIÍ S POČTOM ---
            teamCreationForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const teamNameBase = teamNameInput.value.trim();
                if (teamNameBase === '') {
                    alert('Základný názov tímu nemôže byť prázdny.');
                    return;
                }

                // Získať všetky dynamicky pridané dvojice kategória + počet
                const categoryCountPairs = teamCategoryCountContainer.querySelectorAll('.category-count-pair');

                if (categoryCountPairs.length === 0) {
                    alert('Pridajte aspoň jednu kategóriu a počet tímov.');
                    return;
                }

                // Zbieranie dát a validácia pre každú dvojicu
                const teamsToCreate = []; // Pole pre uchovanie { categoryId, count } pre každú platnú dvojicu
                const seenCategories = new Set(); // Na kontrolu duplicitných kategórií

                for (const pairDiv of categoryCountPairs) {
                     const categorySelect = pairDiv.querySelector('.team-category-select-dynamic');
                     const teamCountInput = pairDiv.querySelector('.team-count-input-dynamic');

                     const categoryId = categorySelect.value;
                     const teamCount = parseInt(teamCountInput.value, 10);

                     // Validácia dvojice
                     if (categoryId === '' || categorySelect.disabled) {
                         alert('Prosím, vyberte kategóriu pre každý riadok.');
                         // Môžete voliteľne pridať označenie chybného riadku
                         return; // Zastaviť spracovanie pri prvej chybe
                     }
                      if (isNaN(teamCount) || teamCount < 1) {
                         alert('Počet tímov musí byť platné číslo väčšie ako 0 pre každú kategóriu.');
                         // Môžete voliteľne pridať označenie chybného riadku
                         return; // Zastaviť spracovanie pri prvej chybe
                      }
                      // Kontrola duplicitnej kategórie v rámci formulára
                       if (seenCategories.has(categoryId)) {
                           alert(`Kategória "${categoryId}" bola vybraná viackrát. Pre každú kategóriu môžete zadať iba jeden počet.`);
                            // Môžete voliteľne pridať označenie chybného riadku
                           return; // Zastaviť spracovanie pri prvej chybe
                       }
                       seenCategories.add(categoryId);

                      // Kontrola, či počet tímov neprekročí počet písmen abecedy (A-Z)
                       if (teamCount > 26) {
                            alert(`Pre kategóriu "${categoryId}": Pre abecedné označenie je možné vytvoriť maximálne 26 tímov naraz (A-Z).`);
                             // Môžete voliteľne pridať označenie chybného riadku
                            return; // Zastaviť spracovanie pri prvej chybe
                       }


                     // Ak je dvojica platná, pridaj ju do zoznamu na vytvorenie
                     teamsToCreate.push({ categoryId: categoryId, count: teamCount });
                }

                console.log("Plánované vytvorenie tímov:", teamNameBase, teamsToCreate);


                try {
                    // Use a batch write for multiple documents for efficiency
                    const batch = writeBatch(db);
                    let successfullyAddedCount = 0; // Counter for successful additions


                    // Iterovať cez plánované tímy na vytvorenie ({ categoryId, count })
                    for (const teamPlan of teamsToCreate) {
                         const categoryId = teamPlan.categoryId;
                         const teamCount = teamPlan.count;

                         // Pre každú kategóriu a počet, vytvoriť špecifikovaný počet tímov
                         for (let i = 1; i <= teamCount; i++) {
                              // Použiť písmená A, B, C... pre názvy tímov, ak počet > 1
                              let teamName;
                              if (teamCount > 1) {
                                   const letter = String.fromCharCode(65 + (i - 1));
                                   teamName = `${teamNameBase} ${letter}`;
                              } else {
                                   teamName = teamNameBase; // Ak je počet 1, názov je len základný názov
                              }

                              // Vytvoriť nový dokument tímu s auto-generovaným ID
                              const newTeamRef = doc(clubsCollectionRef);
                              batch.set(newTeamRef, {
                                  name: teamName,
                                  categoryId: categoryId, // Použiť categoryId z aktuálneho plánu
                                  groupId: null // Pôvodne nepriradený
                                  // voliteľné polia
                              });
                              successfullyAddedCount++; // Inkremetovať počítadlo
                         }
                    }


                    await batch.commit(); // Odoslať batch operácie

                     console.log(`Úspešne vytvorených ${successfullyAddedCount} tím(ov) v ${teamsToCreate.length} kategóri(ách).`);
                     alert(`Úspešne vytvorených ${successfullyAddedCount} tím(ov).`);


                    // --- Spoločná logika po úspešnom vytvorení ---
                    teamCreationModal.style.display = 'none';
                    teamCreationForm.reset();
                    // Vyčistiť dynamické polia po úspechu
                    teamCategoryCountContainer.innerHTML = '';
                     // Pridať späť prvú prázdnu dvojicu pre ďalšie otvorenie modálu
                     await addCategoryCountPair();


                    // Obnoviť zobrazenia, ktoré môžu byť ovplyvnené
                    if (window.location.hash === '#vytvorenie-timov') {
                         displayCreatedTeams(); // Obnoviť zoznam vytvorených tímov
                    }
                     // Zobrazenie priradených klubov (timy-do-skupin) sa nemení, lebo boli vytvorené nepriradené tímy
                     // if (window.location.hash === '#timy-do-skupin') { displayClubs(); }


                } catch (error) {
                    console.error('Chyba pri vytváraní tímov: ', error);
                    alert(`Chyba pri vytváraní tímov! Detail: ${error.message}`);
                     // Close modal and reset state on error (nemusíme čistiť dynamické polia, aby užívateľ videl, čo zadal)
                     teamCreationModal.style.display = 'none';
                     teamCreationForm.reset(); // Vyčistí aspoň základný názov
                     // Nečistíme teamCategoryCountContainer, aby užívateľ videl, čo zadal
                }
            });

             // Event listener pre tlačidlo "Pridať ďalšiu kategóriu" - PRIDANÝ KDE SÚ OSTATNÉ LISTENERY
            addCategoryCountPairButton.addEventListener('click', async () => {
                 await addCategoryCountPair(); // Volaj funkciu na pridanie ďalšej dvojice
            });


    </script>

</body>
</html>
