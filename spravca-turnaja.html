<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Správca turnaja</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">

    <style>
        /* --- General Styles --- */
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-top: 20px;
            margin-bottom: 20px; /* Added margin-bottom for separation */
        }

        h2 {
            margin-top: 0; /* Reset margin-top, controlled by section padding */
            margin-bottom: 10px;
            color: #555;
        }

         h3 { /* Style for category headings in Manage Teams modal */
            margin-top: 15px;
            margin-bottom: 8px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
         }


        .add-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 30px;
            line-height: 60px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 100; /* Ensure button is above other content */
        }

        .container {
            display: flex;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            min-height: calc(100vh - 40px); /* Adjusted to account for h1 margin */
        }

        .sidebar {
            width: 250px;
            background-color: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #e9ecef;
        }

        .sidebar nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar nav ul li {
            margin-bottom: 10px;
        }

        .sidebar nav ul li a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
            display: block;
            padding: 8px 10px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .sidebar nav ul li a:hover {
            background-color: #e9ecef;
        }

        .sidebar nav ul li a.active {
             background-color: #007bff;
             color: white;
        }

        .content {
            flex-grow: 1;
            padding: 20px;
        }

        /* --- Table Styles --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        /* --- Modal Styles --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 500px; /* Max width for smaller modals */
            border-radius: 8px;
            position: relative; /* Needed for the close button positioning */
        }

        /* Adjust max-width for the manage teams modal */
        .modal-content[style*="max-width: 700px"] {
             max-width: 700px;
        }


        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* --- Form Styles --- */
        form {
            margin-top: 15px; /* Add space above the form */
        }

        form div {
            margin-bottom: 15px; /* Space between form groups */
        }

        label {
            display: block; /* Label on its own line */
            margin-bottom: 5px; /* Space between label and input */
            font-weight: bold;
            color: #555;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: calc(100% - 22px); /* Full width minus padding and border */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }

        button[type="submit"],
        button[type="button"] {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button[type="submit"]:hover,
        button[type="button"]:hover {
            background-color: #0056b3;
        }

        button[type="button"].close-button { /* Style for modal close buttons if used inside form */
             background-color: #6c757d;
             margin-left: 10px; /* Space between submit and close buttons */
        }

        button[type="button"].close-button:hover {
             background-color: #545b62;
        }


        /* Specific style for the remove button in addCategoryCountPair */
         .remove-category-pair-button {
            background-color: #dc3545;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-left: 10px; /* Space from the input/select */
         }

        .remove-category-pair-button:hover {
            background-color: #c82333;
        }

        /* Style for container holding category/count pairs */
        .category-count-pair {
            display: flex;
            align-items: center;
            margin-bottom: 10px; /* Space between pairs */
        }

        .category-count-pair select,
        .category-count-pair input[type="number"] {
             width: auto; /* Allow elements to size based on content */
             flex-grow: 1; /* Allow inputs/selects to take available space */
             margin-right: 10px; /* Space between select/input */
        }

        .category-count-pair input[type="number"] {
            max-width: 80px; /* Limit width for count input */
        }


        /* Validation message style */
         .validation-message {
             color: #dc3545; /* Red color for errors */
             font-size: 0.85rem;
             margin-top: 5px;
             display: block; /* Ensure it's on a new line */
         }


         /* Manage Teams Modal Specific Styles */
        .team-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }

        .team-list-item:last-child {
            border-bottom: none;
        }

        .team-list-item span {
            flex-grow: 1;
            margin-right: 10px;
        }

        .team-list-item button {
            padding: 4px 8px;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        .team-list-item button.edit-team-button {
             background-color: #ffc107;
             color: #212529;
        }

        .team-list-item button.edit-team-button:hover {
             background-color: #e0a800;
        }


        .team-list-item button.unassign-team-button {
            background-color: #dc3545;
            color: white;
        }

         .team-list-item button.unassign-team-button:hover {
             background-color: #c82333;
        }

         .manage-teams-form-actions {
             margin-top: 20px;
             text-align: right; /* Align buttons to the right */
         }

         .manage-teams-form-actions button[type="button"].close-button {
              /* Use already defined style */
         }


         /* Style for the drag handle */
         .drag-handle {
            cursor: grab;
            margin-right: 10px;
            font-size: 1.2em;
            color: #888;
         }

         .drag-handle:active {
            cursor: grabbing;
         }

         /* Style for items being dragged */
        .dragging {
            opacity: 0.5;
        }

        /* Style for the drag over area */
        .drag-over {
            border-top: 2px dashed #007bff;
        }


        /* Message area for displaying status or errors */
        .message-area {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            display: none; /* Hidden by default */
        }

        .message-area.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message-area.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }


    </style>
</head>
<body>

    <h1>Správca turnaja</h1>

    <button class="add-button" id="addButton">+</button>

    <div class="container">
        <aside class="sidebar">
            <nav>
                <ul>
                    <li><a href="#kategorie" id="nav-kategorie">Vytvorenie kategórií</a></li>
                    <li><a href="#skupiny" id="nav-skupiny">Vytvorenie skupín</a></li>
                    <li><a href="#zoznam-timov" id="nav-zoznam-timov">Zoznam tímov</a></li>
                    <li><a href="#timy-do-skupin" id="nav-timy-do-skupin">Tímy do skupín</a></li>
                     <li><a href="#sportove-haly" id="nav-sportove-haly">Športové haly</a></li>
                      <li><a href="#sprava-turnaja" id="nav-sprava-turnaja">Správa turnaja</a></li>
                       <li><a href="#nastavenia" id="nav-nastavenia">Nastavenia</a></li>
                </ul>
            </nav>
        </aside>

        <main class="content">
            <section id="kategorie" style="display: none;">
                <h2>Vytvorenie kategórií</h2>
                 <p>Správa kategórií pre turnaj.</p>
                <table id="categoriesTable">
                    <thead>
                        <tr>
                            <th>Názov Kategórie</th>
                            <th>Akcie</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </section>

            <section id="skupiny" style="display: none;">
                <h2>Vytvorenie skupín</h2>
                 <p>Správa skupín pre jednotlivé kategórie.</p>
                <table id="groupsTable">
                    <thead>
                        <tr>
                            <th>Kategória</th>
                            <th>Názov Skupiny</th>
                            <th>Akcie</th>
                        </tr>
                    </thead>
                    <tbody>
                         </tbody>
                </table>
            </section>

            <section id="zoznam-timov" style="display: none;">
                 <h2>Zoznam tímov</h2>
                 <p>Prehľad všetkých vytvorených tímov.</p>
                 <table id="teamsListTable">
                     <thead>
                          <tr>
                                <th>Základný Názov</th>
                                <th>Kategória</th>
                                <th>Počet Tímov</th>
                                <th>Akcie</th>
                          </tr>
                     </thead>
                     <tbody>
                          </tbody>
                 </table>
            </section>


             <section id="timy-do-skupin" style="display: none;">
                 <h2>Tímy do skupín</h2>
                 <p>Priradenie existujúcich tímov do vytvorených skupín.</p>
                 <p>Nepriradené tímy:</p>
                 <table id="unassignedClubsTable">
                    <thead>
                         <tr>
                             <th>Názov Tímu</th>
                              <th>Kategória</th>
                              <th>Akcie</th>
                         </tr>
                    </thead>
                    <tbody>
                         </tbody>
                 </table>

                  <h3>Tímy priradené do skupín:</h3>
                  <p>Tímy v rámci skupín je možné presúvať potiahnutím (drag & drop) a meniť tak ich poradie.</p>
                  <div id="assignedClubsContainer">
                       </div>

            </section>

             <section id="sportove-haly" style="display: none;">
                 <h2>Športové haly</h2>
                 <p>Správa športových hál pre turnaj.</p>
                 <p>Táto sekcia zatiaľ nie je implementovaná.</p>
            </section>

             <section id="sprava-turnaja" style="display: none;">
                 <h2>Správa turnaja</h2>
                 <p>Celková správa turnaja (rozlosovanie, časy, atď.).</p>
                 <p>Táto sekcia zatiaľ nie je implementovaná.</p>
            </section>

             <section id="nastavenia" style="display: none;">
                 <h2>Nastavenia</h2>
                 <p>Nastavenia turnaja (názov, dátum, atď.).</p>
                  <div id="admin-auth-section">
                      <h3>Admin Prihlásenie</h3>
                       <button id="admin-logout-button" style="display: none;">Odhlásiť Admina</button>
                 </div>

                 <p>Táto sekcia zatiaľ nie je plne implementovaná.</p>
            </section>


        </main>
    </div>

    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <span class="close category-modal-close">&times;</span>
            <h2 id="categoryModalTitle">Pridať Kategóriu</h2>
            <form id="categoryForm">
                <div>
                    <label for="categoryName">Názov Kategórie:</label>
                    <input type="text" id="categoryName" name="categoryName" required>
                </div>
                <button type="submit">Uložiť Kategóriu</button>
                 <button type="button" class="close-button category-modal-close">Zrušiť</button> </form>
        </div>
    </div>

     <div class="modal" id="groupModal">
         <div class="modal-content">
              <span class="close group-modal-close">&times;</span>
             <h2 id="groupModalTitle">Pridať Skupinu</h2>
             <form id="groupForm">
                 <div>
                     <label for="groupCategory">Kategória:</label>
                     <select id="groupCategory" name="groupCategory" required>
                         <option value="">-- Vyberte kategóriu --</option>
                         </select>
                 </div>
                 <div>
                     <label for="groupName">Názov Skupiny:</label>
                     <input type="text" id="groupName" name="groupName" required>
                 </div>
                  <button type="submit">Uložiť Skupinu</button>
                  <button type="button" class="close-button group-modal-close">Zrušiť</button> </form>
         </div>
     </div>


     <div class="modal" id="clubModal">
           <div class="modal-content">
               <span class="close club-modal-close">&times;</span>
               <h2 id="clubModalTitle">Priradiť tím do skupiny</h2>
               <form id="clubForm">
                   <div id="unassignedClubSelectContainer">
                        <label for="unassignedClubSelect">Vyberte existujúci tím:</label>
                        <select id="unassignedClubSelect">
                           <option value="">-- Vyberte tím na priradenie --</option>
                         </select>
                   </div>

                   <div id="clubNameInputContainer">
                        <label for="clubName">Názov klubu:</label>
                        <input type="text" id="clubName" name="clubName" required>
                       <span class="validation-message" id="clubNameValidationMessage"></span>
                   </div>

                   <div>
                        <label for="clubCategory">Kategória:</label>
                        <select id="clubCategory" name="clubCategory" required>
                           <option value="">-- Vyberte kategóriu --</option>
                           </select>
                        <span class="validation-message" id="clubCategoryValidationMessage"></span>
                   </div>

                   <div>
                         <label for="clubGroup">Skupina:</label>
                         <select id="clubGroup" name="clubGroup" required disabled>
                            <option value="">-- Najprv vyberte kategóriu --</option>
                         </select>
                         <span class="validation-message" id="clubGroupValidationMessage"></span>
                   </div>

                    <div id="orderInputContainer">
                          <label for="orderInGroup">Poradové číslo v skupine:</label>
                          <input type="number" id="orderInGroup" name="orderInGroup" min="1">
                          <span class="validation-message" id="orderInGroupValidationMessage"></span>
                    </div>

                    <button type="submit">Uložiť</button>
                    <button type="button" class="close-button club-modal-close">Zrušiť</button>
               </form>
           </div>
       </div>


    <div class="modal" id="teamCreationModal">
         <div class="modal-content" style="max-width: 600px;"> <span class="close team-creation-modal-close">&times;</span>
              <h2>Vytvorenie Tímov</h2>
              <p>Vytvorte viacero tímov pre rôzne kategórie naraz.</p>
              <form id="teamCreationForm">
                   <div>
                       <label for="baseTeamName">Základný názov tímu:</label>
                       <input type="text" id="baseTeamName" name="baseTeamName" required placeholder="Napr. Lokomotíva Košice">
                       <span class="validation-message" id="baseTeamNameValidationMessage"></span>
                   </div>

                   <div id="teamCategoryCountContainer">
                        </div>

                   <button type="button" id="addCategoryCountPairButton">Pridať ďalšiu kategóriu</button>

                   <button type="submit">Vytvoriť Tímy</button>
                   <button type="button" class="close-button team-creation-modal-close">Zrušiť</button>
              </form>
             <div class="message-area" id="teamCreationMessageArea"></div> </div>
    </div>

     <div class="modal" id="manageTeamsModal">
        <div class="modal-content" style="max-width: 700px;"> <span class="close manage-teams-modal-close">&times;</span>
            <h2>Správa tímov: <span id="baseTeamNameInModal"></span></h2>
            <p>Individuálna správa tímov vytvorených pod týmto názvom.</p>

            <div id="teamsListInModal">
                 </div>

             <div class="manage-teams-form-actions">
                  <button type="button" class="close-button manage-teams-modal-close">Zavrieť</button>
             </div>
        </div>
    </div>


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"; // Import Auth

        // Tvoja Firebase konfigurácia
        const firebaseConfig = {
            apiKey: "AIzaSyD0h0rQZiIGi0-UDb4-YU_JihRGpIlfz40", // ZMEŇ ZA SVOJ SKUTOČNÝ API KĽÚČ
            authDomain: "turnaj-a28c5.firebaseapp.com", // ZMEŇ ZA SVOJ SKUTOČNÝ authDomain
            projectId: "turnaj-a28c5", // ZMEŇ ZA SVOJ SKUTOČNÝ projectId
            storageBucket: "turnaj-a28c5.firebasestorage.app", // ZMEŇ ZA SVOJ SKUTOČNÝ storageBucket
            messagingSenderId: "13732191148", // ZMEŇ ZA SVOJ SKUTOČNÝ messagingSenderId
            appId: "1:13732191148:web:5ad78eaef2ad452a10f809" // ZMEŇ ZA SVOJ SKUTOČNÝ appId
        };

        // Inicializácia Firebase aplikácie
        const app = initializeApp(firebaseConfig);
        // Získanie inštancie Firestore databázy
        const db = getFirestore(app);
         // Získanie inštancie Auth
        const auth = getAuth(app);


        // Referencia na kolekcie
        // Štruktúra: tournamentData -> mainTournamentData (dokument) -> categories (kolekcia)
        const tournamentDataDocRef = doc(db, 'tournamentData', 'mainTournamentData');
        const categoriesCollectionRef = collection(tournamentDataDocRef, 'categories');
        const groupsCollectionRef = collection(tournamentDataDocRef, 'groups'); // Groups use composite IDs
        const clubsCollectionRef = collection(tournamentDataDocRef, 'clubs'); // Clubs now use auto-generated IDs

        // Referencia na dokument s nastaveniami turnaja (napr. názov, atď.)
        const tournamentSettingsDocRef = doc(db, 'tournamentData', 'mainTournamentData', 'settings', 'general');


        // Globálne premenné pre uloženie kategórií a tímov pre dynamické select boxy
        let allAvailableCategories = [];
        let allAvailableClubs = []; // Used for populating the unassigned clubs select


        // === Autentikácia Admina ===
        let isAdmin = false; // Default state

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in. Check if it's the admin user (anonymous for now)
                 console.log("Firebase Auth state changed. User signed in.", user.uid);
                 // For simplicity, we assume the anonymous user created is the admin
                 // In a real app, you'd check user roles or email etc.
                 isAdmin = true; // Assume any logged in user is admin for this simple case
                 console.log("Admin status:", isAdmin);
                 // TODO: Show admin-only UI elements, hide login form if it existed
                  document.getElementById('admin-logout-button').style.display = 'block';

                 // Redirect away from login page if admin is logged in (if login page existed)
                 // if (window.location.pathname.endsWith('login.html')) {
                 //      window.location.href = 'index.html'; // Redirect to main page
                 // }

            } else {
                // User is signed out
                 console.log("Firebase Auth state changed. User signed out.");
                 isAdmin = false; // Not admin
                 console.log("Admin status:", isAdmin);
                 // TODO: Hide admin-only UI elements, show login form if it existed
                  document.getElementById('admin-logout-button').style.display = 'none';

                 // Redirect to login page if not admin (if login page existed)
                 // if (!window.location.pathname.endsWith('login.html')) {
                 //      window.location.href = 'login.html'; // Redirect to login
                 // }

                 // For THIS simple app, if not logged in, try to log in anonymously
                 // signInAnonymously(auth)
                 //     .then(() => {
                 //          console.log("Attempting anonymous sign-in...");
                 //      })
                 //      .catch((error) => {
                 //          console.error("Error during anonymous sign-in:", error);
                 //          // Handle errors (e.g., display message to user)
                 //      });
                  // === TEMPORARY: Auto sign in anonymously for testing ===
                  // In a real app, this would be triggered by a login form
                   signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
                   // === END TEMPORARY ===
            }
            // After checking auth state, ensure correct content is displayed based on hash and admin status
             toggleContentDisplay(); // Call this after auth state is known
        });

        document.getElementById('admin-logout-button').addEventListener('click', () => {
            signOut(auth).then(() => {
                console.log("Admin signed out.");
                // onAuthStateChanged listener handles UI updates and potential redirect
            }).catch((error) => {
                console.error("Error signing out:", error);
            });
        });


        // === Získame referencie na DOM elementy ===

        const addButton = document.getElementById('addButton');

        // Modál Kategórie
        const categoryModal = document.getElementById('categoryModal');
        const categoryModalCloseBtn = categoryModal ? categoryModal.querySelector('.category-modal-close') : null; // Added null check
        const categoryForm = document.getElementById('categoryForm');
        const categoryNameInput = document.getElementById('categoryName');
        const categoryModalTitle = document.getElementById('categoryModalTitle');
        let editingCategoryId = null; // Store the ID of the category being edited

        // Modál Skupiny
        const groupModal = document.getElementById('groupModal');
        const groupModalCloseBtn = groupModal ? groupModal.querySelector('.group-modal-close') : null; // Added null check
        const groupForm = document.getElementById('groupForm');
        const groupCategorySelect = document.getElementById('groupCategory');
        const groupNameInput = document.getElementById('groupName');
        const groupModalTitle = document.getElementById('groupModalTitle');
        const groupFormSubmitButton = groupForm ? groupForm.querySelector('button[type="submit"]') : null; // Added null check
        let editingGroupId = null; // Store the composite ID "categoryId-groupName" of the group being edited


        // Modál Kluby (pre priradenie do skupín / úpravu priradených)
        const clubModal = document.getElementById('clubModal');
        const clubModalCloseBtn = clubModal ? clubModal.querySelector('.club-modal-close') : null; // Added null check
        const clubForm = document.getElementById('clubForm');
        const clubNameInput = document.getElementById('clubName'); // Existing name input (used when editing assigned)
        const clubCategorySelect = document.getElementById('clubCategory'); // Category select within club modal form
        const clubGroupSelect = document.getElementById('clubGroup'); // Group select within club modal form
        const clubModalTitle = document.getElementById('clubModalTitle');
        const clubFormSubmitButton = clubForm ? clubForm.querySelector('button[type="submit"]') : null; // Added null check

        // Modál Vytvorenie Tímov
        const teamCreationModal = document.getElementById('teamCreationModal');
        const teamCreationModalCloseBtn = teamCreationModal ? teamCreationModal.querySelector('.team-creation-modal-close') : null; // Added null check
        const teamCreationForm = document.getElementById('teamCreationForm');
        const baseTeamNameInput = document.getElementById('baseTeamName');
        const teamCategoryCountContainer = document.getElementById('teamCategoryCountContainer');
        const addCategoryCountPairButton = document.getElementById('addCategoryCountPairButton');
        const teamCreationMessageArea = document.getElementById('teamCreationMessageArea');


        // Nový Modal pre správu individuálnych tímov
        const manageTeamsModal = document.getElementById('manageTeamsModal');
        const baseTeamNameInModalSpan = document.getElementById('baseTeamNameInModal');
        const teamsListInModalDiv = document.getElementById('teamsListInModal');
        const manageTeamsModalCloseBtn = manageTeamsModal ? manageTeamsModal.querySelector('.manage-teams-modal-close') : null; // Added null check


        // REFERENCES FOR CLUB MODAL CHANGES (add/edit assigned)
        const unassignedClubSelectContainer = document.getElementById('unassignedClubSelectContainer');
        const unassignedClubSelect = document.getElementById('unassignedClubSelect');
        const clubNameInputContainer = document.getElementById('clubNameInputContainer');
         const orderInputContainer = document.getElementById('orderInputContainer'); // Reference to the new order input container
        const orderInGroupInput = document.getElementById('orderInGroup'); // Reference to the new order input field

        let currentClubModalMode = 'add-assign'; // 'add-assign' or 'edit'
        let editingClubId = null; // Store the ID of the club being edited when mode is 'edit'


        // === Navigačná logika a zobrazenie sekcií ===

        // Skryje všetky sekcie obsahu
        function hideAllSections() {
            document.querySelectorAll('main .content section').forEach(section => {
                section.style.display = 'none';
            });
             // Skryje všetky modály
             document.querySelectorAll('.modal').forEach(modal => {
                 modal.style.display = 'none';
             });
             // Skryje tlačidlo pridania, ak nie je použiteľné v aktuálnej sekcii
             if (addButton) {
                  addButton.style.display = 'none';
             }

             // Reset modal state when changing sections
             currentClubModalMode = 'add-assign'; // Default mode
             editingClubId = null; // No club being edited
              // Reset form inputs to default states (optional, but good practice)
               if (categoryForm) categoryForm.reset();
               if (groupForm) groupForm.reset();
               if (clubForm) clubForm.reset();
               if (teamCreationForm) {
                    teamCreationForm.reset();
                    // Clear dynamically added category/count pairs except the first one
                    if (teamCategoryCountContainer) {
                         teamCategoryCountContainer.innerHTML = ''; // Clear all pairs
                         addCategoryCountPair(false); // Add back the first empty pair without focusing
                    }
               }


              // Remove active class from all nav links
             document.querySelectorAll('.sidebar nav ul li a').forEach(link => {
                  link.classList.remove('active');
             });

        }

        // Zobrazí sekciu na základe hashu
        async function toggleContentDisplay() {
            hideAllSections(); // Najprv skryje všetko

            if (!isAdmin) {
                 console.warn("Nie je prihlásený admin. Zobrazujem len základný obsah alebo presmerovávam.");
                 // TODO: Implement actual redirect or limited view if not admin
                 // Presmeruj na login, ak nie je admin a nie si už na login stránke (ak existuje)
                 // if (!window.location.pathname.endsWith('login.html')) {
                 //     window.location.href = 'login.html';
                 // }
                  // Dočasne len nelogovanému adminovi nezobrazujeme obsah sekcií
                 return; // Zastaví vykonávanie funkcie, ak nie je admin
            }

            const hash = window.location.hash;
            console.log("Navigating to hash:", hash); // Debug log

            // Získaj referenciu na aktuálny navigačný link a označ ho ako aktívny
            const activeNavLink = document.querySelector(`.sidebar nav ul li a[href="${hash}"]`);
             if(activeNavLink) {
                 activeNavLink.classList.add('active');
             }


            // Zobrazí príslušnú sekciu a načíta dáta
            switch (hash) {
                case '#kategorie':
                     const kategorieSection = document.getElementById('kategorie');
                     if (kategorieSection) {
                          kategorieSection.style.display = 'block';
                           if (addButton) addButton.style.display = 'block'; // Tlačidlo pridania je viditeľné v sekcii kategórií
                           loadCategories(); // Načítaj a zobraz kategórie v tabuľke
                     } else { console.error("Section #kategorie not found!"); }
                    break;
                case '#skupiny':
                     const skupinySection = document.getElementById('skupiny');
                     if (skupinySection) {
                          skupinySection.style.display = 'block';
                          if (addButton) addButton.style.display = 'block'; // Tlačidlo pridania je viditeľné v sekcii skupín
                          loadGroups(); // Načítaj a zobraz skupiny v tabuľke
                     } else { console.error("Section #skupiny not found!"); }
                    break;
                 case '#zoznam-timov':
                     const zoznamTimovSection = document.getElementById('zoznam-timov');
                     if (zoznamTimovSection) {
                          zoznamTimovSection.style.display = 'block';
                          // Tlačidlo pridania je viditeľné len pre hromadné vytvorenie v sekcii tímov
                          if (addButton) addButton.style.display = 'block'; // Tlačidlo pridania je viditeľné v sekcii zoznamu tímov
                          loadTeamsList(); // Načítaj a zobraz zoznam tímov v tabuľke
                     } else { console.error("Section #zoznam-timov not found!"); }
                    break;
                 case '#timy-do-skupin':
                     const timyDoSkupinSection = document.getElementById('timy-do-skupin');
                      if (timyDoSkupinSection) {
                           timyDoSkupinSection.style.display = 'block';
                            if (addButton) addButton.style.display = 'block'; // Tlačidlo pridania je viditeľné v sekcii tímov do skupín (pre priradenie)
                            loadUnassignedClubs(); // Načítaj a zobraz nepriradené kluby
                            loadAssignedClubs(); // Načítaj a zobraz priradené kluby
                      } else { console.error("Section #timy-do-skupin not found!"); }
                    break;
                  case '#sportove-haly':
                     const sportoveHalySection = document.getElementById('sportove-haly');
                      if (sportoveHalySection) {
                           sportoveHalySection.style.display = 'block';
                            if (addButton) addButton.style.display = 'none'; // Tlačidlo pridania nie je viditeľné v tejto sekcii (zatiaľ)
                      } else { console.error("Section #sportove-haly not found!"); }
                    break;
                   case '#sprava-turnaja':
                     const spravaTurnajaSection = document.getElementById('sprava-turnaja');
                      if (spravaTurnajaSection) {
                           spravaTurnajaSection.style.display = 'block';
                           if (addButton) addButton.style.display = 'none'; // Tlačidlo pridania nie je viditeľné v tejto sekcii (zatiaľ)
                      } else { console.error("Section #sprava-turnaja not found!"); }
                    break;
                   case '#nastavenia':
                     const nastaveniaSection = document.getElementById('nastavenia');
                      if (nastaveniaSection) {
                           nastaveniaSection.style.display = 'block';
                           if (addButton) addButton.style.display = 'none'; // Tlačidlo pridania nie je viditeľné v tejto sekcii (zatiaľ)
                           // TODO: Load/handle settings data
                      } else { console.error("Section #nastavenia not found!"); }
                    break;
                default:
                    // Ak hash chýba alebo je neznámy, presmeruj na #kategorie
                    window.location.hash = '#kategorie';
            }
             // Po zmene sekcie znova načítaj kategórie pre všetky dynamické selecty (ak sú potrebné)
            await loadAllCategoriesForDynamicSelects(); // Táto funkcia volá updateDynamicCategorySelects
        }

        // Volá sa pri načítaní stránky a zmene hashu
        window.addEventListener('hashchange', toggleContentDisplay);
        window.addEventListener('load', () => {
             // Pri prvom načítaní stránky (alebo po refreshi) nastav hash, ak nie je nastavený
             if (!window.location.hash) {
                 window.location.hash = '#kategorie'; // Defaultná sekcia
             } else {
                 // Ak hash už je, spustí toggleContentDisplay (listener na hashchange to aj tak urobí)
                 // toggleContentDisplay();
             }
        });


        // === Funkcie pre prácu s dátami (Firebase Firestore) ===

        // Načítanie všetkých kategórií pre dynamické select boxy
        async function loadAllCategoriesForDynamicSelects() {
             if (allAvailableCategories.length > 0) {
                 // Kategórie už sú načítané, nemusíme ich znovu načítavať z databázy
                 // Môžeme rovno aktualizovať selecty
                 updateDynamicCategorySelects();
                 checkIfAddCategoryButtonShouldBeVisible(); // Skontroluje viditeľnosť tlačidla
                 console.log("Kategórie už boli načítané. Aktualizujem selecty.");
                 return;
             }
             console.log("Načítavam kategórie pre dynamické selecty...");
             try {
                 const querySnapshot = await getDocs(query(categoriesCollectionRef));
                 allAvailableCategories = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 console.log("Načítané kategórie pre všetky selecty:", allAvailableCategories.map(cat => cat.name));

                 // Po načítaní kategórií aktualizuj všetky selecty, ktoré ich používajú
                 updateDynamicCategorySelects();
                 checkIfAddCategoryButtonShouldBeVisible(); // Skontroluje viditeľnosť tlačidla
             } catch (e) {
                 console.error("Chyba pri načítaní kategórií pre dynamické selecty: ", e);
             }
        }

         // Aktualizuje všetky select boxy, ktoré majú zobrazovať kategórie
         function updateDynamicCategorySelects() {
              // Zoznam ID select elementov, ktoré sa majú naplniť kategóriami
             const selectIdsToUpdate = [
                 'groupCategory', // Vytvorenie Skupín modál
                 'clubCategory',  // Kluby modál
                 // Pridaj sem ďalšie ID selectov, ak budú potrebné na iných miestach
             ];

              selectIdsToUpdate.forEach(selectId => {
                 const selectElement = document.getElementById(selectId);
                 if (selectElement) {
                      // Voláme populateCategorySelect pre každý takýto select
                      // selectedCategoryId je null, lebo len plníme select, nevyberáme konkrétnu kategóriu z dát
                      populateCategorySelect(selectElement, true); // true = include default option
                 } else {
                     // console.warn(`Select element s ID "${selectId}" nebol nájdený na aktualizáciu kategóriami.`);
                      // Je ok, ak select nie je na aktuálne zobrazenej stránke
                 }
              });

             // Špeciálne naplnenie pre dynamicky pridávané selecty v teamCreationModal
             // Toto je volané aj pri addCategoryCountPair
             updateTeamCreationCategorySelects();

         }


        // Funkcia na naplnenie select boxu kategóriami
        // Zvoliteľne nastaví vybranú kategóriu, ak je provided selectedCategoryId
        async function populateCategorySelect(selectElement, includeDefaultOption = false, selectedCategoryId = null) {
            if (!selectElement) {
                console.error("Chyba: Cieľový select element nebol nájdený pre kategórie.");
                return;
            }
            // --- PRIDANÁ KONTROLA PRE NEOČAKÁVANÚ HODNOTU SELECTEDCATEGORYID ---
            if (selectedCategoryId !== null && typeof selectedCategoryId !== 'string') { // Kategórie ID by mali byť stringy
                 console.warn(`populateCategorySelect: Neočakávaná hodnota alebo typ pre selectedCategoryId:`, selectedCategoryId, `(Typ: ${typeof selectedCategoryId}). Nastavujem na null.`);
                 selectedCategoryId = null; // Resetujeme na null, ak je hodnota neočakávaná
            }
             // --- KONIEC KONTROLY ---


            // Clear current options except maybe a default one if needed
            selectElement.innerHTML = ''; // Clear existing options

            if (includeDefaultOption) {
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "-- Vyberte kategóriu --";
                selectElement.appendChild(defaultOption);
            }

            // Ensure all categories are loaded before populating
            if (allAvailableCategories.length === 0) {
                 console.warn("populateCategorySelect: Kategórie ešte nie sú načítané do allAvailableCategories. Načítavam...");
                 await loadAllCategoriesForDynamicSelects(); // Táto funkcia volá updateDynamicCategorySelects, čo by mohlo spôsobiť rekurziu, ale populateCategorySelect by mala byť volaná až PO naplnení allAvailableCategories
                 // Pre istotu skontrolujeme znovu po await
                  if (allAvailableCategories.length === 0) {
                      console.error("populateCategorySelect: Načítanie kategórií zlyhalo.");
                       // Môžeme sem pridať zobrazenie chybovej správy pre používateľa
                       return;
                  }
            }


            // Sort categories alphabetically by name
            allAvailableCategories.sort((a, b) => a.name.localeCompare(b.name));


            allAvailableCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id; // Document ID is the value
                option.textContent = category.name;
                // Set selected if this option matches the selectedCategoryId
                 if (selectedCategoryId && category.id === selectedCategoryId) { // Check if selectedCategoryId is provided and matches
                     option.selected = true;
                 }
                selectElement.appendChild(option);
            });

            // Log if selectedCategoryId was provided but not found among options (useful for debugging edit mode)
            if (selectedCategoryId && !allAvailableCategories.find(cat => cat.id === selectedCategoryId)) {
                 console.warn(`populateCategorySelect: Kategória s ID "${selectedCategoryId}" pre zvolenú položku nenájdená v zozname kategórií.`, allAvailableCategories.map(cat => ({id: cat.id, name: cat.name}))); // <--- Pôvodná logovacia správa bola tu (riadok 908)
            }

        }

         // Funkcia na naplnenie select boxu skupinami pre danú kategóriu
         async function populateGroupSelect(selectElement, categoryId, includeDefaultOption = false, selectedGroupId = null) {
              if (!selectElement) {
                 console.error("Chyba: Cieľový select element pre skupiny nebol nájdený.");
                 return;
              }
              if (!categoryId) {
                  console.log("populateGroupSelect: Category ID chýba, nemôžem načítať skupiny.");
                   selectElement.innerHTML = includeDefaultOption ? '<option value="">-- Najprv vyberte kategóriu --</option>' : '';
                   selectElement.disabled = true; // Zablokuj, kým sa nevyberie kategória
                   return;
              }
              console.log(`populateGroupSelect: Načítavam skupiny pre kategóriu ID: ${categoryId}`);
              selectElement.disabled = true; // Zablokuj počas načítavania
              selectElement.innerHTML = includeDefaultOption ? '<option value="">-- Načítavam skupiny --</option>' : ''; // Loading message

              try {
                  // Skupiny sú podkolekciou dokumentu kategórie
                 const groupQuery = query(collection(categoriesCollectionRef, categoryId, 'groups'));
                 const querySnapshot = await getDocs(groupQuery);
                 const groups = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                  console.log(`Načítané skupiny pre kategóriu ${categoryId}:`, groups.map(g => g.name));

                  // Clear current options
                  selectElement.innerHTML = '';

                  if (includeDefaultOption) {
                     const defaultOption = document.createElement('option');
                     defaultOption.value = "";
                     defaultOption.textContent = "-- Vyberte skupinu --";
                     selectElement.appendChild(defaultOption);
                  }

                  groups.forEach(group => {
                     const option = document.createElement('option');
                     option.value = group.id; // Use group document ID as value
                     option.textContent = group.name;
                      if (selectedGroupId && group.id === selectedGroupId) { // Set selected if needed
                         option.selected = true;
                     }
                     selectElement.appendChild(option);
                  });

                 selectElement.disabled = false; // Povoľ select box po načítaní
                 // Log if selectedGroupId was provided but not found
                 if (selectedGroupId && !groups.find(g => g.id === selectedGroupId)) {
                     console.warn(`populateGroupSelect: Skupina s ID "${selectedGroupId}" pre zvolenú položku nenájdená v zozname skupín kategórie ${categoryId}.`);
                 }


              } catch (e) {
                 console.error(`Chyba pri načítaní skupín pre kategóriu ${categoryId}: `, e);
                 selectElement.innerHTML = includeDefaultOption ? '<option value="">-- Chyba pri načítaní skupín --</option>' : '';
                 selectElement.disabled = true;
              }
         }


         // Funkcia na načítanie nepriradených klubov (pre select box v clubModal v add-assign móde)
         async function loadUnassignedClubsForSelect() {
              if (!unassignedClubSelect) {
                 console.error("Chyba: Select element pre nepriradené kluby nebol nájdený.");
                 return;
              }
             console.log("Načítavam nepriradené kluby pre select...");
             unassignedClubSelect.disabled = true; // Zablokuj počas načítavania
              unassignedClubSelect.innerHTML = '<option value="">-- Načítavam tímy --</option>'; // Loading message


             try {
                 // Načítaj všetky kluby, ktoré nemajú groupId
                 const q = query(clubsCollectionRef, where("groupId", "==", null)); // Filter for clubs where groupId is null
                 const querySnapshot = await getDocs(q);
                 allAvailableClubs = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                 console.log("Načítané nepriradené kluby:", allAvailableClubs.map(club => club.name));

                 // Clear current options
                 unassignedClubSelect.innerHTML = '';

                 // Add default option
                 const defaultOption = document.createElement('option');
                 defaultOption.value = "";
                 defaultOption.textContent = "-- Vyberte tím na priradenie --";
                 unassignedClubSelect.appendChild(defaultOption);

                  // Sort unassigned clubs by name (and category maybe?)
                 allAvailableClubs.sort((a, b) => a.name.localeCompare(b.name)); // Sort by name

                 allAvailableClubs.forEach(club => {
                     const option = document.createElement('option');
                     option.value = club.id; // Use club document ID as value
                     option.textContent = `${club.name} (${allAvailableCategories.find(cat => cat.id === club.categoryId)?.name || 'Neznáma kategória'})`; // Display name and category
                     option.dataset.categoryId = club.categoryId; // Store categoryId in dataset
                     unassignedClubSelect.appendChild(option);
                 });

                 unassignedClubSelect.disabled = false; // Povoľ select box po načítaní

                 // Ak nie sú žiadne nepriradené kluby, zobraz správu
                 if (allAvailableClubs.length === 0) {
                     const noClubsOption = document.createElement('option');
                     noClubsOption.value = "";
                     noClubsOption.textContent = "-- Žiadne nepriradené tímy --";
                     noClubsOption.disabled = true;
                     unassignedClubSelect.appendChild(noClubsOption);
                      unassignedClubSelect.disabled = true; // Zablokuj, ak nie sú tímy
                 }


             } catch (e) {
                 console.error("Chyba pri načítaní nepriradených klubov pre select: ", e);
                 unassignedClubSelect.innerHTML = '<option value="">-- Chyba pri načítaní tímov --</option>';
                 unassignedClubSelect.disabled = true;
             }
         }



        // === Funkcie pre otváranie/zatváranie modálov ===

         // Funkcia na zatvorenie všetkých modálov
         function closeAllModals() {
             document.querySelectorAll('.modal').forEach(modal => {
                 modal.style.display = 'none';
             });
             // Reset modal state
             currentClubModalMode = 'add-assign'; // Default mode
             editingClubId = null; // No club being edited
              // Reset forms (optional, but good practice)
             if (categoryForm) categoryForm.reset();
             if (groupForm) groupForm.reset();
             if (clubForm) clubForm.reset();
             if (teamCreationForm) {
                 teamCreationForm.reset();
                 // Clear dynamically added category/count pairs except the first one
                 if (teamCategoryCountContainer) {
                      teamCategoryCountContainer.innerHTML = ''; // Clear all pairs
                      addCategoryCountPair(false); // Add back the first empty pair without focusing
                 }
              }
              // Reset message area visibility
              if(teamCreationMessageArea) {
                  teamCreationMessageArea.style.display = 'none';
                  teamCreationMessageArea.className = 'message-area'; // Reset classes
              }

         }


        // Funkcia na otvorenie modálu kategórie (pre pridanie alebo úpravu)
        function openCategoryModal(categoryId = null, categoryData = null) {
            if (!categoryModal) { console.error("Category modal element not found!"); return; }
            if (!categoryForm) { console.error("Category form element not found!"); return; }
             if (!categoryNameInput) { console.error("Category name input element not found!"); return; }
             if (!categoryModalTitle) { console.error("Category modal title element not found!"); return; }


            categoryForm.reset(); // Reset form fields
            editingCategoryId = categoryId; // Store ID if editing

            if (categoryId && categoryData) {
                // Edit mode
                categoryModalTitle.textContent = 'Upraviť Kategóriu';
                categoryNameInput.value = categoryData.name;
            } else {
                // Add mode
                categoryModalTitle.textContent = 'Pridať Kategóriu';
            }

            categoryModal.style.display = 'block';
             categoryNameInput.focus(); // Set focus to the input field
        }


         // Funkcia na otvorenie modálu skupiny (pre pridanie alebo úpravu)
        async function openGroupModal(groupId = null, groupData = null) { // groupId is composite ID
             if (!groupModal) { console.error("Group modal element not found!"); return; }
             if (!groupForm) { console.error("Group form element not found!"); return; }
             if (!groupCategorySelect) { console.error("Group category select element not found!"); return; }
             if (!groupNameInput) { console.error("Group name input element not found!"); return; }
             if (!groupModalTitle) { console.error("Group modal title element not found!"); return; }
             if (!groupFormSubmitButton) { console.error("Group form submit button element not found!"); return; } // Check submit button


             groupForm.reset(); // Reset form fields
             editingGroupId = groupId; // Store ID if editing

             // Vždy naplň select kategórií
             // Ak editujeme, selectCategory bude disabled a nastavený na aktuálnu kategóriu skupiny
             // Ak pridávame, selectCategory bude enabled a s predvolenou možnosťou
             await populateCategorySelect(groupCategorySelect, true, groupData ? groupData.categoryId : null);


             if (groupId && groupData) {
                 // Edit mode
                 groupModalTitle.textContent = 'Upraviť Skupinu';
                 groupCategorySelect.value = groupData.categoryId;
                 groupNameInput.value = groupData.name;

                 // V edit móde nedovolíme meniť kategóriu skupiny
                 groupCategorySelect.disabled = true;
                 groupNameInput.readOnly = false; // Názov skupiny môžeme zmeniť

                 groupFormSubmitButton.textContent = 'Uložiť zmeny';

             } else {
                 // Add mode
                 groupModalTitle.textContent = 'Pridať Skupinu';
                 groupCategorySelect.disabled = false; // Povolíme výber kategórie
                 groupNameInput.readOnly = false;
                 groupFormSubmitButton.textContent = 'Uložiť Skupinu';
             }

             groupModal.style.display = 'block';
              // Nastav focus na kategóriu alebo názov skupiny
              if (groupCategorySelect && !groupCategorySelect.disabled) {
                 groupCategorySelect.focus();
              } else if (groupNameInput) {
                 groupNameInput.focus();
              }

         }

          // Funkcia na otvorenie modálu klubu (pre priradenie do skupín ALEBO úpravu priradeného/nepriradeného)
         // clubId je auto-generované ID dokumentu
         async function openClubModal(clubId = null, clubData = null) { // clubId is auto-generated ID
             // --- DEBUG LOG: Check function call arguments ---
             console.log('openClubModal called. clubId:', clubId, 'clubData:', clubData);
             console.log('Checking DOM elements at start of openClubModal...'); // New log
             // PRIDANÉ KONTROLY EXISTENCIE DOM ELEMENTOV NA ZAČIATKU FUNKCIE
              if (!clubModal) { console.error("FATAL ERROR: clubModal element not found!"); return; }
              if (!clubForm) { console.error("FATAL ERROR: clubForm element not found!"); return; }
              if (!clubModalTitle) { console.error("FATAL ERROR: clubModalTitle element not found!"); return; }
              if (!clubFormSubmitButton) { console.error("FATAL ERROR: clubFormSubmitButton element not found!"); return; }
              if (!unassignedClubSelectContainer) { console.error("FATAL ERROR: unassignedClubSelectContainer element not found!"); return; }
              if (!unassignedClubSelect) { console.error("FATAL ERROR: unassignedClubSelect element not found!"); return; }
              if (!clubNameInputContainer) { console.error("FATAL ERROR: clubNameInputContainer element not found!"); return; }
              if (!clubNameInput) { console.error("FATAL ERROR: clubNameInput element not found!"); return; }
              if (!clubCategorySelect) { console.error("FATAL ERROR: clubCategorySelect element not found!"); return; }
              if (!clubGroupSelect) { console.error("FATAL ERROR: clubGroupSelect element not found!"); return; }
              if (!orderInputContainer) { console.error("FATAL ERROR: orderInputContainer element not found!"); return; }
              if (!orderInGroupInput) { console.error("FATAL ERROR: orderInGroupInput element not found!"); return; }

              console.log('All required DOM elements for clubModal found.'); // Confirmation log


              // --- END DEBUG LOG ---

               // Clear any previous validation messages in the form
             const validationMessages = clubForm.querySelectorAll('.validation-message');
             validationMessages.forEach(msg => msg.textContent = '');


             clubForm.reset(); // Reset form fields (will reset selects too)
             editingClubId = clubId; // Store ID if editing

              // Reset visibility of name input vs select and order input
             unassignedClubSelectContainer.style.display = 'block'; // Default to showing select for add-assign
             clubNameInputContainer.style.display = 'none';
             orderInputContainer.style.display = 'none'; // Hide order input by default

              // Reset group select visibility and disabled state
             clubGroupSelect.parentElement.style.display = 'block'; // Default to showing group select parent
             clubGroupSelect.disabled = true; // Disable group select initially


              // Populate the category select in the club modal
              // In add-assign mode, selectedCategoryId is null
              // In edit mode, we pass the clubData.categoryId
             await populateCategorySelect(clubCategorySelect, true, clubData ? clubData.categoryId : null);


             if (clubId && clubData) {
                // Edit mode
                currentClubModalMode = 'edit';

                 console.log("Opening club modal in edit mode for club ID:", clubId, "Data:", clubData);

                 clubModalTitle.textContent = 'Upraviť tím'; // Specific title
                 clubFormSubmitButton.textContent = 'Uložiť zmeny'; // Specific button text

                 // Hide select for unassigned clubs, show name input (read-only)
                 unassignedClubSelectContainer.style.display = 'none';
                 clubNameInputContainer.style.display = 'block';
                 clubNameInput.value = clubData.name || '';
                 clubNameInput.readOnly = true; // Cannot change name in edit mode (only category/group/order)


                 // Set the category select value and populate groups for that category
                 if (clubCategorySelect) {
                      clubCategorySelect.value = clubData.categoryId || '';
                      clubCategorySelect.disabled = true; // Cannot change category in edit mode
                       // Populate and enable group select based on the club's category
                       if (clubData.categoryId) {
                           await populateGroupSelect(clubGroupSelect, clubData.categoryId, true, clubData.groupId);
                           clubGroupSelect.disabled = false; // Enable group select
                       } else {
                           console.warn("Edit mode: clubData has no categoryId.");
                            clubGroupSelect.disabled = true; // Keep disabled if no category
                            clubGroupSelect.innerHTML = '<option value="">-- Kategória neznáma --</option>';
                       }

                 } else {
                    console.error("FATAL ERROR: clubCategorySelect not found in edit mode!");
                 }


                 // Show and set the order input value
                 orderInputContainer.style.display = 'block';
                 orderInGroupInput.value = clubData.orderInGroup || '';
                 orderInGroupInput.disabled = false; // Order can be changed


             } else { // Add mode (Assigning an UNASSIGNED club to a group)
                currentClubModalMode = 'add-assign';
                // editingClubId is already null by default

                 console.log("Opening club modal in add-assign mode.");

                 // V add-assign móde zobrazujeme select pre výber nepriradeného klubu
                unassignedClubSelectContainer.style.display = 'block';
                clubNameInputContainer.style.display = 'none'; // Názov sa vezme zo selectu
                 clubNameInput.readOnly = false; // Reset readOnly state

                 // Order input by default hidden in add-assign mode, only shown when category/group is chosen
                 orderInputContainer.style.display = 'none';
                 orderInGroupInput.disabled = true; // Disable order input initially


                 // Populate the unassigned clubs select
                 await loadUnassignedClubsForSelect(); // This function populates unassignedClubSelect

                 // DEBUG log from previous attempts - kept for context
                 console.log('DEBUG: Value of clubModalTitle right before setting textContent:', clubModalTitle);


                clubModalTitle.textContent = 'Priradiť tím do skupiny'; // Tento riadok bol predtým blízko chyby

                // --- PÔVODNÝ RIADOK 1356, KTORÝ SPÔSOBOVAL CHYBU ---
                // Pridaná bezpečnostná kontrola je tesne nad týmto riadkom na riadku ~1371 (v staršej verzii)
                // Teraz je tu:
                // --- PRIDANÁ BEZPEČNOSŤNÁ KONTROLA Z PREDCHÁDZAJÚCEJ ÚPRAVY ---
                if (!clubFormSubmitButton) {
                    console.error('FATAL ERROR: clubFormSubmitButton is null in add mode!');
                    // Už sme logovali na začiatku, ale pre istotu zopakujeme a vrátime sa
                    return; // Zastavíme funkciu, ak tlačidlo neexistuje
                }
                // --- KONIEC KONTROLY ---

                // Debug log pred problematickým riadkom
                console.log('DEBUG: Value of clubFormSubmitButton right before setting textContent:', clubFormSubmitButton); // Pridana logovacia sprava pre submit button (teraz riadok ~1370)

                clubFormSubmitButton.textContent = 'Priradiť'; // Pôvodný problemový riadok (teraz riadok ~1371)


                // Skupinový select je predvolene zapnutý, ale disabled
                clubGroupSelect.parentElement.style.display = 'block'; // Ensure the parent div is visible
                clubGroupSelect.disabled = true;

                // Category select is used to filter groups - must be enabled and populated
                 if (clubCategorySelect) {
                       clubCategorySelect.disabled = false;
                       // populateCategorySelect bola volaná na začiatku funkcie, len sa uistíme, že je povolená
                       // await populateCategorySelect(clubCategorySelect, true); // Netreba volať znovu, už bola volaná na začiatku
                  } else {
                       console.error("FATAL ERROR: clubCategorySelect not found in add mode!");
                  }
             }

             // Uistíme sa, že modál je viditeľný (ak nebol vrátený kvôli chybe)
             clubModal.style.display = 'block';


             // Set focus to the first relevant input/select
             // Priorita: unassignedClubSelect (add-assign) -> clubNameInput (edit) -> clubCategorySelect
              if (currentClubModalMode === 'add-assign' && unassignedClubSelect) {
                  unassignedClubSelect.focus();
              } else if (currentClubModalMode === 'edit' && clubNameInput) {
                  clubNameInput.focus();
              } else if (clubCategorySelect && !clubCategorySelect.disabled) { // Fallback focus if enabled
                  clubCategorySelect.focus();
              } else {
                   // Ak sa nepodarilo nastaviť focus, zalogujeme to
                   console.warn("Could not set focus in club modal.");
              }


         } // Koniec openClubModal


         // Funkcia na otvorenie modálu pre hromadné vytvorenie tímov
         async function openTeamCreationModal() {
             if (!teamCreationModal) { console.error("Team Creation modal element not found!"); return; }
             if (!teamCreationForm) { console.error("Team Creation form element not found!"); return; }
             if (!teamCategoryCountContainer) { console.error("teamCategoryCountContainer element not found!"); return; }
             if (!addCategoryCountPairButton) { console.error("addCategoryCountPairButton element not found!"); return; }
              if (!baseTeamNameInput) { console.error("baseTeamNameInput element not found!"); return; }


             teamCreationForm.reset(); // Reset form (base name)
             // Clear previous category/count pairs except the first one
             teamCategoryCountContainer.innerHTML = '';
             addCategoryCountPair(false); // Add the first pair (don't focus immediately)


              // Ensure categories are loaded before populating the first select
             if (allAvailableCategories.length === 0) {
                  console.log("Kategórie nie sú načítané pre Team Creation Modal, načítavam...");
                 await loadAllCategoriesForDynamicSelects(); // Toto volá updateDynamicCategorySelects, čo aktualizuje aj selecty v teamCreationModal
             } else {
                  // Ak sú kategórie už načítané, len aktualizujeme dynamické selecty (volá sa aj v addCategoryCountPair)
                  updateDynamicCategorySelects();
             }


              // Reset message area
              if(teamCreationMessageArea) {
                  teamCreationMessageArea.style.display = 'none';
                  teamCreationMessageArea.className = 'message-area'; // Reset classes
                  teamCreationMessageArea.textContent = '';
              }


             teamCreationModal.style.display = 'block';
             baseTeamNameInput.focus(); // Set focus to the base name input
         }


         // Funkcia na otvorenie modálu pre správu individuálnych tímov
         async function openManageTeamsModal(baseTeamName) {
             if (!manageTeamsModal) { console.error("Manage Teams modal element not found!"); return; }
             if (!baseTeamNameInModalSpan) { console.error("baseTeamNameInModalSpan element not found!"); return; }
              if (!teamsListInModalDiv) { console.error("teamsListInModalDiv element not found!"); return; }


             baseTeamNameInModalSpan.textContent = baseTeamName; // Set the base name in the modal title
             teamsListInModalDiv.innerHTML = 'Načítavam tímy...'; // Loading message

             try {
                 // Načítaj všetky kluby s daným baseTeamName
                 const q = query(clubsCollectionRef, where("baseTeamName", "==", baseTeamName));
                 const querySnapshot = await getDocs(q);
                 const teams = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                 console.log(`Načítané individuálne tímy pre základný názov "${baseTeamName}":`, teams);

                 teamsListInModalDiv.innerHTML = ''; // Clear loading message

                 if (teams.length === 0) {
                     teamsListInModalDiv.textContent = 'Žiadne tímy pre tento názov nenájdené.';
                 } else {
                     // Zoskup tímy podľa kategórie
                     const teamsGroupedByCategory = teams.reduce((acc, team) => {
                         const categoryName = allAvailableCategories.find(cat => cat.id === team.categoryId)?.name || 'Neznáma kategória';
                         if (!acc[categoryName]) {
                             acc[categoryName] = [];
                         }
                         acc[categoryName].push(team);
                         return acc;
                     }, {});

                     // Zobraz tímy v zoskupených zoznamoch
                     for (const categoryName in teamsGroupedByCategory) {
                         const categoryTeams = teamsGroupedByCategory[categoryName];
                         const categoryHeading = document.createElement('h3');
                         categoryHeading.textContent = categoryName;
                         teamsListInModalDiv.appendChild(categoryHeading);

                         const ul = document.createElement('ul');
                         ul.style.listStyle = 'none'; // Remove default list styles
                         ul.style.padding = '0'; // Remove default padding

                         categoryTeams.forEach(team => {
                             const li = document.createElement('li');
                             li.classList.add('team-list-item'); // Apply flex styles
                             li.dataset.clubId = team.id; // Store club ID

                              const teamNameSpan = document.createElement('span');
                              teamNameSpan.textContent = team.name;
                              li.appendChild(teamNameSpan);


                             // Upraviť a Odstrániť tlačidlá
                             const editButton = document.createElement('button');
                             editButton.textContent = 'Upraviť';
                             editButton.classList.add('edit-team-button');
                             editButton.addEventListener('click', () => {
                                 // TODO: Implement editing individual team (e.g., assigning to group/order)
                                 // This would likely open the clubModal in edit mode
                                 console.log("Clicked Edit for team:", team.name, team.id);
                                  // Find the full club data from allAvailableClubs or refetch if not loaded
                                 const fullClubData = allAvailableClubs.find(club => club.id === team.id) || team; // Use team data if not in allAvailableClubs yet
                                  openClubModal(team.id, fullClubData); // Open club modal in edit mode
                                  closeAllModals(); // Close manage teams modal first
                             });

                             const deleteButton = document.createElement('button');
                             deleteButton.textContent = 'Odstrániť';
                             deleteButton.classList.add('unassign-team-button'); // Using unassign style, but it's a permanent delete here
                             deleteButton.addEventListener('click', async () => {
                                 if (confirm(`Naozaj chcete odstrániť tím "${team.name}"?`)) {
                                     console.log("Clicked Delete for team:", team.name, team.id);
                                     await deleteClub(team.id); // Implement deleteClub function
                                     // Po odstránení refreshni zoznam tímov v modále
                                     openManageTeamsModal(baseTeamName); // Reload the modal content
                                      // Tiež refreshni zoznam nepriradených klubov v #timy-do-skupin sekcii
                                     loadUnassignedClubs();
                                     // A zoznam všetkých tímov v #zoznam-timov sekcii
                                      loadTeamsList();
                                 }
                             });

                              // Group button container if needed, or append directly
                              li.appendChild(editButton);
                              li.appendChild(deleteButton);

                             ul.appendChild(li);
                         });
                         teamsListInModalDiv.appendChild(ul);
                     }
                 }


             } catch (e) {
                 console.error(`Chyba pri načítaní individuálnych tímov pre "${baseTeamName}": `, e);
                 teamsListInModalDiv.textContent = 'Chyba pri načítaní tímov.';
             }


             manageTeamsModal.style.display = 'block';
              // Focus is not typically set on this modal automatically
         }


         // === Funkcie pre CRUD operácie (Create, Read, Update, Delete) ===

         // Kategorí́e
         async function loadCategories() {
             const categoriesTableBody = document.querySelector('#categoriesTable tbody');
             if (!categoriesTableBody) { console.error("Categories table body not found!"); return; }

             categoriesTableBody.innerHTML = '<tr><td colspan="2">Načítavam kategórie...</td></tr>'; // Loading message

             try {
                 const querySnapshot = await getDocs(query(categoriesCollectionRef));
                 const categories = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                 console.log("Načítané kategórie pre tabuľku:", categories);

                 categoriesTableBody.innerHTML = ''; // Clear loading message

                 if (categories.length === 0) {
                     categoriesTableBody.innerHTML = '<tr><td colspan="2">Žiadne kategórie nenájdené.</td></tr>';
                 } else {
                     categories.forEach(category => {
                         const row = categoriesTableBody.insertRow();
                         row.insertCell(0).textContent = category.name;

                         const actionsCell = row.insertCell(1);

                         const editButton = document.createElement('button');
                         editButton.textContent = 'Upraviť';
                         editButton.addEventListener('click', () => {
                             openCategoryModal(category.id, category); // Open modal for editing
                         });

                         const deleteButton = document.createElement('button');
                         deleteButton.textContent = 'Vymazať';
                         deleteButton.addEventListener('click', async () => {
                             if (confirm(`Naozaj chcete vymazať kategóriu "${category.name}"? (Tým sa vymažú aj všetky skupiny a tímy v tejto kategórii!)`)) {
                                 await deleteCategory(category.id);
                                 loadCategories(); // Refresh table
                             }
                         });

                         actionsCell.appendChild(editButton);
                         actionsCell.appendChild(deleteButton);
                     });
                 }

                  // Po načítaní kategórií pre tabuľku, znova načítame aj pre dynamické selecty
                  // (ak už neboli načítané na začiatku hashchange)
                 loadAllCategoriesForDynamicSelects(); // Toto volá updateDynamicCategorySelects

             } catch (e) {
                 console.error("Chyba pri načítaní kategórií: ", e);
                 categoriesTableBody.innerHTML = '<tr><td colspan="2">Chyba pri načítaní kategórií.</td></tr>';
             }
         }

         async function saveCategory(id, data) {
             try {
                 if (id) {
                     // Update existing
                     await updateDoc(doc(categoriesCollectionRef, id), data);
                     console.log("Kategória úspešne aktualizovaná:", id);
                 } else {
                     // Add new
                     const docRef = await addDoc(categoriesCollectionRef, data);
                     console.log("Nová kategória úspešne pridaná s ID:", docRef.id);
                 }
                 // Po uložení znova načítame kategórie pre všetky dynamické selecty
                 loadAllCategoriesForDynamicSelects(); // Toto volá updateDynamicCategorySelects
             } catch (e) {
                 console.error("Chyba pri ukladaní kategórie: ", e);
                  // Tu by sme mohli pridať zobrazenie chybovej správy pre používateľa
                 alert("Nastala chyba pri ukladaní kategórie.");
             }
         }

         async function deleteCategory(id) {
             try {
                 // Pri mazaní kategórie je potrebné zvážiť mazanie súvisiacich skupín a tímov
                 // Toto by malo byť implementované ako transakcia alebo cloud funkcia pre robustnosť
                 // Pre zjednodušenie zatiaľ mažeme len samotnú kategóriu, ale v reálnej aplikácii by bolo nutné vyriešiť aj skupiny a tímy

                 // Jednoduché mazanie len dokumentu kategórie (potrebné rozšíriť)
                 await deleteDoc(doc(categoriesCollectionRef, id));
                 console.log("Kategória úspešne vymazaná:", id);

                 // Po zmazaní kategórie, znova načítame kategórie pre všetky dynamické selecty
                 // a tiež znova načítame skupiny a kluby, aby sa zohľadnili zmeny
                 loadAllCategoriesForDynamicSelects(); // Toto volá updateDynamicCategorySelects
                 loadGroups(); // Znova načíta skupiny
                 loadUnassignedClubs(); // Znova načíta nepriradené kluby
                 loadAssignedClubs(); // Znova načíta priradené kluby (tie v zmazanej kategórii zmiznú)
                 loadTeamsList(); // Znova načíta zoznam tímov


             } catch (e) {
                 console.error("Chyba pri mazaní kategórie: ", e);
                 alert("Nastala chyba pri mazaní kategórie.");
             }
         }


         // Skupiny
         async function loadGroups() {
             const groupsTableBody = document.querySelector('#groupsTable tbody');
             if (!groupsTableBody) { console.error("Groups table body not found!"); return; }

             groupsTableBody.innerHTML = '<tr><td colspan="3">Načítavam skupiny...</td></tr>'; // Loading message

             try {
                 // Pre zobrazenie skupín potrebujeme aj názvy kategórií,
                 // takže najprv načítame kategórie, ak ešte nie sú
                 if (allAvailableCategories.length === 0) {
                      await loadAllCategoriesForDynamicSelects(); // Toto volá updateDynamicCategorySelects
                 }

                 // Načítame skupiny z podkolekcií 'groups' pod každým dokumentom kategórie
                 let allGroups = [];
                 for (const category of allAvailableCategories) {
                      const groupQuery = query(collection(categoriesCollectionRef, category.id, 'groups'));
                      const querySnapshot = await getDocs(groupQuery);
                     querySnapshot.docs.forEach(doc => {
                         allGroups.push({
                             id: doc.id, // ID dokumentu skupiny
                             categoryId: category.id, // ID rodičovskej kategórie
                             categoryName: category.name, // Názov rodičovskej kategórie
                             ...doc.data() // Ostatné dáta skupiny (napr. name)
                         });
                     });
                 }


                 console.log("Načítané skupiny pre tabuľku:", allGroups);

                 groupsTableBody.innerHTML = ''; // Clear loading message

                 if (allGroups.length === 0) {
                     groupsTableBody.innerHTML = '<tr><td colspan="3">Žiadne skupiny nenájdené.</td></tr>';
                 } else {
                      // Voliteľné: Zotrieď skupiny podľa kategórie a potom podľa názvu skupiny
                     allGroups.sort((a, b) => {
                          const categoryCompare = a.categoryName.localeCompare(b.categoryName);
                         if (categoryCompare !== 0) return categoryCompare;
                         return a.name.localeCompare(b.name);
                     });


                     allGroups.forEach(group => {
                         const row = groupsTableBody.insertRow();
                         row.insertCell(0).textContent = group.categoryName; // Zobraz názov kategórie
                         row.insertCell(1).textContent = group.name; // Zobraz názov skupiny

                         const actionsCell = row.insertCell(2);

                         const editButton = document.createElement('button');
                         editButton.textContent = 'Upraviť';
                         editButton.addEventListener('click', () => {
                             // Pri úprave skupiny odovzdáme len ID skupiny (doc.id) a celé group dáta (vrátane categoryId)
                             openGroupModal(group.id, group); // Open modal for editing
                         });


                         const deleteButton = document.createElement('button');
                         deleteButton.textContent = 'Vymazať';
                         deleteButton.addEventListener('click', async () => {
                             if (confirm(`Naozaj chcete vymazať skupinu "${group.name}" v kategórii "${group.categoryName}"? (Tým sa zruší priradenie všetkých tímov z tejto skupiny!)`)) {
                                 // Pri mazaní skupiny je potrebné zvážiť odpriradenie tímov z tejto skupiny
                                 await deleteGroup(group.categoryId, group.id); // Potrebujeme aj ID kategórie pre cestu k podkolekcii
                                 loadGroups(); // Refresh table
                             }
                         });

                         actionsCell.appendChild(editButton);
                         actionsCell.appendChild(deleteButton);
                     });
                 }


             } catch (e) {
                 console.error("Chyba pri načítaní skupín: ", e);
                 groupsTableBody.innerHTML = '<tr><td colspan="3">Chyba pri načítaní skupín.</td></tr>';
             }
         }

         async function saveGroup(categoryId, groupId, groupData) { // categoryId needed for path
             try {
                  // Referencia na kolekciu skupín POD konkrétnou kategóriou
                 const groupsSubcollectionRef = collection(categoriesCollectionRef, categoryId, 'groups');

                 if (groupId) {
                     // Update existing (need full path including categoryId)
                     await updateDoc(doc(groupsSubcollectionRef, groupId), groupData);
                     console.log("Skupina úspešne aktualizovaná:", groupId, "v kategórii:", categoryId);
                 } else {
                     // Add new
                     const docRef = await addDoc(groupsSubcollectionRef, groupData);
                     console.log("Nová skupina úspešne pridaná s ID:", docRef.id, "v kategórii:", categoryId);
                 }
                  // Po uložení znova načítame skupiny pre tabuľku a prípadne aj kluby (ak boli priradené)
                 loadGroups();
                 loadUnassignedClubs(); // Ak by sa nejaké tímy zrušili/upravili pri úprave skupiny (nemalo by), znova ich načítame
                 loadAssignedClubs(); // Znova načíta priradené kluby (ak by sa niečo zmenilo)

             } catch (e) {
                 console.error("Chyba pri ukladaní skupiny: ", e);
                  // Tu by sme mohli pridať zobrazenie chybovej správy pre používateľa
                 alert("Nastala chyba pri ukladaní skupiny.");
             }
         }

         async function deleteGroup(categoryId, groupId) { // categoryId needed for path
              try {
                  // Referencia na konkrétnu skupinu
                 const groupDocRef = doc(categoriesCollectionRef, categoryId, 'groups', groupId);

                  // Pred vymazaním skupiny by sme mali "odpriradiť" všetky tímy, ktoré boli v tejto skupine
                 const clubsInGroupQuery = query(clubsCollectionRef, where("groupId", "==", groupId));
                 const querySnapshot = await getDocs(clubsInGroupQuery);
                 const batch = writeBatch(db); // Použijeme batch pre hromadnú operáciu

                  querySnapshot.docs.forEach((clubDoc) => {
                      // Aktualizujeme dokument klubu - nastavíme groupId a orderInGroup na null
                      const clubRef = doc(clubsCollectionRef, clubDoc.id);
                      batch.update(clubRef, {
                          groupId: null,
                          orderInGroup: null
                      });
                  });

                 // Vykonáme batch operáciu na odpriradenie klubov
                 await batch.commit();
                 console.log(`Úspešne odpriradených ${querySnapshot.size} tímov zo skupiny ${groupId}.`);


                  // Teraz môžeme vymazať dokument skupiny
                 await deleteDoc(groupDocRef);
                 console.log("Skupina úspešne vymazaná:", groupId);

                 // Po zmazaní skupiny, znova načítame skupiny pre tabuľku
                 loadGroups();
                  // Znova načítame aj nepriradené a priradené kluby, aby sa zmeny zohľadnili
                 loadUnassignedClubs();
                 loadAssignedClubs();

              } catch (e) {
                 console.error("Chyba pri mazaní skupiny: ", e);
                 alert("Nastala chyba pri mazaní skupiny.");
              }
         }


        // Tímy (Clubs)
        async function loadTeamsList() {
             const teamsListTableBody = document.querySelector('#teamsListTable tbody');
              if (!teamsListTableBody) { console.error("Teams List table body not found!"); return; }

             teamsListTableBody.innerHTML = '<tr><td colspan="4">Načítavam tímy...</td></tr>'; // Loading message

             try {
                 // Načítaj všetky kluby
                 const querySnapshot = await getDocs(query(clubsCollectionRef));
                 const clubs = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                 console.log("Načítané všetky tímy pre zoznam:", clubs);

                 teamsListTableBody.innerHTML = ''; // Clear loading message

                 if (clubs.length === 0) {
                     teamsListTableBody.innerHTML = '<tr><td colspan="4">Žiadne tímy nenájdené.</td></tr>';
                 } else {
                     // Zoskup tímy podľa baseTeamName a categoryId a spočítaj ich
                     const teamsSummary = clubs.reduce((acc, club) => {
                         const key = `${club.baseTeamName || 'Neznámy Názov'} - ${club.categoryId || 'Neznáma Kategória'}`;
                         if (!acc[key]) {
                             acc[key] = {
                                 baseTeamName: club.baseTeamName || 'Neznámy Názov',
                                 categoryId: club.categoryId || 'Neznáma Kategória',
                                 count: 0,
                                 // Uložíme si ID aspoň jedného klubu z tejto skupiny pre akcie
                                 sampleClubId: club.id
                             };
                         }
                         acc[key].count++;
                         return acc;
                     }, {});

                     // Prevedieme zhrnutie na pole pre jednoduchšie zobrazenie v tabuľke
                     const teamsSummaryArray = Object.values(teamsSummary);

                      // Voliteľné: Zotrieď podľa názvu tímu a potom kategórie
                      teamsSummaryArray.sort((a, b) => {
                         const nameCompare = a.baseTeamName.localeCompare(b.baseTeamName);
                         if (nameCompare !== 0) return nameCompare;
                          // Potrebujeme názov kategórie pre triedenie, nie ID
                          const categoryNameA = allAvailableCategories.find(cat => cat.id === a.categoryId)?.name || 'Neznáma Kategória';
                          const categoryNameB = allAvailableCategories.find(cat => cat.id === b.categoryId)?.name || 'Neznáma Kategória';
                          return categoryNameA.localeCompare(categoryNameB);
                      });


                     teamsSummaryArray.forEach(summary => {
                         const row = teamsListTableBody.insertRow();
                         row.insertCell(0).textContent = summary.baseTeamName;
                          // Zobraz názov kategórie namiesto ID
                         const categoryName = allAvailableCategories.find(cat => cat.id === summary.categoryId)?.name || 'Neznáma Kategória';
                         row.insertCell(1).textContent = categoryName;
                         row.insertCell(2).textContent = summary.count;

                         const actionsCell = row.insertCell(3);

                         // Tlačidlo na "Spravovať" (otvorí nový modál so zoznamom individuálnych tímov)
                         const manageButton = document.createElement('button');
                         manageButton.textContent = 'Spravovať';
                         manageButton.addEventListener('click', () => {
                             // Otvor nový modál na správu individuálnych tímov pre tento baseTeamName
                             openManageTeamsModal(summary.baseTeamName);
                         });

                          // TODO: Tlačidlo na vymazanie CELEJ skupiny tímov pod týmto názvom a kategóriou
                         // Vyžadovalo by to batch operáciu na vymazanie všetkých klubov s daným baseTeamName a categoryId
                          const deleteAllButton = document.createElement('button');
                          deleteAllButton.textContent = 'Vymazať Všetky';
                           deleteAllButton.style.backgroundColor = '#dc3545'; // Red style
                           deleteAllButton.style.marginLeft = '10px';
                          deleteAllButton.addEventListener('click', async () => {
                               if (confirm(`Naozaj chcete vymazať VŠETKY tímy s názvom "${summary.baseTeamName}" v kategórii "${categoryName}"?`)) {
                                   console.log(`Mazanie všetkých tímov s názvom "${summary.baseTeamName}" v kategórii "${categoryName}"`);
                                   await deleteAllClubsByBaseNameAndCategory(summary.baseTeamName, summary.categoryId); // Implement this function
                                    loadTeamsList(); // Refresh table
                                    loadUnassignedClubs(); // Refresh unassigned list as some might become unassigned if they were assigned
                                    loadAssignedClubs(); // Refresh assigned list
                               }
                          });


                         actionsCell.appendChild(manageButton);
                          actionsCell.appendChild(deleteAllButton);
                     });
                 }

             } catch (e) {
                 console.error("Chyba pri načítaní zoznamu tímov: ", e);
                 teamsListTableBody.innerHTML = '<tr><td colspan="4">Chyba pri načítaní zoznamu tímov.</td></tr>';
             }
        }

        async function deleteAllClubsByBaseNameAndCategory(baseTeamName, categoryId) {
             try {
                 const q = query(clubsCollectionRef,
                     where("baseTeamName", "==", baseTeamName),
                     where("categoryId", "==", categoryId) // Filter also by categoryId
                 );
                 const querySnapshot = await getDocs(q);
                 const batch = writeBatch(db);

                 querySnapshot.docs.forEach((clubDoc) => {
                     const clubRef = doc(clubsCollectionRef, clubDoc.id);
                     batch.delete(clubRef); // Add delete operation to the batch
                 });

                 await batch.commit();
                 console.log(`Úspešne vymazaných ${querySnapshot.size} tímov s názvom "${baseTeamName}" v kategórii "${categoryId}".`);

             } catch (e) {
                 console.error(`Chyba pri mazaní všetkých tímov s názvom "${baseTeamName}" v kategórii "${categoryId}": `, e);
                 alert(`Nastala chyba pri mazaní tímov s názvom "${baseTeamName}" v kategórii "${categoryId}".`);
             }
        }


         async function saveClub(id, data) {
              try {
                 if (id) {
                     // Update existing
                     await updateDoc(doc(clubsCollectionRef, id), data);
                     console.log("Klub úspešne aktualizovaný:", id);
                 } else {
                     // Add new club (should only be used for assigning an unassigned club)
                     // For creating new clubs, use createTeams function
                     // In add-assign mode, we are updating an existing unassigned club
                     console.error("SaveClub v add mode by nemal pridávať nový klub, len aktualizovať existujúci nepriradený!");
                     return; // Prevent adding new clubs via saveClub in this context
                 }
                  // Po uložení klubu (priradenie/úprava), znova načítame zoznamy klubov
                 loadUnassignedClubs(); // Načíta nepriradené
                 loadAssignedClubs(); // Načíta priradené
                 loadTeamsList(); // Aktualizuje zoznam tímov (zmení sa status priradenia)

              } catch (e) {
                 console.error("Chyba pri ukladaní klubu: ", e);
                 alert("Nastala chyba pri ukladaní klubu.");
              }
         }

          // Funkcia na odpriradenie tímu zo skupiny
         async function unassignClub(clubId) {
              try {
                 const clubRef = doc(clubsCollectionRef, clubId);
                  await updateDoc(clubRef, {
                      groupId: null,
                      orderInGroup: null // Also remove order when unassigned
                  });
                  console.log("Klub úspešne odpriradený:", clubId);

                  // Po odpriradení znova načítame zoznamy klubov
                 loadUnassignedClubs(); // Tím sa vráti do zoznamu nepriradených
                 loadAssignedClubs(); // Tím zmizne zo zoznamu priradených
                  loadTeamsList(); // Aktualizuje zoznam tímov (zmení sa status priradenia)

              } catch (e) {
                 console.error("Chyba pri odpriradení klubu: ", e);
                 alert("Nastala chyba pri odpriradení klubu.");
              }
         }

          // Funkcia na vymazanie individuálneho tímu (klubu)
          async function deleteClub(clubId) {
               try {
                  await deleteDoc(doc(clubsCollectionRef, clubId));
                   console.log("Klub úspešne vymazaný:", clubId);

                  // Po vymazaní znova načítame zoznamy klubov
                   loadUnassignedClubs();
                   loadAssignedClubs();
                   loadTeamsList(); // Aktualizuje zoznam tímov
               } catch (e) {
                   console.error("Chyba pri mazaní klubu: ", e);
                   alert("Nastala chyba pri mazaní klubu.");
               }
          }


         // Funkcia na načítanie nepriradených klubov (pre tabuľku v #timy-do-skupin sekcii)
         async function loadUnassignedClubs() {
             const unassignedClubsTableBody = document.querySelector('#unassignedClubsTable tbody');
             if (!unassignedClubsTableBody) { console.error("Unassigned clubs table body not found!"); return; }

             unassignedClubsTableBody.innerHTML = '<tr><td colspan="3">Načítavam nepriradené tímy...</td></tr>'; // Loading message


             try {
                 // Načítaj všetky kluby, ktoré nemajú groupId
                 const q = query(clubsCollectionRef, where("groupId", "==", null)); // Filter for clubs where groupId is null
                 const querySnapshot = await getDocs(q);
                 const unassignedClubs = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                 console.log("Načítané nepriradené tímy pre tabuľku:", unassignedClubs);

                 unassignedClubsTableBody.innerHTML = ''; // Clear loading message

                 if (unassignedClubs.length === 0) {
                     unassignedClubsTableBody.innerHTML = '<tr><td colspan="3">Žiadne nepriradené tímy nenájdené.</td></tr>';
                 } else {
                     // Pre zobrazenie názvu kategórie potrebujeme mať načítané kategórie
                     if (allAvailableCategories.length === 0) {
                          await loadAllCategoriesForDynamicSelects(); // Toto volá updateDynamicCategorySelects
                     }

                     // Voliteľné: Zotrieď nepriradené kluby podľa kategórie a potom názvu
                      unassignedClubs.sort((a, b) => {
                         const categoryNameA = allAvailableCategories.find(cat => cat.id === a.categoryId)?.name || 'Neznáma kategória';
                         const categoryNameB = allAvailableCategories.find(cat => cat.id === b.categoryId)?.name || 'Neznáma kategória';
                          const categoryCompare = categoryNameA.localeCompare(categoryNameB);
                         if (categoryCompare !== 0) return categoryCompare;
                         return a.name.localeCompare(b.name);
                      });


                     unassignedClubs.forEach(club => {
                         const row = unassignedClubsTableBody.insertRow();
                         row.insertCell(0).textContent = club.name;
                          const categoryName = allAvailableCategories.find(cat => cat.id === club.categoryId)?.name || 'Neznáma kategória';
                         row.insertCell(1).textContent = categoryName;

                         const actionsCell = row.insertCell(2);

                         // Tlačidlo "Priradiť do skupiny" (otvorí clubModal v add-assign móde pre tento klub)
                         const assignButton = document.createElement('button');
                         assignButton.textContent = 'Priradiť';
                         assignButton.addEventListener('click', () => {
                             // Otvor clubModal v add-assign móde pre tento konkrétny nepriradený klub
                             // Odovzdáme jeho ID a dáta
                             openClubModal(club.id, club); // openClubModal bez argumentov otvára MODAL pre NOVÝ nepriradený, s argumentami pre existujúci nepriradený/priradený
                         });

                         actionsCell.appendChild(assignButton);
                     });
                 }

                 // Po načítaní nepriradených klubov, znova naplníme select box v club modale (ak je otvorený alebo sa bude otvárať)
                 loadUnassignedClubsForSelect();


             } catch (e) {
                 console.error("Chyba pri načítaní nepriradených tímov: ", e);
                 unassignedClubsTableBody.innerHTML = '<tr><td colspan="3">Chyba pri načítaní nepriradených tímov.</td></tr>';
             }
         }

         // Funkcia na načítanie priradených klubov (pre zobrazenie v #timy-do-skupin sekcii)
         async function loadAssignedClubs() {
              const assignedClubsContainer = document.getElementById('assignedClubsContainer');
              if (!assignedClubsContainer) { console.error("Assigned clubs container not found!"); return; }

             assignedClubsContainer.innerHTML = 'Načítavam priradené tímy...'; // Loading message

              try {
                 // Načítaj všetky kluby, ktoré majú groupId (tzn. sú priradené)
                 const q = query(clubsCollectionRef, where("groupId", "!=", null)); // Filter for clubs where groupId is NOT null
                 const querySnapshot = await getDocs(q);
                 const assignedClubs = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                 console.log("Načítané priradené tímy:", assignedClubs);

                 assignedClubsContainer.innerHTML = ''; // Clear loading message

                 if (assignedClubs.length === 0) {
                     assignedClubsContainer.textContent = 'Žiadne kluby priradené do skupín nenájdené.'; // <--- Pôvodná logovacia správa bola tu (riadok 1431)
                 } else {
                      // Pre zobrazenie názvov potrebujeme mať načítané kategórie a skupiny
                     if (allAvailableCategories.length === 0) {
                          await loadAllCategoriesForDynamicSelects();
                     }
                     // TODO: Načítanie všetkých skupín by bolo efektívnejšie raz namiesto v cykle
                     // Zatiaľ predpokladáme, že populateGroupSelect načíta skupiny pre danú kategóriu

                      // Zoskup tímy podľa kategórie a potom podľa skupiny
                     const assignedClubsGrouped = assignedClubs.reduce((acc, club) => {
                          const categoryName = allAvailableCategories.find(cat => cat.id === club.categoryId)?.name || 'Neznáma kategória';
                         const groupName = club.groupId ? allAvailableCategories.find(cat => cat.id === club.categoryId)?.groups.find(group => group.id === club.groupId)?.name || 'Neznáma skupina' : 'Nepriradené'; // Find group name
                         const categoryKey = `${club.categoryId || 'unknown'} - ${categoryName}`;
                         const groupKey = `${club.groupId || 'unassigned'} - ${groupName}`;

                         if (!acc[categoryKey]) {
                             acc[categoryKey] = { name: categoryName, groups: {} };
                         }
                         if (!acc[categoryKey].groups[groupKey]) {
                             acc[categoryKey].groups[groupKey] = { name: groupName, clubs: [], groupDocId: club.groupId, categoryDocId: club.categoryId };
                         }
                         acc[categoryKey].groups[groupKey].clubs.push(club);
                         return acc;
                     }, {});


                     // Zobraz zoskupené tímy
                     // Sort categories by name
                     const sortedCategories = Object.keys(assignedClubsGrouped).sort((a, b) => assignedClubsGrouped[a].name.localeCompare(assignedClubsGrouped[b].name));


                     sortedCategories.forEach(categoryKey => {
                         const categoryData = assignedClubsGrouped[categoryKey];
                         const categoryHeading = document.createElement('h4');
                         categoryHeading.textContent = `Kategória: ${categoryData.name}`;
                         assignedClubsContainer.appendChild(categoryHeading);

                         // Sort groups within the category by name
                         const sortedGroups = Object.keys(categoryData.groups).sort((a, b) => categoryData.groups[a].name.localeCompare(categoryData.groups[b].name));


                         sortedGroups.forEach(groupKey => {
                              const groupData = categoryData.groups[groupKey];
                              const groupHeading = document.createElement('h5');
                             groupHeading.textContent = `Skupina: ${groupData.name}`;
                             assignedClubsContainer.appendChild(groupHeading);

                             // Sort clubs within the group by orderInGroup
                              groupData.clubs.sort((a, b) => (a.orderInGroup || Infinity) - (b.orderInGroup || Infinity));


                              const ul = document.createElement('ul');
                             ul.classList.add('assigned-clubs-list'); // Class for styling and drag/drop
                              ul.dataset.categoryId = groupData.categoryDocId; // Store category ID for drag/drop saving
                             ul.dataset.groupId = groupData.groupDocId; // Store group ID for drag/drop saving

                             // Add drag and drop listeners to the list
                             addDragAndDropListeners(ul);


                              groupData.clubs.forEach(club => {
                                 const li = document.createElement('li');
                                 li.classList.add('team-list-item'); // Apply flex styles
                                 li.dataset.clubId = club.id; // Store club ID for drag/drop
                                 li.draggable = true; // Make list item draggable

                                  const dragHandle = document.createElement('span');
                                  dragHandle.classList.add('drag-handle');
                                  dragHandle.textContent = '⠿'; // Drag handle icon
                                  li.appendChild(dragHandle);


                                  const teamNameSpan = document.createElement('span');
                                  teamNameSpan.textContent = `${club.name} (Poradie: ${club.orderInGroup || 'Nenastavené'})`; // Display name and order
                                  li.appendChild(teamNameSpan);


                                  // Tlačidlá Akcií (Upraviť, Odpriradiť)
                                  const editButton = document.createElement('button');
                                 editButton.textContent = 'Upraviť';
                                  editButton.classList.add('edit-team-button'); // Using edit style
                                  editButton.addEventListener('click', () => {
                                     // Otvor clubModal v edit móde pre tento konkrétny priradený klub
                                      openClubModal(club.id, club); // Open club modal in edit mode
                                 });


                                 const unassignButton = document.createElement('button');
                                 unassignButton.textContent = 'Odpriradiť';
                                 unassignButton.classList.add('unassign-team-button'); // Using unassign style
                                 unassignButton.addEventListener('click', async () => {
                                     if (confirm(`Naozaj chcete odpriradiť tím "${club.name}" zo skupiny "${groupData.name}"?`)) {
                                          console.log("Clicked Unassign for club:", club.name, club.id);
                                         await unassignClub(club.id); // Implement unassignClub function
                                          // loadAssignedClubs() and loadUnassignedClubs() are called inside unassignClub
                                     }
                                 });


                                  li.appendChild(editButton);
                                 li.appendChild(unassignButton);


                                  ul.appendChild(li);
                             });
                             assignedClubsContainer.appendChild(ul);
                         });
                     });
                 }


              } catch (e) {
                 console.error("Chyba pri načítaní priradených tímov: ", e);
                 assignedClubsContainer.textContent = 'Chyba pri načítaní priradených tímov.';
              }
         }


         // Drag and Drop pre priradené tímy
         let draggedItem = null;

         function addDragAndDropListeners(listElement) {
             if (!listElement) {
                 console.error("Cannot add drag and drop listeners: list element is null.");
                 return;
             }

             listElement.addEventListener('dragstart', (e) => {
                 // Set the data to be dragged (e.g., club ID)
                 draggedItem = e.target;
                  e.dataTransfer.effectAllowed = 'move';
                 e.dataTransfer.setData('text/plain', draggedItem.dataset.clubId);

                  // Add a class for styling the dragged item
                 setTimeout(() => { // Use timeout to allow the ghost image to be created first
                      draggedItem.classList.add('dragging');
                 }, 0);
             });

             listElement.addEventListener('dragover', (e) => {
                 // Prevent default to allow drop
                 e.preventDefault();
                 e.dataTransfer.dropEffect = 'move';

                 // Add a visual indicator where the item will be dropped
                 const targetItem = e.target.closest('li.team-list-item');
                 if (targetItem && targetItem !== draggedItem) {
                      const rect = targetItem.getBoundingClientRect();
                      const middleY = rect.top + rect.height / 2;

                      // Determine if dropping before or after the target item
                      if (e.clientY < middleY) {
                          targetItem.classList.add('drag-over-top');
                          targetItem.classList.remove('drag-over-bottom');
                      } else {
                           targetItem.classList.add('drag-over-bottom');
                           targetItem.classList.remove('drag-over-top');
                      }
                 } else if (targetItem === null && listElement.children.length === 0) {
                     // Handle dropping into an empty list
                     listElement.classList.add('drag-over-empty');
                 }


             });

              listElement.addEventListener('dragleave', (e) => {
                  // Remove the visual indicator
                   e.target.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-empty');
              });


             listElement.addEventListener('drop', async (e) => {
                 // Prevent default action (open as link)
                 e.preventDefault();

                 // Remove the visual indicator
                 e.target.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-empty');

                 const targetItem = e.target.closest('li.team-list-item');
                  const dropList = e.target.closest('ul.assigned-clubs-list'); // The list element where dropped

                 if (draggedItem && dropList) {
                     const clubId = draggedItem.dataset.clubId; // Get the ID of the dragged club
                     const newCategoryId = dropList.dataset.categoryId; // Get the category ID of the target list
                     const newGroupId = dropList.dataset.groupId; // Get the group ID of the target list

                      // Determine the new position (order)
                      let newOrder = dropList.children.length + 1; // Default to end if dropping into empty or at the end
                       const items = Array.from(dropList.children);
                       const targetIndex = targetItem ? items.indexOf(targetItem) : items.length; // Index of the target item

                       if (targetItem && targetItem !== draggedItem) {
                            const rect = targetItem.getBoundingClientRect();
                           const middleY = rect.top + rect.height / 2;

                           if (e.clientY < middleY) {
                               // Dropping before targetItem
                                newOrder = targetIndex + 1;
                           } else {
                                // Dropping after targetItem
                                newOrder = targetIndex + 2; // Insert after, so order is target's index + 2
                           }
                       } else if (targetItem === null && items.length > 0) {
                            // Dropping into the whitespace of a non-empty list - default to end
                             newOrder = items.length + 1;
                       } else if (targetItem === null && items.length === 0) {
                            // Dropping into an empty list
                             newOrder = 1;
                       }


                      console.log(`Dropped club ID ${clubId} into Category ID ${newCategoryId}, Group ID ${newGroupId}. Proposed new order: ${newOrder}`);

                     // Update the club's data in Firestore
                     try {
                          const clubRef = doc(clubsCollectionRef, clubId);
                         await updateDoc(clubRef, {
                             categoryId: newCategoryId,
                              groupId: newGroupId,
                             orderInGroup: newOrder
                         });
                          console.log(`Club ${clubId} data updated successfully.`);

                         // After successful update, reload the assigned clubs list to reflect changes
                         loadAssignedClubs(); // This will re-fetch, sort, and display

                     } catch (e) {
                          console.error(`Error updating club ${clubId} data during drag and drop: `, e);
                          alert("Nastala chyba pri presúvaní tímu.");
                          // If update fails, refresh to revert the visual change
                          loadAssignedClubs();
                     }

                 }

             });

             listElement.addEventListener('dragend', (e) => {
                 // Remove the dragging class from the dragged item
                  if (draggedItem) {
                     draggedItem.classList.remove('dragging');
                     draggedItem = null; // Clear the dragged item reference
                  }
                 // Clean up any drag-over classes just in case
                  document.querySelectorAll('.drag-over-top, .drag-over-bottom, .drag-over-empty').forEach(el => {
                      el.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-empty');
                 });

             });
         }


        // === Funkcie pre hromadné vytvorenie tímov ===

         // Globálna premenná na uloženie kategórií pre dynamické selecty vo formulári vytvorenia tímov
         // allAvailableCategories sa používa aj inde, toto je len pre istotu ak by bol nejaký edge case
         let teamCreationCategories = [];

         // Aktualizuje select boxy kategórií v dynamicky pridávaných dvojiciach kategória/počet
         function updateTeamCreationCategorySelects() {
              const selects = teamCategoryCountContainer.querySelectorAll('select[name="teamCategory"]');
              selects.forEach(selectElement => {
                 const currentValue = selectElement.value; // Zapamätáme si aktuálnu hodnotu

                 // Clear current options except maybe a default one if needed
                 selectElement.innerHTML = ''; // Clear existing options

                 // Add default option (optional for these selects, but good practice)
                 const defaultOption = document.createElement('option');
                 defaultOption.value = "";
                 defaultOption.textContent = "-- Vyberte kategóriu --";
                 selectElement.appendChild(defaultOption);


                 // Ensure all categories are loaded before populating
                 if (allAvailableCategories.length === 0) {
                      console.warn("updateTeamCreationCategorySelects: Kategórie ešte nie sú načítané. Dynamické selecty budú prázdne.");
                      return; // Nemôžeme naplniť, ak nemáme kategórie
                 }

                 // Sort categories alphabetically by name
                 allAvailableCategories.sort((a, b) => a.name.localeCompare(b.name));


                 allAvailableCategories.forEach(category => {
                     const option = document.createElement('option');
                     option.value = category.id; // Document ID is the value
                     option.textContent = category.name;
                      // Ak sa aktuálna hodnota zhoduje s touto kategóriou, nastav ju ako vybranú
                      if (currentValue && category.id === currentValue) {
                          option.selected = true;
                      }
                     selectElement.appendChild(option);
                 });

                  // Ak aktuálna hodnota bola nastavená, ale už neexistuje v zozname, zresetujeme ju
                 if (currentValue && !allAvailableCategories.find(cat => cat.id === currentValue)) {
                      selectElement.value = ""; // Reset na predvolenú možnosť
                      console.warn(`updateTeamCreationCategorySelects: Predtým zvolená kategória "${currentValue}" už neexistuje. Resetujem select.`);
                 }


             });

         }


         // Funkcia na pridanie novej dvojice kategória/počet tímov do formulára hromadného vytvorenia
         async function addCategoryCountPair(setFocus = true) {
              if (!teamCategoryCountContainer) { console.error("teamCategoryCountContainer element not found!"); return; }
               if (!allAvailableCategories || allAvailableCategories.length === 0) {
                   console.warn("Nemôžem pridať kategória/počet dvojicu - kategórie nie sú načítané.");
                   // Skús načítať kategórie a potom znovu zavolaj funkciu? Alebo požiadaj užívateľa, aby skúsil znova
                   // Ak by sme volali loadAllCategoriesForDynamicSelects(), tá volá updateDynamicCategorySelects, čo by mohlo viesť k rekurzii
                   // Lepšie je zabezpečiť načítanie kategórií PRED volaním tejto funkcie
                   await loadAllCategoriesForDynamicSelects(); // Zabezpečí načítanie a zavolá updateDynamicCategorySelects
                   // Po načítaní skús pridať dvojicu znovu (ak sú kategórie)
                   if (allAvailableCategories.length > 0) {
                       console.log("Kategórie načítané, pridávam dvojicu.");
                        addCategoryCountPair(setFocus); // Volaj znovu, teraz by mali byť kategórie dostupné
                   }
                   return; // Ukončíme aktuálne vykonávanie, aby sa predišlo duplicitnému pridaniu
               }

              const pairDiv = document.createElement('div');
              pairDiv.classList.add('category-count-pair'); // Apply flex styles

              const categorySelect = document.createElement('select');
              categorySelect.name = 'teamCategory';
              categorySelect.required = true;
               // Naplní tento nový select kategóriami (volá updateDynamicCategorySelects na konci)
               populateCategorySelect(categorySelect, true); // true = include default option


              const countInput = document.createElement('input');
              countInput.type = 'number';
              countInput.name = 'teamCount';
              countInput.required = true;
              countInput.min = '1';
              countInput.value = '1'; // Default value

              const removeButton = document.createElement('button');
              removeButton.type = 'button';
              removeButton.textContent = 'Odstrániť';
               removeButton.classList.add('remove-category-pair-button');
              removeButton.addEventListener('click', () => {
                  pairDiv.remove(); // Remove the pair when button is clicked
                  updateRemoveButtonVisibility(); // Check if remove buttons should be visible
                  checkIfAddCategoryButtonShouldBeVisible(); // Check if add button should be visible
              });

              pairDiv.appendChild(categorySelect);
              pairDiv.appendChild(countInput);
              pairDiv.appendChild(removeButton); // Add remove button to the pair

              teamCategoryCountContainer.appendChild(pairDiv);

               // Aktualizujeme viditeľnosť tlačidiel po pridaní novej dvojice
               updateRemoveButtonVisibility();
               checkIfAddCategoryButtonShouldBeVisible(); // Po pridaní dvojice môže byť potrebné skryť + tlačidlo


               // Nastavíme focus na novú pridanú kategóriu, ak je to potrebné
               if (setFocus) {
                   categorySelect.focus();
               }

         }

         // Funkcia na aktualizáciu viditeľnosti tlačidiel "Odstrániť" (skryť prvému prvku, ak je jediný)
         function updateRemoveButtonVisibility() {
              const pairs = teamCategoryCountContainer.querySelectorAll('.category-count-pair');
              pairs.forEach((pair, index) => {
                  const removeButton = pair.querySelector('.remove-category-pair-button');
                 if (removeButton) {
                      // Skryjeme tlačidlo odstrániť, ak je to jediná dvojica
                      removeButton.style.display = pairs.length === 1 ? 'none' : 'inline-block';
                 }
              });
         }

         // Funkcia na kontrolu, či by malo byť viditeľné tlačidlo "Pridať ďalšiu kategóriu"
         // Zobrazí sa len ak počet pridaných dvojíc je menší ako celkový počet dostupných kategórií
         function checkIfAddCategoryButtonShouldBeVisible() {
              if (!addCategoryCountPairButton) { console.error("addCategoryCountPairButton not found!"); return; }
              const currentPairsCount = teamCategoryCountContainer.querySelectorAll('.category-count-pair').length;
              const totalCategoriesCount = allAvailableCategories.length;

              // Tlačidlo sa zobrazí, ak je počet dvojíc menší ako počet kategórií A kategórie sú načítané
              if (totalCategoriesCount > 0 && currentPairsCount < totalCategoriesCount) {
                  addCategoryCountPairButton.style.display = 'inline-block';
              } else {
                  addCategoryCountPairButton.style.display = 'none'; // Skryjeme tlačidlo ak už sú všetky kategórie pridané alebo kategórie nie sú načítané
              }
         }


         // Funkcia na hromadné vytvorenie tímov
         async function createTeams(baseName, teamCounts) { // teamCounts is an array of { categoryId: '...', count: N }
              if (!baseName || baseName.trim() === "") {
                  console.warn("Základný názov tímu chýba.");
                  displayMessage(teamCreationMessageArea, "Základný názov tímu je povinný.", 'error');
                  return;
              }
              if (!teamCounts || teamCounts.length === 0) {
                  console.warn("Neboli zadané žiadne kategórie alebo počty tímov.");
                   displayMessage(teamCreationMessageArea, "Zadajte aspoň jednu kategóriu a počet tímov.", 'error');
                  return;
              }

              // Validácia, či sú všetky kategórie vybrané a počty platné (> 0)
              const validTeamCounts = teamCounts.filter(tc => tc.categoryId && tc.count > 0);
              if (validTeamCounts.length !== teamCounts.length) {
                  console.warn("Niektoré kategórie nie sú vybrané alebo počty tímov sú neplatné.");
                  displayMessage(teamCreationMessageArea, "Skontrolujte výber kategórií a zadané počty tímov.", 'error');
                   // Zvýrazniť nevalidné polia (voliteľné, vyžadovalo by pridanie logiky pre validáciu UI)
                  return;
              }


               displayMessage(teamCreationMessageArea, "Vytváram tímy...", 'success'); // Zobrazíme správu o priebehu
               const batch = writeBatch(db); // Použijeme batch pre hromadné zápisy

              let totalTeamsCreated = 0;

              validTeamCounts.forEach(tc => {
                  for (let i = 1; i <= tc.count; i++) {
                      const teamName = tc.count > 1 ? `${baseName} ${String.fromCharCode(64 + i)}` : baseName; // Napr. "Tím A", "Tím B" alebo len "Tím" ak je 1
                      const newClubRef = doc(clubsCollectionRef); // Vytvoríme novú referenciu s automatickým ID
                      batch.set(newClubRef, { // Použijeme set s referenciou s ID
                          name: teamName,
                          baseTeamName: baseName, // Uložíme aj základný názov pre zoskupenie
                          categoryId: tc.categoryId,
                          groupId: null, // Nové tímy sú nepriradené
                          orderInGroup: null // Nové tímy nemajú poradie
                          // Prípadne ďalšie polia, ak budú potrebné (napr. hala, coach, atď.)
                      });
                      totalTeamsCreated++;
                  }
              });

              try {
                 await batch.commit(); // Vykonaj hromadný zápis
                  console.log(`Úspešne vytvorených ${totalTeamsCreated} tímov.`);
                  displayMessage(teamCreationMessageArea, `Úspešne vytvorených ${totalTeamsCreated} tímov.`, 'success');

                 // Po úspešnom vytvorení, znova načítame zoznam tímov a nepriradené tímy
                  loadTeamsList();
                  loadUnassignedClubs();

                 // Voliteľné: Automaticky zatvor modál po úspechu (alebo po kliknutí na OK)
                 // setTimeout(() => {
                 //      closeAllModals();
                 // }, 2000); // Zatvor po 2 sekundách

              } catch (e) {
                 console.error("Chyba pri hromadnom vytváraní tímov: ", e);
                  displayMessage(teamCreationMessageArea, "Nastala chyba pri vytváraní tímov. Skúste to znovu.", 'error');
                  // Tu by sme nemali volať loadFunctions, pretože tímy sa nemuseli vytvoriť
              }
         }

         // Funkcia na zobrazenie správy v oblasti správ
         function displayMessage(messageAreaElement, message, type) { // type can be 'success' or 'error'
              if (!messageAreaElement) {
                 console.error("Message area element not found!");
                 return;
              }
              messageAreaElement.textContent = message;
              messageAreaElement.className = 'message-area'; // Reset classes
              messageAreaElement.classList.add(type); // Add success or error class
              messageAreaElement.style.display = 'block'; // Show the message area

              // Voliteľné: Automaticky skryť správu po niekoľkých sekundách (ak nie je chybová)
              // if (type !== 'error') {
              //     setTimeout(() => {
              //          messageAreaElement.style.display = 'none';
              //     }, 5000); // Skryť po 5 sekundách
              // }
         }


        // === Event Listeners ===

        // Spoločná obsluha kliknutia na tlačidlo Pridať (+)
        if (addButton) {
            addButton.addEventListener('click', () => {
                const hash = window.location.hash;
                 console.log("Add button clicked in hash:", hash); // Debug log

                switch (hash) {
                    case '#kategorie':
                        openCategoryModal(); // Open modal in add mode
                        break;
                    case '#skupiny':
                        openGroupModal(); // Open modal in add mode
                        break;
                     case '#zoznam-timov':
                         openTeamCreationModal(); // Open modal for creating teams
                        break;
                     case '#timy-do-skupin':
                          // Open club modal in add-assign mode (select an unassigned club)
                         // We open the modal without arguments, loadUnassignedClubsForSelect is called inside
                         openClubModal();
                         console.log("Opening club modal (add-assign mode)."); // Debug log
                        break;
                    // Pridaj ďalšie prípady pre iné sekcie, ak budú mať tlačidlo Pridať
                    default:
                        console.warn("Add button clicked in section without defined add action.");
                }
            });
        }


        // Event listeners pre zatvorenie modálov na kliknutie na 'X' alebo tlačidlo 'Zrušiť'
        // Pridané nulové kontroly, aby sa zabránilo chybám, ak elementy neexistujú
         if (categoryModalCloseBtn) categoryModalCloseBtn.addEventListener('click', closeAllModals);
         if (groupModalCloseBtn) groupModalCloseBtn.addEventListener('click', closeAllModals);
         if (clubModalCloseBtn) clubModalCloseBtn.addEventListener('click', closeAllModals);
         if (teamCreationModalCloseBtn) teamCreationModalCloseBtn.addEventListener('click', closeAllModals);
         if (manageTeamsModalCloseBtn) manageTeamsModalCloseBtn.addEventListener('click', closeAllModals); // Listener pre nový modal

         // Event listener pre zatvorenie modálov na kliknutie mimo modál content
         window.addEventListener('click', (event) => {
             if (event.target === categoryModal) {
                 closeAllModals();
             }
              if (event.target === groupModal) {
                 closeAllModals();
              }
              if (event.target === clubModal) {
                  closeAllModals();
              }
               if (event.target === teamCreationModal) {
                   closeAllModals();
               }
                if (event.target === manageTeamsModal) {
                   closeAllModals();
               }
         });


        // Event listener pre odoslanie formulára Kategórie
        if (categoryForm) {
            categoryForm.addEventListener('submit', async (e) => {
                e.preventDefault(); // Prevent default form submission
                const categoryName = categoryNameInput.value.trim();

                if (categoryName) {
                    const categoryData = {
                        name: categoryName
                        // Add any other category properties here
                    };
                     await saveCategory(editingCategoryId, categoryData);
                     closeAllModals(); // Close modal after saving
                     loadCategories(); // Refresh the list
                } else {
                    alert("Názov kategórie nemôže byť prázdny.");
                }
            });
        }


         // Event listener pre odoslanie formulára Skupiny
         if (groupForm) {
             groupForm.addEventListener('submit', async (e) => {
                 e.preventDefault(); // Prevent default form submission
                 const categoryId = groupCategorySelect.value; // Get selected category ID
                 const groupName = groupNameInput.value.trim();

                  // TODO: Pridať validáciu, či už skupina s daným názvom v danej kategórii neexistuje


                 if (categoryId && groupName) {
                     const groupData = {
                         name: groupName,
                         // categoryId je už známe
                         // Add any other group properties here
                     };
                     await saveGroup(categoryId, editingGroupId, groupData); // Pass categoryId as well
                     closeAllModals(); // Close modal after saving
                     // loadGroups() is called inside saveGroup
                 } else {
                     alert("Vyberte kategóriu a zadajte názov skupiny.");
                 }
             });
         }

          // Event listener pre zmenu výberu kategórie vo formulári skupiny (naplní select skupín)
          if (groupCategorySelect && groupForm) { // Kontrola, či existujú oba elementy a formulár
             groupCategorySelect.addEventListener('change', async () => {
                  const categoryId = groupCategorySelect.value;
                   if (groupGroupSelect) { // Kontrola existencie selectu skupín
                       if (categoryId) {
                           await populateGroupSelect(groupGroupSelect, categoryId, true); // Naplň select skupín pre vybranú kategóriu
                           groupGroupSelect.disabled = false; // Povoľ select skupín
                       } else {
                            // Ak sa nevybrala kategória, zablokuj select skupín
                           groupGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
                           groupGroupSelect.disabled = true;
                       }
                   } else {
                       console.error("Group group select element not found!");
                   }
             });
          } else {
              if (!groupCategorySelect) console.warn("Group category select element not found for change listener.");
              if (!groupForm) console.warn("Group form element not found for change listener.");
          }


         // Event listener pre odoslanie formulára Klubu (pre priradenie/úpravu)
         if (clubForm) {
             clubForm.addEventListener('submit', async (e) => {
                 e.preventDefault(); // Prevent default form submission

                  // Validácia vstupov podľa aktuálneho módu
                  let isValid = true;
                  const clubName = clubNameInput.value.trim(); // Used in edit mode
                  const unassignedClubId = unassignedClubSelect.value; // Used in add-assign mode
                  const categoryId = clubCategorySelect.value;
                  const groupId = clubGroupSelect.value;
                  const orderInGroup = orderInGroupInput.value ? parseInt(orderInGroupInput.value) : null; // Can be null


                  // Reset validation messages
                  clubForm.querySelectorAll('.validation-message').forEach(msg => msg.textContent = '');


                 if (currentClubModalMode === 'add-assign') {
                      // Validácia pre pridanie/priradenie nepriradeného klubu
                     if (!unassignedClubId) {
                         document.getElementById('unassignedClubSelectContainer').querySelector('.validation-message').textContent = 'Vyberte tím.';
                         isValid = false;
                     }
                     if (!categoryId) {
                         document.getElementById('clubCategoryValidationMessage').textContent = 'Vyberte kategóriu.';
                         isValid = false;
                     }
                      // Skupina je povinná len ak existujú skupiny v danej kategórii A select nie je disabled
                     if (clubGroupSelect && !clubGroupSelect.disabled && !groupId) {
                          document.getElementById('clubGroupValidationMessage').textContent = 'Vyberte skupinu.';
                         isValid = false;
                     }
                      // Poradie je povinné len ak je input viditeľný a nie je vyplnený (napr. pri drag and drop je poradie handled inak)
                      if (orderInputContainer.style.display !== 'none' && (orderInGroup === null || isNaN(orderInGroup))) {
                           document.getElementById('orderInGroupValidationMessage').textContent = 'Zadajte platné poradie.';
                           isValid = false;
                       }


                 } else if (currentClubModalMode === 'edit') {
                     // Validácia pre úpravu priradeného klubu (meno by nemalo byť editable, ale pre istotu)
                      if (!clubName) {
                           document.getElementById('clubNameValidationMessage').textContent = 'Názov tímu chýba.';
                           isValid = false;
                       }
                      if (!categoryId) { // Kategória by nemala byť editable, ale pre validáciu
                           document.getElementById('clubCategoryValidationMessage').textContent = 'Kategória chýba.';
                           isValid = false;
                       }
                       // Skupina je povinná ak je select povolený
                       if (clubGroupSelect && !clubGroupSelect.disabled && !groupId) {
                            document.getElementById('clubGroupValidationMessage').textContent = 'Vyberte skupinu.';
                           isValid = false;
                       }
                       // Poradie je povinné ak je input viditeľný
                       if (orderInputContainer.style.display !== 'none' && (orderInGroup === null || isNaN(orderInGroup))) {
                            document.getElementById('orderInGroupValidationMessage').textContent = 'Zadajte platné poradie.';
                           isValid = false;
                       }


                 }


                 if (!isValid) {
                      console.warn("Validácia formulára klubu zlyhala.");
                      // Zobrazenie chybových správ je už handled v rámci validácie vyššie
                      return; // Zastavíme odoslanie formulára
                 }


                 if (currentClubModalMode === 'add-assign') {
                     // === Logic for ASSIGNING an UNASSIGNED club to a group ===
                     // We need the ID of the UNASSIGNED club selected in the select box
                     const clubToAssignId = unassignedClubSelect.value; // This is the ID of the club document
                     // We need the target group and category IDs
                     const targetCategoryId = clubCategorySelect.value;
                     const targetGroupId = clubGroupSelect.value;
                      const targetOrderInGroup = orderInGroupInput.value ? parseInt(orderInGroupInput.value) : null; // Get order if visible


                     if (clubToAssignId && targetCategoryId && targetGroupId) {
                         // Find the selected unassigned club's data (mainly for its name and baseName)
                         const selectedUnassignedClubData = allAvailableClubs.find(club => club.id === clubToAssignId);
                         if (!selectedUnassignedClubData) {
                             console.error("Selected unassigned club data not found!");
                             alert("Chyba: Dáta vybraného tímu sa nenašli.");
                             return;
                         }

                         // Update the existing club document in Firestore
                         const clubRef = doc(clubsCollectionRef, clubToAssignId);
                         await updateDoc(clubRef, {
                             categoryId: targetCategoryId,
                             groupId: targetGroupId,
                             orderInGroup: targetOrderInGroup // Assign the order
                             // Name, baseTeamName should not change
                         });

                         console.log(`Tím ${selectedUnassignedClubData.name} (ID: ${clubToAssignId}) úspešne priradený do skupiny ${targetGroupId} v kategórii ${targetCategoryId} s poradím ${targetOrderInGroup}.`);
                         closeAllModals(); // Close modal after successful assignment
                         // loadUnassignedClubs() and loadAssignedClubs() are called inside saveClub (which we are effectively doing with updateDoc)
                          loadUnassignedClubs(); // Refresh nepriradené (zmizne z neho)
                          loadAssignedClubs(); // Refresh priradené (objaví sa v ňom)
                          loadTeamsList(); // Refresh zoznam tímov (zmení sa status)

                     } else {
                         console.warn("Chýbajú údaje pre priradenie tímu.");
                         // Validácia vyššie by mala zabrániť tomuto stavu, ale pre istotu
                         alert("Vyberte tím, kategóriu a skupinu.");
                     }


                 } else if (currentClubModalMode === 'edit' && editingClubId) {
                     // === Logic for EDITING an ASSIGNED or UNASSIGNED club ===
                     // When editing, we are primarily updating its category, group, and order
                     // Name and baseName are readOnly in edit mode

                     const targetCategoryId = clubCategorySelect.value; // Get category ID (might be disabled, but still has value)
                     const targetGroupId = clubGroupSelect.value; // Get group ID
                     const targetOrderInGroup = orderInGroupInput.value ? parseInt(orderInGroupInput.value) : null; // Get order

                     // Ak už bol tím priradený a meníme mu skupinu/kategóriu, alebo poradie
                      // Ak bol tím nepriradený a meníme mu (napr.) len kategóriu (ak by bolo povolené)
                      // V aktuálnej implementácii edit módu sa otvára len pre priradené tímy z #timy-do-skupin sekcie.
                      // Ak editujeme priradený tím, môžeme meniť jeho group a order. Kategóriu zatiaľ nemeníme.

                      console.log(`Editácia klubu ID: ${editingClubId}. Nová kategória: ${targetCategoryId}, nová skupina: ${targetGroupId}, nové poradie: ${targetOrderInGroup}`);


                      // Aktualizujeme dokument klubu v Firestore
                      const clubRef = doc(clubsCollectionRef, editingClubId);
                      await updateDoc(clubRef, {
                         // categoryId: targetCategoryId, // Kategóriu zatiaľ neumožňujeme meniť v edit móde
                          groupId: targetGroupId, // Skupinu môžeme zmeniť
                          orderInGroup: targetOrderInGroup // Poradie môžeme zmeniť
                      });

                     console.log(`Klub ID ${editingClubId} úspešne aktualizovaný (skupina/poradie).`);
                      closeAllModals(); // Close modal after successful update
                      // loadAssignedClubs() will refresh the list with the new group/order
                       loadAssignedClubs();
                       // loadUnassignedClubs() will also refresh (though this edit won't change assignment status)
                       loadUnassignedClubs();
                       loadTeamsList(); // Refresh list (status won't change, but good practice)


                 } else {
                      console.error("Club form submitted in unknown mode or without editing ID.");
                      alert("Nastala chyba pri spracovaní formulára klubu.");
                 }
             });
         }

         // Event listener pre zmenu výberu nepriradeného klubu vo formulári klubu (add-assign mód)
         if (unassignedClubSelect && clubForm) { // Kontrola, či existujú oba elementy a formulár
              unassignedClubSelect.addEventListener('change', async () => {
                   const selectedClubId = unassignedClubSelect.value;
                   console.log("Unassigned club select changed. Selected ID:", selectedClubId);

                  // Zresetujeme select kategórií a skupín a zablokujeme skupinový select
                   if (clubCategorySelect) {
                        // Nastavíme hodnotu kategórie na základe dát selectedUnassignedClubData
                        // Najprv nájdeme dáta vybraného klubu
                       const selectedUnassignedClubData = allAvailableClubs.find(club => club.id === selectedClubId);
                        if (selectedUnassignedClubData) {
                             console.log("Selected unassigned club data found:", selectedUnassignedClubData);
                             clubCategorySelect.value = selectedUnassignedClubData.categoryId || ''; // Nastavíme kategóriu

                             // Po nastavení kategórie naplníme a povolíme select skupín
                             if (clubGroupSelect) {
                                 if (selectedUnassignedClubData.categoryId) {
                                     await populateGroupSelect(clubGroupSelect, selectedUnassignedClubData.categoryId, true);
                                     clubGroupSelect.disabled = false; // Povolíme select skupín
                                     orderInputContainer.style.display = 'block'; // Show order input when category/group selected
                                      orderInGroupInput.disabled = false; // Enable order input
                                 } else {
                                      console.warn("Selected unassigned club has no category ID.");
                                      clubGroupSelect.innerHTML = '<option value="">-- Kategória neznáma --</option>';
                                      clubGroupSelect.disabled = true;
                                      orderInputContainer.style.display = 'none'; // Hide order input if no category
                                      orderInGroupInput.disabled = true;
                                 }
                             } else {
                                 console.error("Club group select element not found after unassigned club select change.");
                             }

                        } else {
                             console.warn("Data for selected unassigned club not found in allAvailableClubs.");
                             // Reset category/group selects if data is missing
                             if (clubCategorySelect) clubCategorySelect.value = "";
                             if (clubGroupSelect) {
                                 clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
                                 clubGroupSelect.disabled = true;
                                 orderInputContainer.style.display = 'none'; // Hide order input
                                 orderInGroupInput.disabled = true;
                             }
                        }

                   } else {
                       console.error("Club category select element not found after unassigned club select change.");
                   }


              });
         } else {
              if (!unassignedClubSelect) console.warn("Unassigned club select element not found for change listener.");
               if (!clubForm) console.warn("Club form element not found for change listener.");
         }


          // Event listener pre zmenu výberu kategórie vo formulári klubu (add-assign mód)
          // Tento listener je dôležitý na naplnenie selectu skupín po zmene kategórie
         if (clubCategorySelect && clubForm && unassignedClubSelectContainer.style.display !== 'none') { // Uisti sa, že ide o add-assign mód
              // Pridáme listener len ak je select kategórie povolený (tzn. nie sme v edit móde, kde je disabled)
              if (!clubCategorySelect.disabled) {
                 clubCategorySelect.addEventListener('change', async () => {
                     const categoryId = clubCategorySelect.value;
                      console.log("Club modal category select changed. Selected category ID:", categoryId);

                      // Naplníme a povolíme select skupín pre vybranú kategóriu
                      if (clubGroupSelect) {
                           if (categoryId) {
                                await populateGroupSelect(clubGroupSelect, categoryId, true);
                                clubGroupSelect.disabled = false; // Povolíme select skupín
                                orderInputContainer.style.display = 'block'; // Show order input when category/group selected
                                orderInGroupInput.disabled = false; // Enable order input
                           } else {
                               // Ak sa nevybrala kategória, zablokuj select skupín
                               clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
                               clubGroupSelect.disabled = true;
                               orderInputContainer.style.display = 'none'; // Hide order input
                               orderInGroupInput.disabled = true;
                           }
                      } else {
                          console.error("Club group select element not found after category select change.");
                      }

                 });
              }
          } else {
               if (!clubCategorySelect) console.warn("Club category select element not found for change listener (category in club modal).");
               if (!clubForm) console.warn("Club form element not found for change listener (category in club modal).");
          }


         // Event listener pre odoslanie formulára hromadného vytvorenia tímov
         if (teamCreationForm) {
              teamCreationForm.addEventListener('submit', async (e) => {
                   e.preventDefault(); // Prevent default form submission

                   const baseName = baseTeamNameInput.value.trim();
                   const teamCounts = []; // Array to store { categoryId, count }

                   const pairs = teamCategoryCountContainer.querySelectorAll('.category-count-pair');
                   let isValid = true;

                   // Validácia a zber dát z dynamicky pridaných dvojíc
                   pairs.forEach(pair => {
                        const categorySelect = pair.querySelector('select[name="teamCategory"]');
                        const countInput = pair.querySelector('input[name="teamCount"]');
                         const validationMessageSpan = pair.querySelector('.validation-message'); // Assuming a span for message per pair

                         // Reset validation message for this pair
                         if (validationMessageSpan) validationMessageSpan.textContent = '';


                        const categoryId = categorySelect ? categorySelect.value : '';
                        const count = countInput ? parseInt(countInput.value) : 0;


                       if (!categoryId) {
                           isValid = false;
                           if (categorySelect) { // Zobraz chybu priamo pri selecte
                                // Ak nie je validation span, pridaj ho
                                if (!validationMessageSpan) {
                                     const span = document.createElement('span');
                                     span.classList.add('validation-message');
                                     pair.appendChild(span);
                                     span.textContent = 'Vyberte kategóriu.';
                                } else {
                                    validationMessageSpan.textContent = 'Vyberte kategóriu.';
                                }
                           }
                       }

                       if (isNaN(count) || count <= 0) {
                           isValid = false;
                           if (countInput) { // Zobraz chybu priamo pri inpute
                                // Ak nie je validation span, pridaj ho
                                 if (!validationMessageSpan) {
                                     const span = document.createElement('span');
                                     span.classList.add('validation-message');
                                     pair.appendChild(span);
                                     span.textContent = 'Zadajte platný počet (>0).';
                                 } else {
                                     // Ak uz je tam sprava z kategórie, pridaj aj tuto
                                     validationMessageSpan.textContent += (validationMessageSpan.textContent ? ' / ' : '') + 'Zadajte platný počet (>0).';
                                 }
                           }
                       }

                       if (isValid && categoryId && count > 0) { // Ak je daná dvojica platná
                           teamCounts.push({ categoryId, count });
                       }

                   }); // Koniec forEach pairs

                   // Validácia základného názvu
                    if (!baseName) {
                         const validationSpan = document.getElementById('baseTeamNameValidationMessage');
                          if (validationSpan) validationSpan.textContent = 'Základný názov tímu je povinný.';
                         isValid = false;
                    }


                   if (!isValid) {
                       console.warn("Validácia formulára hromadného vytvorenia zlyhala.");
                       displayMessage(teamCreationMessageArea, "Prosím, skontrolujte označené polia.", 'error'); // Zobraz celkovú chybovú správu
                       return; // Zastavíme odoslanie formulára
                   }

                   if (teamCounts.length === 0) {
                        console.warn("Žiadne platné dvojice kategória/počet neboli zadané.");
                       displayMessage(teamCreationMessageArea, "Zadajte aspoň jednu platnú dvojicu kategória a počet tímov.", 'error');
                       return; // Zastavíme odoslanie formulára
                   }


                  // Ak validácia prešla, voláme funkciu na vytvorenie tímov
                  await createTeams(baseName, teamCounts);

                 // Po odoslaní formulára (aj pri chybe zápisu do DB) zresetujeme formulár
                 // Ak by sme ho zresetovali len pri úspechu, pri chybe by užívateľ stratil zadané údaje
                 // Lepšie je resetovať formulár len po úspešnom zatvorení modálu
                 // closeAllModals(); // Zatvor modál (voliteľné)

              });
         }


         // Načíta kategórie pri prvom načítaní stránky, aby boli dostupné pre dynamické selecty
         // Táto funkcia sa volá aj pri hashchange
        // loadAllCategoriesForDynamicSelects(); // Už sa volá v toggleContentDisplay


        // Pri prvom načítaní stránky (alebo po refreshi) nastav hash, ak nie je nastavený
        // window.addEventListener('load', ...) už to robí hore


        // === Spustenie aplikácie ===
        // Inicializácia a prvotné zobrazenie obsahu sa deje cez onAuthStateChanged listener,
        // ktorý volá toggleContentDisplay. loadAllCategoriesForDynamicSelects je volaná v toggleContentDisplay.


        // Pri načítaní stránky pridáme prvú dvojicu kategória/počet do formulára hromadného vytvorenia
        // Toto by sa malo stať, keď sa Team Creation Modal otvorí prvýkrát, nie hneď pri načítaní
        // addCategoryCountPair(); // Odstránené - volá sa teraz pri otvorení modálu

         // Event listener pre zatvorenie modálu hromadného vytvorenia - resetuje formulár
         // Tento listener je už pridaný na closeAllModals, len sa uisti, že TeamCreation form reset je v closeAllModals

         // Ensure the first category/count pair is added when the modal is opened
         // This logic is now inside openTeamCreationModal


         // Update remove button visibility on initial load (if already in #zoznam-timov and has pairs)
         // This is handled by updateRemoveButtonVisibility call inside updateTeamCreationCategorySelects


         // Check if add category button should be visible on initial load
         // This is handled by checkIfAddCategoryButtonShouldBeVisible call inside loadAllCategoriesForDynamicSelects and updateTeamCreationCategorySelects


        // Ensure initial state of remove buttons and add button is set when modal is opened
        // This logic is now within openTeamCreationModal and addCategoryCountPair


         // Example of how to manually trigger loading if needed (for testing)
         // loadCategories();
         // loadGroups();
         // loadTeamsList();
         // loadUnassignedClubs();
         // loadAssignedClubs();

         // Pri prvom zobrazení sekcie #zoznam-timov by sa mal pridať prvý prázdny pár
         // Toto je teraz integrované do openTeamCreationModal
         // A zabezpečené v hideAllSections pri resete teamCreationForm

    </script>

</body>
</html>
