<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Správca turnaja</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">

    <style>
        /* --- General Styles --- */
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-top: 20px;
            margin-bottom: 20px; /* Added margin-bottom for separation */
        }

        h2 {
            margin-top: 0; /* Reset margin-top, controlled by section padding */
            margin-bottom: 10px;
            color: #555;
        }

        .add-button {
            display: block;
            margin: 20px auto;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #28a745;
            color: white;
            font-size: 2em;
            border: none;
            cursor: pointer;
            text-align: center;
            line-height: 50px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
            position: sticky;
            top: 20px;
            z-index: 10;
        }

        .add-button:hover {
            background-color: #218838;
        }

        .content-wrapper {
            display: flex;
            margin-top: 20px;
            padding: 0 20px;
        }

        .left-menu {
            width: 200px;
            margin-right: 20px;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 90px;
            align-self: flex-start;
            max-height: calc(100vh - 110px);
            overflow-y: auto;
        }

        .left-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .left-menu li {
            margin-bottom: 10px;
        }

        .left-menu a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
            display: block;
            padding: 5px 0;
            transition: color 0.3s ease;
        }

        .left-menu a:hover {
            color: #0056b3;
        }

        main {
            flex-grow: 1;
            padding: 0;
            box-shadow: none;
            background-color: transparent;
        }

        /* --- Section Block Style --- */
        .section-block {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px; /* Space below each block */
        }


        /* --- Table Styles --- */
        /* Styles for the table element itself, regardless of the wrapper */
        #categoryTable, .category-group-table, .group-clubs-table, #clubsTable, #createdTeamsTable {
            border-collapse: collapse;
            width: 100%;
            border: none;
            overflow: hidden;
        }


        /* Style for the section wrapping category heading and group table */
        .category-group-section {
            /* Inherits background, padding, radius, shadow from .section-block */
            /* Flex properties only for group sections when inside #groupsContent */
            min-width: 300px;
            flex-grow: 1;
            flex-basis: 0;
        }

        /* Style for the main container of group sections (the flex container) */
        #groupsContent {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
            padding: 0;
            margin-bottom: 20px;
        }
         #groupsContent .section-block {
             margin-bottom: 0; /* Override margin for flex items */
         }


        /* Remove margin-top from the first element inside a section block */
        .section-block h2:first-child,
        .section-block table:first-child {
            margin-top: 0;
        }


        /* Table Header and Cell Styles - apply to all tables */
        #categoryTable th, #clubsTable th, .category-group-table th, .group-clubs-table th, #createdTeamsTable th {
            background-color: #f2f2f2;
            color: #333;
            font-weight: bold;
            text-align: left;
            padding: 12px 15px;
            border-bottom: 2px solid #ddd;
        }

        #categoryTable td, #clubsTable td, .category-group-table td, .group-clubs-table td, #createdTeamsTable td {
            text-align: left;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }

        /* Remove bottom border from last row in tbody for all tables */
        #categoryTable tbody tr:last-child td,
        #clubsTable tbody tr:last-child td,
        .category-group-table tbody tr:last-child td,
        .group-clubs-table tbody tr:last-child td,
        #createdTeamsTable tbody tr:last-child td {
             border-bottom: none;
        }

        /* Hover effect for all table rows */
        #categoryTable tbody tr:hover,
        #clubsTable tbody tr:hover,
        .category-group-table tbody tr:hover,
        .group-clubs-table tbody tr:hover,
        #createdTeamsTable tbody tr:hover {
            background-color: #f9f9f9;
            cursor: pointer;
        }

        /* Ensure last cell in row doesn't wrap buttons */
        #categoryTable td:last-child,
        #clubsTable td:last-child,
        .category-group-table td:last-child,
        .group-clubs-table td:last-child,
        #createdTeamsTable td:last-child {
             white-space: nowrap;
        }

        #clubsContent {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
            padding: 0;
            margin-bottom: 20px;
        }

        /* Style for container divs that wrap club sections when inside #clubsContent */
        #clubsContent .section-block {
            /* Inherits background, padding, radius, shadow from .section-block */
            min-width: 300px;
            flex-grow: 1;
            flex-basis: calc(33.33% - 20px);
            margin-bottom: 0; /* Override the default .section-block margin when inside flex */
        }

        #teamCreationContentSection table {
            /* Ensure table within section block takes full width */
             width: 100%;
        }

        /* Style for number count in the created teams table */
        #createdTeamsTable td {
             text-align: center; /* Center the count numbers */
             width: 50px; /* Give count columns a fixed width */
        }
         #createdTeamsTable td:first-child {
              text-align: left; /* Keep team name left-aligned */
              width: auto; /* Let team name take available width */
         }
          #createdTeamsTable th {
               text-align: center; /* Center header text for categories */
               white-space: nowrap; /* Prevent text wrapping in headers */
          }
          #createdTeamsTable th:first-child {
               text-align: left; /* Keep team name header left-aligned */
          }

          /* Style for the dynamically added sub-rows */
           #createdTeamsTable tr.sub-row td {
                background-color: #e9ecef; /* Slightly different background */
                font-size: 0.9em; /* Smaller font */
                padding-left: 35px; /* Indent the text */
                border-top: none; /* Remove top border */
                border-bottom: 1px dotted #ccc; /* Dotted border below sub-row */
           }

           #createdTeamsTable tr.sub-row:last-child td {
                border-bottom: 1px solid #eee; /* Restore standard border for the last sub-row before next main row */
           }

           #createdTeamsTable tr.sub-row td:not(:first-child) {
                /* Keep category cells empty or add specific info if needed */
                text-align: center; /* Center the '1' or empty */
                font-weight: normal;
           }
            #createdTeamsTable tr.sub-row td:first-child {
                 font-weight: normal; /* Normal font weight for the sub-team name */
            }

           /* Optional: Style for clickable count cells */
           #createdTeamsTable td[data-team-count]:not([data-team-count=""]):not([data-team-count="0"]) {
                cursor: pointer;
                text-decoration: underline;
                color: #007bff;
           }
           #createdTeamsTable td[data-team-count]:not([data-team-count=""]):not([data-team-count="0"]):hover {
                color: #0056b3;
           }


        /* --- Action Button Styles --- */
        .action-button {
            padding: 5px 10px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .action-button:not(.delete-button) {
            background-color: #007bff;
            color: white;
        }

        .action-button.delete-button {
            background-color: #dc3545;
            color: white;
        }

        .action-button:not(.delete-button):hover { background-color: #0056b3; }
        .action-button.delete-button:hover { background-color: #c82333; }


        /* --- Modal Styles --- */
         .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
         }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }

        .close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover, .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content form label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

         .modal-content form input[type="text"],
         .modal-content form input[type="number"],
         .modal-content form select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
         }
         /* Adjust select height for multiple */
         .modal-content form select[multiple] {
              min-height: 100px; /* Or adjust as needed */
         }


        .modal-content form button {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

         .modal-content form button:hover {
            background-color: #218838;
         }

         /* Style for the container divs around specific form elements */
         .modal-content form div {
             margin-bottom: 20px; /* Add spacing below input groups */
         }
         .modal-content form div:last-of-type {
              margin-bottom: 0; /* Remove bottom margin for the last one before the button */
         }
          .modal-content form label,
          .modal-content form input[type="text"],
          .modal-content form input[type="number"],
          .modal-content form select {
              margin-bottom: 0; /* Remove margin from elements inside the div */
          }

          /* Style for dynamically added field groups */
          .category-count-group {
              border: 1px solid #ddd;
              padding: 15px;
              margin-bottom: 15px;
              border-radius: 4px;
              background-color: #f9f9f9;
              position: relative; /* Needed for absolute positioning of remove button */
          }

          .category-count-group .remove-group-button {
              position: absolute;
              top: 5px;
              right: 5px;
              background: none;
              border: none;
              font-size: 1.2em;
              color: #dc3545;
              cursor: pointer;
          }

          .category-count-group .remove-group-button:hover {
              color: #c82333;
          }


</style>
 </head>
 <body>
     <script>
         // Basic check for admin, redirect if not
         const userName = localStorage.getItem('username');
         if (userName !== 'admin') {
              window.location.href = 'login.html';
         }
     </script>

     <h1>Správca turnaja</h1>

     <button class="add-button" id="addButton" title="Pridať položku">+</button>

     <div class="modal" id="categoryModal">
         <div class="modal-content">
             <span class="close category-modal-close">&times;</span>
             <h2 id="categoryModalTitle">Pridať kategóriu</h2>
             <form id="categoryForm">
                 <div>
                     <label for="categoryName">Názov kategórie:</label>
                     <input type="text" id="categoryName" name="categoryName" required>
                 </div>
                 <button type="submit">Uložiť</button>
             </form>
         </div>
     </div>

      <div class="modal" id="groupModal">
          <div class="modal-content">
                  <span class="close group-modal-close">&times;</span>
                  <h2 id="groupModalTitle">Pridať skupinu</h2>
                  <form id="groupForm">
                      <div>
                           <label for="groupCategory">Kategória:</label>
                           <select id="groupCategory" name="groupCategory" required>
                                <option value="">-- Vyberte kategóriu --</option>
                                </select>
                      </div>

                      <div>
                           <label for="groupName">Názov skupiny:</label>
                           <input type="text" id="groupName" name="groupName" required>
                      </div>

                      <button type="submit">Uložiť</button>
                  </form>
          </div>
      </div>

     <div class="modal" id="clubModal">
          <div class="modal-content">
                  <span class="close club-modal-close">&times;</span>
                  <h2 id="clubModalTitle">Priradiť tím do skupiny</h2> <form id="clubForm">
                        <div id="unassignedClubSelectContainer">
                           <label for="unassignedClubSelect">Vyberte existujúci tím:</label>
                           <select id="unassignedClubSelect"> <option value="">-- Vyberte tím na priradenie --</option>
                                </select>
                       </div>

                       <div id="clubNameInputContainer">
                           <label for="clubName">Názov klubu:</label>
                           <input type="text" id="clubName" name="clubName" required>
                        </div>

                       <div>
                           <label for="clubCategory">Kategória:</label>
                           <select id="clubCategory" name="clubCategory" required>
                                <option value="">-- Vyberte kategóriu --</option>
                                </select>
                       </div>

                       <div>
                            <label for="clubGroup">Skupina:</label>
                            <select id="clubGroup" name="clubGroup" required disabled> <option value="">-- Najprv vyberte kategóriu --</option>
                                 </select>
                       </div>

                        <button type="submit">Uložiť</button>
                   </form>
          </div>
      </div>

     <div class="modal" id="teamCreationModal">
         <div class="modal-content">
             <span class="close team-creation-modal-close">&times;</span>
             <h2 id="teamCreationModalTitle">Vytvoriť tímy</h2>
             <form id="teamCreationForm">
                 <div>
                     <label for="teamNameInput">Názov tímu (napr. 'MŠK IUVENTA Michalovce'):</label>
                     <input type="text" id="teamNameInput" name="teamName" required>
                 </div>

                 <div class="category-count-group" id="initialCategoryCountGroup">
                     <label for="teamCategorySelect">Kategória:</label> <select id="teamCategorySelect" name="teamCategory" required> <option value="">-- Vyberte kategóriu --</option>
                     </select>

                     <label for="teamCountInput">Počet tímov:</label> <input type="number" id="teamCountInput" name="teamCount" min="1" value="1" required>
                 </div>

                 <div id="dynamicCategoryCountContainer">
                     </div>

                 <button type="button" id="addCategoryCountPairButton" class="action-button">+ Pridať ďalšiu kategóriu</button>


                 <button type="submit">Vytvoriť</button>
             </form>
         </div>
     </div>


     <div class="content-wrapper">
         <nav class="left-menu">
             <ul>
                 <li><a href="#kategorie">Vytvorenie kategórií</a></li>
                 <li><a href="#skupiny">Vytvorenie skupín</a></li>
                 <li><a href="#vytvorenie-timov">Vytvorenie tímov</a></li> <li><a href="#timy-do-skupin">Tímy do skupín</a></li>
                 <li><a href="#sportove-haly">Športové haly</a></li>
                 <li><a href="#sprava-turnaja">Správa turnaja</a></li>
                 <li><a href="#nastavenia">Nastavenia</a></li>
             </ul>
         </nav>

         <main>
             <div id="categoriesContentSection" class="section-block" style="display: none;">
                  <h2>Vytvorenie kategórií</h2>
                 <table id="categoryTable">
                     <thead>
                         <tr>
                             <th>Názov</th>
                             <th style="width: 150px;">Upraviť</th>
                         </tr>
                     </thead>
                     <tbody id="categoryTableBody">
                         </tbody>
                 </table>
             </div>

             <div id="groupsContent" style="display: none;">
                 </div>

             <div id="clubsContent" style="display: none;">
                  </div>

              <div id="teamCreationContentSection" class="section-block" style="display: none;">
                  <h2>Vytvorenie tímov</h2>
                  <table id="createdTeamsTable">
                      <thead>
                          </thead>
                      <tbody id="createdTeamsTableBody">
                          </tbody>
                  </table>
             </div>

             </main>
     </div>


<script type="module">
         // Import potrebných Firebase Firestore funkcií priamo z CDN
         import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
         import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, where, addDoc, updateDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';
         // Import FieldPath pre query podľa ID dokumentu v clubForm submit handleri
         import { FieldPath } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';


         // Tvoja Firebase konfigurácia
         const firebaseConfig = {
             apiKey: "AIzaSyD0h0rQZiIGi0-UDb4-YU_JihRGpIlfz40", // ZMEŇ ZA SVOJ SKUTOČNÝ API KĽÚČ
             authDomain: "turnaj-a28c5.firebaseapp.com", // ZMEŇ ZA SVOJ SKUTOČNÝ authDomain
             projectId: "turnaj-a28c5", // ZMEŇ ZA SVOJ SKUTOČNÝ projectId
             storageBucket: "turnaj-a28c5.firebaseystorage.app", // ZMEŇ ZA SVOJ SKUTOČNÝ storageBucket
             messagingSenderId: "13732191148", // ZMEŇ ZA SVOJ SKUTOČNÝ messagingSenderId
             appId: "1:13732191148:web:5ad78eaef2ad452a10f809" // ZMEŇ ZA SVOJ SKUTOČNÝ appId
         };

         // Inicializácia Firebase aplikácie
         const app = initializeApp(firebaseConfig);
         // Získanie inštancie Firestore databázy
         const db = getFirestore(app);

         // Referencia na kolekcie
         const categoriesCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'categories');
         const groupsCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'groups'); // Groups use composite IDs
         const clubsCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'clubs'); // Clubs now use auto-generated IDs


         // Získame referencie na DOM elementy
         const addButton = document.getElementById('addButton');

         // Modál Kategórie
         const categoryModal = document.getElementById('categoryModal');
         const categoryModalCloseBtn = categoryModal.querySelector('.category-modal-close');
         const categoryForm = document.getElementById('categoryForm');
         const categoryNameInput = document.getElementById('categoryName');
         const categoryModalTitle = document.getElementById('categoryModalTitle');

         // Modál Skupiny
         const groupModal = document.getElementById('groupModal');
         const groupModalCloseBtn = groupModal.querySelector('.group-modal-close');
         const groupForm = document.getElementById('groupForm');
         const groupCategorySelect = document.getElementById('groupCategory');
         const groupNameInput = document.getElementById('groupName');
         const groupModalTitle = document.getElementById('groupModalTitle');
         const groupFormSubmitButton = groupForm.querySelector('button[type="submit"]');

         // Modál Kluby (pre priradenie do skupín)
         const clubModal = document.getElementById('clubModal');
         const clubModalCloseBtn = clubModal.querySelector('.club-modal-close');
         const clubForm = document.getElementById('clubForm');
         const clubNameInput = document.getElementById('clubName'); // Existing name input (used when editing assigned)
         const clubCategorySelect = document.getElementById('clubCategory');
         const clubGroupSelect = document.getElementById('clubGroup');
         const clubModalTitle = document.getElementById('clubModalTitle');
         const clubFormSubmitButton = clubForm.querySelector('button[type="submit"]');

         // NEW REFERENCES FOR CLUB MODAL CHANGES (add/edit assigned)
         const unassignedClubSelectContainer = document.getElementById('unassignedClubSelectContainer');
         const unassignedClubSelect = document.getElementById('unassignedClubSelect');
         const clubNameInputContainer = document.getElementById('clubNameInputContainer');


         // NEW: Modál Vytvorenie Tímov
         const teamCreationModal = document.getElementById('teamCreationModal');
         const teamCreationModalCloseBtn = teamCreationModal.querySelector('.team-creation-modal-close');
         const teamCreationForm = document.getElementById('teamCreationForm');
         const teamNameInput = document.getElementById('teamNameInput'); // Input for base team name

         // References for the initial category/count fields
         const initialCategoryCountGroup = document.getElementById('initialCategoryCountGroup');
         const teamCategorySelect = document.getElementById('teamCategorySelect'); // Initial Category select
         const teamCountInput = document.getElementById('teamCountInput'); // Initial Count input

         // Reference for the container of dynamic fields
         const dynamicCategoryCountContainer = document.getElementById('dynamicCategoryCountContainer');
         // Reference for the button to add more fields
         const addCategoryCountPairButton = document.getElementById('addCategoryCountPairButton');


         const teamCreationModalTitle = document.getElementById('teamCreationModalTitle');


         // Zobrazované sekcie (obalové divy)
         const categoriesContentSection = document.getElementById('categoriesContentSection'); // Obalový div pre kategórie
         const groupsContentDiv = document.getElementById('groupsContent'); // Flex kontajner pre skupiny
         const clubsContentDiv = document.getElementById('clubsContent'); // Flex kontajner pre kluby v skupinách (priradené)
         // NEW: Obalový div pre sekciu Vytvorenie Tímov (nepriradené)
         const teamCreationContentSection = document.getElementById('teamCreationContentSection');


         // Referencie na samotné tabuľky (pre manipuláciu s tbody)
         const categoryTable = document.getElementById('categoryTable');
         const categoryTableBody = document.getElementById('categoryTableBody');

         // NEW: Referencia na tbody tabuľky Vytvorenie Tímov a thead
         const createdTeamsTable = document.getElementById('createdTeamsTable'); // Added reference to the table itself
         const createdTeamsTableHead = createdTeamsTable.querySelector('thead'); // Added reference to thead
         const createdTeamsTableBody = document.getElementById('createdTeamsTableBody');


         // Premenné stavu modálov
         let currentCategoryModalMode = 'add';
         let editingCategoryName = null;

         let currentGroupModalMode = 'add';
         let editingGroupId = null; // Kompozitné ID upravovanej skupiny

         // NEW: Premenné stavu pre modál Kluby (Priradenie/Úprava)
         let currentClubModalMode = 'add-assign'; // Default mode: 'add-assign' or 'edit-assigned'
         let editingClubId = null; // Auto-generated ID of the club document being edited


         // NEW: Premenné stavu pre modál Vytvorenie Tímov (zatiaľ len 'add')
         let currentTeamCreationModalMode = 'add';

         // NEW: Cache pre zoznam všetkých kategórií
         let allCategories = [];


         // --- Funkcia na prepínanie zobrazenia obsahu ---
         // THIS FUNCTION IS MOVED UP HERE
         function toggleContentDisplay() {
              const hash = window.location.hash;
              console.log("Navigating to hash:", hash);

              // Skryť všetky dynamické oblasti a modály
              addButton.style.display = 'none';
              categoriesContentSection.style.display = 'none';
              groupsContentDiv.style.display = 'none';
              clubsContentDiv.style.display = 'none';
              teamCreationContentSection.style.display = 'none';

              categoryModal.style.display = 'none';
              groupModal.style.display = 'none';
              clubModal.style.display = 'none';
              teamCreationModal.style.display = 'none';


              // Vyčistiť obsah dynamických oblastí
              categoryTableBody.innerHTML = '';
              groupsContentDiv.innerHTML = '';
              clubsContentDiv.innerHTML = '';
              createdTeamsTableBody.innerHTML = '';


              // Reset modal states and forms when navigating away
               currentCategoryModalMode = 'add'; editingCategoryName = null;
               categoryForm.reset();

               currentGroupModalMode = 'add'; editingGroupId = null;
               groupForm.reset();

               // Reset club modal state (add/edit assigned)
               currentClubModalMode = 'add-assign'; editingClubId = null; // Reset to add-assign mode
               clubForm.reset();
               // Ensure the correct input/select is shown/hidden when modal opens next time
               unassignedClubSelectContainer.style.display = 'block';
               clubNameInputContainer.style.display = 'none';


               // Reset team creation modal state
               currentTeamCreationModalMode = 'add';
               teamCreationForm.reset();
                // Clear dynamic fields when navigating away
               dynamicCategoryCountContainer.innerHTML = '';
                // Repopulate the initial category select
               populateCategorySelect(teamCategorySelect, null, []); // Pass empty array for excluded


              if (hash === '#kategorie') {
                  addButton.style.display = 'block';
                  categoriesContentSection.style.display = 'block';
                  loadCategoriesTable();
                  addButton.title = "Pridať kategóriu";
              } else if (hash === '#skupiny') {
                  addButton.style.display = 'block';
                  groupsContentDiv.style.display = 'flex';
                  displayGroupsByCategory();
                  addButton.title = "Pridať skupinu";
              } else if (hash === '#vytvorenie-timov') {
                  addButton.style.display = 'block';
                  teamCreationContentSection.style.display = 'block';
                  displayCreatedTeams();
                  addButton.title = "Vytvoriť tímy";
              }
              else if (hash === '#timy-do-skupin') {
                  addButton.style.display = 'block';
                  clubsContentDiv.style.display = 'flex';
                  displayClubs(); // Load and display assigned clubs
                  // The '+' button in this section is for assigning an UNASSIGNED team
                  addButton.title = "Priradiť tím do skupiny";
              }
              // Add cases for other sections if needed (#sportove-haly, #sprava-turnaja, #nastavenia)
              // else if (hash === '#sportove-haly') { ... }
              // else if (hash === '#sprava-turnaja') { ... }
              // else if (hash === '#nastavenia') { ... }
              else {
                  // Default or unimplemented sections
                  addButton.style.display = 'none';
                  addButton.title = "Pridať položku"; // Default title
                  console.log("Neznáma alebo neimplementovaná sekcia, zobrazujem prázdny obsah.");
              }
         }


         // --- Funkcie pre Kategórie ---
         function addCategoryRowToTable(categoryName) {
              const tr = document.createElement('tr');
              const nameTd = document.createElement('td');
              nameTd.textContent = categoryName;
              const actionsTd = document.createElement('td');
              actionsTd.style.whiteSpace = 'nowrap';

              const renameButton = document.createElement('button');
              renameButton.textContent = 'Premenovať';
              renameButton.classList.add('action-button');
              renameButton.onclick = function() {
                  currentCategoryModalMode = 'edit';
                  editingCategoryName = categoryName;
                  categoryModalTitle.textContent = 'Premenovať kategóriu';
                  categoryNameInput.value = categoryName;
                  categoryModal.style.display = 'block';
                  categoryNameInput.focus();
              };


              const deleteButton = document.createElement('button');
              deleteButton.textContent = 'Vymazať';
              deleteButton.classList.add('action-button', 'delete-button');
              deleteButton.onclick = async function() {
                   const categoryToDelete = this.closest('tr').querySelector('td:first-child').textContent;

                   if (!confirm(`Naozaj chcete vymazať kategóriu "${categoryToDelete}"? Akékoľvek priradené skupiny a kluby prídu o svoju kategóriu (categoryId a groupId sa nastavia na null)!`)) {
                       return;
                   }

                   try {
                       // Pred zmazaním kategórie, nájdi a aktualizuj všetky kluby a skupiny, ktoré na ňu odkazujú
                       const batch = writeBatch(db);

                       // Nájdi a aktualizuj skupiny s touto kategóriou
                       const groupsQuery = query(groupsCollectionRef, where('categoryId', '==', categoryToDelete));
                       const groupsSnapshot = await getDocs(groupsQuery);

                        // Fetch clubs related to groups being deleted *before* starting the batch queries within the loop
                        const clubUpdates = [];
                        for (const groupDoc of groupsSnapshot.docs) {
                            const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', groupDoc.id));
                            const clubsSnapshot = await getDocs(clubsInGroupQuery);
                            clubsSnapshot.forEach(clubDoc => {
                                 // Use the new composite group ID for the update
                                const oldGroupId = groupDoc.id; // e.g., "OldCategory - GroupA"
                                const groupData = groupDoc.data(); // NOTE: This should be groupDoc.data(), not clubDoc.data() if using group name for new ID.
                                                                  // If simply deleting category, clubs in groups related to this category should lose group *and* category references.
                                // Let's simplify: if category deleted, clubs lose both references.
                                clubUpdates.push({ ref: clubDoc.ref, updates: { categoryId: null, groupId: null } }); // Update club with null categoryId and null groupId
                                 console.log(`Klub "${clubDoc.id}" odpriradený kvôli zmazaniu skupiny.`);
                            });
                             // Add group deletion to batch
                            batch.delete(groupDoc.ref); // Delete old group doc
                            console.log(`Stará skupina "${groupDoc.id}" zmazaná po premenovaní kategórie.`); // Clarified log
                        }

                        // Add club updates to batch
                        clubUpdates.forEach(item => {
                            batch.update(item.ref, item.updates);
                        });


                       // Nájdi a aktualizuj kluby s touto kategóriou, ktoré už nemusia byť priradené k skupine (groupId == null)
                       const unassignedClubsQuery = query(clubsCollectionRef, where('categoryId', '==', categoryToDelete), where('groupId', '==', null));
                        const unassignedClubsSnapshot = await getDocs(unassignedClubsQuery);
                        unassignedClubsSnapshot.forEach(doc => {
                            batch.update(doc.ref, { categoryId: null }); // Just update categoryId to null
                            console.log(`Nepriradený klub "${doc.id}" aktualizovaný (categoryId).`);
                        });


                       // Nakoniec zmaž samotnú kategóriu
                       batch.delete(doc(categoriesCollectionRef, categoryToDelete)); // Delete old category doc using old name

                       await batch.commit();

                       console.log(`Kategória "${categoryToDelete}" a súvisiace referencie boli úspešne zmazané/aktualizované.`);

                       // Refresh displays that might be affected
                        loadCategoriesTable(); // Always refresh category table
                        if (window.location.hash === '#skupiny') displayGroupsByCategory();
                        if (window.location.hash === '#timy-do-skupin') displayClubs();
                        if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();

                        // Refresh cached categories after deletion
                        cacheAllCategories();


                   } catch (error) {
                       console.error('Chyba pri mazaní kategórie a súvisiacich dát: ', error);
                       alert('Chyba pri mazaní kategórie! Prosím, skúste znova.');
                       // Close modal and reset state on error
                       categoryModal.style.display = 'none'; categoryForm.reset();
                       currentCategoryModalMode = 'add'; editingCategoryName = null;
                   }
              };

              actionsTd.appendChild(renameButton);
              actionsTd.appendChild(deleteButton);
              tr.appendChild(nameTd);
              tr.appendChild(actionsTd);
              categoryTableBody.appendChild(tr); // Append directly to tbody
          }

          async function loadCategoriesTable() {
              try {
                  categoryTableBody.innerHTML = ''; // Clear existing rows
                  const querySnapshot = await getDocs(categoriesCollectionRef);
                  if (querySnapshot.empty) {
                      console.log("Žiadne kategórie nenájdené.");
                      const noDataRow = document.createElement('tr');
                      const td = document.createElement('td');
                      td.colSpan = 2;
                      td.textContent = "Žiadne kategórie zatiaľ pridané.";
                      td.style.textAlign = 'center';
                      noDataRow.appendChild(td);
                      categoryTableBody.appendChild(noDataRow);
                  } else {
                      // Sort categories alphabetically by name (doc.id)
                      const sortedDocs = querySnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                      sortedDocs.forEach((doc) => {
                          const categoryName = doc.id;
                          addCategoryRowToTable(categoryName);
                      });
                      console.log(`Načítaných kategórií: ${sortedDocs.length}`);
                  }
              } catch (error) {
                  console.error('Chyba pri načítaní kategórií: ', error);
                  alert('Chyba pri načítaní kategórií!');
                   const errorRow = document.createElement('tr');
                   const td = document.createElement('td');
                   td.colSpan = 2;
                   td.textContent = "Chyba pri načítaní kategórií.";
                   td.style.textAlign = 'center';
                   errorRow.appendChild(td);
                   categoryTableBody.appendChild(errorRow);
              }
          }

         // NEW: Cache all categories for dynamic select population
         async function cacheAllCategories() {
              try {
                  const querySnapshot = await getDocs(categoriesCollectionRef);
                  // Sort categories alphabetically by name (doc.id)
                  allCategories = querySnapshot.docs.map(doc => doc.id).sort();
                  console.log(`Cached ${allCategories.length} categories.`);
              } catch (error) {
                  console.error('Error caching categories:', error);
                  allCategories = []; // Clear cache on error
              }
         }


          // --- Funkcie pre Skupiny (logika zápisu používa kompozitné ID) ---

          // Funkcia na načítanie kategórií a naplnenie <select>
          // Použiteľná pre groupModal, clubModal a teamCreationModal
          // Added excludedCategoryIds parameter
          async function populateCategorySelect(selectElement, selectedCategoryId = null, excludedCategoryIds = []) {
               // Clear existing options
               selectElement.innerHTML = '<option value="">-- Vyberte kategóriu --</option>';

                selectElement.disabled = true; // Disable while loading


               try {
                   // Use the cached categories if available, otherwise fetch
                   const categoriesToPopulate = allCategories.length > 0 ? allCategories : (await getDocs(categoriesCollectionRef)).docs.map(doc => doc.id).sort();
                    if (allCategories.length === 0 && categoriesToPopulate.length > 0) {
                        console.log("Populating from fresh fetch, caching now.");
                        allCategories = categoriesToPopulate; // Cache if fetched fresh
                    }


                   if (categoriesToPopulate.length === 0) {
                       console.log("Žiadne kategórie pre naplnenie selectu.");
                       const option = document.createElement('option');
                       option.value = "";
                       option.textContent = "-- Žiadne kategórie --";
                       option.disabled = true;
                       selectElement.appendChild(option);
                        selectElement.disabled = false; // Re-enable even if empty, unless truly errored
                   } else {
                        selectElement.disabled = false; // Enable the select
                        // Sort categories alphabetically by name
                        // Filter out excluded categories
                        const availableCategories = categoriesToPopulate.filter(catId => !excludedCategoryIds.includes(catId));

                        if (availableCategories.length === 0) {
                              const option = document.createElement('option');
                              option.value = "";
                              option.textContent = "-- Žiadne dostupné kategórie --";
                              option.disabled = true;
                              selectElement.appendChild(option);
                        } else {
                            availableCategories.forEach((categoryName) => {
                                 const option = document.createElement('option');
                                 option.value = categoryName;
                                 option.textContent = categoryName;
                                 selectElement.appendChild(option);
                            });

                            // Select the provided category ID(s) - handles single select only now
                            if (selectedCategoryId && !Array.isArray(selectedCategoryId)) { // Ensure it's a single ID for non-multiple select
                                  if (selectElement.querySelector(`option[value="${selectedCategoryId}"]`)) {
                                       selectElement.value = selectedCategoryId;
                                  } else {
                                       console.warn(`Kategória "${selectedCategoryId}" pre zvolenú položku nenájdená v zozname dostupných kategórií.`);
                                       selectElement.value = ""; // Reset to default if selected category not found
                                  }
                            } else if (Array.isArray(selectedCategoryId)) {
                                 console.warn("populateCategorySelect received an array for selectedCategoryId but select is not multiple.");
                                 selectElement.value = "";
                            }
                        }
                    }
                } catch (error) {
                    console.error('Chyba pri načítaní kategórií pre select: ', error);
                     selectElement.innerHTML = '<option value="">Chyba pri načítaní kategórií</option>'; // Indicate error
                     selectElement.disabled = true; // Keep disabled on error
                } finally {
                     // If cache was empty, ensure it's populated for next time
                     if (allCategories.length === 0) {
                         cacheAllCategories(); // Attempt to cache after initial load
                     }
                }
             }

             // Funkcia na načítanie skupín pre danú kategóriu a naplnenie <select> (používa kompozitné ID)
             // Použiteľná pre clubModal
             async function populateGroupSelect(categoryId, selectElement, selectedGroupId = null) { // selectElement, selectedGroupId
                 selectElement.innerHTML = '<option value="">-- Vyberte skupinu --</option>';
                 selectElement.disabled = true; // Disable until category is selected or loading is complete


                 if (!categoryId || categoryId === '-- Vyberte kategóriu --') { // Also check placeholder value
                     selectElement.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
                     selectElement.disabled = true;
                     return; // No category selected, cannot load groups
                 }

                  selectElement.disabled = true; // Re-disable during loading

                 try {
                     // Query groups that belong to the selected category
                     const q = query(groupsCollectionRef, where('categoryId', '==', categoryId));
                     const querySnapshot = await getDocs(q);

                     if (querySnapshot.empty) {
                         console.log(`Žiadne skupiny nájdené pre kategóriu "${categoryId}".`);
                         const option = document.createElement('option');
                         option.value = "";
                         option.textContent = "-- Žiadne skupiny v kategórii --";
                         option.disabled = true;
                         selectElement.appendChild(option);

                     } else {
                         console.log(`Načítané skupín pre kategóriu "${categoryId}".`);
                         // Sort groups alphabetically by name
                         const sortedDocs = querySnapshot.docs.sort((a, b) => (a.data().name || '').localeCompare(b.data().name || ''));

                         sortedDocs.forEach((doc) => {
                              const groupData = doc.data();
                              // The group ID is the composite ID "Category - Group Name"
                              const groupId = doc.id; // This is the composite ID
                              const groupName = groupData.name; // Get the actual group name field

                              const option = document.createElement('option');
                               // Use the composite ID as the option value
                              option.value = groupId;
                               // Display the group name
                              option.textContent = groupName;
                              selectElement.appendChild(option);
                           });

                            // Select the provided group ID if in edit mode and it exists
                            if (selectedGroupId) {
                                  if (selectElement.querySelector(`option[value="${selectedGroupId}"]`)) {
                                       selectElement.value = selectedGroupId;
                                  } else {
                                       console.warn(`Skupina "${selectedGroupId}" pre zvolenú položku nenájdená v zozname skupín pre túto kategóriu.`);
                                       selectElement.value = ""; // Reset to default if selected group not found
                                  }
                            }
                     }
                     selectElement.disabled = false; // Enable after loading (even if empty)

                 } catch (error) {
                     console.error('Chyba pri načítaní skupín pre select: ', error);
                      selectElement.innerHTML = '<option value="">Chyba pri načítaní skupín</option>'; // Indicate error
                      selectElement.disabled = true; // Keep disabled on error
                }
             }


 // Funkcia na otvorenie modálu skupiny (pre pridanie alebo úpravu)
  //groupId je kompozitné ID, groupData má name, categoryId
 async function openGroupModal(groupId = null, groupData = null) {
      groupModal.style.display = 'block';

      // Resetuj stav modálu a formulár
      currentGroupModalMode = 'add';
      editingGroupId = null; // Vymaž ID upravovanej skupiny
      groupForm.reset(); // Vyčisti polia formulára
      groupNameInput.disabled = false; // Uisti sa, že vstup pre názov je povolený
      groupFormSubmitButton.textContent = 'Uložiť'; // Default button text


      // Naplň select kategórií pre modál skupiny
      groupCategorySelect.value = ""; // Resetuj výber kategórie


      if (groupId && groupData) {
          // Režim úpravy
          currentGroupModalMode = 'edit';
          editingGroupId = groupId; // Ulož kompozitné ID skupiny, ktorá sa upravuje
          groupModalTitle.textContent = 'Premenovať skupinu';
          groupFormSubmitButton.textContent = 'Uložiť zmeny';

          // Naplň select kategórií a potom nastav zvolenú hodnotu
          await populateCategorySelect(groupCategorySelect, groupData.categoryId, []); // Pass empty array for excluded categories

          // Vyplň polia formulára
          groupNameInput.value = groupData.name; // Použi pole 'name' z dát
          // Hodnota groupCategorySelect sa nastaví funkciou populateCategorySelect

      } else {
          // Režim pridania (počiatočný stav už nastavený vyššie)
          groupModalTitle.textContent = 'Pridať skupinu';

          await populateCategorySelect(groupCategorySelect, null, []); // Pass empty array for excluded categories
      }

      groupNameInput.focus(); // Nastav focus na pole pre názov
     }


            // Funkcia na zobrazenie skupín usporiadaných podľa kategórií
            async function displayGroupsByCategory() {
                 groupsContentDiv.innerHTML = ''; // Clear container

                 try {
                    // 1. Načítať všetky kategórie
                    const categoriesSnapshot = await getDocs(categoriesCollectionRef);
                    // Sort categories by name (doc.id)
                    const sortedCategoriesDocs = categoriesSnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                    const categories = sortedCategoriesDocs.map(doc => doc.id);


                    if (categories.length === 0) {
                         const message = document.createElement('p');
                         message.textContent = "Pridajte kategórie v sekcii 'Kategórie' pre zobrazenie skupín.";
                         groupsContentDiv.appendChild(message);
                         return;
                    }

                    // 2. Načítať všetky skupiny
                    const groupsSnapshot = await getDocs(groupsCollectionRef);

                    // 3. Zoskupiť skupiny podľa categoryId
                    const groupsByCategory = {};
                    groupsSnapshot.forEach(doc => {
                         const groupData = doc.data();
                         const groupId = doc.id; // This je kompozitné ID
                         const categoryId = groupData.categoryId;

                         if (categoryId) {
                             if (!groupsByCategory[categoryId]) {
                                 // OPRAVENÉ: Inicializuj ako prázdne POLE
                                 groupsByCategory[categoryId] = [];
                             }
                             // Uložíme ID a dáta do poľa
                             groupsByCategory[categoryId].push({ id: groupId, data: groupData });
                         } else {
                             console.warn(`Skupina ${groupId} nemá priradenú categoryId.`);
                             // Optional: Handle groups without a category
                         }
                    });

                    // 4. Pre každú kategóriu vytvoriť sekciu (div) s nadpisom a tabuľkou so skupinami
                    categories.forEach(categoryName => {
                         const groupsForThisCategory = groupsByCategory[categoryName] || [];

                         // Použijeme triedu section-block pre konzistentný vzhľad
                         const categorySectionDiv = document.createElement('div');
                         categorySectionDiv.classList.add('category-group-section', 'section-block');

                         const categoryHeading = document.createElement('h2');
                         categoryHeading.textContent = `${categoryName}`;
                         categorySectionDiv.appendChild(categoryHeading);

                         const categoryGroupsTable = document.createElement('table');
                         categoryGroupsTable.classList.add('category-group-table');

                         const thead = document.createElement('thead');
                         const headerRow = document.createElement('tr');
                         const groupNameTh = document.createElement('th');
                         groupNameTh.textContent = 'Názov';
                         const actionsTh = document.createElement('th');
                         actionsTh.textContent = 'Akcie'; // Changed to Akcie
                         actionsTh.style.width = '150px';

                         headerRow.appendChild(groupNameTh);
                         headerRow.appendChild(actionsTh);
                         thead.appendChild(headerRow);
                         categoryGroupsTable.appendChild(thead);

                         const tbody = document.createElement('tbody');

                         if (groupsForThisCategory.length === 0) {
                             const noGroupsRow = document.createElement('tr');
                             const td = document.createElement('td');
                             td.colSpan = 2;
                             td.textContent = `V kategórii "${categoryName}" zatiaľ nie sú žiadne skupiny.`;
                             td.style.textAlign = 'center';
                             noGroupsRow.appendChild(td);
                             tbody.appendChild(noGroupsRow);
                         } else {
                             // Sort groups by name before displaying
                             groupsForThisCategory.sort((a, b) => (a.data.name || '').localeCompare(b.data.name || ''));

                             groupsForThisCategory.forEach(group => {
                                  const groupRow = document.createElement('tr');
                                  const groupNameTd = document.createElement('td');
                                  groupNameTd.textContent = group.data.name; // Use the 'name' field for display


                                  const groupActionsTd = document.createElement('td');
                                  groupActionsTd.style.whiteSpace = 'nowrap';

                                  // TLAČIDLO ÚPRAVA SKUPINY - VOLÁ openGroupModal
                                   const editGroupButton = document.createElement('button');
                                   editGroupButton.textContent = 'Premenovať';
                                   editGroupButton.classList.add('action-button');
                                   editGroupButton.onclick = () => {
                                        openGroupModal(group.id, group.data); // Pass the composite group ID and its data
                                   };


                                  // TLAČIDLO VYMAZAŤ SKUPINU
                                   const deleteGroupButton = document.createElement('button'); // Correct variable name
                                   deleteGroupButton.textContent = 'Vymazať';
                                   deleteGroupButton.classList.add('action-button', 'delete-button');
                                   deleteGroupButton.onclick = async () => { // THIS is where the error likely occurred
                                        // === OPRAVENÉ: Používa deleteGroupButton ===
                                        if (!confirm(`Naozaj chcete vymazať skupinu "${group.data.name}" z kategórie "${group.data.categoryId}"? Tímy priradené k tejto skupine prídu o priradenie (groupId sa nastaví na null)!`)) { // Updated warning
                                             return;
                                        }
                                        try {
                                             // Pred zmazaním skupiny nájdi všetky kluby, ktoré na ňu odkazujú a aktualizuj ich
                                             const batch = writeBatch(db);

                                             const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', group.id));
                                             const clubsSnapshot = await getDocs(clubsInGroupQuery); // Use await here
                                             clubsSnapshot.forEach(doc => {
                                                  batch.update(doc.ref, { groupId: null }); // Nastav groupId na null
                                                  console.log(`Klub "${doc.id}" odpriradený zo skupiny "${group.id}".`);
                                              });

                                              // Nakoniec zmaž samotnú skupinu
                                              batch.delete(doc(groupsCollectionRef, group.id));

                                              await batch.commit();

                                              console.log(`Skupina "${group.data.name}" (ID: ${group.id}) a súvisiace kluby boli úspešne zmazané/aktualizované.`);

                                              // Refresh displays that might be affected
                                              displayGroupsByCategory(); // Reload display
                                              if (window.location.hash === '#timy-do-skupin') displayClubs();
                                              if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();


                                          } catch (error) {
                                              console.error('Chyba pri mazaní skupiny a súvisiacich dát: ', error);
                                              alert('Chyba pri mazaní skupiny! Prosím, skúste znova.');
                                          }
                                     };

                                     groupActionsTd.appendChild(editGroupButton);
                                     groupActionsTd.appendChild(deleteGroupButton); // <<<<< OPRAVA TU: Použiť deleteGroupButton

                                     groupRow.appendChild(groupNameTd);
                                     groupRow.appendChild(groupActionsTd);
                                     tbody.appendChild(groupRow);
                                });
                             }

                             categoryGroupsTable.appendChild(tbody);
                             categorySectionDiv.appendChild(categoryGroupsTable);
                             groupsContentDiv.appendChild(categorySectionDiv); // Append the section div to the main container
                         });


                      } catch (error) {
                          console.error('Chyba pri načítaní alebo zobrazovaní skupín: ', error);
                          const errorMessage = document.createElement('p');
                          errorMessage.textContent = 'Chyba pri načítaní dát skupín.';
                          groupsContentDiv.appendChild(errorMessage);
                      }
             }


             // --- Funkcie pre Kluby (Priradenie do skupín & Správa priradených) ---

             // NEW: Funkcia na načítanie nepriradených tímov a naplnenie selectu v modáli klubu
             async function populateUnassignedClubsSelect(selectElement, selectedClubId = null) {
                  selectElement.innerHTML = '<option value="">-- Vyberte tím na priradenie --</option>';
                  selectElement.disabled = true; // Disable until clubs are loaded


                  try {
                      // Query clubs where groupId is null (unassigned teams)
                      const q = query(clubsCollectionRef, where('groupId', '==', null));
                      const querySnapshot = await getDocs(q);

                      if (querySnapshot.empty) {
                          console.log("Žiadne nepriradené tímy na priradenie.");
                          const option = document.createElement('option');
                          option.value = "";
                          option.textContent = "-- Žiadne tímy na priradenie --";
                          option.disabled = true;
                          selectElement.appendChild(option);
                          selectElement.disabled = false; // Re-enable even if empty
                      } else {
                           selectElement.disabled = false; // Enable the select
                           // Sort unassigned teams alphabetically by name
                            const sortedDocs = querySnapshot.docs.sort((a, b) => (a.data().name || '').localeCompare(b.data().name || ''));

                            sortedDocs.forEach((doc) => {
                                 const clubData = doc.data();
                                 const clubId = doc.id; // Auto-generated ID

                                 const option = document.createElement('option');
                                 option.value = clubId; // Use the auto-generated ID as value
                                 option.textContent = clubData.name; // Display the club name
                                 selectElement.appendChild(option);
                            });

                            // Select the provided club ID if needed (e.g., if modal is reused for something like re-assigning)
                            if (selectedClubId) {
                                  if (selectElement.querySelector(`option[value="${selectedClubId}"]`)) {
                                       selectElement.value = selectedClubId;
                                  } else {
                                       console.warn(`Nepriradený tím s ID "${selectedClubId}" nenájdený.`);
                                       selectElement.value = ""; // Reset to default
                                  }
                            }
                         }
                     } catch (error) {
                         console.error('Chyba pri načítaní nepriradených tímov pre select: ', error);
                         selectElement.innerHTML = '<option value="">Chyba pri načítaní tímov</option>'; // Indicate error
                         selectElement.disabled = true; // Keep disabled on error
                    }
                 }


             // Funkcia na otvorenie modálu klubu (pre priradenie do skupiny ALEBO úpravu priradeného)
             // clubId je auto-generované ID dokumentu
             async function openClubModal(clubId = null, clubData = null) { // clubId is auto-generated ID
                  clubModal.style.display = 'block';

                  // Reset form fields including the new select
                  clubForm.reset();
                  clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>'; // Clear groups
                  clubGroupSelect.disabled = true;
                  clubCategorySelect.value = ""; // Reset category select

                  // Reset visibility of name input vs select
                  unassignedClubSelectContainer.style.display = 'block';
                  clubNameInputContainer.style.display = 'none';


                  if (clubId && clubData) {
                     // Edit mode (Editing an ALREADY ASSIGNED club)
                     currentClubModalMode = 'edit-assigned';
                     editingClubId = clubId; // Store the auto-generated ID of the club being edited
                     clubModalTitle.textContent = 'Upraviť klub v skupine'; // Specific title
                     clubFormSubmitButton.textContent = 'Uložiť zmeny';

                     // Hide the unassigned clubs select, show the name input (allow editing name of this instance)
                     unassignedClubSelectContainer.style.display = 'none';
                     clubNameInputContainer.style.display = 'block';
                     clubNameInput.readOnly = false;

                     // Populate the category select and then set the value
                     await populateCategorySelect(clubCategorySelect, clubData.categoryId, []); // Pass empty array for excluded

                     // Populate the group select based on the selected category and then set the group value
                     if(clubData.categoryId) {
                          // Pass the composite group ID (clubData.groupId) to select
                          await populateGroupSelect(clubData.categoryId, clubGroupSelect, clubData.groupId);
                     }

                     // Fill the form fields
                     clubNameInput.value = clubData.name; // Use the 'name' field from data
                     // Category and Group selects are set by populate functions

                 } else {
                     // Add mode (Assigning an UNASSIGNED club to a group)
                     currentClubModalMode = 'add-assign';
                     editingClubId = null; // No specific club ID selected yet via edit button
                     clubModalTitle.textContent = 'Priradiť tím do skupiny'; // Specific title
                     clubFormSubmitButton.textContent = 'Priradiť'; // Specific button text

                     // Show the unassigned clubs select, hide the name input
                     unassignedClubSelectContainer.style.display = 'block';
                     clubNameInputContainer.style.display = 'none';
                     clubNameInput.value = ''; // Clear the name input just in case

                     // Populate the unassigned clubs select
                     await populateUnassignedClubsSelect(unassignedClubSelect, null); // Pass select element

                     // Populate the category select (no category pre-selected initially for assignment)
                     await populateCategorySelect(clubCategorySelect, null, []); // Pass empty array for excluded
                 }

                 // Set focus based on mode
                 if (currentClubModalMode === 'add-assign') {
                      unassignedClubSelect.focus();
                 } else { // edit-assigned
                      clubNameInput.focus();
                 }
            }

             // Funkcia na zobrazenie klubov usporiadaných podľa kategórií a skupín (PRIRADENÉ tímy)
             // fetchuje kluby s groupId != null
             async function displayClubs() {
                 clubsContentDiv.innerHTML = ''; // Vyčistiť kontajner

                 try {
                     // Načítať všetky kluby, ktoré SÚ priradené do skupín (groupId != null)
                      const q = query(clubsCollectionRef, where('groupId', '!=', null));
                     const clubsSnapshot = await getDocs(q);

                     const clubs = clubsSnapshot.docs.map(clubDoc => ({ id: clubDoc.id, data: clubDoc.data() })); // Get club data with auto-generated ID

                     if (clubs.length === 0) {
                         console.log("Žiadne kluby priradené do skupín nenájdené.");
                         const message = document.createElement('p');
                         message.textContent = "Žiadne kluby zatiaľ neboli priradené do skupín.";
                         clubsContentDiv.appendChild(message); // Správu pridáme do kontajnera div
                         return;
                     }

                     // Zoskupenie klubov najprv podľa categoryId a potom podľa groupId
                     const clubsByCategoryAndGroup = {};
                     clubs.forEach(club => {
                         const categoryId = club.data.categoryId;
                         const groupId = club.data.groupId; // Toto je kompozitné ID skupiny (NázovKategórie - NázovSkupiny)

                         // Ensure categoryId and groupId exist for grouping
                          if (categoryId && groupId && categoryId !== 'null' && groupId !== 'null') { // Added check against 'null' strings
                              if (!clubsByCategoryAndGroup[categoryId]) {
                                  clubsByCategoryAndGroup[categoryId] = {};
                              }
                              if (!clubsByCategoryAndGroup[categoryId][groupId]) {
                                  clubsByCategoryAndGroup[categoryId][groupId] = [];
                              }
                               clubsByCategoryAndGroup[categoryId][groupId].push(club); // Uložíme celý objekt { id: auto-generated, data }
                          } else {
                              console.warn(`Klub ${club.id} priradený do skupiny (groupId != null) nemá platnú categoryId (${categoryId}) alebo groupId (${groupId}).`);
                          }
                     });

                     // Získaj zotriedené názvy kategórií
                     const sortedCategories = Object.keys(clubsByCategoryAndGroup).sort();

                      if (sortedCategories.length === 0 && clubs.length > 0) {
                          // This case happens if clubs exist but none have valid categoryId/groupId for grouping
                           console.warn("Kluby boli nájdené, ale žiadne nemajú platné categoryId/groupId na zobrazenie v skupinách.");
                           const message = document.createElement('p');
                           message.textContent = "Existujú kluby, ale žiadne nemajú priradenú kategóriu a skupinu pre zobrazenie tu.";
                           clubsContentDiv.appendChild(message);
                           return;
                      }


                     // Iteruj cez kategórie a skupiny, aby si vytvoril/a sekcie a tabuľky
                     sortedCategories.forEach(categoryId => {
                         // Získaj zotriedené kompozitné ID skupín v danej kategórii
                         const sortedGroups = Object.keys(clubsByCategoryAndGroup[categoryId]).sort();

                         sortedGroups.forEach(groupId => {
                             const clubsInThisGroup = clubsByCategoryAndGroup[categoryId][groupId];

                             // Vytvor section block pre túto kombináciu kategória-skupina
                             const groupClubSectionDiv = document.createElement('div');
                             groupClubSectionDiv.classList.add('section-block');

                             // Vytvor nadpis pre túto sekciu
                             const groupNameParts = groupId.split(' - ');
                             const groupName = groupNameParts.length > 1 ? groupNameParts.slice(1).join(' - ') : groupId;

                             const sectionHeading = document.createElement('h2');
                             sectionHeading.textContent = `${categoryId} - ${groupName}`;
                             groupClubSectionDiv.appendChild(sectionHeading);

                             // Vytvor tabuľku pre kluby v tejto skupine
                             const clubTable = document.createElement('table');
                             clubTable.classList.add('group-clubs-table');

                             // Vytvor hlavičku tabuľky
                             const thead = document.createElement('thead');
                             const headerRow = document.createElement('tr');
                             const clubNameTh = document.createElement('th');
                             clubNameTh.textContent = 'Názov klubu';
                              const actionsTh = document.createElement('th');
                              actionsTh.textContent = 'Akcie';
                              actionsTh.style.width = '150px';

                              headerRow.appendChild(clubNameTh);
                              headerRow.appendChild(actionsTh);
                              thead.appendChild(headerRow);
                              clubTable.appendChild(thead);


                             // Vytvor telo tabuľky
                             const tbody = document.createElement('tbody');

                             if (clubsInThisGroup.length === 0) {
                                  const noClubsRow = document.createElement('tr');
                                  const td = document.createElement('td');
                                  td.colSpan = 2;
                                  td.textContent = `Žiadne kluby v tejto skupine.`;
                                  td.style.textAlign = 'center';
                                  tbody.appendChild(noClubsRow); // Corrected this line
                             } else {
                                  // Sort clubs by name before displaying
                                  clubsInThisGroup.sort((a, b) => (a.data.name || '').localeCompare(b.data.name || ''));

                                  // Pridaj riadky pre každý klub v tejto skupine
                                  clubsInThisGroup.forEach(club => {
                                      const tr = document.createElement('tr');

                                      const nameTd = document.createElement('td');
                                      nameTd.textContent = club.data.name; // Zobraz názov klubu z dát

                                      const actionsTd = document.createElement('td');
                                      actionsTd.style.whiteSpace = 'nowrap';

                                      // === TLAČIDLO ÚPRAVA KLUBU (ZMENIŤ SKUPINU/KATEGÓRIU/NÁZOV) ===
                                      // Otvorí clubModal v režime úpravy
                                       const editClubButton = document.createElement('button');
                                       editClubButton.textContent = 'Upraviť';
                                       editClubButton.classList.add('action-button');
                                       editClubButton.onclick = () => {
                                            // Open the club modal with the current club data for editing
                                           // Pass the auto-generated ID and data
                                            openClubModal(club.id, club.data);
                                        };
                                       actionsTd.appendChild(editClubButton);


                                      // === TLAČIDLO VYMAZAŤ KLUBU (ZMAZAŤ ÚPLNE) ===
                                      // Mazanie klubu z tejto sekcie by malo asi znamenať úplné zmazanie dokumentu z Firestore.
                                       const deleteClubButton = document.createElement('button');
                                       deleteClubButton.textContent = 'Vymazať';
                                       deleteClubButton.classList.add('action-button', 'delete-button');
                                       deleteClubButton.onclick = async () => { // THIS is where the error likely occurred
                                        // === OPRAVENÉ: Používa deleteGroupButton ===
                                        // Zmenil som tu 'deleteButton' na 'deleteGroupButton' - OPRAVENÉ V PREDOSLEJ ODPOVEDI
                                        if (!confirm(`Naozaj chcete vymazať skupinu "${group.data.name}" z kategórie "${group.data.categoryId}"? Tímy priradené k tejto skupine prídu o priradenie (groupId sa nastaví na null)!`)) { // Updated warning
                                             return;
                                        }
                                        try {
                                             // Pred zmazaním skupiny nájdi všetky kluby, ktoré na ňu odkazujú a aktualizuj ich
                                             const batch = writeBatch(db);

                                             const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', group.id));
                                             const clubsSnapshot = await getDocs(clubsInGroupQuery); // Use await here
                                             clubsSnapshot.forEach(doc => {
                                                  batch.update(doc.ref, { groupId: null }); // Nastav groupId na null
                                                  console.log(`Klub "${doc.id}" odpriradený zo skupiny "${group.id}".`);
                                              });

                                              // Nakoniec zmaž samotnú skupinu
                                              batch.delete(doc(groupsCollectionRef, group.id));

                                              await batch.commit();

                                              console.log(`Skupina "${group.data.name}" (ID: ${group.id}) a súvisiace kluby boli úspešne zmazané/aktualizované.`);

                                              // Refresh displays that might be affected
                                              displayGroupsByCategory(); // Reload display
                                              if (window.location.hash === '#timy-do-skupin') displayClubs();
                                              if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();


                                          } catch (error) {
                                              console.error('Chyba pri mazaní skupiny a súvisiacich dát: ', error);
                                              alert('Chyba pri mazaní skupiny! Prosím, skúste znova.');
                                          }
                                     };

                                     groupActionsTd.appendChild(editGroupButton);
                                     // === OPRAVENÉ: Používa deleteGroupButton ===
                                     groupActionsTd.appendChild(deleteGroupButton); // <<< OPRAVA BOLA TU A JE ZACHOVANÁ

                                     groupRow.appendChild(groupNameTd);
                                     groupRow.appendChild(groupActionsTd);
                                     tbody.appendChild(groupRow);
                                });
                             }

                             categoryGroupsTable.appendChild(tbody);
                             categorySectionDiv.appendChild(categoryGroupsTable);
                             groupsContentDiv.appendChild(categorySectionDiv); // Append the section div to the main container
                         });


                      } catch (error) {
                          console.error('Chyba pri načítaní alebo zobrazovaní skupín: ', error);
                          const errorMessage = document.createElement('p');
                          errorMessage.textContent = 'Chyba pri načítaní dát skupín.';
                          groupsContentDiv.appendChild(errorMessage);
                      }
             }


             // --- Funkcie pre Kluby (Priradenie do skupín & Správa priradených) ---

             // NEW: Funkcia na načítanie nepriradených tímov a naplnenie selectu v modáli klubu
             async function populateUnassignedClubsSelect(selectElement, selectedClubId = null) {
                  selectElement.innerHTML = '<option value="">-- Vyberte tím na priradenie --</option>';
                  selectElement.disabled = true; // Disable until clubs are loaded


                  try {
                      // Query clubs where groupId is null (unassigned teams)
                      const q = query(clubsCollectionRef, where('groupId', '==', null));
                      const querySnapshot = await getDocs(q);

                      if (querySnapshot.empty) {
                          console.log("Žiadne nepriradené tímy na priradenie.");
                          const option = document.createElement('option');
                          option.value = "";
                          option.textContent = "-- Žiadne tímy na priradenie --";
                          option.disabled = true;
                          selectElement.appendChild(option);
                          selectElement.disabled = false; // Re-enable even if empty
                      } else {
                           selectElement.disabled = false; // Enable the select
                           // Sort unassigned teams alphabetically by name
                            const sortedDocs = querySnapshot.docs.sort((a, b) => (a.data().name || '').localeCompare(b.data().name || ''));

                            sortedDocs.forEach((doc) => {
                                 const clubData = doc.data();
                                 const clubId = doc.id; // Auto-generated ID

                                 const option = document.createElement('option');
                                 option.value = clubId; // Use the auto-generated ID as value
                                 option.textContent = clubData.name; // Display the club name
                                 selectElement.appendChild(option);
                            });

                            // Select the provided club ID if needed (e.g., if modal is reused for something like re-assigning)
                            if (selectedClubId) {
                                  if (selectElement.querySelector(`option[value="${selectedClubId}"]`)) {
                                       selectElement.value = selectedClubId;
                                  } else {
                                       console.warn(`Nepriradený tím s ID "${selectedClubId}" nenájdený.`);
                                       selectElement.value = ""; // Reset to default
                                  }
                            }
                         }
                     } catch (error) {
                         console.error('Chyba pri načítaní nepriradených tímov pre select: ', error);
                         selectElement.innerHTML = '<option value="">Chyba pri načítaní tímov</option>'; // Indicate error
                         selectElement.disabled = true; // Keep disabled on error
                    }
                 }


             // Funkcia na otvorenie modálu klubu (pre priradenie do skupiny ALEBO úpravu priradeného)
             // clubId je auto-generované ID dokumentu
             async function openClubModal(clubId = null, clubData = null) { // clubId is auto-generated ID
                  clubModal.style.display = 'block';

                  // Reset form fields including the new select
                  clubForm.reset();
                  clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>'; // Clear groups
                  clubGroupSelect.disabled = true;
                  clubCategorySelect.value = ""; // Reset category select

                  // Reset visibility of name input vs select
                  unassignedClubSelectContainer.style.display = 'block';
                  clubNameInputContainer.style.display = 'none';


                  if (clubId && clubData) {
                     // Edit mode (Editing an ALREADY ASSIGNED club)
                     currentClubModalMode = 'edit-assigned';
                     editingClubId = clubId; // Store the auto-generated ID of the club being edited
                     clubModalTitle.textContent = 'Upraviť klub v skupine'; // Specific title
                     clubFormSubmitButton.textContent = 'Uložiť zmeny';

                     // Hide the unassigned clubs select, show the name input (allow editing name of this instance)
                     unassignedClubSelectContainer.style.display = 'none';
                     clubNameInputContainer.style.display = 'block';
                     clubNameInput.readOnly = false;

                     // Populate the category select and then set the value
                     await populateCategorySelect(clubCategorySelect, clubData.categoryId, []); // Pass empty array for excluded

                     // Populate the group select based on the selected category and then set the group value
                     if(clubData.categoryId) {
                          // Pass the composite group ID (clubData.groupId) to select
                          await populateGroupSelect(clubData.categoryId, clubGroupSelect, clubData.groupId);
                     }

                     // Fill the form fields
                     clubNameInput.value = clubData.name; // Use the 'name' field from data
                     // Category and Group selects are set by populate functions

                 } else {
                     // Add mode (Assigning an UNASSIGNED club to a group)
                     currentClubModalMode = 'add-assign';
                     editingClubId = null; // No specific club ID selected yet via edit button
                     clubModalTitle.textContent = 'Priradiť tím do skupiny'; // Specific title
                     clubFormSubmitButton.textContent = 'Priradiť'; // Specific button text

                     // Show the unassigned clubs select, hide the name input
                     unassignedClubSelectContainer.style.display = 'block';
                     clubNameInputContainer.style.display = 'none';
                     clubNameInput.value = ''; // Clear the name input just in case

                     // Populate the unassigned clubs select
                     await populateUnassignedClubsSelect(unassignedClubSelect, null); // Pass select element

                     // Populate the category select (no category pre-selected initially for assignment)
                     await populateCategorySelect(clubCategorySelect, null, []); // Pass empty array for excluded
                 }

                 // Set focus based on mode
                 if (currentClubModalMode === 'add-assign') {
                      unassignedClubSelect.focus();
                 } else { // edit-assigned
                      clubNameInput.focus();
                 }
            }

             // Funkcia na zobrazenie klubov usporiadaných podľa kategórií a skupín (PRIRADENÉ tímy)
             // fetchuje kluby s groupId != null
             async function displayClubs() {
                 clubsContentDiv.innerHTML = ''; // Vyčistiť kontajner

                 try {
                     // Načítať všetky kluby, ktoré SÚ priradené do skupín (groupId != null)
                      const q = query(clubsCollectionRef, where('groupId', '!=', null));
                     const clubsSnapshot = await getDocs(q);

                     const clubs = clubsSnapshot.docs.map(clubDoc => ({ id: clubDoc.id, data: clubDoc.data() })); // Get club data with auto-generated ID

                     if (clubs.length === 0) {
                         console.log("Žiadne kluby priradené do skupín nenájdené.");
                         const message = document.createElement('p');
                         message.textContent = "Žiadne kluby zatiaľ neboli priradené do skupín.";
                         clubsContentDiv.appendChild(message); // Správu pridáme do kontajnera div
                         return;
                     }

                     // Zoskupenie klubov najprv podľa categoryId a potom podľa groupId
                     const clubsByCategoryAndGroup = {};
                     clubs.forEach(club => {
                         const categoryId = club.data.categoryId;
                         const groupId = club.data.groupId; // Toto je kompozitné ID skupiny (NázovKategórie - NázovSkupiny)

                         // Ensure categoryId and groupId exist for grouping
                          if (categoryId && groupId && categoryId !== 'null' && groupId !== 'null') { // Added check against 'null' strings
                              if (!clubsByCategoryAndGroup[categoryId]) {
                                  clubsByCategoryAndGroup[categoryId] = {};
                              }
                              if (!clubsByCategoryAndGroup[categoryId][groupId]) {
                                  clubsByCategoryAndGroup[categoryId][groupId] = [];
                              }
                               clubsByCategoryAndGroup[categoryId][groupId].push(club); // Uložíme celý objekt { id: auto-generated, data }
                          } else {
                              console.warn(`Klub ${club.id} priradený do skupiny (groupId != null) nemá platnú categoryId (${categoryId}) alebo groupId (${groupId}).`);
                          }
                     });

                     // Získaj zotriedené názvy kategórií
                     const sortedCategories = Object.keys(clubsByCategoryAndGroup).sort();

                      if (sortedCategories.length === 0 && clubs.length > 0) {
                          // This case happens if clubs exist but none have valid categoryId/groupId for grouping
                           console.warn("Kluby boli nájdené, ale žiadne nemajú platné categoryId/groupId na zobrazenie v skupinách.");
                           const message = document.createElement('p');
                           message.textContent = "Existujú kluby, ale žiadne nemajú priradenú kategóriu a skupinu pre zobrazenie tu.";
                           clubsContentDiv.appendChild(message);
                           return;
                      }


                     // Iteruj cez kategórie a skupiny, aby si vytvoril/a sekcie a tabuľky
                     sortedCategories.forEach(categoryId => {
                         // Získaj zotriedené kompozitné ID skupín v danej kategórii
                         const sortedGroups = Object.keys(clubsByCategoryAndGroup[categoryId]).sort();

                         sortedGroups.forEach(groupId => {
                             const clubsInThisGroup = clubsByCategoryAndGroup[categoryId][groupId];

                             // Vytvor section block pre túto kombináciu kategória-skupina
                             const groupClubSectionDiv = document.createElement('div');
                             groupClubSectionDiv.classList.add('section-block');

                             // Vytvor nadpis pre túto sekciu
                             const groupNameParts = groupId.split(' - ');
                             const groupName = groupNameParts.length > 1 ? groupNameParts.slice(1).join(' - ') : groupId;

                             const sectionHeading = document.createElement('h2');
                             sectionHeading.textContent = `${categoryId} - ${groupName}`;
                             groupClubSectionDiv.appendChild(sectionHeading);

                             // Vytvor tabuľku pre kluby v tejto skupine
                             const clubTable = document.createElement('table');
                             clubTable.classList.add('group-clubs-table');

                             // Vytvor hlavičku tabuľky
                             const thead = document.createElement('thead');
                             const headerRow = document.createElement('tr');
                             const clubNameTh = document.createElement('th');
                             clubNameTh.textContent = 'Názov klubu';
                              const actionsTh = document.createElement('th');
                              actionsTh.textContent = 'Akcie';
                              actionsTh.style.width = '150px';

                              headerRow.appendChild(clubNameTh);
                              headerRow.appendChild(actionsTh);
                              thead.appendChild(headerRow);
                              clubTable.appendChild(thead);


                             // Vytvor telo tabuľky
                             const tbody = document.createElement('tbody');

                             if (clubsInThisGroup.length === 0) {
                                  const noClubsRow = document.createElement('tr');
                                  const td = document.createElement('td');
                                  td.colSpan = 2;
                                  td.textContent = `Žiadne kluby v tejto skupine.`;
                                  td.style.textAlign = 'center';
                                  tbody.appendChild(noClubsRow); // Corrected this line
                             } else {
                                  // Sort clubs by name before displaying
                                  clubsInThisGroup.sort((a, b) => (a.data.name || '').localeCompare(b.data.name || ''));

                                  // Pridaj riadky pre každý klub v tejto skupine
                                  clubsInThisGroup.forEach(club => {
                                      const tr = document.createElement('tr');

                                      const nameTd = document.createElement('td');
                                      nameTd.textContent = club.data.name; // Zobraz názov klubu z dát

                                      const actionsTd = document.createElement('td');
                                      actionsTd.style.whiteSpace = 'nowrap';

                                      // === TLAČIDLO ÚPRAVA KLUBU (ZMENIŤ SKUPINU/KATEGÓRIU/NÁZOV) ===
                                      // Otvorí clubModal v režime úpravy
                                       const editClubButton = document.createElement('button');
                                       editClubButton.textContent = 'Upraviť';
                                       editClubButton.classList.add('action-button');
                                       editClubButton.onclick = () => {
                                            // Open the club modal with the current club data for editing
                                           // Pass the auto-generated ID and data
                                            openClubModal(club.id, club.data);
                                        };
                                       actionsTd.appendChild(editClubButton);


                                      // === TLAČIDLO VYMAZAŤ KLUBU (ZMAZAŤ ÚPLNE) ===
                                      // Mazanie klubu z tejto sekcie by malo asi znamenať úplné zmazanie dokumentu z Firestore.
                                       const deleteClubButton = document.createElement('button');
                                       deleteClubButton.textContent = 'Vymazať';
                                       deleteClubButton.classList.add('action-button', 'delete-button');
                                       deleteClubButton.onclick = async () => { // THIS is where the error likely occurred
                                        // === OPRAVENÉ: Používa deleteGroupButton ===
                                        // Zmenil som tu 'deleteButton' na 'deleteGroupButton' - OPRAVENÉ V PREDOSLEJ ODPOVEDI
                                        if (!confirm(`Naozaj chcete vymazať skupinu "${group.data.name}" z kategórie "${group.data.categoryId}"? Tímy priradené k tejto skupine prídu o priradenie (groupId sa nastaví na null)!`)) { // Updated warning
                                             return;
                                        }
                                        try {
                                             // Pred zmazaním skupiny nájdi všetky kluby, ktoré na ňu odkazujú a aktualizuj ich
                                             const batch = writeBatch(db);

                                             const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', group.id));
                                             const clubsSnapshot = await getDocs(clubsInGroupQuery); // Use await here
                                             clubsSnapshot.forEach(doc => {
                                                  batch.update(doc.ref, { groupId: null }); // Nastav groupId na null
                                                  console.log(`Klub "${doc.id}" odpriradený zo skupiny "${group.id}".`);
                                              });

                                              // Nakoniec zmaž samotnú skupinu
                                              batch.delete(doc(groupsCollectionRef, group.id));

                                              await batch.commit();

                                              console.log(`Skupina "${group.data.name}" (ID: ${group.id}) a súvisiace kluby boli úspešne zmazané/aktualizované.`);

                                              // Refresh displays that might be affected
                                              displayGroupsByCategory(); // Reload display
                                              if (window.location.hash === '#timy-do-skupin') displayClubs();
                                              if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();


                                          } catch (error) {
                                              console.error('Chyba pri mazaní skupiny a súvisiacich dát: ', error);
                                              alert('Chyba pri mazaní skupiny! Prosím, skúste znova.');
                                          }
                                     };

                                     groupActionsTd.appendChild(editGroupButton);
                                     // === OPRAVENÉ: Používa deleteGroupButton ===
                                     groupActionsTd.appendChild(deleteGroupButton); // <<< OPRAVA BOLA TU A JE ZACHOVANÁ

                                     groupRow.appendChild(groupNameTd);
                                     groupRow.appendChild(groupActionsTd);
                                     tbody.appendChild(groupRow);
                                });
                             }

                             categoryGroupsTable.appendChild(tbody);
                             categorySectionDiv.appendChild(categoryGroupsTable);
                             groupsContentDiv.appendChild(categorySectionDiv); // Append the section div to the main container
                         });


                      } catch (error) {
                          console.error('Chyba pri načítaní alebo zobrazovaní skupín: ', error);
                          const errorMessage = document.createElement('p');
                          errorMessage.textContent = 'Chyba pri načítaní dát skupín.';
                          groupsContentDiv.appendChild(errorMessage);
                      }
             }


             // --- Funkcie pre Kluby (Priradenie do skupín & Správa priradených) ---

             // NEW: Funkcia na načítanie nepriradených tímov a naplnenie selectu v modáli klubu
             async function populateUnassignedClubsSelect(selectElement, selectedClubId = null) {
                  selectElement.innerHTML = '<option value="">-- Vyberte tím na priradenie --</option>';
                  selectElement.disabled = true; // Disable until clubs are loaded


                  try {
                      // Query clubs where groupId is null (unassigned teams)
                      const q = query(clubsCollectionRef, where('groupId', '==', null));
                      const querySnapshot = await getDocs(q);

                      if (querySnapshot.empty) {
                          console.log("Žiadne nepriradené tímy na priradenie.");
                          const option = document.createElement('option');
                          option.value = "";
                          option.textContent = "-- Žiadne tímy na priradenie --";
                          option.disabled = true;
                          selectElement.appendChild(option);
                          selectElement.disabled = false; // Re-enable even if empty
                      } else {
                           selectElement.disabled = false; // Enable the select
                           // Sort unassigned teams alphabetically by name
                            const sortedDocs = querySnapshot.docs.sort((a, b) => (a.data().name || '').localeCompare(b.data().name || ''));

                            sortedDocs.forEach((doc) => {
                                 const clubData = doc.data();
                                 const clubId = doc.id; // Auto-generated ID

                                 const option = document.createElement('option');
                                 option.value = clubId; // Use the auto-generated ID as value
                                 option.textContent = clubData.name; // Display the club name
                                 selectElement.appendChild(option);
                            });

                            // Select the provided club ID if needed (e.g., if modal is reused for something like re-assigning)
                            if (selectedClubId) {
                                  if (selectElement.querySelector(`option[value="${selectedClubId}"]`)) {
                                       selectElement.value = selectedClubId;
                                  } else {
                                       console.warn(`Nepriradený tím s ID "${selectedClubId}" nenájdený.`);
                                       selectElement.value = ""; // Reset to default
                                  }
                            }
                         }
                     } catch (error) {
                         console.error('Chyba pri načítaní nepriradených tímov pre select: ', error);
                         selectElement.innerHTML = '<option value="">Chyba pri načítaní tímov</option>'; // Indicate error
                         selectElement.disabled = true; // Keep disabled on error
                    }
                 }


             // Funkcia na otvorenie modálu klubu (pre priradenie do skupiny ALEBO úpravu priradeného)
             // clubId je auto-generované ID dokumentu
             async function openClubModal(clubId = null, clubData = null) { // clubId is auto-generated ID
                  clubModal.style.display = 'block';

                  // Reset form fields including the new select
                  clubForm.reset();
                  clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>'; // Clear groups
                  clubGroupSelect.disabled = true;
                  clubCategorySelect.value = ""; // Reset category select

                  // Reset visibility of name input vs select
                  unassignedClubSelectContainer.style.display = 'block';
                  clubNameInputContainer.style.display = 'none';


                  if (clubId && clubData) {
                     // Edit mode (Editing an ALREADY ASSIGNED club)
                     currentClubModalMode = 'edit-assigned';
                     editingClubId = clubId; // Store the auto-generated ID of the club being edited
                     clubModalTitle.textContent = 'Upraviť klub v skupine'; // Specific title
                     clubFormSubmitButton.textContent = 'Uložiť zmeny';

                     // Hide the unassigned clubs select, show the name input (allow editing name of this instance)
                     unassignedClubSelectContainer.style.display = 'none';
                     clubNameInputContainer.style.display = 'block';
                     clubNameInput.readOnly = false;

                     // Populate the category select and then set the value
                     await populateCategorySelect(clubCategorySelect, clubData.categoryId, []); // Pass empty array for excluded

                     // Populate the group select based on the selected category and then set the group value
                     if(clubData.categoryId) {
                          // Pass the composite group ID (clubData.groupId) to select
                          await populateGroupSelect(clubData.categoryId, clubGroupSelect, clubData.groupId);
                     }

                     // Fill the form fields
                     clubNameInput.value = clubData.name; // Use the 'name' field from data
                     // Category and Group selects are set by populate functions

                 } else {
                     // Add mode (Assigning an UNASSIGNED club to a group)
                     currentClubModalMode = 'add-assign';
                     editingClubId = null; // No specific club ID selected yet via edit button
                     clubModalTitle.textContent = 'Priradiť tím do skupiny'; // Specific title
                     clubFormSubmitButton.textContent = 'Priradiť'; // Specific button text

                     // Show the unassigned clubs select, hide the name input
                     unassignedClubSelectContainer.style.display = 'block';
                     clubNameInputContainer.style.display = 'none';
                     clubNameInput.value = ''; // Clear the name input just in case

                     // Populate the unassigned clubs select
                     await populateUnassignedClubsSelect(unassignedClubSelect, null); // Pass select element

                     // Populate the category select (no category pre-selected initially for assignment)
                     await populateCategorySelect(clubCategorySelect, null, []); // Pass empty array for excluded
                 }

                 // Set focus based on mode
                 if (currentClubModalMode === 'add-assign') {
                      unassignedClubSelect.focus();
                 } else { // edit-assigned
                      clubNameInput.focus();
                 }
            }

             // Funkcia na zobrazenie klubov usporiadaných podľa kategórií a skupín (PRIRADENÉ tímy)
             // fetchuje kluby s groupId != null
             async function displayClubs() {
                 clubsContentDiv.innerHTML = ''; // Vyčistiť kontajner

                 try {
                     // Načítať všetky kluby, ktoré SÚ priradené do skupín (groupId != null)
                      const q = query(clubsCollectionRef, where('groupId', '!=', null));
                     const clubsSnapshot = await getDocs(q);

                     const clubs = clubsSnapshot.docs.map(clubDoc => ({ id: clubDoc.id, data: clubDoc.data() })); // Get club data with auto-generated ID

                     if (clubs.length === 0) {
                         console.log("Žiadne kluby priradené do skupín nenájdené.");
                         const message = document.createElement('p');
                         message.textContent = "Žiadne kluby zatiaľ neboli priradené do skupín.";
                         clubsContentDiv.appendChild(message); // Správu pridáme do kontajnera div
                         return;
                     }

                     // Zoskupenie klubov najprv podľa categoryId a potom podľa groupId
                     const clubsByCategoryAndGroup = {};
                     clubs.forEach(club => {
                         const categoryId = club.data.categoryId;
                         const groupId = club.data.groupId; // Toto je kompozitné ID skupiny (NázovKategórie - NázovSkupiny)

                         // Ensure categoryId and groupId exist for grouping
                          if (categoryId && groupId && categoryId !== 'null' && groupId !== 'null') { // Added check against 'null' strings
                              if (!clubsByCategoryAndGroup[categoryId]) {
                                  clubsByCategoryAndGroup[categoryId] = {};
                              }
                              if (!clubsByCategoryAndGroup[categoryId][groupId]) {
                                  clubsByCategoryAndGroup[categoryId][groupId] = [];
                              }
                               clubsByCategoryAndGroup[categoryId][groupId].push(club); // Uložíme celý objekt { id: auto-generated, data }
                          } else {
                              console.warn(`Klub ${club.id} priradený do skupiny (groupId != null) nemá platnú categoryId (${categoryId}) alebo groupId (${groupId}).`);
                          }
                     });

                     // Získaj zotriedené názvy kategórií
                     const sortedCategories = Object.keys(clubsByCategoryAndGroup).sort();

                      if (sortedCategories.length === 0 && clubs.length > 0) {
                          // This case happens if clubs exist but none have valid categoryId/groupId for grouping
                           console.warn("Kluby boli nájdené, ale žiadne nemajú platné categoryId/groupId na zobrazenie v skupinách.");
                           const message = document.createElement('p');
                           message.textContent = "Existujú kluby, ale žiadne nemajú priradenú kategóriu a skupinu pre zobrazenie tu.";
                           clubsContentDiv.appendChild(message);
                           return;
                      }


                     // Iteruj cez kategórie a skupiny, aby si vytvoril/a sekcie a tabuľky
                     sortedCategories.forEach(categoryId => {
                         // Získaj zotriedené kompozitné ID skupín v danej kategórii
                         const sortedGroups = Object.keys(clubsByCategoryAndGroup[categoryId]).sort();

                         sortedGroups.forEach(groupId => {
                             const clubsInThisGroup = clubsByCategoryAndGroup[categoryId][groupId];

                             // Vytvor section block pre túto kombináciu kategória-skupina
                             const groupClubSectionDiv = document.createElement('div');
                             groupClubSectionDiv.classList.add('section-block');

                             // Vytvor nadpis pre túto sekciu
                             const groupNameParts = groupId.split(' - ');
                             const groupName = groupNameParts.length > 1 ? groupNameParts.slice(1).join(' - ') : groupId;

                             const sectionHeading = document.createElement('h2');
                             sectionHeading.textContent = `${categoryId} - ${groupName}`;
                             groupClubSectionDiv.appendChild(sectionHeading);

                             // Vytvor tabuľku pre kluby v tejto skupine
                             const clubTable = document.createElement('table');
                             clubTable.classList.add('group-clubs-table');

                             // Vytvor hlavičku tabuľky
                             const thead = document.createElement('thead');
                             const headerRow = document.createElement('tr');
                             const clubNameTh = document.createElement('th');
                             clubNameTh.textContent = 'Názov klubu';
                              const actionsTh = document.createElement('th');
                              actionsTh.textContent = 'Akcie';
                              actionsTh.style.width = '150px';

                              headerRow.appendChild(clubNameTh);
                              headerRow.appendChild(actionsTh);
                              thead.appendChild(headerRow);
                              clubTable.appendChild(thead);


                             // Vytvor telo tabuľky
                             const tbody = document.createElement('tbody');

                             if (clubsInThisGroup.length === 0) {
                                  const noClubsRow = document.createElement('tr');
                                  const td = document.createElement('td');
                                  td.colSpan = 2;
                                  td.textContent = `Žiadne kluby v tejto skupine.`;
                                  td.style.textAlign = 'center';
                                  tbody.appendChild(noClubsRow); // Corrected this line
                             } else {
                                  // Sort clubs by name before displaying
                                  clubsInThisGroup.sort((a, b) => (a.data.name || '').localeCompare(b.data.name || ''));

                                  // Pridaj riadky pre každý klub v tejto skupine
                                  clubsInThisGroup.forEach(club => {
                                      const tr = document.createElement('tr');

                                      const nameTd = document.createElement('td');
                                      nameTd.textContent = club.data.name; // Zobraz názov klubu z dát

                                      const actionsTd = document.createElement('td');
                                      actionsTd.style.whiteSpace = 'nowrap';

                                      // === TLAČIDLO ÚPRAVA KLUBU (ZMENIŤ SKUPINU/KATEGÓRIU/NÁZOV) ===
                                      // Otvorí clubModal v režime úpravy
                                       const editClubButton = document.createElement('button');
                                       editClubButton.textContent = 'Upraviť';
                                       editClubButton.classList.add('action-button');
                                       editClubButton.onclick = () => {
                                            // Open the club modal with the current club data for editing
                                           // Pass the auto-generated ID and data
                                            openClubModal(club.id, club.data);
                                        };
                                       actionsTd.appendChild(editClubButton);


                                      // === TLAČIDLO VYMAZAŤ KLUBU (ZMAZAŤ ÚPLNE) ===
                                      // Mazanie klubu z tejto sekcie by malo asi znamenať úplné zmazanie dokumentu z Firestore.
                                       const deleteClubButton = document.createElement('button');
                                       deleteClubButton.textContent = 'Vymazať';
                                       deleteClubButton.classList.add('action-button', 'delete-button');
                                       deleteClubButton.onclick = async () => { // THIS is where the error likely occurred
                                        // === OPRAVENÉ: Používa deleteGroupButton ===
                                        // Zmenil som tu 'deleteButton' na 'deleteGroupButton' - OPRAVENÉ V PREDOSLEJ ODPOVEDI
                                        if (!confirm(`Naozaj chcete vymazať skupinu "${group.data.name}" z kategórie "${group.data.categoryId}"? Tímy priradené k tejto skupine prídu o priradenie (groupId sa nastaví na null)!`)) { // Updated warning
                                             return;
                                        }
                                        try {
                                             // Pred zmazaním skupiny nájdi všetky kluby, ktoré na ňu odkazujú a aktualizuj ich
                                             const batch = writeBatch(db);

                                             const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', group.id));
                                             const clubsSnapshot = await getDocs(clubsInGroupQuery); // Use await here
                                             clubsSnapshot.forEach(doc => {
                                                  batch.update(doc.ref, { groupId: null }); // Nastav groupId na null
                                                  console.log(`Klub "${doc.id}" odpriradený zo skupiny "${group.id}".`);
                                              });

                                              // Nakoniec zmaž samotnú skupinu
                                              batch.delete(doc(groupsCollectionRef, group.id));

                                              await batch.commit();

                                              console.log(`Skupina "${group.data.name}" (ID: ${group.id}) a súvisiace kluby boli úspešne zmazané/aktualizované.`);

                                              // Refresh displays that might be affected
                                              displayGroupsByCategory(); // Reload display
                                              if (window.location.hash === '#timy-do-skupin') displayClubs();
                                              if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();


                                          } catch (error) {
                                              console.error('Chyba pri mazaní skupiny a súvisiacich dát: ', error);
                                              alert('Chyba pri mazaní skupiny! Prosím, skúste znova.');
                                          }
                                     };

                                     groupActionsTd.appendChild(editGroupButton);
                                     // === OPRAVENÉ: Používa deleteGroupButton ===
                                     groupActionsTd.appendChild(deleteGroupButton); // <<< OPRAVA BOLA TU A JE ZACHOVANÁ

                                     groupRow.appendChild(groupNameTd);
                                     groupRow.appendChild(groupActionsTd);
                                     tbody.appendChild(groupRow);
                                });
                             }

                             categoryGroupsTable.appendChild(tbody);
                             categorySectionDiv.appendChild(categoryGroupsTable);
                             groupsContentDiv.appendChild(categorySectionDiv); // Append the section div to the main container
                         });


                      } catch (error) {
                          console.error('Chyba pri načítaní alebo zobrazovaní skupín: ', error);
                          const errorMessage = document.createElement('p');
                          errorMessage.textContent = 'Chyba pri načítaní dát skupín.';
                          groupsContentDiv.appendChild(errorMessage);
                      }
             }


             // --- Funkcie pre Kluby (Priradenie do skupín & Správa priradených) ---

             // NEW: Funkcia na načítanie nepriradených tímov a naplnenie selectu v modáli klubu
             async function populateUnassignedClubsSelect(selectElement, selectedClubId = null) {
                  selectElement.innerHTML = '<option value="">-- Vyberte tím na priradenie --</option>';
                  selectElement.disabled = true; // Disable until clubs are loaded


                  try {
                      // Query clubs where groupId is null (unassigned teams)
                      const q = query(clubsCollectionRef, where('groupId', '==', null));
                      const querySnapshot = await getDocs(q);

                      if (querySnapshot.empty) {
                          console.log("Žiadne nepriradené tímy na priradenie.");
                          const option = document.createElement('option');
                          option.value = "";
                          option.textContent = "-- Žiadne tímy na priradenie --";
                          option.disabled = true;
                          selectElement.appendChild(option);
                          selectElement.disabled = false; // Re-enable even if empty
                      } else {
                           selectElement.disabled = false; // Enable the select
                           // Sort unassigned teams alphabetically by name
                            const sortedDocs = querySnapshot.docs.sort((a, b) => (a.data().name || '').localeCompare(b.data().name || ''));

                            sortedDocs.forEach((doc) => {
                                 const clubData = doc.data();
                                 const clubId = doc.id; // Auto-generated ID

                                 const option = document.createElement('option');
                                 option.value = clubId; // Use the auto-generated ID as value
                                 option.textContent = clubData.name; // Display the club name
                                 selectElement.appendChild(option);
                            });

                            // Select the provided club ID if needed (e.g., if modal is reused for something like re-assigning)
                            if (selectedClubId) {
                                  if (selectElement.querySelector(`option[value="${selectedClubId}"]`)) {
                                       selectElement.value = selectedClubId;
                                  } else {
                                       console.warn(`Nepriradený tím s ID "${selectedClubId}" nenájdený.`);
                                       selectElement.value = ""; // Reset to default
                                  }
                            }
                         }
                     } catch (error) {
                         console.error('Chyba pri načítaní nepriradených tímov pre select: ', error);
                         selectElement.innerHTML = '<option value="">Chyba pri načítaní tímov</option>'; // Indicate error
                         selectElement.disabled = true; // Keep disabled on error
                    }
                 }


             // Funkcia na otvorenie modálu klubu (pre priradenie do skupiny ALEBO úpravu priradeného)
             // clubId je auto-generované ID dokumentu
             async function openClubModal(clubId = null, clubData = null) { // clubId is auto-generated ID
                  clubModal.style.display = 'block';

                  // Reset form fields including the new select
                  clubForm.reset();
                  clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>'; // Clear groups
                  clubGroupSelect.disabled = true;
                  clubCategorySelect.value = ""; // Reset category select

                  // Reset visibility of name input vs select
                  unassignedClubSelectContainer.style.display = 'block';
                  clubNameInputContainer.style.display = 'none';


                  if (clubId && clubData) {
                     // Edit mode (Editing an ALREADY ASSIGNED club)
                     currentClubModalMode = 'edit-assigned';
                     editingClubId = clubId; // Store the auto-generated ID of the club being edited
                     clubModalTitle.textContent = 'Upraviť klub v skupine'; // Specific title
                     clubFormSubmitButton.textContent = 'Uložiť zmeny';

                     // Hide the unassigned clubs select, show the name input (allow editing name of this instance)
                     unassignedClubSelectContainer.style.display = 'none';
                     clubNameInputContainer.style.display = 'block';
                     clubNameInput.readOnly = false;

                     // Populate the category select and then set the value
                     await populateCategorySelect(clubCategorySelect, clubData.categoryId, []); // Pass empty array for excluded

                     // Populate the group select based on the selected category and then set the group value
                     if(clubData.categoryId) {
                          // Pass the composite group ID (clubData.groupId) to select
                          await populateGroupSelect(clubData.categoryId, clubGroupSelect, clubData.groupId);
                     }

                     // Fill the form fields
                     clubNameInput.value = clubData.name; // Use the 'name' field from data
                     // Category and Group selects are set by populate functions

                 } else {
                     // Add mode (Assigning an UNASSIGNED club to a group)
                     currentClubModalMode = 'add-assign';
                     editingClubId = null; // No specific club ID selected yet via edit button
                     clubModalTitle.textContent = 'Priradiť tím do skupiny'; // Specific title
                     clubFormSubmitButton.textContent = 'Priradiť'; // Specific button text

                     // Show the unassigned clubs select, hide the name input
                     unassignedClubSelectContainer.style.display = 'block';
                     clubNameInputContainer.style.display = 'none';
                     clubNameInput.value = ''; // Clear the name input just in case

                     // Populate the unassigned clubs select
                     await populateUnassignedClubsSelect(unassignedClubSelect, null); // Pass select element

                     // Populate the category select (no category pre-selected initially for assignment)
                     await populateCategorySelect(clubCategorySelect, null, []); // Pass empty array for excluded
                 }

                 // Set focus based on mode
                 if (currentClubModalMode === 'add-assign') {
                      unassignedClubSelect.focus();
                 } else { // edit-assigned
                      clubNameInput.focus();
                 }
            }

             // Funkcia na zobrazenie klubov usporiadaných podľa kategórií a skupín (PRIRADENÉ tímy)
             // fetchuje kluby s groupId != null
             async function displayClubs() {
                 clubsContentDiv.innerHTML = ''; // Vyčistiť kontajner

                 try {
                     // Načítať všetky kluby, ktoré SÚ priradené do skupín (groupId != null)
                      const q = query(clubsCollectionRef, where('groupId', '!=', null));
                     const clubsSnapshot = await getDocs(q);

                     const clubs = clubsSnapshot.docs.map(clubDoc => ({ id: clubDoc.id, data: clubDoc.data() })); // Get club data with auto-generated ID

                     if (clubs.length === 0) {
                         console.log("Žiadne kluby priradené do skupín nenájdené.");
                         const message = document.createElement('p');
                         message.textContent = "Žiadne kluby zatiaľ neboli priradené do skupín.";
                         clubsContentDiv.appendChild(message); // Správu pridáme do kontajnera div
                         return;
                     }

                     // Zoskupenie klubov najprv podľa categoryId a potom podľa groupId
                     const clubsByCategoryAndGroup = {};
                     clubs.forEach(club => {
                         const categoryId = club.data.categoryId;
                         const groupId = club.data.groupId; // Toto je kompozitné ID skupiny (NázovKategórie - NázovSkupiny)

                         // Ensure categoryId and groupId exist for grouping
                          if (categoryId && groupId && categoryId !== 'null' && groupId !== 'null') { // Added check against 'null' strings
                              if (!clubsByCategoryAndGroup[categoryId]) {
                                  clubsByCategoryAndGroup[categoryId] = {};
                              }
                              if (!clubsByCategoryAndGroup[categoryId][groupId]) {
                                  clubsByCategoryAndGroup[categoryId][groupId] = [];
                              }
                               clubsByCategoryAndGroup[categoryId][groupId].push(club); // Uložíme celý objekt { id: auto-generated, data }
                          } else {
                              console.warn(`Klub ${club.id} priradený do skupiny (groupId != null) nemá platnú categoryId (${categoryId}) alebo groupId (${groupId}).`);
                          }
                     });

                     // Získaj zotriedené názvy kategórií
                     const sortedCategories = Object.keys(clubsByCategoryAndGroup).sort();

                      if (sortedCategories.length === 0 && clubs.length > 0) {
                          // This case happens if clubs exist but none have valid categoryId/groupId for grouping
                           console.warn("Kluby boli nájdené, ale žiadne nemajú platné categoryId/groupId na zobrazenie v skupinách.");
                           const message = document.createElement('p');
                           message.textContent = "Existujú kluby, ale žiadne nemajú priradenú kategóriu a skupinu pre zobrazenie tu.";
                           clubsContentDiv.appendChild(message);
                           return;
                      }


                     // Iteruj cez kategórie a skupiny, aby si vytvoril/a sekcie a tabuľky
                     sortedCategories.forEach(categoryId => {
                         // Získaj zotriedené kompozitné ID skupín v danej kategórii
                         const sortedGroups = Object.keys(clubsByCategoryAndGroup[categoryId]).sort();

                         sortedGroups.forEach(groupId => {
                             const clubsInThisGroup = clubsByCategoryAndGroup[categoryId][groupId];

                             // Vytvor section block pre túto kombináciu kategória-skupina
                             const groupClubSectionDiv = document.createElement('div');
                             groupClubSectionDiv.classList.add('section-block');

                             // Vytvor nadpis pre túto sekciu
                             const groupNameParts = groupId.split(' - ');
                             const groupName = groupNameParts.length > 1 ? groupNameParts.slice(1).join(' - ') : groupId;

                             const sectionHeading = document.createElement('h2');
                             sectionHeading.textContent = `${categoryId} - ${groupName}`;
                             groupClubSectionDiv.appendChild(sectionHeading);

                             // Vytvor tabuľku pre kluby v tejto skupine
                             const clubTable = document.createElement('table');
                             clubTable.classList.add('group-clubs-table');

                             // Vytvor hlavičku tabuľky
                             const thead = document.createElement('thead');
                             const headerRow = document.createElement('tr');
                             const clubNameTh = document.createElement('th');
                             clubNameTh.textContent = 'Názov klubu';
                              const actionsTh = document.createElement('th');
                              actionsTh.textContent = 'Akcie';
                              actionsTh.style.width = '150px';

                              headerRow.appendChild(clubNameTh);
                              headerRow.appendChild(actionsTh);
                              thead.appendChild(headerRow);
                              clubTable.appendChild(thead);


                             // Vytvor telo tabuľky
                             const tbody = document.createElement('tbody');

                             if (clubsInThisGroup.length === 0) {
                                  const noClubsRow = document.createElement('tr');
                                  const td = document.createElement('td');
                                  td.colSpan = 2;
                                  td.textContent = `Žiadne kluby v tejto skupine.`;
                                  td.style.textAlign = 'center';
                                  tbody.appendChild(noClubsRow); // Corrected this line
                             } else {
                                  // Sort clubs by name before displaying
                                  clubsInThisGroup.sort((a, b) => (a.data.name || '').localeCompare(b.data.name || ''));

                                  // Pridaj riadky pre každý klub v tejto skupine
                                  clubsInThisGroup.forEach(club => {
                                      const tr = document.createElement('tr');

                                      const nameTd = document.createElement('td');
                                      nameTd.textContent = club.data.name; // Zobraz názov klubu z dát

                                      const actionsTd = document.createElement('td');
                                      actionsTd.style.whiteSpace = 'nowrap';

                                      // === TLAČIDLO ÚPRAVA KLUBU (ZMENIŤ SKUPINU/KATEGÓRIU/NÁZOV) ===
                                      // Otvorí clubModal v režime úpravy
                                       const editClubButton = document.createElement('button');
                                       editClubButton.textContent = 'Upraviť';
                                       editClubButton.classList.add('action-button');
                                       editClubButton.onclick = () => {
                                            // Open the club modal with the current club data for editing
                                           // Pass the auto-generated ID and data
                                            openClubModal(club.id, club.data);
                                        };
                                       actionsTd.appendChild(editClubButton);


                                      // === TLAČIDLO VYMAZAŤ KLUBU (ZMAZAŤ ÚPLNE) ===
                                      // Mazanie klubu z tejto sekcie by malo asi znamenať úplné zmazanie dokumentu z Firestore.
                                       const deleteClubButton = document.createElement('button');
                                       deleteClubButton.textContent = 'Vymazať';
                                       deleteClubButton.classList.add('action-button', 'delete-button');
                                       deleteClubButton.onclick = async () => { // THIS is where the error likely occurred
                                        // === OPRAVENÉ: Používa deleteGroupButton ===
                                        // Zmenil som tu 'deleteButton' na 'deleteGroupButton' - OPRAVENÉ V PREDOSLEJ ODPOVEDI
                                        if (!confirm(`Naozaj chcete vymazať skupinu "${group.data.name}" z kategórie "${group.data.categoryId}"? Tímy priradené k tejto skupine prídu o priradenie (groupId sa nastaví na null)!`)) { // Updated warning
                                             return;
                                        }
                                        try {
                                             // Pred zmazaním skupiny nájdi všetky kluby, ktoré na ňu odkazujú a aktualizuj ich
                                             const batch = writeBatch(db);

                                             const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', group.id));
                                             const clubsSnapshot = await getDocs(clubsInGroupQuery); // Use await here
                                             clubsSnapshot.forEach(doc => {
                                                  batch.update(doc.ref, { groupId: null }); // Nastav groupId na null
                                                  console.log(`Klub "${doc.id}" odpriradený zo skupiny "${group.id}".`);
                                              });

                                              // Nakoniec zmaž samotnú skupinu
                                              batch.delete(doc(groupsCollectionRef, group.id));

                                              await batch.commit();

                                              console.log(`Skupina "${group.data.name}" (ID: ${group.id}) a súvisiace kluby boli úspešne zmazané/aktualizované.`);

                                              // Refresh displays that might be affected
                                              displayGroupsByCategory(); // Reload display
                                              if (window.location.hash === '#timy-do-skupin') displayClubs();
                                              if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();


                                          } catch (error) {
                                              console.error('Chyba pri mazaní skupiny a súvisiacich dát: ', error);
                                              alert('Chyba pri mazaní skupiny! Prosím, skúste znova.');
                                          }
                                     };

                                     groupActionsTd.appendChild(editGroupButton);
                                     // === OPRAVENÉ: Používa deleteGroupButton ===
                                     groupActionsTd.appendChild(deleteGroupButton); // <<< OPRAVA BOLA TU A JE ZACHOVANÁ

                                     groupRow.appendChild(groupNameTd);
                                     groupRow.appendChild(groupActionsTd);
                                     tbody.appendChild(groupRow);
                                });
                             }

                             categoryGroupsTable.appendChild(tbody);
                             categorySectionDiv.appendChild(categoryGroupsTable);
                             groupsContentDiv.appendChild(categorySectionDiv); // Append the section div to the main container
                         });


                      } catch (error) {
                          console.error('Chyba pri načítaní alebo zobrazovaní skupín: ', error);
                          const errorMessage = document.createElement('p');
                          errorMessage.textContent = 'Chyba pri načítaní dát skupín.';
                          groupsContentDiv.appendChild(errorMessage);
                      }
             }


             // --- Funkcie pre Kluby (Priradenie do skupín & Správa priradených) ---

             // NEW: Funkcia na načítanie nepriradených tímov a naplnenie selectu v modáli klubu
             async function populateUnassignedClubsSelect(selectElement, selectedClubId = null) {
                  selectElement.innerHTML = '<option value="">-- Vyberte tím na priradenie --</option>';
                  selectElement.disabled = true; // Disable until clubs are loaded


                  try {
                      // Query clubs where groupId is null (unassigned teams)
                      const q = query(clubsCollectionRef, where('groupId', '==', null));
                      const querySnapshot = await getDocs(q);

                      if (querySnapshot.empty) {
                          console.log("Žiadne nepriradené tímy na priradenie.");
                          const option = document.createElement('option');
                          option.value = "";
                          option.textContent = "-- Žiadne tímy na priradenie --";
                          option.disabled = true;
                          selectElement.appendChild(option);
                          selectElement.disabled = false; // Re-enable even if empty
                      } else {
                           selectElement.disabled = false; // Enable the select
                           // Sort unassigned teams alphabetically by name
                            const sortedDocs = querySnapshot.docs.sort((a, b) => (a.data().name || '').localeCompare(b.data().name || ''));

                            sortedDocs.forEach((doc) => {
                                 const clubData = doc.data();
                                 const clubId = doc.id; // Auto-generated ID

                                 const option = document.createElement('option');
                                 option.value = clubId; // Use the auto-generated ID as value
                                 option.textContent = clubData.name; // Display the club name
                                 selectElement.appendChild(option);
                            });

                            // Select the provided club ID if needed (e.g., if modal is reused for something like re-assigning)
                            if (selectedClubId) {
                                  if (selectElement.querySelector(`option[value="${selectedClubId}"]`)) {
                                       selectElement.value = selectedClubId;
                                  } else {
                                       console.warn(`Nepriradený tím s ID "${selectedClubId}" nenájdený.`);
                                       selectElement.value = ""; // Reset to default
                                  }
                            }
                         }
                     } catch (error) {
                         console.error('Chyba pri načítaní nepriradených tímov pre select: ', error);
                         selectElement.innerHTML = '<option value="">Chyba pri načítaní tímov</option>'; // Indicate error
                         selectElement.disabled = true; // Keep disabled on error
                    }
                 }


             // Funkcia na otvorenie modálu klubu (pre priradenie do skupiny ALEBO úpravu priradeného)
             // clubId je auto-generované ID dokumentu
             async function openClubModal(clubId = null, clubData = null) { // clubId is auto-generated ID
                  clubModal.style.display = 'block';

                  // Reset form fields including the new select
                  clubForm.reset();
                  clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>'; // Clear groups
                  clubGroupSelect.disabled = true;
                  clubCategorySelect.value = ""; // Reset category select

                  // Reset visibility of name input vs select
                  unassignedClubSelectContainer.style.display = 'block';
                  clubNameInputContainer.style.display = 'none';


                  if (clubId && clubData) {
                     // Edit mode (Editing an ALREADY ASSIGNED club)
                     currentClubModalMode = 'edit-assigned';
                     editingClubId = clubId; // Store the auto-generated ID of the club being edited
                     clubModalTitle.textContent = 'Upraviť klub v skupine'; // Specific title
                     clubFormSubmitButton.textContent = 'Uložiť zmeny';

                     // Hide the unassigned clubs select, show the name input (allow editing name of this instance)
                     unassignedClubSelectContainer.style.display = 'none';
                     clubNameInputContainer.style.display = 'block';
                     clubNameInput.readOnly = false;

                     // Populate the category select and then set the value
                     await populateCategorySelect(clubCategorySelect, clubData.categoryId, []); // Pass empty array for excluded

                     // Populate the group select based on the selected category and then set the group value
                     if(clubData.categoryId) {
                          // Pass the composite group ID (clubData.groupId) to select
                          await populateGroupSelect(clubData.categoryId, clubGroupSelect, clubData.groupId);
                     }

                     // Fill the form fields
                     clubNameInput.value = clubData.name; // Use the 'name' field from data
                     // Category and Group selects are set by populate functions

                 } else {
                     // Add mode (Assigning an UNASSIGNED club to a group)
                     currentClubModalMode = 'add-assign';
                     editingClubId = null; // No specific club ID selected yet via edit button
                     clubModalTitle.textContent = 'Priradiť tím do skupiny'; // Specific title
                     clubFormSubmitButton.textContent = 'Priradiť'; // Specific button text

                     // Show the unassigned clubs select, hide the name input
                     unassignedClubSelectContainer.style.display = 'block';
                     clubNameInputContainer.style.display = 'none';
                     clubNameInput.value = ''; // Clear the name input just in case

                     // Populate the unassigned clubs select
                     await populateUnassignedClubsSelect(unassignedClubSelect, null); // Pass select element

                     // Populate the category select (no category pre-selected initially for assignment)
                     await populateCategorySelect(clubCategorySelect, null, []); // Pass empty array for excluded
                 }

                 // Set focus based on mode
                 if (currentClubModalMode === 'add-assign') {
                      unassignedClubSelect.focus();
                 } else { // edit-assigned
                      clubNameInput.focus();
                 }
            }

             // Funkcia na zobrazenie vytvorených tímov (klubov, ktoré ešte nie sú priradené do skupiny) - UPRAVENÉ PRE TABUĽKOVÉ ZOBRAZENIE PODĽA KATEGÓRIÍ A ROZKLIKÁVACÍCH RIADKOV
             async function displayCreatedTeams() {
                  createdTeamsTableBody.innerHTML = ''; // Clear existing rows
                  createdTeamsTableHead.innerHTML = ''; // Clear existing header

                  try {
                      // 1. Načítať všetky nepriradené tímy
                      const q = query(clubsCollectionRef, where('groupId', '==', null));
                      const querySnapshot = await getDocs(q);
                      const unassignedTeams = querySnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));

                      // 2. Načítať všetky kategórie (použi kešované, ak sú k dispozícii)
                      const categoriesToDisplay = allCategories.length > 0 ? allCategories : (await getDocs(categoriesCollectionRef)).docs.map(doc => doc.id).sort();
                       if (allCategories.length === 0 && categoriesToDisplay.length > 0) {
                            console.log("Populating categories for display from fresh fetch, caching now.");
                            allCategories = categoriesToDisplay; // Cache if fetched fresh
                       }


                      if (unassignedTeams.length === 0) {
                          console.log("Žiadne tímy na priradenie do skupín zatiaľ nenájdené.");
                          const noDataRow = document.createElement('tr');
                          const td = document.createElement('td');
                          td.colSpan = categoriesToDisplay.length + 1; // Názov tímu + počet kategórií
                          td.textContent = "Žiadne tímy na priradenie zatiaľ pridané.";
                          td.style.textAlign = 'center';
                          noDataRow.appendChild(td);
                          createdTeamsTableBody.appendChild(noDataRow);
                          return; // Exit early if no teams
                      }

                     // 3. Vytvoriť zoskupenie tímov podľa základného názvu tímu a kategórie
                      // Budeme potrebovať funkciu na extrakciu základného názvu, ak používate prípony (napr. "MŠK IUVENTA Michalovce A" -> "MŠK IUVENTA Michalovce")
                     // Predpokladám, že základný názov je to, čo ste zadali pri vytváraní.
                     // Ak je názov vo formáte "Base Name Letter" (napr. "MŠK IUVENTA Michalovce A"), základný názov je "Base Name" ("MŠK IUVENTA Michalovce").
                     // Ak je názov bez prípony alebo s iným formátom, celý názov sa považuje za základný názov.
                     // Toto je jednoduchá heuristika, môže byť potrebné ju upraviť podľa vašich presných pravidiel pomenovania.

                     function getBaseTeamName(fullTeamName) {
                         if (!fullTeamName) return 'Neznámy názov';
                          const parts = fullTeamName.split(' ');
                          if (parts.length > 1) {
                               const lastPart = parts[parts.length - 1];
                               // Check if the last part is a single uppercase letter
                              if (lastPart.length === 1 && lastPart >= 'A' && lastPart <= 'Z') {
                                 return parts.slice(0, -1).join(' '); // Base name is everything except the last part
                              }
                          }
                          return fullTeamName; // If no letter suffix found, the full name is the base name
                     }


                     const teamNames = new Set();
                     const teamsByBaseNameAndCategory = {};

                     unassignedTeams.forEach(team => {
                         const fullTeamName = team.data.name; // Use the full name from data
                         const baseName = getBaseTeamName(fullTeamName); // Get the derived base name
                         const categoryId = team.data.categoryId || 'Nepriradená'; // Handle teams without category if they exist

                         teamNames.add(baseName); // Collect unique base names

                         if (!teamsByBaseNameAndCategory[baseName]) {
                              teamsByBaseNameAndCategory[baseName] = {};
                         }
                          if (!teamsByBaseNameAndCategory[baseName][categoryId]) {
                               // Store the list of teams with this base name and category
                               teamsByBaseNameAndCategory[baseName][categoryId] = [];
                          }
                          teamsByBaseNameAndCategory[baseName][categoryId].push(team); // Store the full team object (id, data)

                     });

                     // Sort unique base names
                     const sortedBaseNames = Array.from(teamNames).sort();


                     // 4. Vytvoriť hlavičku tabuľky
                      const headerRow = document.createElement('tr');
                      const teamNameHeader = document.createElement('th');
                      teamNameHeader.textContent = 'Názov tímu';
                      headerRow.appendChild(teamNameHeader);

                      // Sort categories alphabetically for header
                      const sortedCategoriesForHeader = categoriesToDisplay.sort();

                      sortedCategoriesForHeader.forEach(categoryName => {
                          const th = document.createElement('th');
                          th.textContent = categoryName;
                          headerRow.appendChild(th);
                      });

                      // You can optionally add an 'Akcie' header here if you decide how to handle actions
                      // const actionsHeader = document.createElement('th');
                      // actionsHeader.textContent = 'Akcie';
                      // headerRow.appendChild(actionsHeader);


                      createdTeamsTableHead.appendChild(headerRow);


                     // 5. Vytvoriť telo tabuľky
                     sortedBaseNames.forEach(baseName => {
                         const tr = document.createElement('tr'); // Main row for the base name
                         tr.setAttribute('data-base-name', baseName); // Add data attribute for easy selection

                          // First cell: Team Base Name
                         const nameTd = document.createElement('td');
                         nameTd.textContent = baseName;
                         tr.appendChild(nameTd);

                         // Cells for each category count
                          sortedCategoriesForHeader.forEach(categoryName => {
                              const countTd = document.createElement('td');
                              // Get the array of teams for this base name and category, or empty array if none
                               const teamsInThisCategory = teamsByBaseNameAndCategory[baseName]?.[categoryName] || [];
                               const teamCount = teamsInThisCategory.length;

                              // Display the count
                              countTd.textContent = teamCount > 0 ? teamCount : ''; // Display count or empty string if 0
                              // Add data attribute to store the count and category
                              countTd.setAttribute('data-team-count', teamCount);
                              countTd.setAttribute('data-category', categoryName);

                               // Add click listener if there are teams to display
                               if (teamCount > 0) {
                                    // Store the team data associated with this cell (all team instances for this base name and category)
                                   countTd.dataset.teams = JSON.stringify(teamsInThisCategory);


                                    countTd.addEventListener('click', function() {
                                        const clickedCell = this; // 'this' inside the event listener refers to countTd
                                        const baseName = clickedCell.parentElement.getAttribute('data-base-name'); // Get base name from parent row
                                        const category = clickedCell.getAttribute('data-category'); // Get category from cell
                                         // Retrieve and parse team data from the cell's dataset
                                        const teamsData = JSON.parse(clickedCell.dataset.teams);


                                         // Find the main row (the one with the base name)
                                         const mainRow = clickedCell.parentElement;

                                         // Check if sub-rows for this cell already exist
                                         // We can identify sub-rows by a specific class and data attributes linking them to the main row and category
                                         // Use a more specific selector to only target direct sub-rows of tbody related to THIS cell's category
                                         const existingSubRows = createdTeamsTableBody.querySelectorAll(`tr.sub-row[data-base-name="${baseName}"][data-category="${category}"]`);


                                         if (existingSubRows.length > 0) {
                                             // Sub-rows exist, hide them
                                             existingSubRows.forEach(subRow => subRow.remove());
                                         } else {
                                             // Sub-rows do not exist, create and display them
                                             teamsData.forEach(team => {
                                                 const subRow = document.createElement('tr');
                                                 subRow.classList.add('sub-row'); // Add class for styling and identification
                                                 subRow.setAttribute('data-base-name', baseName); // Link to main row
                                                 subRow.setAttribute('data-category', category); // Link to category

                                                 // Create cells for the sub-row
                                                  // First cell for indented team name
                                                  const subNameTd = document.createElement('td');
                                                  subNameTd.textContent = team.data.name; // Display the full team name
                                                  // Apply indentation using CSS class or inline style
                                                  subNameTd.style.paddingLeft = '35px'; // Indent by 20px + default padding


                                                 // Create cells for each category column to match the header structure
                                                  sortedCategoriesForHeader.forEach(cat => {
                                                      const categoryCell = document.createElement('td');
                                                       // Check if this sub-team belongs to the category of the current column
                                                       if (team.data.categoryId === cat) {
                                                           categoryCell.textContent = '1'; // Display '1' if it belongs to this category
                                                            categoryCell.style.textAlign = 'center'; // Center the '1'
                                                       } else {
                                                           categoryCell.textContent = ''; // Otherwise, leave empty
                                                       }
                                                       // Ensure text alignment for the number '1' if needed, or let CSS handle it
                                                       // categoryCell.style.textAlign = 'center';

                                                      subRow.appendChild(categoryCell); // Append category cell
                                                  });

                                                // Optional: Add an actions cell for the individual team
                                                // const subActionsTd = document.createElement('td');
                                                // Add edit/delete buttons for team.id
                                                // subRow.appendChild(subActionsTd);


                                                subRow.insertBefore(subNameTd, subRow.firstChild); // Insert the name cell as the first child

                                                // Insert the sub-row immediately after the main row
                                                mainRow.parentElement.insertBefore(subRow, mainRow.nextSibling);
                                            });
                                         }

                                    });
                               }


                              tr.appendChild(countTd);
                          });

                          // Optional: Add an 'Akcie' cell if you add the header back
                          // const actionsTd = document.createElement('td');
                          // actionsTd.style.whiteSpace = 'nowrap';
                          // Add buttons here if needed, considering how they apply to the summarized view
                          // tr.appendChild(actionsTd);


                         createdTeamsTableBody.appendChild(tr);
                     });

                      console.log(`Načítaných a zoskupených tímov (na priradenie do skupín).`);

                  } catch (error) {
                      console.error('Chyba pri načítaní alebo zobrazovaní vytvorených tímov v novom formáte: ', error);
                      const errorMessage = document.createElement('tr'); // Use tr to fit in table body
                      const td = document.createElement('td');
                      td.colSpan = (allCategories.length > 0 ? allCategories.length : 1) + 1; // Estimate colspan
                      td.textContent = 'Chyba pri načítaní dát tímov.';
                      td.style.textAlign = 'center';
                      errorMessage.appendChild(td);
                      createdTeamsTableBody.appendChild(errorMessage);
                  }
             }

             // NEW: Function to update the available options in all category selects
              function updateCategorySelectOptions() {
                  // Get all currently selected categories across all groups
                  const selectedCategoryIds = [];
                  const initialSelect = initialCategoryCountGroup.querySelector('select');
                  if (initialSelect.value !== '') {
                       selectedCategoryIds.push(initialSelect.value);
                  }

                  const dynamicGroups = dynamicCategoryCountContainer.querySelectorAll('.category-count-group');
                  dynamicGroups.forEach(groupDiv => {
                       const categorySelect = groupDiv.querySelector('select');
                       if (categorySelect.value !== '') {
                            selectedCategoryIds.push(categorySelect.value);
                       }
                  });

                  // Now update options for each select
                  // Update initial select (it should only exclude categories selected IN OTHER dynamic selects)
                  const otherSelectedCategoryIdsForInitial = selectedCategoryIds.filter(id => id !== initialSelect.value);
                  // Corrected call: Pass an empty array if otherSelectedCategoryIdsForInitial is empty, although filter should handle this.
                  populateCategorySelect(initialSelect, initialSelect.value, otherSelectedCategoryIdsForInitial); // Pass current value and excluded IDs

                  // Update dynamic selects
                  dynamicGroups.forEach(groupDiv => {
                       const categorySelect = groupDiv.querySelector('select');
                        const otherSelectedCategoryIdsForDynamic = selectedCategoryIds.filter(id => id !== categorySelect.value);
                       // Corrected call: Pass an empty array if otherSelectedCategoryIdsForDynamic is empty
                       populateCategorySelect(categorySelect, categorySelect.value, otherSelectedCategoryIdsForDynamic); // Pass current value and excluded IDs
                  });
              }


             // NEW: Event listener for changes in category selects to update other selects
              // Listen for changes on the initial select
              teamCategorySelect.addEventListener('change', updateCategorySelectOptions);

              // Listen for changes on dynamic selects (requires event delegation or adding listener when creating)
              // Using event delegation on the container
              dynamicCategoryCountContainer.addEventListener('change', function(event) {
                   if (event.target.tagName === 'SELECT') {
                        updateCategorySelectOptions();
                   }
              });


             // NEW: Event listener for the "Add another category" button
             addCategoryCountPairButton.addEventListener('click', () => {
                  // Create a new div for the category/count pair
                  const groupDiv = document.createElement('div');
                  groupDiv.classList.add('category-count-group'); // Use the same class for styling

                  // Create Category label and select
                  const categoryLabel = document.createElement('label');
                  categoryLabel.textContent = 'Kategória:';

                  const categorySelect = document.createElement('select');
                  categorySelect.classList.add('dynamic-category-select'); // Add a class for easier selection
                  categorySelect.required = true;


                  // Create Count label and input
                  const countLabel = document.createElement('label');
                  countLabel.textContent = 'Počet tímov:';

                  const countInput = document.createElement('input');
                  countInput.setAttribute('type', 'number');
                  countInput.classList.add('dynamic-team-count-input'); // Add a class
                  countInput.setAttribute('min', '1');
                  countInput.setAttribute('value', '1');
                  countInput.required = true;

                  // Create Remove button
                  const removeButton = document.createElement('button');
                  removeButton.setAttribute('type', 'button');
                  removeButton.classList.add('remove-group-button');
                  removeButton.textContent = 'X'; // Or an icon


                  // Append elements to the group div
                  groupDiv.appendChild(removeButton); // Add remove button first for positioning
                  groupDiv.appendChild(categoryLabel);
                  groupDiv.appendChild(categorySelect);
                  groupDiv.appendChild(countLabel);
                  groupDiv.appendChild(countInput);


                  // Append the new group div to the container
                  dynamicCategoryCountContainer.appendChild(groupDiv);

                  // Populate the new category select, excluding already selected categories
                  updateCategorySelectOptions(); // This will update all selects, including the new one

                   // Add event listener to the remove button
                   removeButton.addEventListener('click', () => {
                       groupDiv.remove(); // Remove the entire group div
                       updateCategorySelectOptions(); // Update options in remaining selects
                   });

                  // Focus the new select element
                  categorySelect.focus();
             });

              // NEW: Event listener for removing dynamic category/count pairs (using delegation)
              dynamicCategoryCountContainer.addEventListener('click', function(event) {
                   if (event.target.classList.contains('remove-group-button')) {
                        // The event listener for the button itself handles removal and option update
                        // This delegation listener is not strictly needed for removal,
                        // but could be useful for other actions on the container.
                   }
              });


            // Spustíme toggleContentDisplay pri načítaní stránky a zmene hašu
            window.addEventListener('hashchange', toggleContentDisplay);
            window.addEventListener('load', async () => { // Made async to ensure cacheAllCategories completes before potential subsequent actions
                 // Initial cache of categories on load - moved here and made load listener async
                 await cacheAllCategories(); // Ensure categories are cached first

                 // Set initial hash if none is present, e.g., to #kategorie
                 if (!window.location.hash || window.location.hash === '#') { // Also handle empty hash
                      window.location.hash = '#kategorie';
                 }
                 // Always call toggleContentDisplay on load, regardless of initial hash presence.
                 // This handles cases where hashchange might not fire consistently.
                  toggleContentDisplay();

            });


            // Obsluha formulára na pridanie/úpravu kategórie
            categoryForm.addEventListener('submit', async (e) => {
                 e.preventDefault();
                 const categoryName = categoryNameInput.value.trim();
                 if (categoryName === '') { alert('Názov kategórie nemôže byť prázdny.'); return; }

                 if (currentCategoryModalMode === 'add') {
                      const categoryDocRef = doc(categoriesCollectionRef, categoryName);
                      try {
                           const existingDoc = await getDoc(categoryDocRef);
                           if (existingDoc.exists()) { alert(`Kategória "${categoryName}" už existuje!`); return; }
                           await setDoc(categoryDocRef, { /* optional data like createdAt: new Date() */ });
                           console.log(`Kategória "${categoryName}" bola úspešne pridaná.`);
                           categoryModal.style.display = 'none'; categoryForm.reset();
                           currentCategoryModalMode = 'add'; editingCategoryName = null;
                           // Refresh displays that might be affected
                           loadCategoriesTable(); // Always refresh category table
                           if (window.location.hash === '#skupiny') displayGroupsByCategory();
                           if (window.location.hash === '#timy-do-skupin') displayClubs();
                           if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();

                      } catch (error) {
                           console.error('Chyba pri pridávaní kategórie: ', error);
                           alert('Chyba pri pridávaní kategórie!');
                           // Close modal and reset state on error
                           categoryModal.style.display = 'none'; categoryForm.reset();
                           currentCategoryModalMode = 'add'; editingCategoryName = null;
                      }
                 } else if (currentCategoryModalMode === 'edit') {
                      const oldCategoryName = editingCategoryName;
                      const newCategoryName = categoryName;
                      if (!oldCategoryName) { console.error("Chyba: Chýba pôvodný názov kategórie."); alert("Chyba pri úprave kategórie."); categoryModal.style.display = 'none'; categoryForm.reset(); currentCategoryModalMode = 'add'; editingCategoryName = null; return; }
                      if (newCategoryName === oldCategoryName) { console.log("Názov kategórie sa nezmenil."); categoryModal.style.display = 'none'; categoryForm.reset(); return; }

                      const newCategoryDocRef = doc(categoriesCollectionRef, newCategoryName);
                      try {
                           const existingDoc = await getDoc(newCategoryDocRef);
                           if (existingDoc.exists()) { alert(`Kategória s názvom "${newCategoryName}" už existuje!`); return; }

                           const oldCategoryDocRef = doc(categoriesCollectionRef, oldCategoryName);
                           const oldDocSnapshot = await getDoc(oldCategoryDocRef);
                           if (!oldDocSnapshot.exists()) { console.error(`Chyba: Pôvodný dokument kategórie ${oldCategoryName} nenájdený.`); alert("Pôvodná kategória na úpravu nebola nájdená."); categoryModal.style.display = 'none'; categoryForm.reset(); currentCategoryModalMode = 'add'; editingCategoryName = null; loadCategoriesTable(); return; }
                           const oldDocData = oldDocSnapshot.data();

                           const batch = writeBatch(db);
                           batch.set(newCategoryDocRef, oldDocData); // Create new doc with new ID
                           batch.delete(oldCategoryDocRef); // Delete old doc with old ID

                           // UPDATE REFERENCES IN GROUPS AND CLUBS
                           // Groups first
                           const groupsQuery = query(groupsCollectionRef, where('categoryId', '==', oldCategoryName));
                           const groupsSnapshot = await getDocs(groupsQuery);

                       // Fetch clubs related to groups being deleted *before* starting the batch queries within the loop
                       const clubUpdates = [];
                       for (const groupDoc of groupsSnapshot.docs) {
                           const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', groupDoc.id));
                           const clubsSnapshot = await getDocs(clubsInGroupQuery);
                           clubsSnapshot.forEach(clubDoc => {
                                // Use the new composite group ID for the update
                               const oldGroupId = groupDoc.id; // e.g., "OldCategory - GroupA"
                               const groupData = groupDoc.data(); // Get group data to reconstruct the name part
                               const newGroupId = `${newCategoryName} - ${groupData.name}`; // Construct new group ID using new category name and old group name

                               clubUpdates.push({ ref: clubDoc.ref, updates: { categoryId: newCategoryName, groupId: newGroupId } }); // Update club with new categoryId and new groupId
                                console.log(`Klub "${clubDoc.id}" aktualizovaný (categoryId, groupId) kvôli zmene kategórie skupiny.`);
                           });
                            // Add group deletion to batch
                           batch.delete(groupDoc.ref); // Delete old group doc
                           console.log(`Stará skupina "${groupDoc.id}" zmazaná po premenovaní kategórie.`); // Clarified log
                       }

                       // Add club updates to batch
                       clubUpdates.forEach(item => {
                           batch.update(item.ref, item.updates);
                       });


                      // Nájdi a aktualizuj kluby s touto kategóriou, ktoré už nemusia byť priradené k skupine (groupId == null)
                      const unassignedClubsQuery = query(clubsCollectionRef, where('categoryId', '==', oldCategoryName), where('groupId', '==', null));
                       const unassignedClubsSnapshot = await getDocs(unassignedClubsQuery);
                       unassignedClubsSnapshot.forEach(doc => {
                           batch.update(doc.ref, { categoryId: newCategoryName }); // Just update categoryId to new name
                           console.log(`Nepriradený klub "${doc.id}" aktualizovaný (categoryId).`);
                       });


                      // Nakoniec zmaž samotnú kategóriu
                      batch.delete(doc(categoriesCollectionRef, oldCategoryName)); // Delete old category doc using old name

                      await batch.commit();

                      console.log(`Premenovanie kategórie "${oldCategoryName}" na "${newCategoryName}" a aktualizácia referencií bolo úspešné.`);

                      currentCategoryModalMode = 'add'; editingCategoryName = null;
                      categoryModal.style.display = 'none'; categoryForm.reset();

                      // Refresh displays that might be affected
                      loadCategoriesTable();
                      if (window.location.hash === '#skupiny') displayGroupsByCategory();
                      if (window.location.hash === '#timy-do-skupin') displayClubs();
                      if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();


                      } catch (error) {
                           console.error('Chyba pri premenovaní kategórie a aktualizácii referencií: ', error);
                           alert('Chyba pri premenovaní kategórie! Prosím, skúste znova.');
                           // Reset state and close modal on error
                           currentCategoryModalMode = 'add'; editingCategoryName = null;
                           categoryModal.style.display = 'none'; categoryForm.reset();
                      }
                 }
            });


             // --- Obsluha formulára Skupiny (používa kompozitné ID) ---
              groupForm.addEventListener('submit', async (e) => {
                  e.preventDefault();
                  const selectedCategoryId = groupCategorySelect.value;
                  const groupName = groupNameInput.value.trim();

                  if (selectedCategoryId === '' || selectedCategoryId === '-- Vyberte kategóriu --' || groupCategorySelect.disabled) { alert('Prosím, vyberte platnú kategóriu pre skupinu.'); return; }
                  if (groupName === '') { alert('Názov skupiny nemôže byť prázdny.'); return; }

                  const compositeGroupId = `${selectedCategoryId} - ${groupName}`;
                  const groupDocRef = doc(groupsCollectionRef, compositeGroupId);

                  try {
                      const existingDoc = await getDoc(groupDocRef);

                      if (currentGroupModalMode === 'add') {
                          // === LOGIKA PRIDÁVANIA SKUPINY ===
                          if (existingDoc.exists()) {
                               alert(`Skupina s názvom "${groupName}" už v kategórii "${selectedCategoryId}" existuje! Názvy skupín musia byť unikátne v rámci kategórie.`);
                               return;
                          }
                          await setDoc(groupDocRef, { name: groupName, categoryId: selectedCategoryId });
                          console.log(`Skupina "${groupName}" (ID: ${compositeGroupId}) bola úspešne pridaná do kategórie "${selectedCategoryId}".`);

                      } else if (currentGroupModalMode === 'edit') {
                          // === LOGIKA ÚPRAVY SKUPINY (PREMENOVANIE / ZMENA KATEGÓRIE) ===
                          const oldGroupId = editingGroupId;
                          if (!oldGroupId) { console.error("Chyba: Režim úpravy skupiny bez platného editingGroupId."); alert("Chyba pri úprave skupiny. Prosím, obnovte stránku."); groupModal.style.display = 'none'; groupForm.reset(); currentGroupModalMode = 'add'; editingGroupId = null; return; }

                          const oldGroupDocRef = doc(groupsCollectionRef, oldGroupId);
                          const oldDocSnapshot = await getDoc(oldGroupDocRef);
                          if (!oldDocSnapshot.exists()) { console.error(`Chyba: Pôvodný dokument skupiny ${oldGroupId} nenájdený.`); alert("Pôvodná skupina na úpravu nebola nájdená."); groupModal.style.display = 'none'; groupForm.reset(); currentGroupModalMode = 'add'; editingGroupId = null; displayGroupsByCategory(); return; }
                          const oldGroupData = oldDocSnapshot.data();


                          // Check if the composite ID has changed (name or category)
                          if (oldGroupId !== compositeGroupId) {
                               console.log(`Premenovanie/presun skupiny z "${oldGroupId}" na "${compositeGroupId}".`);
                               // Check if the NEW composite ID already exists (another group with this name/category)
                               if (existingDoc.exists()) {
                                  alert(`Skupina s názvom "${groupName}" už v kategórii "${selectedCategoryId}" existuje (iná skupina)! Názvy skupín musia byť unikátne v rámci kategórie.`);
                                  return;
                               }
                               // If ID changes, we need to delete the old document and create a new one
                               const batch = writeBatch(db);
                               // Use the current data from the form for the new document
                               batch.set(groupDocRef, { name: groupName, categoryId: selectedCategoryId }); // Create new group doc with new ID
                               batch.delete(oldGroupDocRef); // Delete the old document


                               // Update clubs that referenced the OLD group ID
                               const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', oldGroupId));
                               const clubsSnapshot = await getDocs(clubsInGroupQuery); // Use await here
                               clubsSnapshot.forEach(clubDoc => {
                                    // Update the club's groupId to the new composite ID
                                    batch.update(clubDoc.ref, { groupId: compositeGroupId });
                                    console.log(`Klub "${clubDoc.id}" aktualizovaný (groupId) kvôli zmene skupiny.`);
                               });


                               await batch.commit();

                               console.log(`Skupina úspešne premenovaná/presunutá z ID "${oldGroupId}" na "${compositeGroupId}" a súvisiace kluby aktualizované.`);

                           } else {
                               // If the composite ID hasn't changed, just update the existing document
                               console.log(`Úprava údajov pre skupinu s ID "${oldGroupId}". Kompozitné ID sa nemení.`);
                               // Use updateDoc on the document with the current ID
                               await updateDoc(groupDocRef, {
                                   name: groupName,
                                   categoryId: selectedCategoryId
                               });
                               console.log(`Skupina s ID "${oldGroupId}" úspešne upravená.`);
                           }
                      }

                      // --- Common logic after successful add or edit ---
                      groupModal.style.display = 'none'; groupForm.reset();
                      currentGroupModalMode = 'add'; editingGroupId = null;

                      // Refresh displays that might be affected
                      if (window.location.hash === '#skupiny') displayGroupsByCategory();
                      if (window.location.hash === '#timy-do-skupin') displayClubs();
                      if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();


                   } catch (error) {
                       console.error('Chyba pri ukladaní skupiny: ', error);
                       alert(`Chyba pri ukladaní skupiny! Detail: ${error.message}`);
                        // Reset state and close modal on error
                       groupModal.style.display = 'none';
                       groupForm.reset();
                       currentGroupModalMode = 'add'; editingGroupId = null;
                    }
               });

            // --- Obsluha formulára Kluby (Priradenie do skupín & Správa priradených) ---
             clubForm.addEventListener('submit', async (e) => {
                 e.preventDefault();

                 const selectedCategoryId = clubCategorySelect.value;
                 const selectedGroupId = clubGroupSelect.value; // Composite group ID (Category - Group Name)


                 // Validate selects (mandatory in both add-assign and edit-assigned modes)
                 if (clubCategorySelect.disabled === false && (selectedCategoryId === '' || selectedCategoryId === '-- Vyberte kategóriu --')) {
                     alert('Prosím, vyberte platnú kategóriu.');
                     return;
                 }
                 if (clubGroupSelect.disabled === false && (selectedGroupId === '' || selectedGroupId === '-- Vyberte skupinu --' || selectedGroupId === '-- Žiadne skupiny v kategórii --')) {
                     alert('Prosím, vyberte platnú skupinu.');
                     return;
                 }


                 try {
                     if (currentClubModalMode === 'add-assign') {
                         // === LOGIKA PRIRADENIA TÍMU DO SKUPINY ===
                         const selectedUnassignedClubId = unassignedClubSelect.value;

                         // Validate the selected unassigned club
                         if (unassignedClubSelectContainer.style.display !== 'none' && selectedUnassignedClubId === '') { // Only validate if the select je viditeľný
                             alert('Prosím, vyberte tím na priradenie.');
                             return;
                         }

                         // Fetch the selected unassigned club document to confirm it exists and is unassigned
                         const clubRefToAssign = doc(clubsCollectionRef, selectedUnassignedClubId);
                         const clubDocToAssign = await getDoc(clubRefToAssign);

                         if (!clubDocToAssign.exists()) {
                             alert('Vybraný tím nebol nájdený alebo už bol priradený/zmazaný.');
                             // Refresh the unassigned list and close modal
                             populateUnassignedClubsSelect(unassignedClubSelect, null);
                             clubModal.style.display = 'none';
                             clubForm.reset();
                             // Reset visibility
                             unassignedClubSelectContainer.style.display = 'block';
                             clubNameInputContainer.style.display = 'none';
                             return;
                         }

                         const clubDataToAssign = clubDocToAssign.data();
                         if (clubDataToAssign.groupId !== null) {
                             alert(`Tím "${clubDataToAssign.name}" je už priradený do skupiny.`);
                             // Refresh the unassigned list and close modal
                             populateUnassignedClubsSelect(unassignedClubSelect, null);
                             clubModal.style.display = 'none';
                             clubForm.reset();
                              // Reset visibility
                             unassignedClubSelectContainer.style.display = 'block';
                             clubNameInputContainer.style.display = 'none';
                             return;
                         }

                         // Double check if a club with the exact same name already exists IN THIS TARGET GROUP
                         const existingClubInGroupQuery = query(clubsCollectionRef,
                              where('groupId', '==', selectedGroupId),
                              where('name', '==', clubDataToAssign.name)
                         );
                         const existingClubInGroupSnapshot = await getDocs(existingClubInGroupQuery);
                         if (!existingClubInGroupSnapshot.empty) {
                             alert(`Tím s názvom "${clubDataToAssign.name}" už v skupine "${selectedGroupId}" existuje!`);
                             return;
                         }


                         // Update the existing unassigned club document to assign it to the group
                         await updateDoc(clubRefToAssign, {
                             categoryId: selectedCategoryId, // Update categoryId based on selected group's category
                             groupId: selectedGroupId, // Store the composite group ID
                             // Keep the original name
                         });

                         console.log(`Tím "${clubDataToAssign.name}" (ID: ${selectedUnassignedClubId}) úspešne priradený do skupiny "${selectedGroupId}".`);
                         alert(`Tím "${clubDataToAssign.name}" úspešne priradený.`);


                     } else if (currentClubModalMode === 'edit-assigned') {
                         // === LOGIKA ÚPRAVY PRIRADENÉHO KLUBU ===
                         // editingClubId holds the auto-generated ID of the assigned club being edited
                         const clubIdToEdit = editingClubId;
                         const updatedClubName = clubNameInput.value.trim(); // Get the potentially updated name
                         const currentClubDoc = await getDoc(doc(clubsCollectionRef, clubIdToEdit));
                         if (!currentClubDoc.exists()) {
                            console.error("Chyba: Dokument upravovaného klubu neexistuje.");
                            alert("Klub na úpravu nebol nájdený.");
                             clubModal.style.display = 'none'; clubForm.reset(); currentClubModalMode = 'add-assign'; editingClubId = null;
                              // Reset visibility
                             unassignedClubSelectContainer.style.display = 'block';
                             clubNameInputContainer.style.display = 'none';
                             displayClubs(); // Refresh the display as the club might be gone
                             return;
                         }
                         const currentClubData = currentClubDoc.data();


                         if (!clubIdToEdit) {
                              console.error("Chyba: Režim úpravy priradeného klubu bez platného editingClubId.");
                              alert("Chyba pri úprave klubu. Prosím, obnovte stránku.");
                              clubModal.style.display = 'none'; clubForm.reset(); currentClubModalMode = 'add-assign'; editingClubId = null;
                               // Reset visibility
                              unassignedClubSelectContainer.style.display = 'block';
                              clubNameInputContainer.style.display = 'none';
                              return;
                         }
                         if (updatedClubName === '') {
                              alert('Názov klubu nemôže byť prázdny.');
                              return;
                         }

                         // Double check if a different club with the same updated name already exists IN THE TARGET GROUP
                         const existingClubInTargetGroupQuery = query(clubsCollectionRef,
                              where('groupId', '==', selectedGroupId),
                              where('name', '==', updatedClubName),
                              where(FieldPath.documentId(), '!=', clubIdToEdit) // Exclude the current document
                         );
                         const existingClubInTargetGroupSnapshot = await getDocs(existingClubInTargetGroupQuery);
                         if (!existingClubInTargetGroupSnapshot.empty) {
                              alert(`Klub s názvom "${updatedClubName}" už v skupine "${selectedGroupId}" existuje! Prosím, zvoľte iný názov.`);
                              return;
                         }


                         const clubRefToEdit = doc(clubsCollectionRef, clubIdToEdit);
                         const clubDocToEdit = await getDoc(clubRefToEdit);
                         if (!clubDocToEdit.exists()) {
                             console.error(`Chyba: Dokument priradeného klubu ${clubIdToEdit} nenájdený na úpravu.`);
                             alert("Klub na úpravu nebol nájdený.");
                             clubModal.style.display = 'none'; clubForm.reset(); currentClubModalMode = 'add-assign'; editingClubId = null;
                             displayClubs(); // Refresh display as the club je preč
                             return;
                         }
                         const clubDataToEdit = clubDocToEdit.data();

                         // Check if any changes were made
                         if (clubDataToEdit.name === updatedClubName &&
                             clubDataToEdit.categoryId === selectedCategoryId &&
                             clubDataToEdit.groupId === selectedGroupId) {
                             console.log("Žiadne zmeny na klube.", clubIdToEdit);
                             clubModal.style.display = 'none'; clubForm.reset();
                             currentClubModalMode = 'add-assign'; editingClubId = null;
                              // Reset visibility
                             unassignedClubSelectContainer.style.display = 'block';
                             clubNameInputContainer.style.display = 'none';
                             return; // No changes, just close modal
                         }


                         // Update the assigned club document
                         await updateDoc(clubRefToEdit, {
                              name: updatedClubName, // Update name
                             categoryId: selectedCategoryId,
                             groupId: selectedGroupId,
                             // Update other fields if they were in the form
                         });

                         console.log(`Klub "${updatedClubName}" (ID: ${clubIdToEdit}) úspešne upravený v skupine "${selectedGroupId}".`);
                         alert(`Klub úspešne upravený.`);

                     }

                     // --- Common logic after successful add/assign or edit ---
                     clubModal.style.display = 'none';
                     clubForm.reset();
                     currentClubModalMode = 'add-assign'; // Reset state to add-assign
                     editingClubId = null; // Clear editing ID

                     // Reset visibility of name input vs select for next time
                      unassignedClubSelectContainer.style.display = 'block';
                      clubNameInputContainer.style.display = 'none';


                     // Refresh displays that might be affected
                      if (window.location.hash === '#timy-do-skupin') {
                           displayClubs(); // Refresh clubs in groups display
                      }
                      if (window.location.hash === '#vytvorenie-timov') {
                           displayCreatedTeams(); // Refresh created teams list (assigning removes from this list, editing might affect it)
                      }


                 } catch (error) {
                     console.error('Chyba pri ukladaní alebo priradzovaní klubu: ', error);
                     alert(`Chyba pri ukladaní alebo priradzovaní klubu! Detail: ${error.message}`);
                      // Zatvor modál a resetuj stav pri chybe
                      clubModal.style.display = 'none';
                      clubForm.reset();
                      currentClubModalMode = 'add-assign'; editingClubId = null;
                       // Reset visibility of name input vs select on error
                      unassignedClubSelectContainer.style.display = 'block';
                      clubNameInputContainer.style.display = 'none';
                 }
             });

            // --- Event Listener pre zmenu kategórie v modáli klubu (pre priradenie do skupiny) ---
             clubCategorySelect.addEventListener('change', async () => { // Made async to use await for populateGroupSelect
                 const selectedCategoryId = clubCategorySelect.value;
                 // Populate the group select based on the newly selected category
                 await populateGroupSelect(selectedCategoryId, clubGroupSelect); // Pass category ID and select element
             });

             // NEW: Event listener for change in the unassigned club select (in clubModal) - handles category/group selects update
             unassignedClubSelect.addEventListener('change', async () => {
                  const selectedClubId = unassignedClubSelect.value;
                  // When an unassigned club is selected, populate the category select with its category
                  // and then populate the group select.
                  if (selectedClubId) {
                       try {
                           const clubDoc = await getDoc(doc(clubsCollectionRef, selectedClubId));
                           if (clubDoc.exists()) {
                               const clubData = clubDoc.data();
                               await populateCategorySelect(clubCategorySelect, clubData.categoryId, []); // Populate and select category, Pass empty array for excluded
                               // Populate group select based on the selected category
                               await populateGroupSelect(clubData.categoryId, clubGroupSelect, clubData.groupId); // Pass category ID and select element, groupId should be null initially
                           } else {
                               console.warn(`Vybraný nepriradený tím ${selectedClubId} už neexistuje.`);
                               // Reset selects if the selected team is no longer found
                               unassignedClubSelect.value = "";
                               clubCategorySelect.value = "";
                               clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
                               clubGroupSelect.disabled = true;
                           }
                       } catch (error) {
                           console.error('Chyba pri načítaní detailov vybraného nepriradeného tímu:', error);
                           alert('Chyba pri načítaní detailov tímu.');
                           unassignedClubSelect.value = "";
                           clubCategorySelect.value = "";
                           clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
                           clubGroupSelect.disabled = true;
                       }
                  } else {
                       // No team selected in unassigned select, reset category and group selects
                       clubCategorySelect.value = "";
                       clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
                       clubGroupSelect.disabled = true;
                  }
             });


            // NEW: Obsluha formulára Vytvorenie Tímov
            teamCreationForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const teamNameBase = teamNameInput.value.trim();
                 // Get data from the initial category/count fields
                const initialCategoryId = teamCategorySelect.value;
                const initialTeamCount = parseInt(teamCountInput.value, 10);

                 const teamEntries = []; // Array to store { categoryId: '...', count: ... }

                  // Validate initial entry separately
                  if (teamNameBase === '') {
                       alert('Názov tímu nemôže byť prázdny.');
                        // Do not return yet, allow adding dynamic entries even if initial name is missing
                  }
                  if (initialCategoryId !== '' && !isNaN(initialTeamCount) && initialTeamCount >= 1) {
                      if (initialTeamCount > 26) {
                          alert(`Počet tímov pre kategóriu "${initialCategoryId}" (${initialTeamCount}) v prvom zadaní prekračuje limit pre abecedné označenie (26). Prosím, znížte počet.`);
                          return; // Stop submission if initial entry count is invalid
                      }
                      teamEntries.push({ categoryId: initialCategoryId, count: initialTeamCount });
                  } else if (initialCategoryId !== '' || (teamNameBase !== '' && (isNaN(initialTeamCount) || initialTeamCount < 1))) {
                      // Alert if category was selected but count is invalid, or name is entered but initial count is invalid
                       alert('Prosím, zadajte platnú kategóriu a počet tímov (väčší ako 0) pre prvú položku.');
                        return; // Stop submission
                  }


                 // 2. Get data from dynamically added category/count fields
                 const dynamicGroups = dynamicCategoryCountContainer.querySelectorAll('.category-count-group');
                 dynamicGroups.forEach(groupDiv => {
                      // Find the select and input within THIS specific group div
                      const categorySelect = groupDiv.querySelector('select');
                      const countInput = groupDiv.querySelector('input[type="number"]');

                      const categoryId = categorySelect.value;
                      const teamCount = parseInt(countInput.value, 10);

                      if (categoryId !== '' && !isNaN(teamCount) && teamCount >= 1) {
                           if (teamCount > 26) {
                               alert(`Počet tímov pre kategóriu "${categoryId}" (${teamCount}) v jednom zo zadaní prekračuje limit pre abecedné označenie (26). Prosím, znížte počet.`);
                                return; // Stop submission if any dynamic entry count is invalid
                           }
                           teamEntries.push({ categoryId: categoryId, count: teamCount });
                      } else if (categoryId !== '' || (!isNaN(teamCount) && teamCount >= 1)) {
                          // Alert if category was selected but count is invalid, or count is valid but category is missing
                           alert('Prosím, zadajte platnú kategóriu a počet tímov (väčší ako 0) pre dynamickú položku.');
                            return; // Stop submission
                      }
                 });

                  // Validate that at least one valid entry was collected
                  if (teamEntries.length === 0) {
                       alert('Prosím, zadajte aspoň jednu kategóriu a počet tímov na vytvorenie.');
                       return;
                  }

                 // Re-check base name after checking entries, just in case
                  if (teamNameBase === '') {
                     alert('Názov tímu nemôže byť prázdny.');
                     return;
                 }


                 try {
                     // Use a batch write for multiple documents for efficiency
                     const batch = writeBatch(db);
                     let successfullyAddedCount = 0; // Counter for successful additions

                     // Store potential duplicate IDs to alert the user AFTER the batch attempt
                     const potentialDuplicates = [];


                     // Iterate through each collected category/count entry
                     for (const entry of teamEntries) {
                         const categoryId = entry.categoryId;
                         const teamCount = entry.count;

                         // For each category and count, create the specified number of teams
                         for (let i = 1; i <= teamCount; i++) {
                              let teamName;
                              // Apply letter suffix only if count > 1 FOR THIS SPECIFIC ENTRY
                              if (teamCount > 1) {
                                   const letter = String.fromCharCode(65 + (i - 1));
                                   teamName = `${teamNameBase} ${letter}`;
                              } else {
                                   teamName = teamNameBase;
                              }

                              // *** ZMENA TU: Tvorba ID dokumentu ***
                              const teamDocumentId = `${categoryId} - ${teamName}`;
                              const newTeamRef = doc(clubsCollectionRef, teamDocumentId); // Create doc ref with explicit ID

                              // Optional: You could try to check if the document exists here first,
                              // but checking inside the batch is not straightforward.
                              // setDoc will overwrite if the document ID already exists.
                              // We'll rely on Firestore behavior and maybe warn the user afterwards.

                              batch.set(newTeamRef, {
                                  name: teamName, // Store the full name in the document data
                                  categoryId: categoryId,
                                  groupId: null // Initially, no group assigned
                                  // optional fields like createdAt: new Date()
                              });
                              successfullyAddedCount++; // Increment counter for each team document intended for creation/overwrite

                              // Check if this ID was already added in this batch (means a duplicate entry in the form)
                               // Or if we expect this ID to potentially overwrite an existing document.
                               // Simple check for duplicates within the current batch operation based on form input:
                              const existingEntryInBatch = teamEntries.find(item =>
                                   `${item.categoryId} - ${teamName}` === teamDocumentId && (item.count > (teamDocumentId === `${initialCategoryId} - ${teamName}` ? i : 0)) // Simplified check, might not catch all edge cases
                               );
                                // A more robust check would involve querying Firestore *before* creating the batch,
                                // which adds complexity and potential race conditions if multiple users use it.
                                // For this example, we'll let setDoc handle potential overwrites and just report based on batch size vs entries.
                          }
                     }

                      // If you need to warn about potential overwrites, you'd need to fetch existing docs first.
                      // For now, let's just commit and assume setDoc is acceptable behaviour (overwriting unassigned duplicates).


                     await batch.commit(); // Commit the batch

                      console.log(`Pokus o vytvorenie/aktualizáciu ${successfullyAddedCount} tím(ov) na základe ${teamEntries.length} zadani(í).`);
                      alert(`Úspešne spracovaných ${successfullyAddedCount} tím(ov). Skontrolujte zoznam vytvorených tímov.`); // Modified alert

                     // --- Common logic after successful creation ---
                     teamCreationModal.style.display = 'none';
                     teamCreationForm.reset();
                     // Clear dynamic fields after submission
                     dynamicCategoryCountContainer.innerHTML = '';
                      // Repopulate the initial category select
                     populateCategorySelect(teamCategorySelect, null, []); // Pass empty array for excluded


                     // After successful creation, refresh the list of created teams
                     if (window.location.hash === '#vytvorenie-timov') {
                          displayCreatedTeams(); // Call the updated display function
                     }
                      // Refresh clubs-in-groups display if visible (newly created won't appear unless assigned)
                      // if (window.location.hash === '#timy-do-skupin') { displayClubs(); }


                 } catch (error) {
                     console.error('Chyba pri vytváraní tímov: ', error);
                     alert(`Chyba pri vytváraní tímov! Detail: ${error.message}`);
                      // Close modal and reset state on error
                      teamCreationModal.style.display = 'none';
                      teamCreationForm.reset();
                      // Clear dynamic fields on error
                      dynamicCategoryCountContainer.innerHTML = '';
                      // Repopulate the initial category select
                      populateCategorySelect(teamCategorySelect, null, []); // Pass empty array for excluded
                 }
             });

             // NEW: Function to update the available options in all category selects
              function updateCategorySelectOptions() {
                  // Get all currently selected categories across all groups
                  const selectedCategoryIds = [];
                  const initialSelect = initialCategoryCountGroup.querySelector('select');
                  if (initialSelect.value !== '') {
                       selectedCategoryIds.push(initialSelect.value);
                  }

                  const dynamicGroups = dynamicCategoryCountContainer.querySelectorAll('.category-count-group');
                  dynamicGroups.forEach(groupDiv => {
                       const categorySelect = groupDiv.querySelector('select');
                       if (categorySelect.value !== '') {
                            selectedCategoryIds.push(categorySelect.value);
                       }
                  });

                  // Now update options for each select
                  // Update initial select (it should only exclude categories selected IN OTHER dynamic selects)
                  const otherSelectedCategoryIdsForInitial = selectedCategoryIds.filter(id => id !== initialSelect.value);
                  // Corrected call: Pass an empty array if otherSelectedCategoryIdsForInitial is empty, although filter should handle this.
                  populateCategorySelect(initialSelect, initialSelect.value, otherSelectedCategoryIdsForInitial); // Pass current value and excluded IDs

                  // Update dynamic selects
                  dynamicGroups.forEach(groupDiv => {
                       const categorySelect = groupDiv.querySelector('select');
                        const otherSelectedCategoryIdsForDynamic = selectedCategoryIds.filter(id => id !== categorySelect.value);
                       // Corrected call: Pass an empty array if otherSelectedCategoryIdsForDynamic is empty
                       populateCategorySelect(categorySelect, categorySelect.value, otherSelectedCategoryIdsForDynamic); // Pass current value and excluded IDs
                  });
              }


             // NEW: Event listener for changes in category selects to update other selects
              // Listen for changes on the initial select
              teamCategorySelect.addEventListener('change', updateCategorySelectOptions);

              // Listen for changes on dynamic selects (requires event delegation or adding listener when creating)
              // Using event delegation on the container
              dynamicCategoryCountContainer.addEventListener('change', function(event) {
                   if (event.target.tagName === 'SELECT') {
                        updateCategorySelectOptions();
                   }
              });


             // NEW: Event listener for the "Add another category" button
             addCategoryCountPairButton.addEventListener('click', () => {
                  // Create a new div for the category/count pair
                  const groupDiv = document.createElement('div');
                  groupDiv.classList.add('category-count-group'); // Use the same class for styling

                  // Create Category label and select
                  const categoryLabel = document.createElement('label');
                  categoryLabel.textContent = 'Kategória:';

                  const categorySelect = document.createElement('select');
                  categorySelect.classList.add('dynamic-category-select'); // Add a class for easier selection
                  categorySelect.required = true;


                  // Create Count label and input
                  const countLabel = document.createElement('label');
                  countLabel.textContent = 'Počet tímov:';

                  const countInput = document.createElement('input');
                  countInput.setAttribute('type', 'number');
                  countInput.classList.add('dynamic-team-count-input'); // Add a class
                  countInput.setAttribute('min', '1');
                  countInput.setAttribute('value', '1');
                  countInput.required = true;

                  // Create Remove button
                  const removeButton = document.createElement('button');
                  removeButton.setAttribute('type', 'button');
                  removeButton.classList.add('remove-group-button');
                  removeButton.textContent = 'X'; // Or an icon


                  // Append elements to the group div
                  groupDiv.appendChild(removeButton); // Add remove button first for positioning
                  groupDiv.appendChild(categoryLabel);
                  groupDiv.appendChild(categorySelect);
                  groupDiv.appendChild(countLabel);
                  groupDiv.appendChild(countInput);


                  // Append the new group div to the container
                  dynamicCategoryCountContainer.appendChild(groupDiv);

                  // Populate the new category select, excluding already selected categories
                  updateCategorySelectOptions(); // This will update all selects, including the new one

                   // Add event listener to the remove button
                   removeButton.addEventListener('click', () => {
                       groupDiv.remove(); // Remove the entire group div
                       updateCategorySelectOptions(); // Update options in remaining selects
                   });

                  // Focus the new select element
                  categorySelect.focus();
             });

              // NEW: Event listener for removing dynamic category/count pairs (using delegation)
              dynamicCategoryCountContainer.addEventListener('click', function(event) {
                   if (event.target.classList.contains('remove-group-button')) {
                        // The event listener for the button itself handles removal and option update
                        // This delegation listener is not strictly needed for removal,
                        // but could be useful for other actions on the container.
                   }
              });


     </script>

 </body>
 </html>
