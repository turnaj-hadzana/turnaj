<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Správca turnaja</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">

    <style>
        /* --- General Styles --- */
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-top: 20px;
            margin-bottom: 20px; /* Added margin-bottom for separation */
        }

        h2 {
            margin-top: 0; /* Reset margin-top, controlled by section padding */
            margin-bottom: 10px;
            color: #555;
        }

         h3 { /* Style for category headings in Manage Teams modal */
            margin-top: 15px;
            margin-bottom: 8px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
         }


        .add-button {
            display: block;
            margin: 20px auto;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #28a745;
            color: white;
            font-size: 2em;
            border: none;
            cursor: pointer;
            text-align: center;
            line-height: 50px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
            position: sticky;
            top: 20px;
            z-index: 10;
        }

        .add-button:hover {
            background-color: #218838;
        }

        .content-wrapper {
            display: flex;
            margin-top: 20px;
            padding: 0 20px;
        }

        .left-menu {
            width: 200px;
            margin-right: 20px;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 90px;
            align-self: flex-start;
            max-height: calc(100vh - 110px);
            overflow-y: auto;
        }

        .left-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .left-menu li {
            margin-bottom: 10px;
        }

        .left-menu a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
            display: block;
            padding: 5px 0;
            transition: color 0.3s ease;
        }

        .left-menu a:hover {
            color: #0056b3;
        }

        main {
            flex-grow: 1;
            padding: 0;
            box-shadow: none;
            background-color: transparent;
        }

        /* --- Section Block Style --- */
        .section-block {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px; /* Space below each block */
        }


        /* --- Table Styles --- */
        /* Styles for the table element itself, regardless of the wrapper */
        #categoryTable, .category-group-table, #clubsTable, #createdTeamsTable {
            border-collapse: collapse;
            width: 100%; /* Keep 100% width for these tables */
            border: none;
            overflow: hidden;
        }

         /* Specific style for tables in #timy-do-skupin and manage teams modal */
        .group-clubs-table {
            border-collapse: collapse;
             /* Allow width to be flexible within its flex container parent */
             /* width: 100%; /* Removed 100% width */
            border: none;
            overflow: hidden;
             /* Added table-layout: auto to make columns fit content */
            table-layout: auto;
        }


        /* Style for the section wrapping category heading and group table */
        .category-group-section {
            /* Inherits background, padding, radius, shadow from .section-block */
            /* Flex properties only for group sections when inside #groupsContent */
            min-width: 300px;
            flex-grow: 1;
            flex-basis: 0;
        }

        /* Style for the main container of group sections (the flex container) */
        #groupsContent {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
            padding: 0;
            margin-bottom: 20px;
        }
         #groupsContent .section-block {
             margin-bottom: 0; /* Override margin for flex items */
         }


        /* Remove margin-top from the first element inside a section block */
        .section-block h2:first-child,
        .section-block table:first-child {
            margin-top: 0;
        }

         /* Style for tables within the manage teams modal */
         #manageTeamsModal .group-clubs-table {
             margin-bottom: 15px; /* Space below each category table in the modal */
             width: 100%; /* Set 100% width inside modal for these tables */
         }


        /* Table Header and Cell Styles - apply to all relevant table types */
        #categoryTable th, #clubsTable th, .category-group-table th, .group-clubs-table th, #createdTeamsTable th,
         #manageTeamsModal .group-clubs-table th /* Also apply to modal tables */
         {
            background-color: #f2f2f2;
            color: #333;
            font-weight: bold;
            text-align: left;
            padding: 12px 15px;
            border-bottom: 2px solid #ddd;
        }

        #categoryTable td, #clubsTable td, .category-group-table td, .group-clubs-table td, #createdTeamsTable td,
         #manageTeamsModal .group-clubs-table td /* Also apply to modal tables */
         {
            text-align: left;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }

        /* Center align quantity cells in Created Teams table */
         #createdTeamsTable tbody td:not(:first-child):not(:last-child) {
              text-align: center;
         }

         /* Center align order column in group-clubs-table */
         .group-clubs-table tbody td:first-child {
              text-align: center;
         }
         #manageTeamsModal .group-clubs-table tbody td:first-child {
             text-align: center; /* Also for modal tables */
         }


        /* Remove bottom border from last row in tbody for all tables */
        #categoryTable tbody tr:last-child td,
        #clubsTable tbody tr:last-child td,
        .category-group-table tbody tr:last-child td,
        .group-clubs-table tbody tr:last-child td,
        #createdTeamsTable tbody tr:last-child td,
         #manageTeamsModal .group-clubs-table tbody tr:last-child td
         {
             border-bottom: none;
        }

        /* Hover effect for all table rows */
        #categoryTable tbody tr:hover,
        #clubsTable tbody tr:hover,
        .category-group-table tbody tr:hover,
        .group-clubs-table tbody tr:hover,
        #createdTeamsTable tbody tr:hover,
         #manageTeamsModal .group-clubs-table tbody tr:hover
         {
            background-color: #f9f9f9;
            cursor: pointer;
        }

        /* Ensure last cell in row doesn't wrap buttons */
        #categoryTable td:last-child,
        #clubsTable td:last-child,
        .category-group-table td:last-child,
        .group-clubs-table td:last-child,
        #createdTeamsTable td:last-child,
         #manageTeamsModal .group-clubs-table td:last-child /* Also for tables in modal */
         {
             white-space: nowrap;
        }

        #clubsContent {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
            padding: 0;
            margin-bottom: 20px;
        }

        /* Style for container divs that wrap club sections when inside #clubsContent */
        #clubsContent .section-block {
            /* Inherits background, padding, radius, shadow from .section-block */
             /* Remove min-width and flex-basis to allow content to dictate width better */
            /* min-width: 300px; */
            flex-grow: 1; /* Allow growing to fill space */
            flex-basis: 0; /* Reset flex-basis */
            margin-bottom: 0; /* Override the default .section-block margin when inside flex */
        }

        #teamCreationContentSection table {
            /* Ensure table within section block takes full width */
             width: 100%;
        }


        /* --- Action Button Styles --- */
        .action-button {
            padding: 5px 10px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .action-button:not(.delete-button) {
            background-color: #007bff;
            color: white;
        }

        .action-button.delete-button {
            background-color: #dc3545;
            color: white;
        }

        .action-button:not(.delete-button):hover { background-color: #0056b3; }
        .action-button.delete-button:hover { background-color: #c82333; }


        /* --- Modal Styles --- */
         .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
         }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }

        .close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover, .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content form label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

         .modal-content form input[type="text"],
         .modal-content form input[type="number"],
         .modal-content form select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
         }
         /* Adjust select height for multiple */
         .modal-content form select[multiple] {
              min-height: 100px; /* Or adjust as needed */
         }


        .modal-content form button[type="submit"] { /* Target the submit button */
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

         .modal-content form button[type="submit"]:hover { /* Target the submit button */
            background-color: #218838;
         }

         /* Style for the container divs around specific form elements */
         .modal-content form div {
             margin-bottom: 20px; /* Add spacing below input groups */
         }
         .modal-content form div:last-of-type {
              margin-bottom: 0; /* Remove bottom margin for the last one before the button */
         }
          .modal-content form label,
          .modal-content form input[type="text"],
          .modal-content form input[type="number"],
          .modal-content form select {
              margin-bottom: 0; /* Remove margin from elements inside the div */
          }

          /* Optional CSS for dynamically added category/count pairs */
            .category-count-pair {
                border: 1px solid #eee;
                padding: 10px;
                margin-bottom: 15px; /* Space below each pair */
                border-radius: 5px;
                background-color: #f9f9f9;
            }

            .category-count-pair label {
                display: inline-block; /* Make labels inline */
                margin-bottom: 5px;
                margin-right: 10px; /* Space between label and input/select */
                font-weight: normal; /* Less bold than section titles */
                min-width: 80px; /* Align labels (adjust as needed) */
            }

            .category-count-pair select,
            .category-count-pair input[type="number"] {
                 display: inline-block; /* Make inputs/selects inline */
                 width: auto; /* Allow size based on content/min-width */
                 margin-bottom: 0; /* Remove bottom margin */
                 margin-right: 10px; /* Space between elements */
                 padding: 5px; /* Smaller padding */
            }

            /* Style for the remove button within the pair */
            .category-count-pair .action-button.delete-button {
                padding: 3px 8px; /* Smaller padding */
                font-size: 0.8em; /* Smaller font */
            }

            /* Adjust spacing within the container div */
            #teamCategoryCountContainer div {
                margin-bottom: 10px; /* Space between inner divs (label+element) */
            }

            /* Ensure remove button is not on a new line if space allows */
            .category-count-pair div:last-of-type { /* This targets the last div within a pairDiv */
                 margin-bottom: 0;
            }


    </style>
</head>
<body>
    <script>
        // Basic check for admin, redirect if not
        const userName = localStorage.getItem('username');
        if (userName !== 'admin') {
             window.location.href = 'login.html';
        }
    </script>

    <h1>Správca turnaja</h1>

    <button class="add-button" id="addButton" title="Pridať položku">+</button>

    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <span class="close category-modal-close">&times;</span>
            <h2 id="categoryModalTitle">Pridať kategóriu</h2>
            <form id="categoryForm">
                <div>
                    <label for="categoryName">Názov kategórie:</label>
                    <input type="text" id="categoryName" name="categoryName" required>
                </div>
                <button type="submit">Uložiť</button>
            </form>
        </div>
    </div>

     <div class="modal" id="groupModal">
         <div class="modal-content">
                 <span class="close group-modal-close">&times;</span>
                 <h2 id="groupModalTitle">Pridať skupinu</h2>
                 <form id="groupForm">
                     <div>
                          <label for="groupCategory">Kategória:</label>
                          <select id="groupCategory" name="groupCategory" required>
                               <option value="">-- Vyberte kategóriu --</option>
                               </select>
                     </div>

                     <div>
                          <label for="groupName">Názov skupiny:</label>
                          <input type="text" id="groupName" name="groupName" required>
                     </div>

                     <button type="submit">Uložiť</button>
                 </form>
         </div>
     </div>

    <div class="modal" id="clubModal">
         <div class="modal-content">
                 <span class="close club-modal-close">&times;</span>
                 <h2 id="clubModalTitle">Priradiť tím do skupiny</h2>
                 <form id="clubForm">
                       <div id="unassignedClubSelectContainer">
                          <label for="unassignedClubSelect">Vyberte existujúci tím:</label>
                          <select id="unassignedClubSelect">
                               <option value="">-- Vyberte tím na priradenie --</option>
                           </select>
                      </div>

                      <div id="clubNameInputContainer">
                          <label for="clubName">Názov klubu:</label>
                          <input type="text" id="clubName" name="clubName">
                       </div>

                      <div>
                          <label for="clubCategory">Kategória:</label>
                          <select id="clubCategory" name="clubCategory" required>
                               <option value="">-- Vyberte kategóriu --</option>
                               </select>
                      </div>

                      <div>
                           <label for="clubGroup">Skupina:</label>
                           <select id="clubGroup" name="clubGroup" required disabled>
                                <option value="">-- Najprv vyberte kategóriu --</option>
                            </select>
                      </div>

                       <div id="orderInputContainer">
                            <label for="orderInGroup">Poradové číslo v skupine:</label>
                            <input type="number" id="orderInGroup" name="orderInGroup" min="1">
                       </div>

                       <button type="submit">Uložiť</button>
                  </form>
         </div>
     </div>

    <div class="modal" id="teamCreationModal">
        <div class="modal-content">
            <span class="close team-creation-modal-close">&times;</span>
            <h2 id="teamCreationModalTitle">Vytvoriť tímy</h2>
            <form id="teamCreationForm">
                <div>
                    <label for="teamNameInput">Základný názov tímu:</label>
                    <input type="text" id="teamNameInput" name="teamName" required>
                </div>

                <div id="teamCategoryCountContainer">
                     </div>

                 <button type="button" id="addCategoryCountPairButton" class="action-button" style="margin-bottom: 15px;">Pridať ďalšiu kategóriu</button> <button type="submit">Vytvoriť tímy</button> </form>
        </div>
    </div>

    <div class="modal" id="manageTeamsModal">
        <div class="modal-content" style="max-width: 700px;"> <span class="close manage-teams-modal-close">&times;</span>
            <h2 id="manageTeamsModalTitle"><span id="baseTeamNameInModal"></span></h2>

            <div id="teamsListInModal">
                <p>Načítavam tímy...</p> </div>

            <div style="text-align: right; margin-top: 20px;">
                 <button class="action-button" onclick="closeManageTeamsModal()">Zatvoriť</button>
            </div>
        </div>
    </div>


    <div class="content-wrapper">
        <nav class="left-menu">
            <ul>
                <li><a href="#kategorie">Vytvorenie kategórií</a></li>
                <li><a href="#skupiny">Vytvorenie skupín</a></li>
                <li><a href="#zoznam-timov">Zoznam tímov</a></li>
                <li><a href="#timy-do-skupin">Tímy do skupín</a></li>
                <li><a href="#sportove-haly">Športové haly</a></li>
                <li><a href="#sprava-turnaja">Správa turnaja</a></li>
                <li><a href="#nastavenia">Nastavenia</a></li>
            </ul>
        </nav>

        <main>
            <div id="categoriesContentSection" class="section-block" style="display: none;">
                 <h2>Vytvorenie kategórií</h2>
                <table id="categoryTable">
                    <thead>
                        <tr>
                            <th>Názov</th>
                            <th style="width: 150px;"></th>
                        </tr>
                    </thead>
                    <tbody id="categoryTableBody">
                        </tbody>
                </table>
            </div>

            <div id="groupsContent" style="display: none;">
                </div>

            <div id="clubsContent" style="display: none;">
                 </div>

             <div id="teamCreationContentSection" class="section-block" style="display: none;">
                 <h2>Zoznam tímov</h2>
                 <table id="createdTeamsTable">
                     <thead>
                         <tr id="createdTeamsTableHeader"> <th>Názov tímu</th>
                             <th style="width: 150px;"></th>
                         </tr>
                     </thead>
                     <tbody id="createdTeamsTableBody">
                         </tbody>
                 </table>
            </div>

            </main>
    </div>


<script type="module">
        // Import potrebných Firebase Firestore funkcií priamo z CDN
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, where, addDoc, updateDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

        // Tvoja Firebase konfigurácia
        const firebaseConfig = {
            apiKey: "AIzaSyD0h0rQZiIGi0-UDb4-YU_JihRGpIlfz40", // ZMEŇ ZA SVOJ SKUTOČNÝ API KĽÚČ
            authDomain: "turnaj-a28c5.firebaseapp.com", // ZMEŇ ZA SVOJ SKUTOČNÝ authDomain
            projectId: "turnaj-a28c5", // ZMEŇ ZA SVOJ SKUTOČNÝ projectId
            storageBucket: "turnaj-a28c5.firebasestorage.app", // ZMEŇ ZA SVOJ SKUTOČNÝ storageBucket
            messagingSenderId: "131088352981", // ZMEŇ ZA SVOJ SKUTOČNÝ messagingSenderId
            appId: "1:131088352981:web:4a2b2c3d4e5f6g7h8i9j0", // ZMEŇ ZA SVOJ SKUTOČNÝ appId
            measurementId: "G-XXXXXXXXXX" // ZMEŇ ZA SVOJ SKUTOČNÝ measurementId, ak používaš Google Analytics
        };

        // Inicializácia Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Referencie na hlavné kolekcie v databáze Firestore
        // Predpokladáme, že všetky dáta turnaja sú pod jedným dokumentom 'mainTournamentData' v kolekcii 'tournamentData'
        const tournamentDataRef = doc(db, 'tournamentData', 'mainTournamentData');
        const categoriesCollectionRef = collection(tournamentDataRef, 'categories');
        const groupsCollectionRef = collection(tournamentDataRef, 'groups');
        const clubsCollectionRef = collection(tournamentDataRef, 'clubs');


        // --- GLOBÁLNE PREMENNÉ PRE MODÁLY A DÁTA ---
        // Premenné pre modál kategórií
        const categoryModal = document.getElementById('categoryModal');
        const categoryModalCloseBtn = categoryModal.querySelector('.close');
        const categoryForm = document.getElementById('categoryForm');
        const categoryNameInput = document.getElementById('categoryName');
        const categorySubmitButton = categoryForm.querySelector('button[type="submit"]');
        let currentCategoryModalMode = 'add'; // 'add' alebo 'edit'
        let editingCategoryId = null; // Uchováva ID kategórie v režime úpravy

        // Premenné pre modál skupín
        const groupModal = document.getElementById('groupModal');
        const groupModalCloseBtn = groupModal.querySelector('.close');
        const groupForm = document.getElementById('groupForm');
        const groupNameInput = document.getElementById('groupName');
        const groupCategorySelect = document.getElementById('groupCategory'); // Select pre výber kategórie v modáli skupiny
        const groupSubmitButton = groupForm.querySelector('button[type="submit"]');
        let currentGroupModalMode = 'add'; // 'add' alebo 'edit'
        let editingGroupId = null; // Uchováva ID skupiny v režime úpravy

        // Premenné pre modál klubov/tímov (priradenie do skupín & úprava)
        const clubModal = document.getElementById('clubModal');
        const clubModalCloseBtn = clubModal.querySelector('.club-modal-close');
        const clubForm = document.getElementById('clubForm');
        const clubNameInput = document.getElementById('clubName'); // Pre úpravu názvu (v edit móde)
        const clubCategorySelect = document.getElementById('clubCategory'); // Select pre výber kategórie v modáli klubu
        const clubGroupSelect = document.getElementById('clubGroup'); // Select pre výber skupiny v modáli klubu
        const clubModalTitle = document.getElementById('clubModalTitle');

        // Referencie pre zmeny viditeľnosti v CLUB MODÁLI (pre Add/Assign vs Edit)
        const unassignedClubSelectContainer = document.getElementById('unassignedClubSelectContainer');
        const unassignedClubSelect = document.getElementById('unassignedClubSelect'); // Select pre výber nepriradeného tímu
        const clubNameInputContainer = document.getElementById('clubNameInputContainer'); // Kontajner pre input názvu (viditeľný len pri Edit)
         const orderInputContainer = document.getElementById('orderInputContainer'); // Kontajner pre poradie
        const orderInGroupInput = document.getElementById('orderInGroup'); // Input pre poradie

        // Stavové premenné pre CLUB MODAL
        let currentClubModalMode = 'add-assign'; // 'add-assign' alebo 'edit'
        let editingClubId = null; // Uchováva ID tímu v režime úpravy


        // Premenné pre modál hromadného vytvárania tímov
        const teamCreationModal = document.getElementById('teamCreationModal');
        const teamCreationModalCloseBtn = teamCreationModal.querySelector('.close');
        const teamCreationForm = document.getElementById('teamCreationForm');
        const teamNameInput = document.getElementById('teamNameInput');
        const teamCategoryCountContainer = document.getElementById('teamCategoryCountContainer'); // Kontajner pre dynamické dvojice kategória/počet
        const addCategoryCountPairButton = document.getElementById('addCategoryCountPairButton'); // Tlačidlo na pridanie ďalšej dvojice
        const teamCreationSubmitButton = teamCreationForm.querySelector('button[type="submit"]');

        // Premenné pre modál správy jednotlivých tímov (z Create Teams listu)
        const manageTeamsModal = document.getElementById('manageTeamsModal');
        const manageTeamsModalCloseBtn = manageTeamsModal.querySelector('.close');
        const manageTeamsContent = document.getElementById('manageTeamsContent');


        // Globálne zoznamy dát pre plnenie selectboxov atď.
        let allAvailableCategories = []; // Zoznam všetkých kategórií ID
        // let allAvailableGroups = []; // Zoznam všetkých skupín ID (ak by bol potrebný)
        // let allAvailableClubs = []; // Zoznam všetkých klubov ID (ak by bol potrebný)


        // --- Pomocné funkcie ---

        // Funkcia na naplnenie selectboxu kategórií (používa sa vo viacerých modáloch)
        async function populateCategorySelect(selectElement, includePlaceholder = true) {
             console.log(`DEBUG: Populating categories for select: ${selectElement.id || 'Unnamed Select'}`);
              selectElement.innerHTML = ''; // Clear before adding options
               if (includePlaceholder) {
                 selectElement.innerHTML = '<option value="">-- Vyberte kategóriu --</option>'; // Add placeholder
              }


              selectElement.disabled = true; // Disable while loading

              try {
                  const querySnapshot = await getDocs(categoriesCollectionRef);
                  if (querySnapshot.empty) {
                      const option = document.createElement('option');
                      option.value = '';
                      option.textContent = '-- Žiadne kategórie --';
                       option.disabled = true; // Make it non-selectable
                      selectElement.appendChild(option);
                       selectElement.disabled = true; // Keep disabled if no categories
                       console.warn("No categories found in Firestore.");
                  } else {
                       selectElement.disabled = false; // Enable if categories are found
                       const sortedDocs = querySnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                       allAvailableCategories = sortedDocs.map(doc => doc.id); // Update global list
                       sortedDocs.forEach((doc) => {
                            const categoryName = doc.id; // Kategória ID je názov dokumentu
                            const option = document.createElement('option');
                            option.value = categoryName;
                            option.textContent = categoryName;
                            selectElement.appendChild(option);
                       });

                       // Po naplnení možností nastavíme selectedCategoryId, ak bol poskytnutý
                       // Toto sa používa napr. pri úprave skupiny/klubu
                        // Ak includePlaceholder = true a selectedCategoryId nie je nájdený, zostane vybraný placeholder
                        if (selectedCategoryId) {
                            selectElement.value = selectedCategoryId;
                        }
                   }
               } catch (error) {
                   console.error('Chyba pri načítaní kategórií: ', error);
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '-- Chyba pri načítaní --';
                    option.disabled = true;
                    selectElement.appendChild(option);
                    selectElement.disabled = true; // Keep disabled on error
               } finally {
                   // --- Pridať volanie na odstránenie duplicít po naplnení ---
                   // Túto funkciu voláme vždy po naplnení, ako poistku (pre clubCategorySelect)
                   if (selectElement.id === 'clubCategory') {
                        removeDuplicateOptions(selectElement);
                   }
                   // ------------------------------------------------------
               }
            }


         // Funkcia na naplnenie selectboxu skupín pre danú kategóriu
         async function populateGroupSelect(selectedCategoryId, selectElement, selectedGroupId = null) {
              console.log(`DEBUG: Populating groups for select: ${selectElement.id || 'Unnamed Select'} based on category: ${selectedCategoryId}`);
              selectElement.innerHTML = '<option value="">-- Vyberte skupinu --</option>'; // Clear and add placeholder

              selectElement.disabled = true; // Disable while loading


              if (!selectedCategoryId || selectedCategoryId === '' || selectedCategoryId === '-- Vyberte kategóriu --') {
                   // Ak nie je vybraná platná kategória, len resetujeme select skupín a necháme ho zablokovaný
                   console.log("DEBUG: populateGroupSelect called with no valid category selected. Resetting group select.");
                   // Select už bol resetovaný na placeholder na začiatku funkcie
                    // Zabezpečíme, že zostane zablokovaný
                    selectElement.disabled = true; // Ponechať zablokovaný
                   return; // Ukončiť funkciu
              }


              try {
                   // Query groups for the selected category
                   const groupsQuery = query(groupsCollectionRef, where('categoryId', '==', selectedCategoryId));
                  const querySnapshot = await getDocs(groupsQuery);

                  if (querySnapshot.empty) {
                       const option = document.createElement('option');
                       option.value = '';
                       option.textContent = '-- Žiadne skupiny v kategórii --';
                       option.disabled = true;
                       selectElement.appendChild(option);
                       selectElement.disabled = true; // Keep disabled if no groups found for category
                       console.warn(`No groups found for category: ${selectedCategoryId}`);
                  } else {
                       selectElement.disabled = false; // Enable if groups are found
                       const sortedDocs = querySnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                       sortedDocs.forEach((doc) => {
                            const groupName = doc.id; // Group ID je názov dokumentu
                            const option = document.createElement('option');
                            option.value = groupName; // Použiť ID dokumentu ako value
                            option.textContent = groupName; // Použiť ID dokumentu ako text (alebo použiť iné pole z dokumentu skupiny ak existuje, napr. group.name)
                            selectElement.appendChild(option);
                       });

                       // Set the selected value if provided
                       if (selectedGroupId) {
                           selectElement.value = selectedGroupId;
                       }
                   }
               } catch (error) {
                   console.error(`Chyba pri načítaní skupín pre kategóriu ${selectedCategoryId}: `, error);
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '-- Chyba pri načítaní --';
                    option.disabled = true;
                    selectElement.appendChild(option);
                    selectElement.disabled = true; // Keep disabled on error
               } finally {
                   // --- Pridať volanie na odstránenie duplicít po naplnení ---
                   // Túto funkciu voláme vždy po naplnení, ako poistku (pre clubGroupSelect)
                   if (selectElement.id === 'clubGroup') {
                       removeDuplicateOptions(selectElement);
                   }
                    // ------------------------------------------------------
               }
         }


         // Funkcia na naplnenie selectboxu nepriradených tímov (pre clubModal v add-assign móde)
         async function populateUnassignedClubsSelect(selectElement, selectedClubId = null) {
              console.log(`DEBUG: Populating unassigned clubs for select: ${selectElement.id || 'Unnamed Select'}`);
             selectElement.innerHTML = '<option value="">-- Vyberte tím na priradenie --</option>'; // Clear and add placeholder

             selectElement.disabled = true; // Disable while loading

             try {
                  // Filtrovať kluby, kde groupId je null (alebo nie je nastavené)
                 const unassignedQuery = query(clubsCollectionRef, where('groupId', '==', null)); // Filtrovať podľa groupId == null
                 const querySnapshot = await getDocs(unassignedQuery);

                 if (querySnapshot.empty) {
                       const option = document.createElement('option');
                       option.value = '';
                       option.textContent = '-- Žiadne nepriradené tímy --';
                       option.disabled = true;
                       selectElement.appendChild(option);
                       selectElement.disabled = true; // Keep disabled if no unassigned teams
                       console.log("No unassigned clubs found.");
                 } else {
                      selectElement.disabled = false; // Enable if unassigned clubs are found
                       // Zoradiť podľa názvu pre ľahšie nájdenie
                       const sortedDocs = querySnapshot.docs.sort((a, b) => (a.data().name || '').localeCompare(b.data().name || ''));

                       sortedDocs.forEach((doc) => {
                           const club = doc.data();
                           const option = document.createElement('option');
                           option.value = doc.id; // Použiť ID dokumentu ako value (auto-generované)
                           option.textContent = club.name || 'Bez názvu'; // Použiť názov klubu ako text
                           selectElement.appendChild(option);
                       });

                       // Nastaviť vybranú hodnotu, ak bola poskytnutá
                       if (selectedClubId) {
                           selectElement.value = selectedClubId;
                       }
                 }
             } catch (error) {
                  console.error('Chyba pri načítaní nepriradených tímov: ', error);
                   const option = document.createElement('option');
                   option.value = '';
                   option.textContent = '-- Chyba pri načítaní --';
                   option.disabled = true;
                   selectElement.appendChild(option);
                   selectElement.disabled = true; // Keep disabled on error
             }
              // Pri tomto selecte neočakávame duplicity názvov v rámci nepriradených,
              // takže funkciu removeDuplicateOptions tu nevoláme.
         }


        // Funkcia na načítanie všetkých kategórií pre dynamické selectboxy (v modáli vytvárania tímov)
        async function loadAllCategoriesForDynamicSelects() {
            console.log("DEBUG: loading all categories for dynamic selects...");
            try {
                const querySnapshot = await getDocs(categoriesCollectionRef);
                if (querySnapshot.empty) {
                    allAvailableCategories = []; // Reset
                    console.warn("No categories found for dynamic selects.");
                } else {
                     const sortedDocs = querySnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                    allAvailableCategories = sortedDocs.map(doc => doc.id); // Fill the global array
                }
                // Po načítaní, aktualizujeme dynamicky pridané selecty
                updateDynamicCategorySelects(); // Táto funkcia musí použiť allAvailableCategories na naplnenie selectov
                 checkIfAddCategoryButtonShouldBeVisible(); // Táto funkcia používa allAvailableCategories
                 console.log("DEBUG: All categories loaded and dynamic selects/button updated.");

            } catch (error) {
                console.error('Chyba pri načítaní kategórií pre dynamické selectboxy: ', error);
                 allAvailableCategories = []; // Reset on error
                 // Aj pri chybe sa pokúsime aktualizovať selecty a viditeľnosť tlačidla
                 updateDynamicCategorySelects();
                  checkIfAddCategoryButtonShouldBeVisible();
                  console.log("DEBUG: Error loading categories, dynamic selects/button updated with empty list.");
            }
             console.log("DEBUG: finished loading all categories for dynamic selects. allAvailableCategories:", allAvailableCategories);
        }

         // Funkcia na aktualizáciu možností v dynamicky pridaných category selectoch (v modáli vytvárania tímov)
         function updateDynamicCategorySelects() {
              console.log("DEBUG: updateDynamicCategorySelects called.");
             const dynamicCategorySelects = teamCategoryCountContainer.querySelectorAll('.team-category-select-dynamic');
             dynamicCategorySelects.forEach(selectElement => {
                  const currentValue = selectElement.value; // Zapamätáme si aktuálnu hodnotu

                  selectElement.innerHTML = '<option value="">-- Vyberte kategóriu --</option>'; // Vyčistíme a pridáme placeholder
                  selectElement.disabled = true; // Zablokujeme počas aktualizácie

                 if (allAvailableCategories.length > 0) {
                      allAvailableCategories.forEach(categoryName => {
                           const option = document.createElement('option');
                           option.value = categoryName;
                           option.textContent = categoryName;
                           selectElement.appendChild(option);
                      });
                       selectElement.disabled = false; // Povolíme, ak sú kategórie

                       // Pokúsime sa nastaviť späť zapamätanú hodnotu
                       if (currentValue && allAvailableCategories.includes(currentValue)) {
                           selectElement.value = currentValue;
                       }

                 } else {
                       const option = document.createElement('option');
                       option.value = '';
                       option.textContent = '-- Žiadne kategórie --';
                       option.disabled = true;
                       selectElement.appendChild(option);
                       selectElement.disabled = true; // Zostane zablokovaný
                 }
                  // Pri dynamických selectoch neočakávame duplicity generované kódom
                  // takže funkciu removeDuplicateOptions tu nevoláme
             });
             console.log(`DEBUG: Updated ${dynamicCategorySelects.length} dynamic category selects.`);
         }

        // Funkcia na manažovanie viditeľnosti tlačidla "Pridať ďalšiu kategóriu" (v modáli vytvárania tímov)
        function checkIfAddCategoryButtonShouldBeVisible() {
             console.log("DEBUG: checkIfAddCategoryButtonShouldBeVisible called.");
            // Tlačidlo by malo byť viditeľné, len ak existujú nejaké kategórie
            if (addCategoryCountPairButton) {
                if (allAvailableCategories.length > 0) {
                    addCategoryCountPairButton.style.display = 'inline-block'; // Alebo 'block'
                     console.log("DEBUG: Add category button visible.");
                } else {
                    addCategoryCountPairButton.style.display = 'none';
                     console.log("DEBUG: Add category button hidden (no categories).");
                }
            }
        }

         // Funkcia na pridanie novej dvojice Kategória/Počet do formulára vytvárania tímov
         async function addCategoryCountPair() {
              console.log("DEBUG: addCategoryCountPair called.");
             if (!teamCategoryCountContainer || !allAvailableCategories) {
                  console.error("Cannot add category count pair: container or categories list not found.");
                  return;
             }

             const pairDiv = document.createElement('div');
             pairDiv.classList.add('category-count-pair'); // Pridaj triedu pre štýlovanie/výber

             const categorySelect = document.createElement('select');
             categorySelect.classList.add('team-category-select-dynamic');
              categorySelect.setAttribute('required', ''); // Select kategórie je povinný

             const countInput = document.createElement('input');
             countInput.type = 'number';
             countInput.value = '1'; // Predvolená hodnota
             countInput.min = '1';
             countInput.classList.add('team-count-input-dynamic');
              countInput.setAttribute('required', ''); // Input počtu je povinný

              const removeButton = document.createElement('button');
              removeButton.type = 'button'; // Dôležité: aby nespúšťalo submit formulára
              removeButton.textContent = 'Odstrániť';
              removeButton.classList.add('remove-pair-button'); // Trieda pre štýlovanie
              removeButton.style.marginLeft = '10px'; // Malý odstup


              // Naplníme nový select kategórií dostupnými kategóriami
              updateDynamicCategorySelects(); // Re-run this to populate the new select (and update others)

              // Pridaj listener na tlačidlo odstrániť
              removeButton.addEventListener('click', () => {
                   console.log("DEBUG: removePairButton clicked.");
                  pairDiv.remove(); // Odstráni celú dvojicu
                  updateRemoveButtonVisibility(); // Aktualizuje viditeľnosť tlačidiel odstrániť
              });

             pairDiv.appendChild(categorySelect);
             pairDiv.appendChild(countInput);
             pairDiv.appendChild(removeButton); // Pridaj tlačidlo odstrániť
             teamCategoryCountContainer.appendChild(pairDiv);

             updateRemoveButtonVisibility(); // Zabezpečí správnu viditeľnosť tlačidiel odstrániť po pridaní
              console.log("DEBUG: Category count pair added.");
         }

         // Funkcia na manažovanie viditeľnosti tlačidiel "Odstrániť" pri dvojiciach kategória/počet
         function updateRemoveButtonVisibility() {
              console.log("DEBUG: updateRemoveButtonVisibility called.");
             const removeButtons = teamCategoryCountContainer.querySelectorAll('.remove-pair-button');
             // Zobraz tlačidlo Odstrániť, len ak existuje viac ako jedna dvojica
             if (removeButtons.length > 1) {
                  removeButtons.forEach(button => button.style.display = 'inline-block');
                  console.log("DEBUG: Showing remove buttons.");
             } else {
                  removeButtons.forEach(button => button.style.display = 'none');
                  console.log("DEBUG: Hiding remove buttons (only one pair left).");
             }
         }


         // Funkcia na odstránenie duplicitných <option> elementov zo selectboxu
         // Používame ju ako poistku po naplnení selectboxov kategórií a skupín
         function removeDuplicateOptions(selectElement) {
              if (!selectElement) {
                  console.error("DEBUG: Attempted to remove duplicates from a null select element.");
                  return;
              }
              console.log(`DEBUG: Removing duplicates from select: ${selectElement.id || 'Unnamed Select'}`);
              const seenValues = new Set();
              // Iterovať od konca, aby bolo odstraňovanie bezpečné pre indexy
              for (let i = selectElement.options.length - 1; i >= 0; i--) {
                   const option = selectElement.options[i];
                   // Použijeme option.value na kontrolu jedinečnosti
                   if (seenValues.has(option.value)) {
                        console.log(`DEBUG: Removing duplicate option with value: "${option.value}" and text: "${option.textContent}"`);
                       selectElement.removeChild(option);
                   } else {
                        seenValues.add(option.value);
                   }
              }
              console.log(`DEBUG: Finished removing duplicates. Remaining options: ${selectElement.options.length}`);
         }


        // --- Funkcia na zobrazenie klubov priradených do skupín v sekcii #timy-do-skupin ---
        // Pridaný príznak isDisplayingClubs na zabránenie viacnásobnému spusteniu
        let isDisplayingClubs = false;
        async function displayClubs() {
            console.log("DEBUG: displayClubs called.");

            // --- Kontrola, či funkcia už beží ---
            if (isDisplayingClubs) {
                 console.log("DEBUG: displayClubs is already running, skipping.");
                 return; // Ak už beží, preskočíme
            }
             isDisplayingClubs = true; // Nastavíme príznak na začiatku vykonávania


            const clubsContentSection = document.getElementById('clubsContent');
            const clubsTableBody = document.getElementById('clubsTableBody');

            if (!clubsContentSection || !clubsTableBody) {
                 console.error("FATAL ERROR: Required DOM elements for displayClubs not found!");
                 isDisplayingClubs = false; // Reset príznaku aj pri chybe hľadania elementov
                 return;
            }

            // Vymazať telo tabuľky PRED načítaním nových dát
            clubsTableBody.innerHTML = '';
            console.log("DEBUG: clubsTableBody cleared.");


            try {
                // Načítanie klubov, ktoré sú priradené do skupiny (groupId nie je null)
                console.log("DEBUG: Fetching assigned clubs...");
                // Použijeme where('groupId', '!=', null) na filtrovanie priradených tímov
                const assignedClubsQuery = query(clubsCollectionRef, where('groupId', '!=', null));
                const querySnapshot = await getDocs(assignedClubsQuery);

                console.log(`DEBUG: Found ${querySnapshot.size} assigned clubs.`);

                if (querySnapshot.empty) {
                    const row = clubsTableBody.insertRow();
                    const cell = row.insertCell(0);
                    cell.colSpan = 4; // Predpokladáme 4 stĺpce: Názov, Kategória, Skupina, Poradie
                    cell.textContent = 'Žiadne tímy zatiaľ nie sú priradené do skupín.';
                    cell.style.textAlign = 'center';
                     console.log("DEBUG: No assigned clubs found. Table populated with message.");
                } else {
                    // Zoradenie priradených klubov podľa skupiny a následne podľa poradia v skupine
                     const sortedClubs = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                         .sort((a, b) => {
                             // Zoradenie podľa groupId
                             const groupComparison = (a.groupId || '').localeCompare(b.groupId || '');
                             if (groupComparison !== 0) {
                                 return groupComparison;
                             }
                             // Potom zoradenie podľa orderInGroup (ošetrenie null/undefined a numerické porovnanie)
                             const orderA = typeof a.orderInGroup === 'number' ? a.orderInGroup : Infinity; // null/undefined idú nakoniec
                             const orderB = typeof b.orderInGroup === 'number' ? b.orderInGroup : Infinity;
                             return orderA - orderB;
                         });

                    console.log(`DEBUG: Populating table with ${sortedClubs.length} sorted clubs.`);
                    sortedClubs.forEach((club) => {
                        const row = clubsTableBody.insertRow();
                        row.insertCell(0).textContent = club.name || 'Bez názvu';
                         row.insertCell(1).textContent = club.categoryId || 'N/A';
                         row.insertCell(2).textContent = club.groupId || 'N/A'; // Toto by malo byť vždy groupId v tejto query
                         row.insertCell(3).textContent = typeof club.orderInGroup === 'number' ? club.orderInGroup : '-'; // Zobraz '-' ak nie je poradie
                        // Tlačidlá na úpravu/zmazanie priradených tímov by sa pridali tu, ak sú v tomto pohľade povolené
                        // Napr.: Pridanie bunky s tlačidlami Úprava/Zmazať
                         /*
                         const actionsCell = row.insertCell(4); // Pridaj ďalší stĺpec
                         const editButton = document.createElement('button');
                         editButton.textContent = 'Upraviť';
                         editButton.addEventListener('click', () => {
                              // Logic to open clubModal in edit mode for this club
                              openClubModal(club.id, club); // Použiť ID dokumentu a načítané dáta
                         });
                         const deleteButton = document.createElement('button');
                         deleteButton.textContent = 'Zmazať';
                         deleteButton.addEventListener('click', async () => {
                              if (confirm(`Naozaj chcete zmazať tím "${club.name}" zo skupiny "${club.groupId}"?`)) {
                                   try {
                                        await deleteDoc(doc(clubsCollectionRef, club.id));
                                        alert('Tím úspešne zmazaný.');
                                        displayClubs(); // Refresh table
                                        displayCreatedTeams(); // Refresh created teams list
                                        if (unassignedClubSelect) populateUnassignedClubsSelect(unassignedClubSelect, null); // Refresh unassigned list
                                   } catch (error) {
                                        console.error('Chyba pri mazaní tímu: ', error);
                                        alert('Chyba pri mazaní tímu.');
                                   }
                              }
                         });
                         actionsCell.appendChild(editButton);
                         actionsCell.appendChild(deleteButton);
                         */
                    });
                     console.log("DEBUG: Table population complete.");
                }
            } catch (error) {
                console.error('Chyba pri načítaní priradených klubov: ', error);
                 clubsTableBody.innerHTML = ''; // Vymazať tabuľku pri chybe
                 const row = clubsTableBody.insertRow();
                 const cell = row.insertCell(0);
                 cell.colSpan = 4; // Predpokladáme 4 stĺpce
                 cell.textContent = 'Chyba pri načítaní dát.';
                 cell.style.textAlign = 'center';
                 console.log("DEBUG: Error displayed in table.");
            } finally {
                 isDisplayingClubs = false; // Vždy resetovať príznak na konci
                 console.log("DEBUG: displayClubs finished and flag reset.");
            }
        }


        // Funkcia na zobrazenie všetkých vytvorených tímov (v sekcii #zoznam-timov)
        // Pridaný príznak isDisplayingCreatedTeams na zabránenie viacnásobnému spusteniu
         let isDisplayingCreatedTeams = false;
         async function displayCreatedTeams() {
              console.log("DEBUG: displayCreatedTeams called.");
              if (isDisplayingCreatedTeams) {
                   console.log("DEBUG: displayCreatedTeams is already running, skipping.");
                   return;
              }
              isDisplayingCreatedTeams = true;

              const createdTeamsContentSection = document.getElementById('createdTeamsContentSection');
              const createdTeamsTableBody = document.getElementById('createdTeamsTableBody'); // Predpokladáme existenciu tbody pre túto tabuľku

               if (!createdTeamsContentSection || !createdTeamsTableBody) {
                   console.error("FATAL ERROR: Required DOM elements for displayCreatedTeams not found!");
                   isDisplayingCreatedTeams = false;
                   return;
               }

               createdTeamsTableBody.innerHTML = ''; // Vyčisti telo tabuľky
               console.log("DEBUG: createdTeamsTableBody cleared.");


              try {
                   // Načítaj VŠETKY kluby bez ohľadu na priradenie do skupín
                   const allClubsQuery = query(clubsCollectionRef);
                   const querySnapshot = await getDocs(allClubsQuery);

                   console.log(`DEBUG: Found ${querySnapshot.size} total clubs.`);

                   if (querySnapshot.empty) {
                       const row = createdTeamsTableBody.insertRow();
                       const cell = row.insertCell(0);
                       cell.colSpan = 5; // Predpokladáme 5 stĺpcov: Základný názov, Kategória, Počet, Skupina, Akcie
                       cell.textContent = 'Zatiaľ nie sú vytvorené žiadne tímy.';
                       cell.style.textAlign = 'center';
                        console.log("DEBUG: No created teams found. Table populated with message.");
                   } else {
                       // Zoskupenie tímov podľa základného názvu a kategórie
                       // Základný názov sa pokúsime získať z ID "Kategória - Základný Názov [Suffix]" alebo použijeme celý názov
                       const teamsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                       // Mapa pre zoskupenie: { "Základný názov_Kategória": [tím1, tím2, ...], ... }
                       const groupedTeams = teamsData.reduce((acc, team) => {
                            const teamName = team.name || 'Bez názvu';
                            const category = team.categoryId || 'N/A';
                            // Skúsme extrahovať základný názov z ID, ak má formát "Kategória - Základný Názov [Suffix]"
                             // Toto je komplexné a nemusí fungovať pre všetky ID/formáty
                             // Jednoduchšie: Zoskupme len podľa PLNEHO názvu a kategórie, alebo len podľa kategórie a názvu.
                             // Ak chceme zoskupovať ako "Základný názov (Kategória)", musíme extrahovať základný názov.
                             // Predpokladajme, že základný názov je časť názvu pred poslednou medzerou a číslom/písmenom, alebo celý názov
                             // Ak sa tím vytvorí cez modal "Vytvoriť tímy", jeho názov by mal byť Základný názov + Suffix (napr. Hádzaná Trenčín 1)
                             // Ak sa priradí nepriradený tím, jeho názov ostane pôvodný (napr. FC Juniori B)
                             // Najjednoduchšie a najbezpečnejšie je zoskupiť len podľa KATEGÓRIE a v rámci kategórie zobraziť tímy.
                             // Alebo zoskupovať podľa PLNEHO názvu a kategórie.

                             // Ak chceme zoskupovať ako "Základný názov" a zobraziť kategórie/počet, musíme mať konzistentný spôsob extrakcie.
                             // Skúsme zoskupiť podľa team.name a team.categoryId ako jedinečný kľúč pre agregáciu
                             const groupKey = `${teamName}_${category}`; // Unikátny kľúč pre zoskupenie

                             if (!acc[groupKey]) {
                                  acc[groupKey] = {
                                       name: teamName, // Uložíme plný názov
                                       categoryId: category,
                                       teams: [] // Zoznam tímov s týmto názvom a kategóriou
                                  };
                             }
                              acc[groupKey].teams.push(team); // Pridaj tím do skupiny
                            return acc;
                       }, {});

                       console.log("DEBUG: Grouped teams data:", groupedTeams);

                       // Zobrazenie zoskupených dát v tabuľke
                       // Zoradíme zoskupené skupiny (napr. podľa názvu)
                       const sortedGroupKeys = Object.keys(groupedTeams).sort();

                       sortedGroupKeys.forEach(key => {
                            const groupInfo = groupedTeams[key];
                             const teamsInGroup = groupInfo.teams; // Zoznam tímov pre toto zoskupenie

                             // Zoradíme tímy v rámci zoskupenia (napr. podľa ID alebo názvu, alebo orderInGroup ak by bolo konzistentné)
                             // Ak ide o tímy z "Vytvoriť tímy" (napr. Hádzaná Trenčín 1, Hádzaná Trenčín 2), chceme ich zoradiť podľa suffixu
                             // Toto vyžaduje inteligentnejšie zoradenie
                              teamsInGroup.sort((a, b) => {
                                  // Jednoduché zoradenie podľa ID alebo názvu
                                  return (a.name || '').localeCompare(b.name || ''); // Zoradiť podľa názvu
                              });

                            // Zobrazíme riadok pre každé zoskupenie (napr. "Základný názov (Kategória) - Počet: X")
                            // Alebo zobrazíme riadok pre KAŽDÝ tím, ale zoskupené vizuálne?
                            // Ak chceme tabuľku podobnú Manage Teams modal, potrebujeme názov, kategóriu, počet (1), skupinu, poradie, akcie
                            // Zobrazme riadok pre KAŽDÝ tím, zoradený podľa kategórie a názvu, a pridajme stĺpec Skupina/Poradie.

                             teamsInGroup.forEach(team => {
                                  const row = createdTeamsTableBody.insertRow();
                                  row.insertCell(0).textContent = team.name || 'Bez názvu'; // Názov tímu
                                   row.insertCell(1).textContent = team.categoryId || 'N/A'; // Kategória
                                  // Stĺpec "Počet" - V tomto pohľade je každý riadok 1 tím, takže počet je vždy 1
                                   row.insertCell(2).textContent = '1';
                                   // Zobraziť informácie o priradení do skupiny a poradie
                                   row.insertCell(3).textContent = team.groupId ? `${team.groupId} (${typeof team.orderInGroup === 'number' ? team.orderInGroup : '-'})` : 'Nepriradený'; // Skupina (Poradie) alebo Nepriradený

                                  // Stĺpec Akcie - tu by sa pridali tlačidlá Upraviť/Zmazať/Presunúť (napr. do nepriradených)
                                   const actionsCell = row.insertCell(4); // Predpokladaj 5. stĺpec pre akcie
                                   // Tlačidlo úpravy
                                    const editButton = document.createElement('button');
                                    editButton.textContent = 'Upraviť';
                                    editButton.addEventListener('click', () => {
                                         // Otvor modal na úpravu tohto konkrétneho tímu
                                         // clubId je document.id, clubData sú načítané dáta
                                         openClubModal(team.id, team); // Zmena: voláme openClubModal v edit móde s ID a dátami tímu
                                    });
                                    actionsCell.appendChild(editButton);

                                   // Tlačidlo zmazania
                                    const deleteButton = document.createElement('button');
                                    deleteButton.textContent = 'Zmazať';
                                     deleteButton.classList.add('delete-button'); // Pre štýlovanie
                                    deleteButton.addEventListener('click', async () => {
                                         if (confirm(`Naozaj chcete zmazať tím "${team.name}"?`)) {
                                              try {
                                                   await deleteDoc(doc(clubsCollectionRef, team.id));
                                                   alert('Tím úspešne zmazaný.');
                                                   // Po zmazaní obnov tabuľky, ktoré sa mohli zmeniť
                                                   displayCreatedTeams(); // Obnov tento zoznam
                                                   // Ak bol tím priradený, treba obnoviť aj tabuľku priradených tímov
                                                   if (team.groupId) {
                                                        // Aby sa predišlo viacnásobnému volaniu, len skontroluj hash
                                                        if (window.location.hash === '#timy-do-skupin') {
                                                             displayClubs(); // Obnov tabuľku priradených, ak je viditeľná
                                                        }
                                                   }
                                                    // Ak bol nepriradený, treba obnoviť zoznam nepriradených v modáli
                                                    if (!team.groupId) {
                                                         if (unassignedClubSelect) populateUnassignedClubsSelect(unassignedClubSelect, null);
                                                    }


                                              } catch (error) {
                                                   console.error('Chyba pri mazaní tímu: ', error);
                                                   alert('Chyba pri mazaní tímu.');
                                              }
                                         }
                                    });
                                     actionsCell.appendChild(deleteButton);


                                   // Tlačidlo "Presunúť do nepriradených" (len ak je priradený)
                                    if (team.groupId) {
                                         const unassignButton = document.createElement('button');
                                         unassignButton.textContent = 'Nepriradiť';
                                          unassignButton.classList.add('unassign-button'); // Pre štýlovanie
                                         unassignButton.addEventListener('click', async () => {
                                              if (confirm(`Naozaj chcete tím "${team.name}" odpriradiť zo skupiny "${team.groupId}"?`)) {
                                                   try {
                                                        // Odpriradenie tímu = nastavenie groupId a orderInGroup na null
                                                        await updateDoc(doc(clubsCollectionRef, team.id), {
                                                             groupId: null,
                                                             orderInGroup: null
                                                        });
                                                        alert('Tím úspešne odpriradený.');
                                                        // Po odpriradení obnov tabuľky
                                                        displayCreatedTeams(); // Obnov tento zoznam
                                                        // Ak bol priradený, treba obnoviť aj tabuľku priradených tímov
                                                         if (window.location.hash === '#timy-do-skupin') {
                                                              displayClubs(); // Obnov tabuľku priradených, ak je viditeľná
                                                         }
                                                         // Obnoviť zoznam nepriradených v modáli
                                                         if (unassignedClubSelect) populateUnassignedClubsSelect(unassignedClubSelect, null);


                                                   } catch (error) {
                                                        console.error('Chyba pri odpriradení tímu: ', error);
                                                        alert('Chyba pri odpriradení tímu.');
                                                   }
                                              }
                                         });
                                         actionsCell.appendChild(unassignButton);
                                    }

                             });


                       });

                   }
              } catch (error) {
                  console.error('Chyba pri načítaní vytvorených tímov: ', error);
                   createdTeamsTableBody.innerHTML = ''; // Vyčisti tabuľku pri chybe
                   const row = createdTeamsTableBody.insertRow();
                   const cell = row.insertCell(0);
                   cell.colSpan = 5;
                   cell.textContent = 'Chyba pri načítaní dát.';
                   cell.style.textAlign = 'center';
                    console.log("DEBUG: Error displayed in created teams table.");
              } finally {
                  isDisplayingCreatedTeams = false;
                  console.log("DEBUG: displayCreatedTeams finished and flag reset.");
              }
         }



        // --- Funkcia na prepínanie zobrazenia obsahu na základe URL hashu ---
        function toggleContentDisplay() {
             console.log("DEBUG: toggleContentDisplay called. Current hash:", window.location.hash);
            const hash = window.location.hash || '#kategorie'; // Default to #kategorie

            // Skryť všetky obsahové sekcie prv
            document.querySelectorAll('main section').forEach(section => {
                section.style.display = 'none';
            });

            // Zobraziť sekciu zodpovedajúcu hashu
            const targetSectionId = `${hash.substring(1)}ContentSection`; // Predpokladá ID sekcie ako #hash -> hashContentSection
            // Oprava: Názvy ID sekcií sú rôzne, nie vždy 'hashContentSection'. Potrebujeme mapovanie alebo konzistentné ID.
            // Predpokladajme, že ID sekcií sú: categoriesContentSection, groupsContent, clubsContent, createdTeamsContentSection
            let actualTargetSectionId;
            if (hash === '#kategorie') actualTargetSectionId = 'categoriesContentSection';
            else if (hash === '#skupiny') actualTargetSectionId = 'groupsContent'; // Potrebné implementovať zobrazenie skupín
            else if (hash === '#timy-do-skupin') actualTargetSectionId = 'clubsContent';
            else if (hash === '#zoznam-timov') actualTargetSectionId = 'createdTeamsContentSection';
            // else if (hash === '#vytvorit-timy') actualTargetSectionId = 'teamCreationContentSection'; // Toto je modal, nie sekcia?

             console.log("DEBUG: Resolved target section ID:", actualTargetSectionId);

            const targetSection = document.getElementById(actualTargetSectionId);

            if (targetSection) {
                 console.log("DEBUG: Showing section:", actualTargetSectionId);
                targetSection.style.display = 'block';

                // Zavolať špecifickú funkciu na zobrazenie obsahu pre danú sekciu
                if (hash === '#kategorie') {
                    console.log("DEBUG: Calling loadCategoriesTable from toggleContentDisplay");
                    loadCategoriesTable(); // Predpokladá existenciu loadCategoriesTable
                } else if (hash === '#skupiny') {
                     console.log("DEBUG: Handling #skupiny from toggleContentDisplay - needs specific display logic.");
                     // Sem by prišla logika na zobrazenie skupín, napr. načítanie kategórií pre filter, zobrazenie prvej kategórie skupín
                     // Napr.: populateCategorySelect(groupCategoryFilterSelect, true); // Naplní filter kategórií v sekcii skupín
                     // loadGroupsForCategory(groupCategoryFilterSelect.value); // Načíta skupiny pre predvolenú/vybranú kategóriu
                } else if (hash === '#timy-do-skupin') {
                     console.log("DEBUG: Handling #timy-do-skupin from toggleContentDisplay.");
                     // --- ODSTRÁNENÉ: displayClubs() sa už nebude volať z toggleContentDisplay pri každej zmene hashu ---
                     // DisplayClubs sa zavolá pri prvom načítaní stránky s týmto hashom alebo po úspešnom submite formulára
                     // Toto by malo byť ošetrené externým volaním
                     console.log("DEBUG: Relying on external call for displayClubs.");

                } else if (hash === '#zoznam-timov') {
                     console.log("DEBUG: Handling #zoznam-timov from toggleContentDisplay.");
                     // --- ODSTRÁNENÉ: displayCreatedTeams() sa už nebude volať z toggleContentDisplay pri každej zmene hashu ---
                     // DisplayCreatedTeams sa zavolá pri prvom načítaní stránky s týmto hashom alebo po úspešnom submite formulára
                      console.log("DEBUG: Relying on external call for displayCreatedTeams.");
                }
                // Pridaj ďalšie sekcie tu, ak nejaké existujú (napr. #statistiky, #nastavenia)
            } else {
                 console.warn("No content section found for hash:", hash);
                 // Voliteľne presmerovať na predvolenú stránku alebo zobraziť chybovú správu
                 // window.location.hash = '#kategorie'; // Presmerovať na predvolenú
            }
        }

        // --- Správa zobrazenia sekcií pri načítaní stránky a zmene hashu ---

        // Inicializovať stav zobrazenia pri načítaní stránky
        // Toto sa spustí raz pri prvom načítaní
        console.log("DEBUG: Initial page load display setup.");
        const initialHash = window.location.hash || '#kategorie';

        // Volanie príslušnej zobrazovacej funkcie pre počiatočný hash
        if (initialHash === '#kategorie') {
             console.log("DEBUG: Initial display for #kategorie.");
            toggleContentDisplay(); // Spustí toggleContentDisplay, ktorý zobrazí sekciu a zavolá loadCategoriesTable
        } else if (initialHash === '#skupiny') {
             console.log("DEBUG: Initial display for #skupiny.");
             toggleContentDisplay(); // Spustí toggleContentDisplay, ktorý zobrazí sekciu (logika zobrazenia skupín musí byť v toggleContentDisplay alebo inde)
        } else if (initialHash === '#timy-do-skupin') {
             console.log("DEBUG: Initial display for #timy-do-skupin. Calling toggleContentDisplay and displayClubs.");
             toggleContentDisplay(); // Zobrazí sekciu #timy-do-skupin
             displayClubs(); // Zavolá displayClubs pre prvotné naplnenie tabuľky priradených tímov
        } else if (initialHash === '#zoznam-timov') {
             console.log("DEBUG: Initial display for #zoznam-timov. Calling toggleContentDisplay and displayCreatedTeams.");
             toggleContentDisplay(); // Zobrazí sekciu #zoznam-timov
             displayCreatedTeams(); // Zavolá displayCreatedTeams pre prvotné naplnenie tabuľky všetkých tímov
        } else {
             console.warn(`DEBUG: Initial hash ${initialHash} does not match any known section. Defaulting to #kategorie.`);
             window.location.hash = '#kategorie'; // Presmeruje na #kategorie, čo spustí hashchange listener
        }


        // Pridať poslucháča udalosti 'hashchange', ktorý zavolá toggleContentDisplay
        // Toto sa spustí pri KAŽDEJ zmene hashu (kliknutie na navigačné linky, programová zmena hashu)
        console.log("DEBUG: Adding hashchange listener.");
        window.addEventListener('hashchange', toggleContentDisplay);


        // --- Inicializácia dát pri načítaní skriptu ---
        // Tieto dáta sú potrebné pre plnenie selectboxov v modáloch hneď pri ich otvorení
        loadAllCategoriesForDynamicSelects(); // Načíta kategórie pre modál vytvárania tímov a volá updateDynamicCategorySelects/checkIfAddCategoryButtonShouldBeVisible
        // populateCategorySelect(clubCategorySelect, true); // Toto volanie je presunuté do openClubModal
        // populateUnassignedClubsSelect(unassignedClubSelect, null); // Toto volanie je presunuté do openClubModal

        // Načítanie počiatočných dát pre hlavné pohľady (už ošetrené vyššie v logike inicializácie podľa hashu)
        // displayClubs(); // Nechceme volať displayClubs() tu, volá sa na základe hashu pri inicializácii alebo po submite
        // displayCreatedTeams(); // Nechceme volať displayCreatedTeams() tu, volá sa na základe hashu pri inicializácii alebo po submite


        // --- Správa modálov (otváranie/zatváranie) ---

        // Funkcia na otvorenie modálu kategórií (používa sa pri + a Úprava kategórie)
        async function openCategoryModal(categoryId = null, categoryData = null) {
            console.log('DEBUG: openCategoryModal called. categoryId:', categoryId, 'categoryData:', categoryData);
            if (!categoryForm) { console.error("FATAL ERROR: categoryForm not found!"); if (categoryModal) categoryModal.style.display = 'none'; return; }

            categoryForm.reset();
             if (!categorySubmitButton) { console.error("FATAL ERROR: categorySubmitButton not found!"); if (categoryModal) categoryModal.style.display = 'none'; return; }


            if (categoryId && categoryData) {
                // Režim úpravy
                currentCategoryModalMode = 'edit';
                editingCategoryId = categoryId;
                categoryNameInput.value = categoryData.name || categoryId; // Názov je ID dokumentu
                categorySubmitButton.textContent = 'Uložiť zmeny';
            } else {
                // Režim pridania
                currentCategoryModalMode = 'add';
                editingCategoryId = null;
                categorySubmitButton.textContent = 'Pridať';
            }

            if (categoryModal) categoryModal.style.display = 'block';
             // Nastavenie focusu po krátkej pauze
             setTimeout(() => {
                  if (categoryNameInput) categoryNameInput.focus();
             }, 50);
        }

        // Funkcia na otvorenie modálu skupiny (používa sa pri + a Úprava skupiny)
        async function openGroupModal(groupId = null, groupData = null) { // groupId je ID dokumentu skupiny
            console.log('DEBUG: openGroupModal called. groupId:', groupId, 'groupData:', groupData);
            if (!groupForm) { console.error("FATAL ERROR: groupForm not found!"); if (groupModal) groupModal.style.display = 'none'; return; }

            groupForm.reset();
             if (!groupSubmitButton) { console.error("FATAL ERROR: groupSubmitButton not found!"); if (groupModal) groupModal.style.display = 'none'; return; }
             if (!groupCategorySelect) { console.error("FATAL ERROR: groupCategorySelect not found!"); if (groupModal) groupModal.style.display = 'none'; return; }


            // Naplníme select kategórií pred zobrazením modálu
            await populateCategorySelect(groupCategorySelect, true); // Naplní select kategórií, vrátane placeholderu

            if (groupId && groupData) {
                // Režim úpravy
                currentGroupModalMode = 'edit';
                editingGroupId = groupId;
                groupNameInput.value = groupData.name || groupId; // Názov je ID dokumentu
                groupSubmitButton.textContent = 'Uložiť zmeny';

                // Nastavíme vybranú kategóriu podľa dát skupiny
                groupCategorySelect.value = groupData.categoryId || '';
                // V režime úpravy by sa kategória skupiny nemala meniť, takže zablokujeme select
                 groupCategorySelect.disabled = true;


            } else {
                // Režim pridania
                currentGroupModalMode = 'add';
                editingGroupId = null;
                groupNameInput.value = '';
                groupSubmitButton.textContent = 'Pridať';
                // V režime pridania je category select povolený
                 groupCategorySelect.disabled = false;
                // Predvolene je vybraný placeholder
                 groupCategorySelect.value = '';
            }

            if (groupModal) groupModal.style.display = 'block';
             // Nastavenie focusu
             setTimeout(() => {
                  if (groupNameInput) groupNameInput.focus();
             }, 50);
        }


        // Funkcia na otvorenie modálu klubu (pre priradenie do skupín ALEBO úpravu priradeného/nepriradeného)
             async function openClubModal(clubId = null, clubData = null) {
                 console.log('DEBUG: openClubModal called. clubId:', clubId, 'clubData:', clubData);

                 if (!clubForm) { console.error("FATAL ERROR: clubForm not found!"); if (clubModal) clubModal.style.display = 'none'; return; }
                 clubForm.reset();
                 const clubFormSubmitButton = clubForm.querySelector('button[type="submit"]');
                 if (!clubFormSubmitButton) { console.error("FATAL ERROR: Submit button not found in clubForm!"); if (clubModal) clubModal.style.display = 'none'; return; }


                  // Reset visibility of name input vs select and order input
                  unassignedClubSelectContainer.style.display = 'block';
                  clubNameInputContainer.style.display = 'none';
                  orderInputContainer.style.display = 'none';


                  // Reset group select visibility and disabled state
                  clubGroupSelect.parentElement.style.display = 'block';
                  clubGroupSelect.disabled = true; // Zablokuje select skupín predvolene


                  // === NASTAVENIE POČIATOČNÉHO STAVU SELECTOV PRI OTVORENÍ ===
                  // Kategórie sa naplnia hneď, ale ich stav (disabled) závisí od režimu. Skupiny sú vždy zablokované na začiatku.
                   await populateCategorySelect(clubCategorySelect, true); // Naplní kategórie, vrátane placeholderu


                  if (clubId && clubData) {
                     // Edit mode (Úprava existujúceho klubu)
                     currentClubModalMode = 'edit';
                     editingClubId = clubId;

                      // V edit móde je category select povolený a hodnota nastavená
                      if (clubCategorySelect) {
                           clubCategorySelect.disabled = false; // Povoliť category select v edit móde
                           clubCategorySelect.value = clubData.categoryId || ''; // Nastaviť hodnotu
                            // Následne sa volá populateGroupSelect, ktorý spraví disable/enable group select
                             // Ak tím nie je priradený k skupine (groupId === null), skryjeme aj select skupín
                            if (clubData.groupId === null) {
                                 clubGroupSelect.parentElement.style.display = 'none'; // Skry skupinu
                                  orderInputContainer.style.display = 'none'; // Skry poradie
                                   orderInGroupInput.required = false;
                            } else {
                                 clubGroupSelect.parentElement.style.display = 'block';
                                 orderInputContainer.style.display = 'block';
                                 orderInGroupInput.required = true;
                            }
                            // Naplní skupiny na základe nastavenej kategórie. Disable/Enable group select rieši populateGroupSelect.
                            await populateGroupSelect(clubCategorySelect.value, clubGroupSelect, clubData.groupId);

                      } else { console.error("FATAL ERROR: clubCategorySelect not found in edit mode!"); if (clubModal) clubModal.style.display = 'none'; return; }


                      // Zobrazí input pre názov a nastaví jeho hodnotu
                      clubNameInputContainer.style.display = 'block';
                      unassignedClubSelectContainer.style.display = 'none'; // Skry select nepriradených v edit móde
                      clubNameInput.value = clubData.name || '';
                       orderInGroupInput.value = typeof clubData.orderInGroup === 'number' ? clubData.orderInGroup : '';


                     if (!clubModalTitle) { console.error('FATAL ERROR: clubModalTitle is null in edit mode!'); if (clubModal) clubModal.style.display = 'none'; return; }
                     clubModalTitle.textContent = 'Upraviť tím';
                     clubFormSubmitButton.textContent = 'Uložiť zmeny';


                  } else { // Add mode (Priradenie UNASSIGNED klubu do skupiny)
                     currentClubModalMode = 'add-assign';
                     editingClubId = null;

                     // V add-assign móde zobrazujeme select pre výber nepriradeného klubu
                     unassignedClubSelectContainer.style.display = 'block';
                     clubNameInputContainer.style.display = 'none'; // Input názvu je skrytý
                     orderInputContainer.style.display = 'none'; // Poradie je skryté
                      orderInGroupInput.required = false;

                      // Category select je už naplnený z úvodu funkcie, ale ZOSTÁVA ZABLOKOVANÝ
                      if (clubCategorySelect) {
                           clubCategorySelect.disabled = true; // !!! Zablokovať category select na začiatku add-assign !!!
                           clubCategorySelect.value = ''; // Reset hodnoty na placeholder
                      } else { console.error("FATAL ERROR: clubCategorySelect not found in add mode!"); if (clubModal) clubModal.style.display = 'none'; return; }

                     // Skupinový select je zobrazený, ale zablokovaný
                     clubGroupSelect.parentElement.style.display = 'block';
                     clubGroupSelect.disabled = true;


                     // Naplní select nepriradených klubov (môže spustiť 'change' ak je predvolená hodnota)
                     await populateUnassignedClubsSelect(unassignedClubSelect);


                     if (!clubModalTitle) { console.error('FATAL ERROR: clubModalTitle is null in add mode!'); if (clubModal) clubModal.style.display = 'none'; return; }
                     clubModalTitle.textContent = 'Priradiť tím do skupiny';
                     clubFormSubmitButton.textContent = 'Priradiť';
                  }

                  // Reset any previous validation messages (spoločné pre oba režimy)
                  const validationMessages = clubForm.querySelectorAll('.validation-message');
                  validationMessages.forEach(msg => msg.textContent = '');

                  // Zobraz modál až po nastavení obsahu
                  clubModal.style.display = 'block';

                  // Set focus to the first relevant input/select
                   if (currentClubModalMode === 'add-assign' && unassignedClubSelect) {
                       unassignedClubSelect.focus();
                   } else if (currentClubModalMode === 'edit' && clubNameInput) {
                       clubNameInput.focus();
                   } else if (clubCategorySelect && !clubCategorySelect.disabled) { // Fallback focus (len ak nie je zablokovaný)
                       clubCategorySelect.focus();
                   } else {
                        console.warn("Could not set focus in club modal.");
                   }
             } // Koniec openClubModal


        // Funkcia na otvorenie modálu hromadného vytvárania tímov (z sekcie #zoznam-timov)
        async function openTeamCreationModal() {
             console.log('DEBUG: openTeamCreationModal called.');
             if (!teamCreationModal) { console.error("FATAL ERROR: teamCreationModal not found!"); return; }
             if (!teamCreationForm) { console.error("FATAL ERROR: teamCreationForm not found!"); if (teamCreationModal) teamCreationModal.style.display = 'none'; return; }
             if (!teamCategoryCountContainer) { console.error("FATAL ERROR: teamCategoryCountContainer not found!"); if (teamCreationModal) teamCreationModal.style.display = 'none'; return; }


             // Reset formulára
             teamCreationForm.reset();
             // Vymaž všetky dynamicky pridané dvojice kategória/počet
             teamCategoryCountContainer.innerHTML = '';

             // Zabezpečiť, že kategórie sú načítané pred pridaním prvej dvojice
             if (allAvailableCategories.length === 0) {
                  await loadAllCategoriesForDynamicSelects(); // Načítaj kategórie ak ešte nie sú
             }

             // Pridaj prvú dvojicu kategória/počet automaticky
             await addCategoryCountPair(); // Táto funkcia volá updateDynamicCategorySelects()


             if (teamCreationModal) teamCreationModal.style.display = 'block';
             // Nastav focus na názov tímu
             setTimeout(() => {
                  if (teamNameInput) teamNameInput.focus();
             }, 50);
        }

        // Funkcia na otvorenie modálu správy jednotlivých tímov (v sekcii #zoznam-timov, kliknutím na základný názov)
        async function openManageTeamsModal(baseTeamName, categoryId) {
            console.log('DEBUG: openManageTeamsModal called for baseName:', baseTeamName, 'categoryId:', categoryId);
             if (!manageTeamsModal) { console.error("FATAL ERROR: manageTeamsModal not found!"); return; }
             if (!manageTeamsContent) { console.error("FATAL ERROR: manageTeamsContent not found!"); if (manageTeamsModal) manageTeamsModal.style.display = 'none'; return; }


            // Vyčisti obsah modálu
            manageTeamsContent.innerHTML = '<h3>Správa tímov: ' + baseTeamName + ' (' + categoryId + ')</h3>';
             const teamsListDiv = document.createElement('div'); // Kontajner pre zoznam tímov
             teamsListDiv.classList.add('manage-teams-list'); // Trieda pre štýlovanie


            try {
                 // Načítaj tímy, ktoré zodpovedajú základnému názvu a kategórii
                 // Predpokladáme, že "Základný názov" + "Suffix" tvorí celý názov tímu
                 // Toto je komplexné, ak nemáme v DB uložený aj "baseName" a "suffix" samostatne.
                 // Použijeme query na základe celého názvu a kategórie, alebo skúsime query podľa ID ak má formát "Kategória - Základný Názov [Suffix]"
                 // Najspoľahlivejšie je query podľa categoryId a pokúsiť sa filtrovať názvy na strane klienta, alebo mať baseName ako pole v DB.
                 // Ak ID dokumentu je "Kategória - Celý Názov", môžeme filtrovať podľa prefixu ID.
                 // Skúsme filtrovať podľa categoryId a názvu začínajúceho na baseTeamName.

                 const teamsQuery = query(clubsCollectionRef,
                      where('categoryId', '==', categoryId)
                      // Ak máme pole 'baseName' v DB, mohli by sme použiť:
                      // where('baseName', '==', baseTeamName)
                     // Ak nemáme baseName v DB, musíme načítať všetky v kategórii a filtrovať názov na strane klienta
                 );
                 const querySnapshot = await getDocs(teamsQuery);

                 if (querySnapshot.empty) {
                      teamsListDiv.textContent = 'Žiadne tímy nájdené pre toto zoskupenie.';
                       console.warn("No teams found for managing under baseName/category.");
                 } else {
                      const teams = querySnapshot.docs
                          .map(doc => ({ id: doc.id, ...doc.data() }))
                           // Filter na strane klienta podľa názvu začínajúceho na baseTeamName (ak nemáme baseName v DB)
                           .filter(team => (team.name || '').startsWith(baseTeamName));


                       if (teams.length === 0) {
                            teamsListDiv.textContent = 'Žiadne tímy nájdené s týmto základným názvom v kategórii.';
                             console.warn("No teams found after client-side filtering.");
                       } else {
                           console.log(`DEBUG: Found ${teams.length} teams for managing.`);
                            // Zoradiť tímy v rámci zoznamu (napr. podľa názvu/suffixu)
                            teams.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

                            const teamList = document.createElement('ul'); // Zoznam pre jednotlivé tímy
                             teamList.classList.add('manage-teams-ul');

                            teams.forEach(team => {
                                 const listItem = document.createElement('li');
                                  listItem.classList.add('manage-teams-li'); // Trieda pre štýlovanie

                                 const teamNameSpan = document.createElement('span');
                                  teamNameSpan.textContent = team.name || 'Bez názvu';
                                  listItem.appendChild(teamNameSpan);

                                 // Pridaj informáciu o priradení do skupiny a poradí
                                  const assignmentInfo = document.createElement('span');
                                  assignmentInfo.classList.add('assignment-info');
                                  assignmentInfo.textContent = team.groupId ? ` (Skupina: ${team.groupId}, Poradie: ${typeof team.orderInGroup === 'number' ? team.orderInGroup : '-'})` : ' (Nepriradený)';
                                  listItem.appendChild(assignmentInfo);


                                 // Pridaj tlačidlá akcií pre jednotlivé tímy
                                  const actionsDiv = document.createElement('div');
                                   actionsDiv.classList.add('manage-team-actions'); // Trieda pre tlačidlá

                                 // Tlačidlo Úprava (otvorí clubModal v edit móde)
                                  const editButton = document.createElement('button');
                                  editButton.textContent = 'Upraviť';
                                  editButton.addEventListener('click', () => {
                                       // Otvor modal na úpravu tohto konkrétneho tímu
                                       // team.id je document.id, team sú načítané dáta
                                       openClubModal(team.id, team);
                                        // Po otvorení iného modálu zatvoríme tento manageTeamsModal
                                        if (manageTeamsModal) manageTeamsModal.style.display = 'none';
                                  });
                                  actionsDiv.appendChild(editButton);

                                 // Tlačidlo Zmazať
                                  const deleteButton = document.createElement('button');
                                  deleteButton.textContent = 'Zmazať';
                                   deleteButton.classList.add('delete-button');
                                  deleteButton.addEventListener('click', async () => {
                                       if (confirm(`Naozaj chcete zmazať tím "${team.name}"?`)) {
                                            try {
                                                 await deleteDoc(doc(clubsCollectionRef, team.id));
                                                 alert('Tím úspešne zmazaný.');
                                                 // Po zmazaní obnov modály a tabuľky, ktoré sa mohli zmeniť
                                                 // Znovu načítať Manage Teams modal (ak zoskupenie stále existuje)
                                                  // Ak bol posledný tím v zoskupení, zoskupenie zmizne
                                                 // Najbezpečnejšie je zatvoriť tento modal a obnoviť hlavný zoznam
                                                  if (manageTeamsModal) manageTeamsModal.style.display = 'none';
                                                  displayCreatedTeams(); // Obnoví zoznam všetkých tímov
                                                  // Ak bol tím priradený, treba obnoviť aj tabuľku priradených tímov
                                                  if (team.groupId) {
                                                       if (window.location.hash === '#timy-do-skupin') {
                                                            displayClubs(); // Obnov tabuľku priradených, ak je viditeľná
                                                       }
                                                  }
                                                   // Ak bol nepriradený, treba obnoviť zoznam nepriradených v club modáli
                                                   if (!team.groupId) {
                                                        if (unassignedClubSelect) populateUnassignedClubsSelect(unassignedClubSelect, null);
                                                   }

                                            } catch (error) {
                                                 console.error('Chyba pri mazaní tímu: ', error);
                                                 alert('Chyba pri mazaní tímu.');
                                            }
                                       }
                                  });
                                   actionsDiv.appendChild(deleteButton);

                                  // Tlačidlo "Presunúť do nepriradených" (len ak je priradený)
                                   if (team.groupId) {
                                        const unassignButton = document.createElement('button');
                                        unassignButton.textContent = 'Nepriradiť';
                                         unassignButton.classList.add('unassign-button');
                                        unassignButton.addEventListener('click', async () => {
                                             if (confirm(`Naozaj chcete tím "${team.name}" odpriradiť zo skupiny "${team.groupId}"?`)) {
                                                  try {
                                                       await updateDoc(doc(clubsCollectionRef, team.id), {
                                                            groupId: null,
                                                            orderInGroup: null
                                                       });
                                                       alert('Tím úspešne odpriradený.');
                                                       // Po odpriradení obnov modály a tabuľky
                                                       // Znovu načítať Manage Teams modal (zobrazí tím ako nepriradený)
                                                        // openManageTeamsModal(baseTeamName, categoryId); // Mohlo by byť rekurzívne/zacykliť? Radšej len obnoviť hlavný zoznam
                                                        if (manageTeamsModal) manageTeamsModal.style.display = 'none'; // Zatvoriť tento modal
                                                        displayCreatedTeams(); // Obnoví zoznam všetkých tímov
                                                        // Ak bol tím priradený, treba obnoviť aj tabuľku priradených tímov
                                                        if (window.location.hash === '#timy-do-skupin') {
                                                             displayClubs(); // Obnov tabuľku priradených, ak je viditeľná
                                                        }
                                                        // Obnoviť zoznam nepriradených v club modáli
                                                        if (unassignedClubSelect) populateUnassignedClubsSelect(unassignedClubSelect, null);


                                                  } catch (error) {
                                                       console.error('Chyba pri odpriradení tímu: ', error);
                                                       alert('Chyba pri odpriradení tímu.');
                                                  }
                                             }
                                        });
                                        actionsDiv.appendChild(unassignButton);
                                   }

                                  listItem.appendChild(actionsDiv); // Pridaj div s tlačidlami do li
                                 teamList.appendChild(listItem); // Pridaj li do ul
                            });

                            teamsListDiv.appendChild(teamList); // Pridaj zoznam do kontajnera
                       }
                   }
            } catch (error) {
                 console.error('Chyba pri načítaní tímov na správu: ', error);
                 teamsListDiv.textContent = 'Chyba pri načítaní dát.';
            }


             manageTeamsContent.appendChild(teamsListDiv); // Pridaj kontajner zoznamu do modálu

             // Zobraz modál
             manageTeamsModal.style.display = 'block';
        }


        // --- Správa modálov (zatváranie) ---

        // Funkcia na zatvorenie modálu (spoločná)
         function closeModal(modal) {
              if (modal) {
                   modal.style.display = 'none';
                   // Optional: Reset form associated with the modal if needed
                   // if (modal.id === 'categoryModal' && categoryForm) categoryForm.reset();
                   // if (modal.id === 'groupModal' && groupForm) groupForm.reset();
                   // if (modal.id === 'clubModal' && clubForm) clubForm.reset(); // Form is reset in submit handler
                   // if (modal.id === 'teamCreationModal' && teamCreationForm) { teamCreationForm.reset(); teamCategoryCountContainer.innerHTML = ''; }
                   // if (modal.id === 'manageTeamsModal' && manageTeamsContent) manageTeamsContent.innerHTML = '';
              }
         }


        // Pridanie poslucháčov na zatváranie modálov
        if (categoryModalCloseBtn && categoryModal) { categoryModalCloseBtn.addEventListener('click', () => closeModal(categoryModal)); }
        if (groupModalCloseBtn && groupModal) { groupModalCloseBtn.addEventListener('click', () => closeModal(groupModal)); }
        if (clubModalCloseBtn && clubModal) { clubModalCloseBtn.addEventListener('click', () => closeModal(clubModal)); }
        if (teamCreationModalCloseBtn && teamCreationModal) { teamCreationModalCloseBtn.addEventListener('click', () => closeModal(teamCreationModal)); }
        if (manageTeamsModalCloseBtn && manageTeamsModal) { manageTeamsModalCloseBtn.addEventListener('click', () => closeModal(manageTeamsModal)); }


        // Zatvorenie modálu kliknutím mimo neho (spoločné pre všetky modály s triedou .modal)
        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target);
            }
        });


        // --- Event Listeners pre tlačidlá a formuláre ---

        // Listener pre tlačidlo "+" v rôznych sekciách (použije sa class="add-button")
        const addButton = document.querySelector('.add-button');
        if (addButton) {
            addButton.addEventListener('click', () => {
                const currentHash = window.location.hash;
                if (currentHash === '#kategorie') {
                    openCategoryModal();
                } else if (currentHash === '#skupiny') {
                    openGroupModal();
                } else if (currentHash === '#timy-do-skupin') {
                     // Otvoriť club modal v režime priradenia (Add/Assign)
                     openClubModal(); // Volá sa bez argumentov pre režim priradenia
                } else if (currentHash === '#zoznam-timov') {
                     // Otvoriť modal na vytváranie tímov
                     openTeamCreationModal();
                }
                // Pridaj ďalšie podmienky pre iné sekcie
            });
        } else { console.error("Add button not found!"); }


        // --- Event Listener pre zmenu kategórie v modáli klubu ---
             if (clubCategorySelect) {
                console.log("Attaching clubCategorySelect change listener");
                clubCategorySelect.addEventListener('change', async () => {
                     console.log("clubCategorySelect change event fired");
                    const selectedCategoryId = clubCategorySelect.value;

                    // Reset order input when category changes (applies to both add-assign and edit)
                     if (orderInGroupInput) orderInGroupInput.value = '';
                     if (orderInputContainer) orderInputContainer.style.display = 'none'; // Skryjeme poradie kým sa nevyberie skupina
                     if (orderInGroupInput) orderInGroupInput.required = false; // Poradie nie je povinné

                    // Populate the group select based on the newly selected category
                     // Len ak je vybraná platná kategória a select skupín je viditeľný
                     if (selectedCategoryId && selectedCategoryId !== '' && selectedCategoryId !== '-- Vyberte kategóriu --' &&
                         clubGroupSelect && clubGroupSelect.parentElement && clubGroupSelect.parentElement.style.display !== 'none') {

                           clubGroupSelect.disabled = true; // Zablokuj select skupín počas načítania
                           await populateGroupSelect(selectedCategoryId, clubGroupSelect); // Pass category ID and select element
                           clubGroupSelect.disabled = false; // Povol select skupín po načítaní

                           // Ak po naplnení nie sú v kategórii žiadne skupiny, zablokuj ho úplne a zobraz správu
                           if (clubGroupSelect.options.length <= 1) { // Contains only the placeholder option
                                clubGroupSelect.disabled = true;
                                clubGroupSelect.innerHTML = '<option value="">-- Žiadne skupiny v kategórii --</option>';
                                console.warn(`No groups found for category: ${selectedCategoryId}`);
                           }

                     } else {
                          // Ak sa vybrala neplatná kategória (placeholder) alebo select skupín nie je viditeľný,
                          // vyprázdnime a zablokujeme select skupín
                           if (clubGroupSelect) {
                                clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>'; // Reset na počiatočný stav
                                clubGroupSelect.disabled = true;
                           }
                     }
                });
            } else { console.error("Club category select not found!"); }


             // Event listener pre zmenu skupiny v modáli klubu - manažuje pole poradia
             if (clubGroupSelect) {
                 console.log("Attaching clubGroupSelect change listener");
                 clubGroupSelect.addEventListener('change', () => {
                      console.log("clubGroupSelect change event fired");
                      const selectedGroupId = clubGroupSelect.value;
                      // Show/hide order input and set required based on whether a group is selected
                      if (selectedGroupId && selectedGroupId !== '' && selectedGroupId !== '-- Vyberte skupinu --' && selectedGroupId !== '-- Žiadne skupiny v kategórii --') {
                           if (orderInputContainer) orderInputContainer.style.display = 'block';
                           if (orderInGroupInput) orderInGroupInput.required = true; // Order is required when a group is selected
                           // Automaticky nastavíme focus na pole poradia po výbere skupiny
                            if (orderInGroupInput) orderInGroupInput.focus();
                      } else {
                           if (orderInputContainer) orderInputContainer.style.display = 'none';
                           if (orderInGroupInput) orderInGroupInput.required = false;
                           if (orderInGroupInput) orderInGroupInput.value = ''; // Clear value when group is deselected
                      }
                 });
             } else { console.error("Club group select not found!"); }


             // Event listener pre zmenu nepriradeného tímu (Vyberte existujúci tím)
             if (unassignedClubSelect) {
                 console.log("Attaching unassignedClubSelect change listener");
                 unassignedClubSelect.addEventListener('change', async () => {
                      console.log("unassignedClubSelect change event fired");
                      const selectedClubId = unassignedClubSelect.value;

                      // === LOGIKA PO VÝBERE NEPRIRADENÉHO TÍMU ===
                      if (currentClubModalMode === 'add-assign' && selectedClubId && selectedClubId !== '-- Vyberte tím na priradenie --') {
                           try {
                               const clubDoc = await getDoc(doc(clubsCollectionRef, selectedClubId));
                               if (clubDoc.exists()) {
                                   const clubData = clubDoc.data();
                                   if (clubCategorySelect) {
                                       // Povolíme category select a nastavíme hodnotu
                                        clubCategorySelect.disabled = false; // !!! Povoliť category select po výbere tímu !!!
                                        clubCategorySelect.value = clubData.categoryId || '';
                                        console.log("unassignedClubSelect change: Nastavená hodnota clubCategorySelect na:", clubCategorySelect.value);

                                        // Spustíme change udalosť na clubCategorySelect, aby sa spustil jeho poslucháč a naplnil skupiny
                                        const event = new Event('change');
                                        clubCategorySelect.dispatchEvent(event);
                                        console.log("unassignedClubSelect change: Spustený dispatchEvent na clubCategorySelect");

                                        // Nastavíme focus na select skupiny (ak je povolený po naplnení)
                                         setTimeout(() => {
                                              if (clubGroupSelect && clubGroupSelect.parentElement && clubGroupSelect.parentElement.style.display !== 'none' && !clubGroupSelect.disabled) {
                                                   clubGroupSelect.focus();
                                              } // Ak nie je skupina, focus zostane na category selecte alebo pôjde na ďalšie pole
                                         }, 0);


                                   } else { console.error("clubCategorySelect not found after selecting unassigned club."); }

                               } else {
                                    console.warn(`Vybraný nepriradený tím ${selectedClubId} už neexistuje.`);
                                    // Reset selects if the selected team is no longer found
                                    unassignedClubSelect.value = "";
                                    // Zablokovať a resetovať category select
                                    if (clubCategorySelect) { clubCategorySelect.disabled = true; clubCategorySelect.value = ""; } // !!! Zablokovať a resetovať !!!
                                     // Spustíme change event na kategórii, aby sa resetovali skupiny a poradie
                                     const event = new Event('change');
                                     if (clubCategorySelect) clubCategorySelect.dispatchEvent(event);
                                }
                            } catch (error) {
                               console.error('Chyba pri načítaní detailov vybraného nepriradeného tímu:', error);
                               alert('Chyba pri načítaní detailov tímu.');
                               unassignedClubSelect.value = "";
                               // Zablokovať a resetovať category select aj pri chybe
                               if (clubCategorySelect) { clubCategorySelect.disabled = true; clubCategorySelect.value = ""; } // !!! Zablokovať a resetovať !!!
                                // Spustíme change event na kategórii aj pri chybe
                                 const event = new Event('change');
                                 if (clubCategorySelect) clubCategorySelect.dispatchEvent(event);
                            }
                       } else if (currentClubModalMode === 'add-assign' && (!selectedClubId || selectedClubId === '-- Vyberte tím na priradenie --')) {
                           console.log("Unassigned club select reset or placeholder selected.");
                           // Ak sa vybral placeholder, zablokovať a resetovať category select
                           if (clubCategorySelect) { clubCategorySelect.disabled = true; clubCategorySelect.value = ""; } // !!! Zablokovať a resetovať !!!
                            // Spustíme change event na kategórii, aby sa resetovali skupiny a poradie
                            const event = new Event('change');
                            if (clubCategorySelect) clubCategorySelect.dispatchEvent(event);
                       }
                 });
             } else { console.error("Unassigned club select not found!"); }


            // --- Obsluha formulára Kluby (clubForm submit) ---
            if (clubForm) {
                clubForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log("DEBUG: clubForm submit event fired."); // Log

                    const selectedCategoryId = clubCategorySelect.value;
                    const selectedGroupId = (clubGroupSelect && !clubGroupSelect.disabled && clubGroupSelect.value !== '' && clubGroupSelect.value !== '-- Vyberte skupinu --' && clubGroupSelect.value !== '-- Žiadne skupiny v kategórii --') ? clubGroupSelect.value : null;
                    const orderInGroupValue = parseInt(orderInGroupInput && orderInGroupInput.value, 10);
                     const orderInGroup = (selectedGroupId !== null && orderInputContainer && orderInputContainer.style.display !== 'none' && orderInGroupInput && orderInGroupInput.value.trim() !== '' && !isNaN(orderInGroupValue) && orderInGroupValue >= 1) ? orderInGroupValue : null;


                    // Validate selects based on mode and visibility
                    // Kategória je povinná len ak nie je zablokovaná
                    if (clubCategorySelect && !clubCategorySelect.disabled && (selectedCategoryId === '' || selectedCategoryId === '-- Vyberte kategóriu --')) {
                        alert('Prosím, vyberte platnú kategóriu.');
                        console.log("DEBUG: Validation failed: Invalid category.");
                        return;
                    }
                     // Skupina je povinná len ak je select skupiny viditeľný a povolený
                    if (clubGroupSelect && clubGroupSelect.parentElement && clubGroupSelect.parentElement.style.display !== 'none' && clubGroupSelect.disabled === false && selectedGroupId === null) {
                         alert('Prosím, vyberte platnú skupinu.');
                         console.log("DEBUG: Validation failed: Invalid group.");
                         return;
                     }
                    // Poradie je povinné len ak je pole poradia viditeľné
                     if (orderInputContainer && orderInputContainer.style.display !== 'none' && orderInGroup === null) {
                          alert('Prosím, zadajte platné poradové číslo väčšie ako 0.');
                          console.log("DEBUG: Validation failed: Invalid order.");
                          return;
                     }

                     // Dodatočná kontrola: V add-assign móde musí byť vybraný aj tím na priradenie
                     if (currentClubModalMode === 'add-assign') {
                         const selectedUnassignedClubId = unassignedClubSelect && unassignedClubSelect.value;
                         if (!selectedUnassignedClubId || selectedUnassignedClubId === '-- Vyberte tím na priradenie --') {
                             alert('Prosím, vyberte tím na priradenie.');
                             console.log("DEBUG: Validation failed: No unassigned team selected in add-assign mode.");
                             return;
                         }
                          // V add-assign móde musia byť vybrané aj kategória a skupina (už ošetrené vyššie, ale pre istotu)
                          if (selectedCategoryId === '' || selectedGroupId === null) {
                               // Táto kontrola by sa nemala spustiť, ak predošlé prešli, ale pre istotu
                               alert('Prosím, vyberte kategóriu aj skupinu pre priradenie.');
                               console.log("DEBUG: Validation failed: Category or group missing in add-assign mode.");
                               return;
                          }
                     }


                    try {
                         console.log("DEBUG: Validation successful. Proceeding with submit logic.");
                        if (currentClubModalMode === 'add-assign') {
                            // === LOGIKA PRIRADENIA TÍMU DO SKUPINY ===
                             const selectedUnassignedClubId = unassignedClubSelect.value; // Už vieme, že nie je placeholder

                            const clubRefToAssign = doc(clubsCollectionRef, selectedUnassignedClubId);
                            const clubDocToAssign = await getDoc(clubRefToAssign);

                            if (!clubDocToAssign.exists()) { alert('Vybraný tím nebol nájdený alebo už bol priradený/zmazaný.'); console.log("DEBUG: Team to assign not found."); if (unassignedClubSelect) populateUnassignedClubsSelect(unassignedClubSelect, null); if (clubModal) closeModal(clubModal); if (clubForm) clubForm.reset(); currentClubModalMode = 'add-assign'; editingClubId = null; if (unassignedClubSelectContainer) unassignedClubSelectContainer.style.display = 'block'; if (clubNameInputContainer) clubNameInputContainer.style.display = 'none'; if (clubCategorySelect) { clubCategorySelect.disabled = true; clubCategorySelect.value = ''; } if (clubGroupSelect && clubGroupSelect.parentElement) clubGroupSelect.parentElement.style.display = 'block'; if (clubGroupSelect) { clubGroupSelect.disabled = true; clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>'; } if (orderInputContainer) orderInputContainer.style.display = 'none'; if (orderInGroupInput) orderInGroupInput.required = false; return; }
                            const clubDataToAssign = clubDocToAssign.data();

                            if (clubDataToAssign.groupId !== null) { alert(`Tím "${clubDataToAssign.name}" je už priradený do skupiny "${clubDataToAssign.groupId}".`); console.log("DEBUG: Team already assigned."); if (unassignedClubSelect) populateUnassignedClubsSelect(unassignedClubSelect, null); if (clubModal) closeModal(clubModal); if (clubForm) clubForm.reset(); currentClubModalMode = 'add-assign'; editingClubId = null; if (unassignedClubSelectContainer) unassignedClubSelectContainer.style.display = 'block'; if (clubNameInputContainer) clubNameInputContainer.style.display = 'none'; if (clubCategorySelect) { clubCategorySelect.disabled = true; clubCategorySelect.value = ''; } if (clubGroupSelect && clubGroupSelect.parentElement) clubGroupSelect.parentElement.style.display = 'block'; if (clubGroupSelect) { clubGroupSelect.disabled = true; clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>'; } if (orderInputContainer) orderInputContainer.style.display = 'none'; if (orderInGroupInput) orderInGroupInput.required = false; return; }

                            // --- DEFINÍCIA NOVÝCH DÁT A NOVÉHO CIEĽOVÉHO ID ---
                            const newCategoryId = selectedCategoryId;
                            const newName = clubDataToAssign.name;
                            const newGroupId = selectedGroupId;
                            const newOrderInGroup = orderInGroup;

                             const newDocumentId = `${newCategoryId} - ${newName}`;
                             const newClubDocRef = doc(clubsCollectionRef, newDocumentId);

                             // --- KONTROLA DUPLICITNÉHO PORADIA V CIEĽOVEJ SKUPINE ---
                            if (newGroupId !== null && newOrderInGroup !== null) {
                                 const targetDocSnapshotForOrderCheck = await getDoc(newClubDocRef);
                                  const existingOrderQuery = query(clubsCollectionRef, where('groupId', '==', newGroupId), where('orderInGroup', '==', newOrderInGroup), ...(targetDocSnapshotForOrderCheck.exists() ? [where('__name__', '!=', newDocumentId)] : []));
                                  const existingOrderSnapshot = await getDocs(existingOrderQuery);
                                  if (!existingOrderSnapshot.empty) { alert(`Tím s poradovým číslom "${newOrderInGroup}" už v skupine "${newGroupId}" existuje! Prosím, zvoľte iné poradové číslo.`); console.log("DEBUG: Duplicate order found in target group."); return; }
                            }

                            // --- Vykonať BATCH operácie (mazanie starého, vytváranie/prepísanie nového) ---
                             console.log("DEBUG: Starting batch write: delete old, set new.");
                            const batch = writeBatch(db);
                            batch.delete(clubRefToAssign);
                            batch.set(newClubDocRef, {
                                name: newName,
                                categoryId: newCategoryId,
                                groupId: newGroupId,
                                orderInGroup: newOrderInGroup
                            });

                            await batch.commit();
                            console.log("DEBUG: Batch commit successful.");

                            alert(`Tím "${newName}" úspešne priradený.`);


                        } else if (currentClubModalMode === 'edit') {
                            // === LOGIKA ÚPRAVY EXISTUJÚCEHO KLUBU ===
                             console.log("DEBUG: Edit mode logic.");

                            const clubIdToEdit = editingClubId;
                            const updatedClubName = clubNameInput && clubNameInput.value.trim();
                             const updatedCategoryId = selectedCategoryId;
                            const updatedGroupId = selectedGroupId;
                            const updatedOrderInGroup = orderInGroup;


                            if (!clubIdToEdit) { console.error("Chyba: Režim úpravy klubu bez platného editingClubId."); alert("Chyba pri úprave klubu. Prosím, obnovte stránku."); if (clubModal) closeModal(clubModal); if (clubForm) clubForm.reset(); currentClubModalMode = 'add-assign'; editingClubId = null; if (unassignedClubSelectContainer) unassignedClubSelectContainer.style.display = 'block'; if (clubNameInputContainer) clubNameInputContainer.style.display = 'none'; if (clubCategorySelect) { clubCategorySelect.disabled = true; clubCategorySelect.value = ''; } if (clubGroupSelect && clubGroupSelect.parentElement) clubGroupSelect.parentElement.style.display = 'block'; if (clubGroupSelect) { clubGroupSelect.disabled = true; clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>'; } if (orderInputContainer) orderInputContainer.style.display = 'none'; if (orderInGroupInput) orderInGroupInput.required = false;} return; }
                             if (clubNameInputContainer.style.display !== 'none' && (!updatedClubName || updatedClubName === '')) { alert('Názov klubu nemôže byť prázdny.'); console.log("DEBUG: Validation failed: Name is empty in edit mode."); return; }

                            const clubRefToEdit = doc(clubsCollectionRef, clubIdToEdit);
                            const clubDocToEdit = await getDoc(clubRefToEdit);
                            if (!clubDocToEdit.exists()) { console.error(`Chyba: Dokument klubu ${clubIdToEdit} nenájdent na úpravu.`); alert("Klub na úpravu nebol nájdený."); console.log("DEBUG: Team to edit not found."); if (clubModal) closeModal(clubModal); if (clubForm) clubForm.reset(); currentClubModalMode = 'add-assign'; editingClubId = null; displayClubs(); displayCreatedTeams(); if (unassignedClubSelectContainer) unassignedClubSelectContainer.style.display = 'block'; if (clubNameInputContainer) clubNameInputContainer.style.display = 'none'; if (clubCategorySelect) { clubCategorySelect.disabled = true; clubCategorySelect.value = ''; } if (clubGroupSelect && clubGroupSelect.parentElement) clubGroupSelect.parentElement.style.display = 'block'; if (clubGroupSelect) { clubGroupSelect.disabled = true; clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>'; } if (orderInputContainer) orderInputContainer.style.display = 'none'; if (orderInGroupInput) orderInGroupInput.required = false;} return; }
                            const originalClubData = clubDocToEdit.data();


                            // === Podmienené kontroly duplicity pre režim úpravy ===
                            const nameHasChanged = updatedClubName !== originalClubData.name;
                            const groupHasChanged = updatedGroupId !== (originalClubData.groupId || null);
                            const orderHasChanged = updatedOrderInGroup !== (typeof originalClubData.orderInGroup === 'number' ? originalClubData.orderInGroup : null);


                            if (updatedGroupId !== null) { // Ak sa upravuje v skupine alebo sa presúva DO skupiny
                                 if (nameHasChanged || groupHasChanged) {
                                      const existingClubInTargetGroupQuery = query(clubsCollectionRef, where('groupId', '==', updatedGroupId), where('name', '==', updatedClubName), where('__name__', '!=', clubIdToEdit));
                                      const existingClubInTargetGroupSnapshot = await getDocs(existingClubInTargetGroupQuery);
                                      if (!existingClubInTargetGroupSnapshot.empty) { alert(`Klub s názvom "${updatedClubName}" už v cieľovej skupine "${updatedGroupId}" existuje! Prosím, zvoľte iný názov alebo skupinu.`); console.log("DEBUG: Duplicate name found in target group during edit."); return; }
                                 }
                                if (updatedGroupId !== null && updatedOrderInGroup !== null) { // Kontroluj poradie len ak je skupina zadaná a poradie zadané
                                      if (orderHasChanged || groupHasChanged) { // Kontroluj ak sa zmenilo poradie ALEBO skupina
                                           const existingOrderQuery = query(clubsCollectionRef, where('groupId', '==', updatedGroupId), where('orderInGroup', '==', updatedOrderInGroup), where('__name__', '!=', clubIdToEdit));
                                           const existingOrderSnapshot = await getDocs(existingOrderQuery);
                                           if (!existingOrderSnapshot.empty) { alert(`Tím s poradovým číslom "${updatedOrderInGroup}" už v skupine "${updatedGroupId}" existuje! Prosím, zvoľte iné poradové číslo.`); console.log("DEBUG: Duplicate order found in target group during edit."); return; }
                                      }
                                 }

                             } else { // Ak sa upravuje NEPRIRADENÝ tím alebo sa presúva Z skupiny (updatedGroupId === null)
                                  // Ak sa mení názov nepriradeného tímu, skontroluj duplicity medzi ostatnými nepriradenými
                                  if (nameHasChanged && (originalClubData.groupId === null || originalClubData.groupId === undefined)) {
                                      const existingUnassignedClubQuery = query(clubsCollectionRef, where('groupId', '==', null), where('name', '==', updatedClubName), where('__name__', '!=', clubIdToEdit));
                                      const existingUnassignedClubSnapshot = await getDocs(existingUnassignedClubQuery);
                                      if (!existingUnassignedClubSnapshot.empty) { alert(`Iný nepriradený klub s názvom "${updatedClubName}" už existuje!`); console.log("DEBUG: Duplicate name found among unassigned during edit."); return; }
                                  }
                               }


                             console.log(`DEBUG: Updating club document: ${clubIdToEdit}`);
                             await updateDoc(clubRefToEdit, {
                                  name: updatedClubName,
                                 categoryId: updatedCategoryId,
                                 groupId: updatedGroupId,
                                  orderInGroup: updatedGroupId !== null ? updatedOrderInGroup : null
                             });

                             console.log(`SUCCESS: Klub "${updatedClubName}" (ID: ${clubIdToEdit}) úspešne upravený.`);
                             alert(`Klub úspešne upravený.`);

                         }

                         // --- Spoločná logika po úspechu ---
                         console.log("DEBUG: Common success logic started.");
                         if (clubModal) closeModal(clubModal); // Použiť funkciu closeModal
                         if (clubForm) clubForm.reset();
                         currentClubModalMode = 'add-assign';
                         editingClubId = null;

                         // Reset visibility a disabled states pre ďalšie otvorenie
                          if (unassignedClubSelectContainer) unassignedClubSelectContainer.style.display = 'block';
                          if (clubNameInputContainer) clubNameInputContainer.style.display = 'none';
                          if (clubCategorySelect) { clubCategorySelect.disabled = true; clubCategorySelect.value = ''; } // Zablokovať a resetovať kategórie
                          if (clubGroupSelect && clubGroupSelect.parentElement) clubGroupSelect.parentElement.style.display = 'block';
                          if (clubGroupSelect) { clubGroupSelect.disabled = true; clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>'; } // Zablokovať a resetovať skupiny
                          if (orderInputContainer) orderInputContainer.style.display = 'none';
                          if (orderInGroupInput) orderInGroupInput.required = false;


                         // Refresh displays that might be affected
                         // !!! ODSTRÁNENÉ EXPLICITNÉ VOLANIA displayCreatedTeams a displayClubs !!!
                         // Spoliehame sa na to, že toggleContentDisplay (spustený hashchange listenerom alebo inak)
                         // sa postará o zobrazenie správnej sekcie a volanie jej display funkcie.
                         // displayCreatedTeams();
                         // if (window.location.hash === '#timy-do-skupin') {
                         //      displayClubs();
                         // }
                         // -------------------------------------------------------------------

                          // Obnovíme len zoznam nepriradených tímov, ak je to relevantné
                           if (unassignedClubSelect) {
                               console.log("DEBUG: Calling populateUnassignedClubsSelect after submit success.");
                               populateUnassignedClubsSelect(unassignedClubSelect, null); // Obnoví zoznam nepriradených
                           }

                         console.log("DEBUG: Submit success handler finished. Check console for subsequent display calls from toggleContentDisplay."); // Final log in handler


                     } catch (error) {
                         console.error('Chyba pri ukladaní alebo priradzovaní klubu: ', error);
                         alert(`Chyba pri ukladaní alebo priradzovaní klubu! Detail: ${error.message}`);
                          // Zatvor modál a resetuj stav pri chybe
                          if (clubModal) closeModal(clubModal); // Použiť funkciu closeModal
                          if (clubForm) clubForm.reset();
                          currentClubModalMode = 'add-assign'; editingClubId = null;
                           // Reset visibility a disabled states pri chybe
                          if (unassignedClubSelectContainer) unassignedClubSelectContainer.style.display = 'block';
                          if (clubNameInputContainer) clubNameInputContainer.style.display = 'none';
                           if (clubCategorySelect) { clubCategorySelect.disabled = true; clubCategorySelect.value = ''; }
                          if (clubGroupSelect && clubGroupSelect.parentElement) clubGroupSelect.parentElement.style.display = 'block';
                           if (clubGroupSelect) { clubGroupSelect.disabled = true; clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>'; }
                           if (orderInputContainer) orderInputContainer.style.display = 'none';
                          if (orderInGroupInput) orderInGroupInput.required = false;
                          console.log("DEBUG: Submit error handler finished.");
                     }
                });
            } else { console.error("Club form not found!"); }


        // --- Event Listener pre formulár kategórií ---
        if (categoryForm) {
            categoryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                 console.log("DEBUG: categoryForm submit event fired."); // Log

                const categoryName = categoryNameInput.value.trim();
                if (!categoryName) {
                    alert('Názov kategórie nemôže byť prázdny.');
                     console.log("DEBUG: Validation failed: Category name is empty.");
                    return;
                }

                try {
                    if (currentCategoryModalMode === 'add') {
                        // Režim pridania
                        const categoryRef = doc(categoriesCollectionRef, categoryName); // ID dokumentu je názov kategórie

                        // Kontrola, či kategória už existuje (dokument s daným ID)
                        const docSnap = await getDoc(categoryRef);
                        if (docSnap.exists()) {
                            alert(`Kategória s názvom "${categoryName}" už existuje!`);
                             console.log("DEBUG: Validation failed: Category already exists.");
                            return;
                        }

                        // Pridanie novej kategórie
                        await setDoc(categoryRef, {
                            name: categoryName // Môžeme uložiť názov aj v poli, aj keď ID je to isté
                            // Prípadné ďalšie polia pre kategóriu
                        });

                        alert(`Kategória "${categoryName}" úspešne pridaná.`);
                         console.log("DEBUG: Category added successfully.");

                    } else if (currentCategoryModalMode === 'edit') {
                        // Režim úpravy (premenovanie kategórie)
                        const oldCategoryId = editingCategoryId;
                        const newCategoryId = categoryName; // Nový názov = nové ID

                        if (oldCategoryId === newCategoryId) {
                             alert('Názov kategórie nebol zmenený.');
                              console.log("DEBUG: Edit skipped: Name is the same.");
                             if (categoryModal) closeModal(categoryModal); // Zavrieť modál ak sa nič nezmenilo
                             if (categoryForm) categoryForm.reset();
                             currentCategoryModalMode = 'add'; editingCategoryId = null;
                             return;
                        }

                        // Kontrola, či nová kategória už existuje
                        const newCategoryRef = doc(categoriesCollectionRef, newCategoryId);
                        const newDocSnap = await getDoc(newCategoryRef);
                        if (newDocSnap.exists()) {
                             alert(`Kategória s novým názvom "${newCategoryId}" už existuje!`);
                              console.log("DEBUG: Validation failed: New category name already exists.");
                            return;
                        }

                        // Získanie dát starej kategórie
                         const oldCategoryRef = doc(categoriesCollectionRef, oldCategoryId);
                         const oldDocSnap = await getDoc(oldCategoryRef);
                         if (!oldDocSnap.exists()) {
                              console.error(`Chyba: Stará kategória ${oldCategoryId} nenájdená pri premenovaní.`);
                              alert('Chyba pri premenovaní kategórie: Pôvodná kategória nebola nájdená.');
                               if (categoryModal) closeModal(categoryModal); // Zavrieť modál
                               if (categoryForm) categoryForm.reset();
                               currentCategoryModalMode = 'add'; editingCategoryId = null;
                               loadCategoriesTable(); // Obnoviť tabuľku
                              return;
                         }
                         const oldCategoryData = oldDocSnap.data();


                        // === Vykonanie BATCH operácie pre premenovanie ===
                        // Premenovanie kategórie = zmazanie starého dokumentu, vytvorenie nového s novým ID,
                        // a AKTUALIZÁCIA categoryId vo VŠETKÝCH skupinách a kluboch patriacich pod starú kategóriu.
                        console.log(`DEBUG: Starting batch write for renaming category "${oldCategoryId}" to "${newCategoryId}".`);
                        const batch = writeBatch(db);

                        // 1. Zmazať starý dokument kategórie
                        batch.delete(oldCategoryRef);
                        console.log(`DEBUG: Batch: Old category document (ID: ${oldCategoryId}) marked for deletion.`);


                        // 2. Vytvoriť nový dokument kategórie s novým ID a pôvodnými dátami
                         batch.set(newCategoryRef, {
                              name: newCategoryId, // Nový názov = nové ID
                             // Preniesť ostatné dáta zo starej kategórie, ak existujú
                             ...oldCategoryData
                         });
                         console.log(`DEBUG: Batch: New category document (ID: ${newCategoryId}) marked for creation.`);


                        // 3. Aktualizovať categoryId vo VŠETKÝCH skupinách, ktoré mali starú kategóriu
                         const groupsToUpdateQuery = query(groupsCollectionRef, where('categoryId', '==', oldCategoryId));
                         const groupsSnapshot = await getDocs(groupsToUpdateQuery);
                         groupsSnapshot.docs.forEach(groupDoc => {
                              const groupRef = doc(groupsCollectionRef, groupDoc.id);
                              batch.update(groupRef, { categoryId: newCategoryId });
                              console.log(`DEBUG: Batch: Updating categoryId for group "${groupDoc.id}" to "${newCategoryId}".`);
                         });


                        // 4. Aktualizovať categoryId vo VŠETKÝCH kluboch, ktoré mali starú kategóriu
                         const clubsToUpdateQuery = query(clubsCollectionRef, where('categoryId', '==', oldCategoryId));
                         const clubsSnapshot = await getDocs(clubsToUpdateQuery);
                         clubsSnapshot.docs.forEach(clubDoc => {
                              const clubRef = doc(clubsCollectionRef, clubDoc.id);
                              batch.update(clubRef, { categoryId: newCategoryId });
                              console.log(`DEBUG: Batch: Updating categoryId for club "${clubDoc.id}" to "${newCategoryId}".`);
                         });

                        await batch.commit();
                        console.log("DEBUG: Batch commit successful for category rename.");

                        alert(`Kategória úspešne premenovaná na "${newCategoryId}".`);
                         console.log("DEBUG: Category renamed successfully.");

                    }

                     // Spoločná logika po úspešnom pridaní/úprave kategórie
                    if (categoryModal) closeModal(categoryModal); // Použiť funkciu closeModal
                    if (categoryForm) categoryForm.reset();
                    currentCategoryModalMode = 'add'; editingCategoryId = null;

                    // Refresh tabuľku kategórií (v sekcii #kategorie)
                     console.log("DEBUG: Calling loadCategoriesTable after category submit success."); // Log
                    loadCategoriesTable(); // Toto volá display, ktorý zobrazuje #kategorie
                    // Aktualizovať selectboxy kategórií vo VŠETKÝCH modáloch a sekciách, kde sa používajú
                    loadAllCategoriesForDynamicSelects(); // Pre modál vytvárania tímov
                     // Pre ostatné modály sa kategórie načítajú pri ich otvorení (populateCategorySelect)
                } catch (error) {
                    console.error('Chyba pri ukladaní kategórie: ', error);
                    alert(`Chyba pri ukladaní kategórie! Detail: ${error.message}`);
                     console.log("DEBUG: Category submit error handler finished.");
                }
            });
        } else { console.error("Category form not found!"); }


        // --- Event Listener pre formulár skupín ---
        if (groupForm) {
            groupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                 console.log("DEBUG: groupForm submit event fired."); // Log

                const groupName = groupNameInput.value.trim();
                const categoryId = groupCategorySelect.value;

                // Validácia
                if (!groupName) { alert('Názov skupiny nemôže byť prázdny.'); console.log("DEBUG: Validation failed: Group name is empty."); return; }
                if (!categoryId) { alert('Prosím, vyberte kategóriu.'); console.log("DEBUG: Validation failed: Category not selected."); return; }

                // ID dokumentu skupiny bude kombinácia kategórie a názvu
                const groupId = `${categoryId} - ${groupName}`; // Napr. "U12 - Skupina A"

                try {
                    if (currentGroupModalMode === 'add') {
                        // Režim pridania
                        const groupRef = doc(groupsCollectionRef, groupId); // ID dokumentu je kombinácia kategórie a názvu

                        // Kontrola, či skupina s daným ID už existuje
                        const docSnap = await getDoc(groupRef);
                        if (docSnap.exists()) {
                             alert(`Skupina s názvom "${groupName}" v kategórii "${categoryId}" už existuje!`);
                             console.log("DEBUG: Validation failed: Group already exists.");
                            return;
                        }

                        // Pridanie novej skupiny
                        await setDoc(groupRef, {
                            name: groupName, // Môžeme uložiť názov skupiny samostatne
                            categoryId: categoryId // Uložíme aj ID kategórie pre filtrovanie
                            // Prípadné ďalšie polia pre skupinu
                        });

                        alert(`Skupina "${groupName}" v kategórii "${categoryId}" úspešne pridaná.`);
                         console.log("DEBUG: Group added successfully.");

                    } else if (currentGroupModalMode === 'edit') {
                        // Režim úpravy (premenovanie skupiny)
                        // Premenovanie skupiny je možné len v rámci tej istej kategórie (category select je v edit móde disabled)
                        const oldGroupId = editingGroupId; // ID starého dokumentu skupiny
                        const newGroupName = groupName; // Nový názov skupiny
                        const currentCategoryId = groupCategorySelect.value; // Kategória (nemala by sa dať zmeniť)

                        // Nové ID dokumentu skupiny
                        const newGroupId = `${currentCategoryId} - ${newGroupName}`;

                        if (oldGroupId === newGroupId) {
                             alert('Názov skupiny nebol zmenený.');
                             console.log("DEBUG: Edit skipped: Group name is the same.");
                             if (groupModal) closeModal(groupModal); // Zavrieť modál ak sa nič nezmenilo
                             if (groupForm) groupForm.reset();
                             currentGroupModalMode = 'add'; editingGroupId = null;
                            return;
                        }

                         // Kontrola, či skupina s novým ID už existuje
                         const newGroupRef = doc(groupsCollectionRef, newGroupId);
                         const newDocSnap = await getDoc(newGroupRef);
                         if (newDocSnap.exists()) {
                             alert(`Skupina s novým názvom "${newGroupName}" v kategórii "${currentCategoryId}" už existuje!`);
                             console.log("DEBUG: Validation failed: New group name already exists.");
                             return;
                         }

                         // Získanie dát starej skupiny
                          const oldGroupRef = doc(groupsCollectionRef, oldGroupId);
                          const oldDocSnap = await getDoc(oldGroupRef);
                           if (!oldDocSnap.exists()) {
                                console.error(`Chyba: Stará skupina ${oldGroupId} nenájdená pri premenovaní.`);
                                alert('Chyba pri premenovaní skupiny: Pôvodná skupina nebola nájdená.');
                                 if (groupModal) closeModal(groupModal);
                                 if (groupForm) groupForm.reset();
                                currentGroupModalMode = 'add'; editingGroupId = null;
                                 // loadGroupsForCategory(currentCategoryId); // Obnoviť zobrazenie skupín
                                return;
                           }
                           const oldGroupData = oldDocSnap.data();


                        // === Vykonanie BATCH operácie pre premenovanie skupiny ===
                        // Premenovanie skupiny = zmazanie starého dokumentu, vytvorenie nového s novým ID,
                        // a AKTUALIZÁCIA groupId vo VŠETKÝCH kluboch patriacich pod starú skupinu.
                        console.log(`DEBUG: Starting batch write for renaming group "${oldGroupId}" to "${newGroupId}".`);
                        const batch = writeBatch(db);

                        // 1. Zmazať starý dokument skupiny
                        batch.delete(oldGroupRef);
                         console.log(`DEBUG: Batch: Old group document (ID: ${oldGroupId}) marked for deletion.`);


                        // 2. Vytvoriť nový dokument skupiny s novým ID a pôvodnými dátami
                         batch.set(newGroupRef, {
                              name: newGroupName, // Nový názov
                             categoryId: currentCategoryId, // Kategória zostáva rovnaká
                             // Preniesť ostatné dáta zo starej skupiny, ak existujú
                             ...oldGroupData
                         });
                         console.log(`DEBUG: Batch: New group document (ID: ${newGroupId}) marked for creation.`);


                        // 3. Aktualizovať groupId vo VŠETKÝCH kluboch, ktoré patrili pod starú skupinu
                         const clubsToUpdateQuery = query(clubsCollectionRef, where('groupId', '==', oldGroupId));
                         const clubsSnapshot = await getDocs(clubsToUpdateQuery);
                         clubsSnapshot.docs.forEach(clubDoc => {
                              const clubRef = doc(clubsCollectionRef, clubDoc.id);
                              batch.update(clubRef, { groupId: newGroupId });
                              console.log(`DEBUG: Batch: Updating groupId for club "${clubDoc.id}" to "${newGroupId}".`);
                         });


                        await batch.commit();
                        console.log("DEBUG: Batch commit successful for group rename.");

                        alert(`Skupina úspešne premenovaná na "${newGroupName}".`);
                         console.log("DEBUG: Group renamed successfully.");

                    }

                    // Spoločná logika po úspešnom pridaní/úprave skupiny
                    if (groupModal) closeModal(groupModal); // Použiť funkciu closeModal
                    if (groupForm) groupForm.reset();
                    currentGroupModalMode = 'add'; editingGroupId = null;

                    // Refresh zobrazenia skupín v sekcii #skupiny
                    // Predpokladá, že sekcia #skupiny zobrazuje skupiny filtrované podľa kategórie
                    // Ak je v sekcii filter kategórií, musíme obnoviť zobrazenie skupín pre aktuálne vybranú kategóriu
                     console.log("DEBUG: Calling logic to refresh groups display after submit success.");
                     // TODO: Implementovať logiku obnovenia zobrazenia skupín v sekcii #skupiny
                     // Napr. ak existuje filter kategórií v sekcii #skupiny s ID 'groupCategoryFilterSelect':
                     // loadGroupsForCategory(document.getElementById('groupCategoryFilterSelect').value);
                     // Ak #skupiny zobrazuje skupiny nejako inak, volajte príslušnú funkciu.
                     // Ak #skupiny zobrazuje všetky skupiny naraz, volajte funkciu, ktorá to robí.
                     // Dočasne: Ak je aktuálny hash #timy-do-skupin, obnoví aj priradené tímy (pre prípad zmeny názvu skupiny)
                      if (window.location.hash === '#timy-do-skupin') {
                           displayClubs();
                      }
                       // Ak je aktuálny hash #zoznam-timov, obnoví aj zoznam všetkých tímov (pre prípad zmeny názvu skupiny v informácii o priradení)
                       if (window.location.hash === '#zoznam-timov') {
                            displayCreatedTeams();
                       }

                } catch (error) {
                    console.error('Chyba pri ukladaní skupiny: ', error);
                    alert(`Chyba pri ukladaní skupiny! Detail: ${error.message}`);
                     console.log("DEBUG: Group submit error handler finished.");
                }
            });
        } else { console.error("Group form not found!"); }


        // --- Event Listener pre formulár hromadného vytvárania tímov ---
        if (teamCreationForm) {
            teamCreationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                 console.log("DEBUG: teamCreationForm submit event fired."); // Log

                const baseTeamName = teamNameInput.value.trim();
                if (!baseTeamName) {
                     alert('Základný názov tímu nemôže byť prázdny.');
                     console.log("DEBUG: Validation failed: Base team name is empty.");
                    return;
                }

                const pairs = teamCategoryCountContainer.querySelectorAll('.category-count-pair');
                const teamsToCreate = [];

                // Validácia a zber dát z dynamických dvojíc
                for (const pair of pairs) {
                    const categorySelect = pair.querySelector('.team-category-select-dynamic');
                    const countInput = pair.querySelector('.team-count-input-dynamic');

                    const category = categorySelect.value;
                    const count = parseInt(countInput.value, 10);

                    if (!category) { alert('Prosím, vyberte kategóriu pre všetky dvojice.'); console.log("DEBUG: Validation failed: Category missing in pair."); return; }
                    if (isNaN(count) || count <= 0) { alert('Prosím, zadajte platný počet tímov (aspoň 1) pre všetky dvojice.'); console.log("DEBUG: Validation failed: Invalid count in pair."); return; }

                    teamsToCreate.push({ category, count });
                }

                if (teamsToCreate.length === 0) {
                     alert('Prosím, pridajte aspoň jednu dvojicu kategórie a počtu.');
                      console.log("DEBUG: Validation failed: No pairs added.");
                    return;
                }

                 console.log("DEBUG: Teams to create:", teamsToCreate);


                try {
                    // === Vytvorenie tímov pomocou BATCH operácie ===
                    console.log("DEBUG: Starting batch write for creating teams.");
                    const batch = writeBatch(db);

                    for (const teamInfo of teamsToCreate) {
                        const { category, count } = teamInfo;

                        for (let i = 1; i <= count; i++) {
                            // Konštrukcia názvu tímu a ID dokumentu
                            const teamSuffix = count > 1 ? ` ${i}` : ''; // Pridaj suffix ak je viac ako 1 tím
                             const fullTeamName = `${baseTeamName}${teamSuffix}`; // Celý názov tímu
                             // ID dokumentu bude "Kategória - Celý Názov Tímu"
                            const teamDocumentId = `${category} - ${fullTeamName}`; // Použiť konzistentný formát ID


                            const teamDocRef = doc(clubsCollectionRef, teamDocumentId); // Referencia na dokument s určeným ID

                            // Dáta pre nový tím
                            const newTeamData = {
                                name: fullTeamName, // Uložíme celý názov
                                categoryId: category,
                                groupId: null, // Nové tímy sú nepriradené
                                orderInGroup: null // Nemajú poradie kým nie sú priradené
                                // Prípadné ďalšie predvolené polia pre tím
                            };

                            // Kontrola, či dokument s týmto ID už existuje (ak by napr. už bol vytvorený/priradený tím s rovnakým ID)
                             // Táto kontrola je dôležitá, aby sme nepremazali existujúci záznam nechtiac.
                             // Ak chceme dovoliť prepísanie, túto kontrolu vynecháme, ale setDoc s konkrétnym ID prepisuje.
                             // Predpokladáme, že nechceme prepisovať existujúce tímy s týmto ID.
                             const existingTeamSnap = await getDoc(teamDocRef);
                             if (existingTeamSnap.exists()) {
                                 console.warn(`DEBUG: Team with ID "${teamDocumentId}" already exists. Skipping creation for this specific team.`);
                                 // Môžeme preskočiť túto konkrétnu iteráciu alebo informovať používateľa
                                 alert(`Tím s názvom "${fullTeamName}" v kategórii "${category}" už existuje. Tento tím nebol znovu vytvorený.`);
                                 continue; // Preskočiť pridanie do batchu pre tento tím
                             }


                            // Pridanie operácie vytvorenia dokumentu do batchu
                            batch.set(teamDocRef, newTeamData);
                             console.log(`DEBUG: Batch: Team "${teamDocumentId}" marked for creation.`);

                        }
                    }

                    await batch.commit();
                    console.log("DEBUG: Batch commit successful for team creation.");

                    alert('Tímy úspešne vytvorené.');
                     console.log("DEBUG: Teams created successfully.");

                     // Spoločná logika po úspešnom vytvorení tímov
                    if (teamCreationModal) closeModal(teamCreationModal); // Použiť funkciu closeModal
                     // Formulár sa resetuje v catch bloku alebo po úspechu priamo pred resetovaním stavu modálu

                    // Refresh tabuľku so zoznamom všetkých tímov (v sekcii #zoznam-timov)
                     console.log("DEBUG: Calling displayCreatedTeams after team creation submit success."); // Log
                     // !!! ODSTRÁNENÉ: displayCreatedTeams() sa už nebude volať explicitne po submite !!!
                     // displayCreatedTeams();
                    // --------------------------------------------------------------------------

                     // Tiež treba aktualizovať zoznam nepriradených tímov pre club modal, ak je relevantné
                      if (unassignedClubSelect) {
                           console.log("DEBUG: Calling populateUnassignedClubsSelect after team creation submit success.");
                           populateUnassignedClubsSelect(unassignedClubSelect, null);
                      }

                } catch (error) {
                     console.error('Chyba pri vytváraní tímov: ', error);
                     alert(`Chyba pri vytváraní tímov! Detail: ${error.message}`);
                      console.log("DEBUG: Team creation submit error handler finished.");

                     // Reset formulára pri chybe (alebo necháme, aby užívateľ videl, čo zadal?)
                     // Ak bol celý batch zlyhaný, pravdepodobne chceme nechať formulár vyplnený, aby užívateľ mohol skúsiť znova.
                      // Ak nastala chyba pri getDoc (kontrola existencie), tiež nechať formulár.
                     // Resetovanie formulára by sa malo diať len pri ÚSPECHU.

                     // Reset formulára len ak chceme začať odznova po chybe
                     // if (teamCreationForm) teamCreationForm.reset(); // Vyčistí aspoň základný názov
                     // if (teamCategoryCountContainer) teamCategoryCountContainer.innerHTML = ''; // Vyčistí dynamické dvojice
                     // loadAllCategoriesForDynamicSelects(); // Pre istotu znovu načítaj kategórie a aktualizuj selecty
                }
            });
        } else { console.error("Team creation form not found!"); }


        // --- Event listener pre tlačidlo "Pridať ďalšiu kategóriu" (v modáli vytvárania tímov) ---
        if (addCategoryCountPairButton) {
            addCategoryCountPairButton.addEventListener('click', async () => {
                 console.log("DEBUG: addCategoryCountPairButton clicked.");
                 // Pred pridaním novej dvojice zabezpečiť, že kategórie sú načítané
                 if (allAvailableCategories.length === 0) {
                      await loadAllCategoriesForDynamicSelects(); // Načítaj kategórie ak ešte nie sú (volá updateDynamicCategorySelects a checkIfAddCategoryButtonShouldBeVisible)
                 }
                 await addCategoryCountPair(); // Volaj funkciu na pridanie ďalšej dvojice (volá updateDynamicCategorySelects a updateRemoveButtonVisibility)
            });
        } else { console.error("Add category count pair button not found!"); }


        // --- Event Listener pre kliknutie na riadok tímu v tabuľke Zoznam tímov (pre otvorenie Manage Teams modal) ---
        // Predpokladáme, že tabuľka Zoznam tímov má ID 'createdTeamsTable' a riadky s dátami majú triedu 'team-row'
        // A klikáme napr. na prvú bunku (názov tímu)
        // Ak je v displayCreatedTeams generovaná iná štruktúra, tento listener treba prispôsobiť
        // V aktuálnej displayCreatedTeams generujeme priamo riadky (<tr>) s bunkami (<td>)
        // Skúsme pridať listener na telo tabuľky a delegovať kliknutie na riadky

        const createdTeamsTableBody = document.getElementById('createdTeamsTableBody'); // Referencia získaná už vyššie
        if (createdTeamsTableBody) {
            // Použijeme event delegation na telo tabuľky
            createdTeamsTableBody.addEventListener('click', (event) => {
                console.log("DEBUG: Click event on createdTeamsTableBody."); // Log
                const clickedRow = event.target.closest('tr'); // Nájdeme najbližší rodičovský riadok (<tr>)

                // Uistíme sa, že sme klikli na riadok a že to nie je riadok s chybou/prázdnou správou
                if (clickedRow && !clickedRow.classList.contains('no-data-row') && !clickedRow.classList.contains('error-row')) { // Pridajte triedy pre riadky s info/chybou ak existujú
                     // Získame dáta z riadku alebo z elementov v riadku, ktoré identifikujú zoskupenie
                     // V aktuálnej displayCreatedTeams generujeme riadky PRE KAŽDÝ TÍM.
                     // Ak chceme otvoriť Manage Teams modal pre zoskupenie (Základný názov + Kategória),
                     // musíme z riadku získať Základný názov a Kategóriu.
                     // V aktuálnej displayCreatedTeams, stĺpec 0 je Názov, stĺpec 1 je Kategória.
                     // Toto zoskupenie je založené na PLNOM názve a kategórii.
                     // Takže kliknutie na riadok tímu by malo otvoriť správu pre toto zoskupenie (plný názov + kategória).
                     // ALEBO, ak chceme zoskupovať v modali správu podľa Základného názvu + Kategórie,
                     // potrebujeme mať spôsob, ako z plného názvu tímu získať základný názov.

                     // Predpokladajme, že kliknutie na prvú bunku (názov tímu) v riadku spustí správu pre toto zoskupenie
                     // Nájdime prvú bunku v riadku
                      const firstCell = clickedRow.querySelector('td:first-child');
                      const categoryCell = clickedRow.querySelector('td:nth-child(2)'); // Druhá bunka pre kategóriu

                     if (firstCell && categoryCell) {
                          const fullTeamName = firstCell.textContent; // Celý názov z prvej bunky
                          const category = categoryCell.textContent; // Kategória z druhej bunky

                         // !!! Dôležité: Ak chceme otvoriť Manage Teams modal ZOSKUPENÝ podľa Základného názvu,
                         // potrebujeme ZÁKLADNÝ názov, nie celý názov.
                         // V displayCreatedTeams je stĺpec 0 "Názov tímu" (celý názov).
                         // Ak Manage Teams modal zobrazuje tímy podľa Základného názvu a Kategórie,
                         // potrebujeme pri kliknutí na riadok tímu vypočítať Základný názov z celého názvu.
                         // Toto je problematické, ak nemáme konzistentné suffixy alebo uložený baseName.
                         // AKO SA TERAZ V DISPLAYCREATEDTEAMS ZOBRAZUJE "ZÁKLADNÝ NÁZOV"?
                         // displayCreatedTeams zoskupuje podľa team.name a team.categoryId.
                         // Riadok zobrazuje team.name (celý názov) a team.categoryId.
                         // Manage Teams modal otvárame s baseTeamName a categoryId.
                         // AK Manage Teams modal ZOBRAZUJE TIIMY PODLA Základného názvu a Kategórie,
                         // MUSÍME ZÍSKAŤ Základný názov z kliknutého riadku.
                         // Ak displayCreatedTeams zobrazuje "Základný názov (Kategória)", a klikneme na to,
                         // musíme z textu extrahovať Základný názov a Kategóriu.
                         // Alebo, ak displayCreatedTeams zobrazuje Riadky pre KAŽDÝ TÍM (ako v mojej úprave displayCreatedTeams),
                         // kliknutie na riadok by malo otvoriť Manage Teams modal pre ZOSKUPENIE založené na
                         // ZÁKLADNOM NÁZVE (vypočítanom z celého názvu) a KATEGÓRII.

                         // Predpokladajme, že Manage Teams modal sa otvára s PLNYM názvom tímu a Kategóriou
                         // (to by zodpovedalo tomu, ako zoskupujeme teraz v displayCreatedTeams pre zobrazenie).
                         // Teda openManageTeamsModal(fullTeamName, category);

                          // Alebo, ak Manage Teams modal ZOBRAZUJE tímy so Základným názvom HORE a potom zoznam tímy
                          // a otvoríme ho kliknutím na Zoskupenie "Základný názov (Kategória)",
                          // potrebujeme získať Základný názov z riadku zoskupenia.
                          // V AKTUÁLNEJ displayCreatedTeams ZOBRAZUJEM Riadok pre KAŽDÝ TÍM.
                          // Takže kliknutie na riadok by malo otvoriť Manage Teams pre ZOSKUPENIE tohto tímu.
                          // Základný názov sa musí vypočítať.

                          // Vypočítanie Základného názvu z Celého názvu je neisté bez uloženia baseName v DB.
                          // Ak je celý názov "Hádzaná Trenčín 1", základný názov je "Hádzaná Trenčín".
                          // Ak je celý názov "FC Juniori B", základný názov je "FC Juniori B" (alebo "FC Juniori" ak suffix je B?)
                          // AK ID JE "Kategória - Celý Názov", potom "Celý Názov" je team.name.
                          // Ak chceme zoskupovať v modale podľa "Základný názov (Kategória)", musíme mať baseName.

                          // Zmeňme to tak, že kliknutie na riadok v displayCreatedTeams otvorí CLUB MODAL V EDIT MÓDE pre daný tím.
                          // To je jednoduchšie a konzistentnejšie. Správa jednotlivých tímov sa bude diať cez Club Modal.
                          // Funkciu openManageTeamsModal budeme volať len pri kliknutí na ZOSKUPENIE (ak by displayCreatedTeams zobrazoval zoskupenia inak).
                          // Alebo, ak chceme ZACHOVAŤ Manage Teams Modal, musíme mu nejako povedať, ktoré tímy má zobraziť.
                          // Môžeme mu predať Zoznam ID tímov z daného zoskupenia?
                          // Alebo mu predať Základný názov a Kategóriu, a Manage Teams Modal si ich načíta?

                          // V aktuálnom kóde, kliknutie na riadok v displayCreatedTeams volá openManageTeamsModal(fullTeamName, category).
                          // Toto volá modal s PLNYM názvom tímu a kategóriou.
                          // Funkcia openManageTeamsModal následne query firestore na tímy s TOUTO kategóriou a FILTRUJE na tie,
                          // ktorých názov ZACINA na baseTeamName (čo je tu fullTeamName).
                          // Toto nie je správne, ak chceme vidieť tímy s ROVNAKYM Základným názvom.

                          // Zmeňme poslucháč kliknutia v displayCreatedTeams tak, aby volal openClubModal v edit móde pre daný tím.
                          // Odstránime Manage Teams modal a jeho logiku, ak jeho účelom bola len hromadná úprava/mazanie (ktoré sa dá robiť jednotlivo cez Club Modal).
                          // Ak chceme hromadnú úpravu/mazanie zoskupenia, Manage Teams modal je potrebný, ale jeho logika načítania sa musí zmeniť.

                           // Zatiaľ ponecháme volanie openManageTeamsModal, ale treba si uvedomiť jeho obmedzenia s extrakciou baseName.
                           // AKTUÁLNE sa otvára Manage Teams modal pre zoskupenie = "Celý Názov Tímu" + Kategória.
                           // A vnútri Manage Teams modalu sa hľadajú tímy, ktorých názov ZACINA na "Celý Názov Tímu".
                           // Toto by malo vrátiť len samotný kliknutý tím, ak jeho názov nezačína na iný názov.
                           // Je to mätúce.


                           // Presuňme logiku úpravy/mazania z displayCreatedTeams do ManageTeamsModal.
                           // A kliknutie na riadok v displayCreatedTeams BUDE volať openManageTeamsModal.

                           // Ponecháme aktuálne volanie openManageTeamsModal(fullTeamName, category);
                           // A budeme pracovať s tým, že Manage Teams modal zobrazí tímy, ktorých názov začína na 'fullTeamName' v danej kategórii.
                           // Toto je stále problematické pre extrakciu základného názvu.

                           // Alternatíva: Upraviť displayCreatedTeams tak, aby zoskupoval a zobrazoval "Základný názov (Kategória)" riadky.
                           // A kliknutie na TIE riadky by volalo openManageTeamsModal(baseName, category).
                           // Potom by sa upravil openManageTeamsModal, aby načítal tímy podľa baseName a category.

                           // Zatiaľ necháme pôvodnú logiku volania openManageTeamsModal z displayCreatedTeams,
                           // ale s vedomím, že zoskupovanie a filtrovanie v Manage Teams modali nemusí byť presne podľa očakávania.

                             const fullTeamName = firstCell.textContent; // Celý názov tímu z prvej bunky
                             const category = categoryCell.textContent; // Kategória z druhej bunky

                             console.log("DEBUG: Clicked team row in createdTeamsTableBody. Calling openManageTeamsModal.");
                            // Volanie openManageTeamsModal s PLNYM názvom tímu a Kategóriou
                            openManageTeamsModal(fullTeamName, category);

                        } else {
                             console.log("DEBUG: Clicked on createdTeamsTableBody, but not a data row.");
                        }
                    });
                } else { console.error("Created teams table body not found!"); }


        // --- Event Listener pre formulár Manage Teams (v modáli správy jednotlivých tímov) ---
        // Ak Manage Teams modal obsahuje formulár na hromadnú úpravu/mazanie, treba pridať jeho listener.
        // V aktuálnom HTML tam formulár nie je, sú tam len tlačidlá pre jednotlivé tímy v zozname.
        // Ak by tam bol formulár, tu by bol jeho addEventListener('submit', ...)


        // --- Inicializácia dát pri načítaní stránky ---
        // Toto sa spustí raz pri prvom načítaní scriptu
        console.log("DEBUG: Script loaded. Starting initial display setup.");
        // Initializovať stav zobrazenia pri načítaní stránky
        const initialHash = window.location.hash || '#kategorie';

        // Volanie príslušnej zobrazovacej funkcie pre počiatočný hash
        if (initialHash === '#kategorie') {
             console.log("DEBUG: Initial display for #kategorie.");
            toggleContentDisplay(); // Spustí toggleContentDisplay, ktorý zobrazí sekciu a zavolá loadCategoriesTable
        } else if (initialHash === '#skupiny') {
             console.log("DEBUG: Initial display for #skupiny.");
             toggleContentDisplay(); // Spustí toggleContentDisplay, ktorý zobrazí sekciu
             // TODO: Zavolať funkciu na zobrazenie skupín v sekcii #skupiny
             // Napr. loadGroupsForCategory(document.getElementById('groupCategoryFilterSelect').value);
        } else if (initialHash === '#timy-do-skupin') {
             console.log("DEBUG: Initial display for #timy-do-skupin. Calling toggleContentDisplay and displayClubs.");
             toggleContentDisplay(); // Zobrazí sekciu #timy-do-skupin
             displayClubs(); // !!! Zavolá displayClubs pre prvotné naplnenie tabuľky priradených tímov pri načítaní strany !!!
        } else if (initialHash === '#zoznam-timov') {
             console.log("DEBUG: Initial display for #zoznam-timov. Calling toggleContentDisplay and displayCreatedTeams.");
             toggleContentDisplay(); // Zobrazí sekciu #zoznam-timov
             displayCreatedTeams(); // !!! Zavolá displayCreatedTeams pre prvotné naplnenie tabuľky všetkých tímov pri načítaní strany !!!
        } else {
             console.warn(`DEBUG: Initial hash ${initialHash} does not match any known section. Defaulting to #kategorie.`);
             // Ak hash neznámy, presmerujeme na #kategorie, čo spustí hashchange listener
             window.location.hash = '#kategorie';
        }


        // Pridať poslucháča udalosti 'hashchange', ktorý zavolá toggleContentDisplay
        // Toto sa spustí pri KAŽDEJ zmene hashu (kliknutie na navigačné linky, programová zmena hashu)
        console.log("DEBUG: Adding hashchange listener.");
        window.addEventListener('hashchange', toggleContentDisplay);


        // --- Inicializácia dát pri načítaní skriptu ---
        // Tieto dáta sú potrebné pre plnenie selectboxov v modáloch hneď pri ich otvorení
        console.log("DEBUG: Initial data loading for modals.");
        loadAllCategoriesForDynamicSelects(); // Načíta kategórie pre modál vytvárania tímov a volá updateDynamicCategorySelects/checkIfAddCategoryButtonShouldBeVisible
        // Ostatné potrebné dáta pre modály (kategórie, nepriradené tímy, skupiny) sa načítajú v príslušných openModal funkciách alebo v change listeneroch.


    </script>
    
</body>
</html>
